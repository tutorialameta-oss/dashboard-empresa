<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LA META — Diagnóstico Evaluaciones (GitHub ↔ Apps Script)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;background:#faf7f7;color:#111}
    h1{margin:0 0 8px 0}
    .muted{color:#555;margin:0 0 18px 0}
    .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 6px 18px rgba(0,0,0,.04)}
    label{display:block;font-size:12px;color:#444;margin:8px 0 6px}
    input,select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .primary{background:#b50000;color:#fff}
    .dark{background:#111827;color:#fff}
    .gray{background:#e5e7eb;color:#111827}
    pre{white-space:pre-wrap;background:#0b1220;color:#e8eefc;padding:14px;border-radius:12px;overflow:auto;max-height:420px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f4f6;color:#111827;font-size:12px;margin-right:8px}
    .warn{background:#fff7ed;border-color:#fed7aa}
    .ok{background:#ecfdf5;border-color:#bbf7d0}
  </style>
</head>
<body>
  <h1>LA META — Diagnóstico Evaluaciones</h1>
  <p class="muted">Esto confirma si el problema está en <b>parámetros</b> (universidad/salón/curso), en <b>JSONP</b> o en el <b>Apps Script</b>.</p>

  <div class="card">
    <div class="row">
      <div>
        <label>URL WebApp (/exec)</label>
        <input id="execUrl" value="https://script.google.com/macros/s/AKfycbxT0lOvu20Vo8_3leNUxgCrH1hpK2pGx2qo37t6bCRW2VusVDXvBSJni0btkI7mmdXR/exec" />
      </div>
      <div>
        <label>apiKey</label>
        <input id="apiKey" value="LAMETA2026" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>universidad (ej: AGRARIA)</label>
        <input id="universidad" value="AGRARIA" />
      </div>
      <div>
        <label>salón (IMPORTANTE: escribe EXACTO lo que tiene el alumno, ej: AGRARIA LM 2)</label>
        <input id="salon" value="AGRARIA LM 2" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>curso (opcional, ej: RAZONAMIENTO VERBAL)</label>
        <input id="curso" value="" />
      </div>
      <div>
        <label>action</label>
        <select id="action">
          <option value="list">list (recomendado)</option>
          <option value="list_evals">list_evals</option>
          <option value="debug_filter">debug_filter (diagnóstico del filtro)</option>
          <option value="selftest">selftest</option>
          <option value="ping">ping</option>
        </select>
      </div>
    </div>

    <div class="btns">
      <button class="primary" onclick="run()">PROBAR</button>
      <button class="dark" onclick="run('debug_filter')">DEBUG FILTRO</button>
      <button class="gray" onclick="clearOut()">LIMPIAR</button>
    </div>
  </div>

  <div class="card warn">
    <span class="pill">Pista #1</span> Si aquí funciona y en tu panel no, entonces el panel está usando <b>otros parámetros</b> o <b>otra URL / apiKey</b>.
    <br><span class="pill">Pista #2</span> Si <b>debug_filter</b> dice <i>matchCount = 0</i>, entonces el salón del alumno <b>no coincide</b> con el salón de EVAL_PDFS.
  </div>

  <div class="card ok">
    <div style="margin-bottom:10px"><b>Request URL</b></div>
    <pre id="req">(vacío)</pre>
  </div>

  <div class="card">
    <div style="margin-bottom:10px"><b>Response</b></div>
    <pre id="out">(aún no ejecutas)</pre>
  </div>

<script>
let lastCb = null;

function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    lastCb = cb;
    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };
    const s = document.createElement("script");
    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    s.onerror = () => {
      cleanup();
      reject(new Error("JSONP load error (script.onerror)."));
    };
    document.head.appendChild(s);

    function cleanup(){
      try { delete window[cb]; } catch(e){ window[cb] = undefined; }
      if (s && s.parentNode) s.parentNode.removeChild(s);
    }
  });
}

function buildUrl(actionOverride){
  const execUrl = document.getElementById("execUrl").value.trim();
  const apiKey = document.getElementById("apiKey").value.trim();
  const universidad = document.getElementById("universidad").value.trim();
  const salon = document.getElementById("salon").value.trim();
  const curso = document.getElementById("curso").value.trim();
  const action = (actionOverride || document.getElementById("action").value).trim();

  const params = new URLSearchParams();
  params.set("apiKey", apiKey);
  params.set("action", action);
  if (universidad) params.set("universidad", universidad);
  if (salon) params.set("salon", salon);
  if (curso) params.set("curso", curso);

  return execUrl + "?" + params.toString();
}

async function run(actionOverride){
  const url = buildUrl(actionOverride);
  document.getElementById("req").textContent = url;
  document.getElementById("out").textContent = "Cargando...";
  try{
    const data = await jsonp(url);
    document.getElementById("out").textContent = JSON.stringify(data, null, 2);
  }catch(err){
    document.getElementById("out").textContent = JSON.stringify({ok:false, error:"client_error", detail:String(err && err.message ? err.message : err)}, null, 2);
  }
}

function clearOut(){
  document.getElementById("req").textContent = "(vacío)";
  document.getElementById("out").textContent = "(limpio)";
}
</script>
</body>
</html>
