<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LA META | PANEL DE CONTROL</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,0.10);
      --accent:#d10b0b;
      --accent2:#a40000;
      --soft:#fff5f5;
      --shadow: 0 14px 34px rgba(15,23,42,0.10);
      --radius:18px;

      /* estados */
      --ok:#16a34a;      /* ACTIVO */
      --bad:#dc2626;     /* RETIRO */
      --warn:#f59e0b;    /* CAMBIO */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }

    .topbar{ height:10px; background:linear-gradient(90deg,var(--accent2),var(--accent)); }

    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height: calc(100vh - 10px);
    }

    .sidebar{
      border-right:1px solid var(--border);
      padding:18px 14px;
      position: sticky;
      top: 0;
      align-self: start;
      height: calc(100vh - 10px);
      overflow:auto;
      background:#fff;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      padding:12px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: #fff;
    }

    .brand img{
      width:64px; height:64px; object-fit:contain;
      border-radius:14px; border:1px solid var(--border);
      padding:8px; background:#fff;
    }

    .brand h1{
      margin:0;
      font-size:15px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.15;
      text-transform: uppercase;
    }
    .brand .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    .nav{
      margin-top:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .nav button{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:950;
      color: var(--text);
    }
    .nav button.active{
      border-color: rgba(209,11,11,0.40);
      box-shadow: 0 0 0 3px rgba(209,11,11,0.10);
      background: var(--soft);
      color: var(--accent2);
    }

    .small{
      margin-top:16px;
      padding:14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:#fff;
      box-shadow: var(--shadow);
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(209,11,11,0.25);
      background: rgba(209,11,11,0.06);
      color: var(--accent2);
      font-size:12px;
      font-weight:950;
    }
    .badge{
      display:block;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fafafa;
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      margin-top:10px;
    }

    .toggle{
      display:flex; align-items:center; gap:10px;
      margin-top:12px;
      font-size:12px; color: var(--muted);
      font-weight:900;
    }

    .main{ padding:22px 22px 32px; }

    .headerline{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
    }

    .title{ display:flex; flex-direction:column; gap:8px; }
    .title h2{
      margin:0;
      font-size:20px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    .title p{
      margin:0;
      color: var(--muted);
      font-size:13px;
      font-weight:750;
      line-height:1.4;
      max-width: 980px;
    }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }

    select, input, button{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 14px;
      padding:11px 12px;
      font-size:12px;
      outline:none;
      color: var(--text);
    }
    input{ min-width:320px; }
    input::placeholder{ color:#94a3b8; }
    select:focus, input:focus{
      border-color: rgba(209,11,11,0.40);
      box-shadow: 0 0 0 3px rgba(209,11,11,0.10);
    }
    button{
      cursor:pointer;
      font-weight:950;
      border-color: rgba(209,11,11,0.25);
      background: var(--soft);
      color: var(--accent2);
    }
    button:hover{
      border-color: rgba(209,11,11,0.45);
      background: rgba(209,11,11,0.10);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      min-width: 0;
    }

    .kpi{ grid-column: span 3; min-height: 110px; }
    .kpi .label{ color: var(--muted); font-size:12px; font-weight:950; text-transform: uppercase; }
    .kpi .value{ margin-top:8px; font-size:34px; font-weight:950; color: var(--accent2); }
    .kpi .hint{ margin-top:8px; color: var(--muted); font-size:12px; font-weight:900; text-transform: uppercase; }

    .panel{ grid-column: span 6; }
    .panel4{ grid-column: span 4; }
    .panel12{ grid-column: span 12; }

    .cardtitle{
      color: var(--muted);
      font-size:12px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform: uppercase;
      margin-bottom:10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }

    canvas{ width:100% !important; height:380px !important; }

    table{ width:100%; border-collapse: collapse; font-size:12px; }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
    }
    th{
      position:sticky;
      top:0;
      background:#fff;
      z-index:1;
      color: var(--muted);
      font-weight:950;
      text-transform: uppercase;
    }

    .softHint{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      text-transform: uppercase;
    }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot.ok{ background: var(--ok); }
    .dot.bad{ background: var(--bad); }
    .dot.warn{ background: var(--warn); }

    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .kpi{ grid-column: span 6; }
      .panel, .panel4{ grid-column: span 12; }
      canvas{ height:320px !important; }
      input{ min-width: 220px; }
      .controls{ justify-content:flex-start; }
    }
  </style>
</head>

<body>
  <div class="topbar"></div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="logo.png" alt="LA META" onerror="this.style.display='none'"/>
        <div>
          <h1>LA META<br/>PANEL DE CONTROL</h1>
          <div class="sub">Monitoreo de alumnos por local y ciclo</div>
        </div>
      </div>

      <div class="nav">
        <button id="nav_overview" class="active">RESUMEN GENERAL</button>
        <button id="nav_local">POR LOCAL</button>
        <button id="nav_table">TABLA</button>
      </div>

      <div class="small">
        <div class="pill" id="statusPill">CONECTANDO…</div>
        <div class="badge">FUENTE: <b>GOOGLE SHEETS</b></div>
        <div class="badge">ACTUALIZACIÓN: <b>30s</b></div>
        <div class="badge">ÚLTIMA ACTUALIZACIÓN: <b id="lastLoad">—</b></div>

        <div class="toggle">
          <input type="checkbox" id="autoOn" checked />
          <label for="autoOn">Auto-actualización</label>
        </div>

        <button id="btnNow" style="width:100%; margin-top:12px;">ACTUALIZAR AHORA</button>
      </div>
    </aside>

    <main class="main">
      <div class="headerline">
        <div class="title">
          <h2 id="viewTitle">RESUMEN GENERAL</h2>
          <p id="viewDesc">Visión consolidada de matrícula y movimientos.</p>
        </div>

        <div class="controls">
          <select id="fLocal"></select>
          <select id="fCiclo"></select>
          <select id="fSalon"></select>
          <select id="fModalidad"></select>
          <select id="fEstado"></select>
          <input id="q" type="text" placeholder="Buscar por nombre"/>
        </div>
      </div>

      <div id="view_overview" class="grid"></div>
      <div id="view_local" class="grid" style="display:none;"></div>
      <div id="view_table" class="grid" style="display:none;"></div>
    </main>
  </div>

<script>
  // ============================ CONFIG DE TUS SALONES ============================
  const SPREADSHEET_ID = "1nHCBQLuJ8RZNtLisvAqD916pcxbUmtqPrMnO4V0ewvs";

  const SALONES = [
    // LA MOLINA
    { local:"LA MOLINA", ciclo:"AGRARIA", salon:"AGRARIA 1", gid:115906280 },
    { local:"LA MOLINA", ciclo:"AGRARIA", salon:"AGRARIA 2", gid:1576159193 },
    { local:"LA MOLINA", ciclo:"PUCP", salon:"PUCP", gid:1037962332 },
    { local:"LA MOLINA", ciclo:"U.LIMA", salon:"U.LIMA", gid:877886853 },
    { local:"LA MOLINA", ciclo:"ADELANTO", salon:"ADELANTO", gid:1271606284 },
    { local:"LA MOLINA", ciclo:"PARALELO", salon:"PARALELO", gid:1863430245 },

    // SAN BORJA
    { local:"SAN BORJA", ciclo:"AGRARIA", salon:"AGRARIA", gid:538377241 },
    { local:"SAN BORJA", ciclo:"PUCP", salon:"PUCP", gid:998068235 },
    { local:"SAN BORJA", ciclo:"U.LIMA", salon:"U.LIMA 1", gid:670800187 },
    { local:"SAN BORJA", ciclo:"U.LIMA", salon:"U.LIMA 2", gid:1856014712 },

    // SAN MIGUEL
    { local:"SAN MIGUEL", ciclo:"AGRARIA", salon:"AGRARIA", gid:513074883 },
    { local:"SAN MIGUEL", ciclo:"PUCP", salon:"PUCP", gid:1531300183 },
    { local:"SAN MIGUEL", ciclo:"U.LIMA", salon:"U.LIMA 1", gid:1080962628 },
    { local:"SAN MIGUEL", ciclo:"U.LIMA", salon:"U.LIMA 2", gid:679583464 },
    { local:"SAN MIGUEL", ciclo:"ADELANTO", salon:"ADELANTO U.LIMA (MIXTO)", gid:2120250792 },
    { local:"SAN MIGUEL", ciclo:"PARALELO", salon:"PARALELO", gid:721468852 },

    // VIRTUAL
    { local:"VIRTUAL", ciclo:"AGRARIA", salon:"AGRARIA (VIRTUAL)", gid:709062846 },
    { local:"VIRTUAL", ciclo:"ESC. U.LIMA", salon:"ESCOLAR U.LIMA", gid:315999969 },
    { local:"VIRTUAL", ciclo:"U.LIMA", salon:"U.LIMA (VIRTUAL)", gid:1667430860 },
  ];

  const AUTO_REFRESH_MS = 30000;

  // Orden fijo solicitado
  const CICLO_ORDER = ["AGRARIA","U.LIMA","PUCP","ADELANTO","PARALELO","ESC. U.LIMA"];
  const cicloSort = (a,b) => (CICLO_ORDER.indexOf(a) - CICLO_ORDER.indexOf(b));

  // Headers (por texto)
  const HEAD = {
    NOMBRES_A: "NOMBRES COMPLETOS",
    NOMBRES_B: "NOMBRE COMPLETO",
    NOMBRES_C: "NOMBRES",
    MODALIDAD: "MODALIDAD",
    ESTADO: "ESTADO",
  };

  // ============================ UTIL ============================
  function csvUrl(gid){
    return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${gid}`;
  }

  function parseCSVLine(line){
    const out = [];
    let cur = "", inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"'){
        if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === "," && !inQ){
        out.push(cur); cur = "";
      } else cur += ch;
    }
    out.push(cur);
    return out.map(x => String(x ?? "").trim());
  }

  function norm(s){ return String(s ?? "").replace(/\s+/g," ").trim(); }
  function low(s){ return norm(s).toLowerCase(); }
  function uniq(arr){ return [...new Set(arr)]; }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fillSelectKeep(selId, values, labelAll){
    const sel = document.getElementById(selId);
    const prev = sel.value || "__ALL__";
    sel.innerHTML = "";

    const all = document.createElement("option");
    all.value = "__ALL__";
    all.textContent = labelAll;
    sel.appendChild(all);

    for (const v of values){
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    }

    const exists = Array.from(sel.options).some(o => o.value === prev);
    sel.value = exists ? prev : "__ALL__";
  }

  // 3 estados exactos: ACTIVO / RETIRO / CAMBIO
  function normalizeEstado(x){
    const s = low(x);
    if (s.includes("reti") || s.includes("retir")) return "RETIRO";
    if (s.includes("cambi")) return "CAMBIO";
    if (s.includes("activ")) return "ACTIVO";
    return "CAMBIO"; // si viene raro/empty, lo tratamos como CAMBIO (tus 3 tipos)
  }

  // Modalidad: SOLO PRESENCIAL / VIRTUAL
  function normalizeModalidad(x, localFallback){
    const s = low(x);
    if (s.includes("virtual") || s.includes("online") || s.includes("remot")) return "VIRTUAL";
    if (s.includes("pres") || s.includes("aula")) return "PRESENCIAL";
    // Si no hay dato, inferimos por local (para no crear 3ra categoría):
    return (localFallback === "VIRTUAL") ? "VIRTUAL" : "PRESENCIAL";
  }

  function countBy(arr, keyFn){
    const m = new Map();
    for (const it of arr){
      const k = keyFn(it);
      if (!k) continue;
      m.set(k, (m.get(k)||0)+1);
    }
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  }

  // Dedupe por NOMBRE con prioridad (ACTIVO > RETIRO > CAMBIO)
  function dedupeByNameWithPriority(rows){
    const best = new Map();
    const score = (estado) => estado==="ACTIVO" ? 3 : (estado==="RETIRO" ? 2 : 1);

    for (const r of rows){
      const key = low(r.nombre);
      if (!key) continue;
      const cur = best.get(key);
      if (!cur || score(r.estado) > score(cur.estado)){
        best.set(key, r);
      }
    }
    return [...best.values()];
  }

  // Aulas mixtas (salón con PRESENCIAL y VIRTUAL dentro del mismo salón)
  function computeAulaMixta(rows){
    const map = new Map(); // key local||ciclo||salon -> set modalidades
    for (const r of rows){
      const k = `${r.local}||${r.ciclo}||${r.salon}`;
      if (!map.has(k)) map.set(k, new Set());
      map.get(k).add(r.modalidad);
    }
    const mixtas = new Set();
    for (const [k,set] of map.entries()){
      if (set.has("PRESENCIAL") && set.has("VIRTUAL")) mixtas.add(k);
    }
    return mixtas;
  }

  // ============================ STATE ============================
  const state = {
    view: "overview",
    rawRows: [],            // todas las filas
    canonical: [],          // consolidado por nombre (estado actual)
    cambiosUnique: [],      // lista única por nombre de eventos CAMBIO (para KPI)
    cambiosRows: [],        // filas CAMBIO para agrupar por local/ciclo/salon (eventos)
    aulaMixtaKeys: new Set(),

    filtered: [],
    autoOn: true,

    // Charts
    ch_over_estado: null,
    ch_over_modalidad: null,
    ch_over_retiros: null,

    ch_loc_cambios_ciclo: null,
    ch_loc_retiros_ciclo: null,
    ch_loc_cambios_salon: null,
    ch_loc_retiros_salon: null,
  };

  // ============================ CHART BASE ============================
  Chart.register(ChartDataLabels);

  const GRID = "rgba(15,23,42,0.10)";
  const TICK = "#64748b";

  function baseOptions(){
    return {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { position: "bottom", labels:{ color:TICK, font:{ weight:"800" } } },
        datalabels: { display:false }
      }
    };
  }

  function mkDoughnut(canvasId, labels, values, colors){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;
    return new Chart(canvas, {
      type: "doughnut",
      data: { labels, datasets:[{ data: values, backgroundColor: colors, borderColor:"rgba(15,23,42,0.06)", borderWidth:1 }] },
      options: {
        ...baseOptions(),
        plugins: {
          ...baseOptions().plugins,
          datalabels: { display:false }
        }
      }
    });
  }

  function mkBar(canvasId, labels, values, color, labelText){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;
    return new Chart(canvas, {
      type:"bar",
      data:{ labels, datasets:[{ label:labelText||"", data: values, backgroundColor: color, borderColor: color, borderWidth: 1.5, borderRadius: 10 }] },
      options:{
        responsive:true, maintainAspectRatio:false, animation:false,
        plugins:{
          legend:{ display:false },
          datalabels:{
            color:"#0f172a",
            anchor:"end",
            align:"end",
            clamp:true,
            offset: 2,
            font:{ weight:"900" },
            formatter:(v)=> (v && v>0) ? v : ""
          }
        },
        scales:{
          x:{ ticks:{ color:TICK, font:{ weight:"800" } }, grid:{ color:GRID } },
          y:{ beginAtZero:true, ticks:{ color:TICK, font:{ weight:"800" } }, grid:{ color:GRID } }
        }
      }
    });
  }

  function updateChart(chart, labels, values){
    if (!chart) return;
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update("none");
  }

  // ============================ UI NAV ============================
  function setView(v){
    state.view = v;
    document.getElementById("nav_overview").classList.toggle("active", v==="overview");
    document.getElementById("nav_local").classList.toggle("active", v==="local");
    document.getElementById("nav_table").classList.toggle("active", v==="table");

    document.getElementById("view_overview").style.display = (v==="overview") ? "" : "none";
    document.getElementById("view_local").style.display = (v==="local") ? "" : "none";
    document.getElementById("view_table").style.display = (v==="table") ? "" : "none";

    const titles = {
      overview: ["RESUMEN GENERAL", "Visión consolidada de matrícula y movimientos."],
      local: ["POR LOCAL", "Control por ciclo y salón (cambios y retiros)."],
      table: ["TABLA", "Búsqueda y filtros para consulta interna."]
    };
    document.getElementById("viewTitle").textContent = titles[v][0];
    document.getElementById("viewDesc").textContent = titles[v][1];

    render();
  }

  // ============================ FILTERS ============================
  function initFilters(){
    const locals = uniq(SALONES.map(s=>s.local)).sort();
    const ciclos = uniq(SALONES.map(s=>s.ciclo)).sort(cicloSort);

    fillSelectKeep("fLocal", locals, "LOCAL: TODOS");
    fillSelectKeep("fCiclo", ciclos, "CICLO: TODOS");

    // Salones se recalculan según Local/Ciclo seleccionados
    rebuildSalonOptions();

    // Modalidad: SOLO 2
    fillSelectKeep("fModalidad", ["PRESENCIAL","VIRTUAL"], "MODALIDAD: TODAS");

    // Estados (para tabla)
    fillSelectKeep("fEstado", ["ACTIVO","RETIRO"], "ESTADO: TODOS");
  }

  function rebuildSalonOptions(){
    const fLocal = document.getElementById("fLocal").value;
    const fCiclo = document.getElementById("fCiclo").value;

    let base = state.canonical;
    if (fLocal !== "__ALL__") base = base.filter(r=>r.local===fLocal);
    if (fCiclo !== "__ALL__") base = base.filter(r=>r.ciclo===fCiclo);

    const salones = uniq(base.map(r=>r.salon)).sort();
    fillSelectKeep("fSalon", salones, "SALÓN: TODOS");
  }

  function applyFilters(){
    const fLocal = document.getElementById("fLocal").value;
    const fCiclo = document.getElementById("fCiclo").value;
    const fSalon = document.getElementById("fSalon").value;
    const fMod = document.getElementById("fModalidad").value;
    const fEst = document.getElementById("fEstado").value;
    const q = low(document.getElementById("q").value);

    let base = state.canonical;

    base = base.filter(r=>{
      if (fLocal!=="__ALL__" && r.local!==fLocal) return false;
      if (fCiclo!=="__ALL__" && r.ciclo!==fCiclo) return false;
      if (fSalon!=="__ALL__" && r.salon!==fSalon) return false;
      if (fMod!=="__ALL__" && r.modalidad!==fMod) return false;
      if (fEst!=="__ALL__" && r.estado!==fEst) return false;

      if (q){
        const blob = low([r.nombre, r.local, r.ciclo, r.salon, r.modalidad, r.estado].join(" | "));
        if (!blob.includes(q)) return false;
      }
      return true;
    });

    state.filtered = base;
  }

  // ============================ LAYOUTS ============================
  function ensureOverviewLayout(){
    const el = document.getElementById("view_overview");
    if (el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card kpi">
        <div class="label">TOTAL DE ALUMNOS</div>
        <div class="value" id="k_total">0</div>
      </div>

      <div class="card kpi">
        <div class="label">ACTIVOS</div>
        <div class="value" id="k_act">0</div>
      </div>

      <div class="card kpi">
        <div class="label">RETIROS</div>
        <div class="value" id="k_ret">0</div>
      </div>

      <div class="card kpi">
        <div class="label">CAMBIOS (TRASLADOS)</div>
        <div class="value" id="k_cam">0</div>
        <div class="hint">NO SUMA AL TOTAL</div>
      </div>

      <div class="card panel4">
        <div class="cardtitle">ESTADO (MATRÍCULA)</div>
        <div class="softHint">
          <span class="dot ok"></span>ACTIVO
          <span class="dot bad"></span>RETIRO
          <span class="dot warn"></span>CAMBIO
        </div>
        <div style="height:380px;margin-top:10px;"><canvas id="over_estado"></canvas></div>
      </div>

      <div class="card panel4">
        <div class="cardtitle">MODALIDAD</div>
        <div style="height:380px;margin-top:10px;"><canvas id="over_modalidad"></canvas></div>
      </div>

      <div class="card panel4">
        <div class="cardtitle">RETIROS POR CICLO</div>
        <div style="height:380px"><canvas id="over_retiros"></canvas></div>
      </div>
    `;

    state.ch_over_estado = mkDoughnut(
      "over_estado",
      ["ACTIVO","RETIRO","CAMBIO"],
      [0,0,0],
      ["#16a34a","#dc2626","#f59e0b"]
    );

    state.ch_over_modalidad = mkDoughnut(
      "over_modalidad",
      ["PRESENCIAL","VIRTUAL"],
      [0,0],
      ["rgba(209,11,11,0.55)","rgba(15,23,42,0.12)"]
    );

    state.ch_over_retiros = mkBar("over_retiros", [], [], "#dc2626", "RETIROS");

    el.dataset.ready = "1";
  }

  function ensureLocalLayout(){
    const el = document.getElementById("view_local");
    if (el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card panel12">
        <div class="cardtitle">CAMBIOS Y RETIROS</div>
        <div class="softHint">
          <span class="dot warn"></span>CAMBIO
          <span class="dot bad"></span>RETIRO
        </div>
      </div>

      <div class="card panel">
        <div class="cardtitle">CAMBIOS POR CICLO</div>
        <div style="height:380px"><canvas id="loc_cambios_ciclo"></canvas></div>
      </div>

      <div class="card panel">
        <div class="cardtitle">RETIROS POR CICLO</div>
        <div style="height:380px"><canvas id="loc_retiros_ciclo"></canvas></div>
      </div>

      <div class="card panel">
        <div class="cardtitle">CAMBIOS POR SALÓN</div>
        <div style="height:380px"><canvas id="loc_cambios_salon"></canvas></div>
      </div>

      <div class="card panel">
        <div class="cardtitle">RETIROS POR SALÓN</div>
        <div style="height:380px"><canvas id="loc_retiros_salon"></canvas></div>
      </div>

      <div class="card panel12">
        <div class="cardtitle">RESUMEN (CICLO)</div>
        <div style="overflow:auto; max-height: 40vh;">
          <table>
            <thead>
              <tr>
                <th>CICLO</th>
                <th>TOTAL</th>
                <th>ACTIVOS</th>
                <th>RETIROS</th>
                <th>PRESENCIAL</th>
                <th>VIRTUAL</th>
                <th>CAMBIOS</th>
              </tr>
            </thead>
            <tbody id="loc_table_ciclo"></tbody>
          </table>
        </div>
      </div>

      <div class="card panel12">
        <div class="cardtitle">RESUMEN (SALÓN)</div>
        <div style="overflow:auto; max-height: 45vh;">
          <table>
            <thead>
              <tr>
                <th>SALÓN</th>
                <th>CICLO</th>
                <th>TOTAL</th>
                <th>ACTIVOS</th>
                <th>RETIROS</th>
                <th>PRESENCIAL</th>
                <th>VIRTUAL</th>
                <th>AULA MIXTA</th>
                <th>CAMBIOS</th>
              </tr>
            </thead>
            <tbody id="loc_table_salon"></tbody>
          </table>
        </div>
      </div>
    `;

    state.ch_loc_cambios_ciclo = mkBar("loc_cambios_ciclo", [], [], "#f59e0b", "CAMBIOS");
    state.ch_loc_retiros_ciclo = mkBar("loc_retiros_ciclo", [], [], "#dc2626", "RETIROS");
    state.ch_loc_cambios_salon = mkBar("loc_cambios_salon", [], [], "#f59e0b", "CAMBIOS");
    state.ch_loc_retiros_salon = mkBar("loc_retiros_salon", [], [], "#dc2626", "RETIROS");

    el.dataset.ready = "1";
  }

  function ensureTableLayout(){
    const el = document.getElementById("view_table");
    if (el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card panel12">
        <div class="cardtitle">TABLA</div>
        <div style="overflow:auto; max-height: 75vh;">
          <table>
            <thead>
              <tr>
                <th>NOMBRE</th>
                <th>LOCAL</th>
                <th>CICLO</th>
                <th>SALÓN</th>
                <th>MODALIDAD</th>
                <th>ESTADO</th>
              </tr>
            </thead>
            <tbody id="tb_body"></tbody>
          </table>
        </div>
      </div>
    `;

    el.dataset.ready = "1";
  }

  // ============================ RENDER ============================
  function renderOverview(){
    ensureOverviewLayout();

    const rows = state.filtered;

    // TOTAL: Activo + Retiro (NO incluye cambio)
    const total = rows.length;
    const act = rows.filter(r=>r.estado==="ACTIVO").length;
    const ret = rows.filter(r=>r.estado==="RETIRO").length;

    // CAMBIOS: se calcula desde eventos (por nombre), no desde canonical
    const fLocal = document.getElementById("fLocal").value;
    const fCiclo = document.getElementById("fCiclo").value;
    const fSalon = document.getElementById("fSalon").value;
    let cambiosBase = state.cambiosRows;

    if (fLocal!=="__ALL__") cambiosBase = cambiosBase.filter(r=>r.local===fLocal);
    if (fCiclo!=="__ALL__") cambiosBase = cambiosBase.filter(r=>r.ciclo===fCiclo);
    if (fSalon!=="__ALL__") cambiosBase = cambiosBase.filter(r=>r.salon===fSalon);

    const cambiosUnique = uniq(cambiosBase.map(r=>low(r.nombre))).filter(Boolean).length;

    // Modalidad (solo 2)
    const pres = rows.filter(r=>r.modalidad==="PRESENCIAL").length;
    const virt = rows.filter(r=>r.modalidad==="VIRTUAL").length;

    document.getElementById("k_total").textContent = total.toLocaleString("es-PE");
    document.getElementById("k_act").textContent = act.toLocaleString("es-PE");
    document.getElementById("k_ret").textContent = ret.toLocaleString("es-PE");
    document.getElementById("k_cam").textContent = cambiosUnique.toLocaleString("es-PE");

    updateChart(state.ch_over_estado, ["ACTIVO","RETIRO","CAMBIO"], [act, ret, cambiosUnique]);
    updateChart(state.ch_over_modalidad, ["PRESENCIAL","VIRTUAL"], [pres, virt]);

    // Retiros por ciclo (según filtros actuales)
    const byCicloRet = countBy(rows.filter(r=>r.estado==="RETIRO"), r=>r.ciclo).sort((a,b)=>cicloSort(a[0],b[0]));
    const labels = byCicloRet.map(x=>x[0]);
    const values = byCicloRet.map(x=>x[1]);
    updateChart(state.ch_over_retiros, labels, values);
  }

  function renderLocal(){
    ensureLocalLayout();

    const fLocal = document.getElementById("fLocal").value;

    // En "Por Local" lo normal es elegir un local
    let baseCanon = state.canonical;
    let baseCambios = state.cambiosRows;

    if (fLocal !== "__ALL__"){
      baseCanon = baseCanon.filter(r=>r.local===fLocal);
      baseCambios = baseCambios.filter(r=>r.local===fLocal);
    }

    // Aplicar también ciclo/salon/modalidad/estado/búsqueda sobre canonical en esta vista
    applyFilters();
    const rows = state.filtered;

    // ---- CAMBIOS por ciclo (EVENTOS)
    let cambiosFiltrados = baseCambios;
    const fCiclo = document.getElementById("fCiclo").value;
    const fSalon = document.getElementById("fSalon").value;
    const fMod = document.getElementById("fModalidad").value;

    if (fCiclo !== "__ALL__") cambiosFiltrados = cambiosFiltrados.filter(r=>r.ciclo===fCiclo);
    if (fSalon !== "__ALL__") cambiosFiltrados = cambiosFiltrados.filter(r=>r.salon===fSalon);
    if (fMod !== "__ALL__") cambiosFiltrados = cambiosFiltrados.filter(r=>r.modalidad===fMod);

    const ciclos = uniq(baseCanon.map(r=>r.ciclo)).sort(cicloSort);
    const cambiosByCiclo = ciclos.map(c=>{
      const names = uniq(cambiosFiltrados.filter(r=>r.ciclo===c).map(r=>low(r.nombre))).filter(Boolean);
      return names.length;
    });

    // ---- RETIROS por ciclo (CANONICAL)
    const retirosByCiclo = ciclos.map(c=> rows.filter(r=>r.ciclo===c && r.estado==="RETIRO").length );

    updateChart(state.ch_loc_cambios_ciclo, ciclos, cambiosByCiclo);
    updateChart(state.ch_loc_retiros_ciclo, ciclos, retirosByCiclo);

    // ---- Por salón (para monitoreo de tutores)
    const salones = uniq(baseCanon.map(r=>r.salon)).sort();

    const cambiosBySalon = salones.map(s=>{
      const names = uniq(cambiosFiltrados.filter(r=>r.salon===s).map(r=>low(r.nombre))).filter(Boolean);
      return names.length;
    });

    const retirosBySalon = salones.map(s=> rows.filter(r=>r.salon===s && r.estado==="RETIRO").length );

    updateChart(state.ch_loc_cambios_salon, salones, cambiosBySalon);
    updateChart(state.ch_loc_retiros_salon, salones, retirosBySalon);

    // ---- Tabla resumen ciclo
    const tbodyC = document.getElementById("loc_table_ciclo");
    tbodyC.innerHTML = ciclos.map(c=>{
      const rC = rows.filter(r=>r.ciclo===c);
      const total = rC.length;
      const act = rC.filter(r=>r.estado==="ACTIVO").length;
      const ret = rC.filter(r=>r.estado==="RETIRO").length;
      const pres = rC.filter(r=>r.modalidad==="PRESENCIAL").length;
      const virt = rC.filter(r=>r.modalidad==="VIRTUAL").length;

      const namesCambio = uniq(cambiosFiltrados.filter(r=>r.ciclo===c).map(r=>low(r.nombre))).filter(Boolean);
      const cam = namesCambio.length;

      return `
        <tr>
          <td>${escapeHtml(c)}</td>
          <td>${total}</td>
          <td>${act}</td>
          <td>${ret}</td>
          <td>${pres}</td>
          <td>${virt}</td>
          <td>${cam}</td>
        </tr>
      `;
    }).join("");

    // ---- Tabla resumen salón
    const tbodyS = document.getElementById("loc_table_salon");
    tbodyS.innerHTML = salones.map(s=>{
      const rS = rows.filter(r=>r.salon===s);
      const total = rS.length;
      const act = rS.filter(r=>r.estado==="ACTIVO").length;
      const ret = rS.filter(r=>r.estado==="RETIRO").length;
      const pres = rS.filter(r=>r.modalidad==="PRESENCIAL").length;
      const virt = rS.filter(r=>r.modalidad==="VIRTUAL").length;

      const any = rS[0];
      const k = any ? `${any.local}||${any.ciclo}||${any.salon}` : "";
      const isMixta = k && state.aulaMixtaKeys.has(k) ? "SÍ" : "NO";

      const namesCambio = uniq(cambiosFiltrados.filter(r=>r.salon===s).map(r=>low(r.nombre))).filter(Boolean);
      const cam = namesCambio.length;

      const ciclo = any ? any.ciclo : "";

      return `
        <tr>
          <td>${escapeHtml(s)}</td>
          <td>${escapeHtml(ciclo)}</td>
          <td>${total}</td>
          <td>${act}</td>
          <td>${ret}</td>
          <td>${pres}</td>
          <td>${virt}</td>
          <td>${isMixta}</td>
          <td>${cam}</td>
        </tr>
      `;
    }).join("");
  }

  function renderTable(){
    ensureTableLayout();

    const rows = state.filtered;
    const tbody = document.getElementById("tb_body");
    tbody.innerHTML = rows.slice(0,800).map(r=>`
      <tr>
        <td>${escapeHtml(r.nombre)}</td>
        <td>${escapeHtml(r.local)}</td>
        <td>${escapeHtml(r.ciclo)}</td>
        <td>${escapeHtml(r.salon)}</td>
        <td>${escapeHtml(r.modalidad)}</td>
        <td>${escapeHtml(r.estado)}</td>
      </tr>
    `).join("");
  }

  function render(){
    applyFilters();
    if (state.view==="overview") renderOverview();
    if (state.view==="local") renderLocal();
    if (state.view==="table") renderTable();
  }

  // ============================ DATA LOAD ============================
  async function loadOneSalon(salon){
    const url = csvUrl(salon.gid) + "&v=" + Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} (${salon.local} / ${salon.ciclo} / ${salon.salon})`);

    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);

    let headerIdx = -1;
    let header = null;

    for (let i=0;i<Math.min(lines.length, 200);i++){
      const cells = parseCSVLine(lines[i]).map(norm);
      const hasName = cells.includes(HEAD.NOMBRES_A) || cells.includes(HEAD.NOMBRES_B) || cells.includes(HEAD.NOMBRES_C);
      const hasEst = cells.includes(HEAD.ESTADO);
      if (hasName && hasEst){
        headerIdx = i; header = cells; break;
      }
    }

    if (headerIdx === -1){
      return { salon, rows: [], error: "No se encontró encabezado con NOMBRES y ESTADO." };
    }

    const idx = (name) => header.findIndex(h => norm(h) === name);
    const iNombreA = idx(HEAD.NOMBRES_A);
    const iNombreB = idx(HEAD.NOMBRES_B);
    const iNombreC = idx(HEAD.NOMBRES_C);
    const iNombre = (iNombreA>=0) ? iNombreA : (iNombreB>=0 ? iNombreB : iNombreC);

    const iMod = idx(HEAD.MODALIDAD);
    const iEst = idx(HEAD.ESTADO);

    const out = [];
    for (let i=headerIdx+1; i<lines.length; i++){
      const cells = parseCSVLine(lines[i]);
      if (!cells.some(v=>norm(v).length>0)) continue;

      const nombre = norm(cells[iNombre]);
      if (!nombre) continue;

      const modalidadCell = (iMod>=0) ? cells[iMod] : "";
      const modalidad = normalizeModalidad(modalidadCell, salon.local);

      const estado = normalizeEstado(cells[iEst]);

      out.push({
        nombre,
        modalidad,
        estado,
        local: salon.local,
        ciclo: salon.ciclo,
        salon: salon.salon,
        gid: salon.gid
      });
    }

    return { salon, rows: out, error: null };
  }

  async function loadAll(){
    try{
      document.getElementById("statusPill").textContent = "ACTUALIZANDO…";

      const results = await Promise.allSettled(SALONES.map(loadOneSalon));

      let rows = [];
      let warnings = [];

      for (const r of results){
        if (r.status==="fulfilled"){
          rows = rows.concat(r.value.rows);
          if (r.value.error) warnings.push(`${r.value.salon.local} · ${r.value.salon.ciclo} · ${r.value.salon.salon}: ${r.value.error}`);
        } else {
          warnings.push(String(r.reason || "Error desconocido"));
        }
      }

      state.rawRows = rows;

      // Aula mixta (por salón)
      state.aulaMixtaKeys = computeAulaMixta(state.rawRows);

      // Canonical (estado actual por nombre)
      state.canonical = dedupeByNameWithPriority(state.rawRows);

      // Cambios (eventos, no suman al total)
      state.cambiosRows = state.rawRows.filter(r=>r.estado==="CAMBIO");
      const cambiosNames = uniq(state.cambiosRows.map(r=>low(r.nombre))).filter(Boolean);
      state.cambiosUnique = cambiosNames;

      initFilters();
      render();

      document.getElementById("statusPill").textContent = warnings.length ? "OK · CON ALERTAS" : "OK · DATOS ACTUALIZADOS";
      document.getElementById("lastLoad").textContent = new Date().toLocaleString("es-PE");

      if (warnings.length) console.warn("WARNINGS:", warnings);

    } catch(e){
      console.error(e);
      document.getElementById("statusPill").textContent = "ERROR DE CARGA";
    }
  }

  // ============================ EVENTS ============================
  document.getElementById("nav_overview").addEventListener("click", ()=>setView("overview"));
  document.getElementById("nav_local").addEventListener("click", ()=>setView("local"));
  document.getElementById("nav_table").addEventListener("click", ()=>setView("table"));

  ["fLocal","fCiclo"].forEach(id=>{
    document.getElementById(id).addEventListener("change", ()=>{
      rebuildSalonOptions();
      render();
    });
  });

  ["fSalon","fModalidad","fEstado"].forEach(id=>{
    document.getElementById(id).addEventListener("change", render);
  });

  document.getElementById("q").addEventListener("input", render);

  document.getElementById("btnNow").addEventListener("click", loadAll);

  document.getElementById("autoOn").addEventListener("change", (e)=>{
    state.autoOn = !!e.target.checked;
  });

  // ============================ START ============================
  initFilters();
  loadAll();

  setInterval(()=>{
    if (state.autoOn) loadAll();
  }, AUTO_REFRESH_MS);
</script>
</body>
</html>
