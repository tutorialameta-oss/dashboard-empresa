<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <title>LA META | DASHBOARD</title>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <!-- PNG export (captura COMPLETA del elemento, no solo lo visible) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* ======================================================================
      ✅ EDITA COLORES AQUÍ (HORARIOS)
      - AGRARIA: NO TOCAR
      - PUCP: azul
      - U.LIMA: naranja
    ====================================================================== */
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,0.10);
      --accent:#d10b0b;
      --accent2:#a40000;
      --soft:#fff5f5;
      --shadow: 0 14px 34px rgba(15,23,42,0.10);
      --radius:18px;

      /* Universidades (marcadores) */
      --pucp:#6ea8da;     /* Azul */
      --ulima:#ff9900;    /* Naranja */
      --agraria:#4caf50;  /* Verde */

      /* Modalidad */
      --pres:#2bb673;
      --virt:#f2c94c;

      /* Estados */
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#f59e0b;

      /* ===== AGRARIA (NO TOCAR) ===== */
      --schHead_AGR:#1f5a1a;
      --schCell_AGR:#cfe8c8;

      /* ===== PUCP (AZUL) ===== */
      --schHead_PUCP:#1f4e79;
      --schCell_PUCP:#d6e9f7;

      /* ===== U.LIMA (NARANJA) ===== */
      --schHead_UL:#b85f00;
      --schCell_UL:#ffe6c7;
      --schHead_ESC:#d4a200;
      --schCell_ESC:#fff4cc;

      /* Líneas de tabla / col horas */
      --schGrid:rgba(15,23,42,0.28);
      --schTimeBg:#ffffff;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }
    .topbar{ height:10px; background:linear-gradient(90deg,var(--accent2),var(--accent)); }

    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height: calc(100vh - 10px);
    }

    .sidebar{
      border-right:1px solid var(--border);
      padding:18px 14px;
      position: sticky;
      top: 0;
      align-self: start;
      height: calc(100vh - 10px);
      overflow:auto;
      background:#fff;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      padding:12px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: #fff;
    }
    .brand img{
      width:64px; height:64px; object-fit:contain;
      border-radius:14px; border:1px solid var(--border);
      padding:8px; background:#fff;
    }
    .brand h1{
      margin:0;
      font-size:15px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.15;
      text-transform: uppercase;
    }
    .brand .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    .nav{ margin-top:16px; display:flex; flex-direction:column; gap:10px; }
    .nav button{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:950;
      color: var(--text);
    }
    .nav button.active{
      border-color: rgba(209,11,11,0.40);
      box-shadow: 0 0 0 3px rgba(209,11,11,0.10);
      background: var(--soft);
      color: var(--accent2);
    }

    .main{ padding:22px 22px 32px; }

    .headerline{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
    }

    .title{ display:flex; flex-direction:column; gap:8px; }
    .title h2{
      margin:0;
      font-size:20px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    .title p{
      margin:0;
      color: var(--muted);
      font-size:13px;
      font-weight:750;
      line-height:1.4;
      max-width: 980px;
    }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }

    select, input, button{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 14px;
      padding:11px 12px;
      font-size:12px;
      outline:none;
      color: var(--text);
    }
    input{ min-width:320px; }
    input::placeholder{ color:#94a3b8; }
    select:focus, input:focus{
      border-color: rgba(209,11,11,0.40);
      box-shadow: 0 0 0 3px rgba(209,11,11,0.10);
    }
    button{
      cursor:pointer;
      font-weight:950;
      border-color: rgba(209,11,11,0.25);
      background: var(--soft);
      color: var(--accent2);
    }
    button:hover{
      border-color: rgba(209,11,11,0.45);
      background: rgba(209,11,11,0.10);
    }


    /* Anchor/button helper (used for 'CARPETA' link) */
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background: var(--soft);
      border:1px solid rgba(209,11,11,0.25);
      border-radius: 14px;
      padding:11px 12px;
      font-size:12px;
      font-weight:950;
      color: var(--accent2);
      cursor:pointer;
      text-decoration:none;
      line-height:1;
    }
    .btn:hover{
      border-color: rgba(209,11,11,0.45);
      background: rgba(209,11,11,0.10);
    }
    .btn.folder{
      background:#fff;
      border-color: rgba(209,11,11,0.35);
    }
    .btn.disabled{
      pointer-events:none;
      opacity:.55;
    }

    /* SEM% “semáforo” */
    .semBadge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:6px 10px;
      min-width:78px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      border:1px solid var(--border);
      background:#fff;
      line-height:1;
    }
    .semDot{ width:10px; height:10px; border-radius:999px; }
    .semBadge.s0{ background: rgba(220,38,38,0.10); color:#b91c1c; border-color: rgba(220,38,38,0.25); }
    .semBadge.s0 .semDot{ background:#dc2626; }
    .semBadge.s33{ background: rgba(245,158,11,0.12); color:#b45309; border-color: rgba(245,158,11,0.30); }
    .semBadge.s33 .semDot{ background:#f59e0b; }
    .semBadge.s67{ background: rgba(34,197,94,0.12); color:#15803d; border-color: rgba(34,197,94,0.30); }
    .semBadge.s67 .semDot{ background:#22c55e; }
    .semBadge.s100{ background: rgba(22,163,74,0.14); color:#065f46; border-color: rgba(22,163,74,0.35); }
    .semBadge.s100 .semDot{ background:#16a34a; }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:18px;
      pointer-events:auto;
      pointer-events:auto;
      box-shadow: var(--shadow);
      min-width: 0;
    }

    .kpi{ grid-column: span 3; min-height: 118px; }
    .kpi .label{ color: var(--muted); font-size:12px; font-weight:950; text-transform: uppercase; }
    .kpi .value{ margin-top:8px; font-size:36px; font-weight:950; color: var(--accent2); }
    .kpi .hint{ margin-top:8px; color: var(--muted); font-size:12px; font-weight:900; text-transform: uppercase; }

    .panel12{ grid-column: span 12; }
    .panel8{ grid-column: span 8; }
    .panel4{ grid-column: span 4; }
    .panel6{ grid-column: span 6; }

    .cardtitle{
      color: var(--muted);
      font-size:12px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform: uppercase;
      margin-bottom:10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }

    .panelHint{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color: var(--muted); font-weight:900; font-size:12px; text-transform: uppercase;
    }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot.pucp{ background: var(--pucp); }
    .dot.ulima{ background: var(--ulima); }
    .dot.escolares{ background: var(--schHead_ESC); }
    .dot.agraria{ background: var(--agraria); }
    .dot.pres{ background: var(--pres); }
    .dot.virt{ background: var(--virt); }

    .chartBox{ height: 420px; }
    .chartBoxTall{ height: 520px; }
    canvas{ width:100% !important; height:100% !important; }

    .uniCards{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    .uniCard{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      display:flex; gap:10px; align-items:center;
      background:#fff;
    }
    .uniCard img{
      width:44px; height:44px; object-fit:contain;
      border-radius:12px; border:1px solid var(--border);
      padding:6px; background:#fff;
    }
    .uniCard .t{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .uniCard .name{
      font-weight:950; font-size:12px; text-transform:uppercase;
      color: var(--text);
    }
    .uniCard .nums{
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fafafa;
      font-weight:950;
      font-size:12px;
    }

    table{ width:100%; border-collapse: collapse; font-size:12px; }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
    }
    th{
      position:sticky;
      top:0;
      background:#fff;
      z-index:1;
      color: var(--muted);
      font-weight:950;
      text-transform: uppercase;
    }

    /* ===================== HORARIOS ===================== */
    .schGridWrap{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .schMatrixWrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 18px;
      background:#fff;

      /* Zoom por defecto (más “alejado” para ver más contenido) */
      --mxZoom: .85;
      box-shadow: var(--shadow);

      /* Más espacio visible para la matriz */
      max-height: calc(100vh - 230px);

      /* Evita “gutter” izquierdo (rendijas) */
      scrollbar-gutter: stable;
      overscroll-behavior: contain;

      /* Grid pegada a bordes */
      padding: 0;

      /* navegación tipo “mano” (drag-to-scroll) */
      cursor: grab;
    }
    .schMatrixWrap.dragging{
      cursor: grabbing;
    }

    .hFsBtn{
      border:1px solid rgba(15,23,42,0.18);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
    }
    .hMatrixHost{ position:relative; }
    .hMatrixTopBar{ display:none; }
    .hMatrixExit{ display:none; }
    .hMatrixFsBadge{ display:none; }
    .hMatrixHost.isFullscreen{
      position:fixed;
      inset:10px;
      z-index:10040;
      background:#fff;
      border-radius:16px;
      box-shadow:0 24px 70px rgba(2,6,23,.28);
      border:1px solid rgba(15,23,42,0.14);
      padding:12px;
      display:grid;
      grid-template-rows:auto minmax(0,1fr);
      gap:10px;
    }
    .hMatrixHost.isFullscreen .hMatrixTopBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:sticky;
      top:0;
      z-index:3;
      background:#fff;
      padding:2px 0;
    }
    .hMatrixHost.isFullscreen .hMatrixFsBadge{
      display:inline-flex;
      align-items:center;
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.14);
      background:#f8fafc;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      color:var(--muted);
    }
    .hMatrixHost.isFullscreen .hMatrixExit{
      display:inline-flex;
      position:sticky;
      top:0;
      z-index:4;
    }
    .hMatrixHost.isFullscreen .schMatrixWrap{
      max-height:calc(100vh - 88px);
      height:calc(100vh - 88px);
    }

    /* Horarios: filtros más compactos para ganar área de matriz */
    .horariosFiltersCard{ padding: 8px 10px; }
    .horariosFiltersCard .cardtitle{ margin-bottom:4px; font-size:12px; }
    .horariosFiltersCard .controls{ gap:6px; }
    .horariosFiltersCard select,
    .horariosFiltersCard button{ padding: 7px 9px; font-size:12px; }
    .schMatrix{
      display:grid;
      /* Columna de locales más angosta (porque el texto va vertical) */
      grid-template-columns: 72px repeat(6, minmax(520px, 1fr));
      min-width: calc(72px + 6*520px);
      background:#fff;
    }
    .mxCorner{
      position:sticky;
      top:0; left:0;
      z-index:6;
      background:#fff;
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
    }
    .mxHead{
      position:sticky;
      top:0;
      z-index:5;
      background:#fff;
      padding: 8px 6px;
      text-align:center;
      font-weight:950;
      color: var(--muted);
      text-transform: uppercase;
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      white-space:nowrap;
    }
    .mxRowHead{
      position:sticky;
      left:0;
      z-index:4;
      background:#fff;
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);

      /* Vertical para ahorrar espacio */
      writing-mode: vertical-rl;
      text-orientation: mixed;
      transform: rotate(180deg);

      font-weight:950;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing:.2px;

      display:grid;
      place-items:center;
      padding: 8px 0;
      white-space:nowrap;
    }
    .mxCell{
      padding: 6px;
      border-right:1px solid var(--border);
      border-bottom:1px solid var(--border);
      background:#fff;
    }

    /* En matriz: reducir tamaño de los horarios para ver más contenido */
    .schMatrixWrap .mxCell .schCard{
      zoom: var(--mxZoom, .85);
    }

    .mxCell .schCard{ margin-bottom: 10px; }
    .mxCell .schCard:last-child{ margin-bottom: 0; }
    .mxEmpty{
      color: var(--muted);
      font-weight: 900;
      padding: 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      text-align:center;
    }

    .schCard{
      border:1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow);
    }
    .schHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .schHead .hLeft{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .schHead .loc{
      font-size:18px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform:uppercase;
      margin:0;
      line-height:1.1;
    }
    .schHead .sal{
      font-size:13px;
      font-weight:900;
      color: var(--muted);
      text-transform:uppercase;
      margin:0;
      line-height:1.1;
    }
    .schUniPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:10px 14px;
      font-weight:950;
      text-transform:uppercase;
      border:1px solid rgba(15,23,42,0.12);
      background:#f8fafc;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .schUniPill .b{
      width:10px;height:10px;border-radius:999px;display:inline-block;
    }

    /* Botón descargar PNG */

    .hEditBtn{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(220,38,38,0.35);
      background:#fff;
      color:var(--accent);
      font-weight:900;
      letter-spacing:.02em;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(15,23,42,.06);
    }
    .hEditBtn:hover{ filter:brightness(0.98); }

    .hEditBtnGhost{
      padding:10px 14px;
      border-radius:999px;
      border:1px dashed rgba(220,38,38,0.35);
      background:#fff;
      color:var(--accent);
      font-weight:900;
      cursor:pointer;
    }
    .hEditBar{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(220,38,38,0.06);
      border:1px solid rgba(220,38,38,0.16);
      color:var(--muted);
      font-weight:800;
    }
    .hUniBadges{ margin-top:10px; }
    .hUniBadge{
      cursor:default;
      user-select:none;
    }

    .schEdit{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(220,38,38,0.35);
      background:#fff;
      color:var(--accent);
      font-weight:900;
      cursor:pointer;
    }

    .hCellEditOverlay{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,0.52);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10060;
      padding:16px;
    }
    .hCellEditModal{
      width:calc(100% - 32px);
      max-width:720px;
      max-height:calc(100vh - 32px);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(15,23,42,0.12);
      box-shadow:0 24px 72px rgba(2,6,23,.30);
      overflow:auto;
    }
    .hCellEditHead{
      padding:16px 18px 12px;
      border-bottom:1px solid rgba(15,23,42,0.10);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      position:sticky;
      top:0;
      background:#fff;
      z-index:1;
    }
    .hCellEditTitle{ font-size:18px; font-weight:1000; line-height:1.15; }
    .hCellEditSub{ font-size:12px; color:var(--muted); font-weight:800; margin-top:6px; }
    .hCellEditHead .hBtnTiny{ padding:8px 10px; border-radius:10px; font-size:14px; line-height:1; }
    .hCellEditBody{
      padding:14px 18px 16px;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
    }
    .hCellEditBody .full{ grid-column:1 / -1; }
    .hCellEditBody .hLbl{ margin-bottom:6px; }
    .hCellEditBody .hInp{
      border:1px solid rgba(15,23,42,0.18);
      border-radius:12px;
      padding:10px 12px;
      min-height:42px;
      background:#fff;
    }
    .hCellEditFoot{
      padding:12px 18px 14px;
      border-top:1px solid rgba(15,23,42,0.10);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      position:sticky;
      bottom:0;
      background:#fff;
    }
    @media(max-width:760px){
      .hCellEditBody{ grid-template-columns:1fr; }
    }
    .schCard.hEditEnabled .hCellEditable{ cursor:pointer; }
    .schCard.hEditEnabled .hCellEditable:hover{ outline:2px solid rgba(220,38,38,0.18); outline-offset:-2px; }
    .schCard[data-placeholder="1"] .schDl,
    .schCard[data-placeholder="1"] .schEdit{ display:none !important; }

    /* Modal editor */
    .hEditorOverlay{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 20000;
      pointer-events:auto;
      padding: 18px;
    }
    .hEditorModal{
      width:min(980px, 96vw);
      max-height: 92vh;
      overflow:auto;
      background:#fff;
      border-radius:18px;
      box-shadow: 0 30px 90px rgba(2,6,23,.30);
      border:1px solid rgba(15,23,42,0.12);
    }
    .hEditorHead{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid rgba(15,23,42,0.10);
      position:sticky;
      top:0;
      background:#fff;
      z-index:1;
    }
    .hEditorTitle{ font-weight:1000; letter-spacing:.02em; }
    .hEditorSub{ color:var(--muted); font-weight:800; font-size:12px; margin-top:4px; }
    .hEditorClose{
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:1000;
    }
    .hEditorBody{ padding: 16px 18px; }
    .hEditorGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
      margin-bottom:14px;
    }
    @media(max-width:900px){
      .hEditorGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .hLbl{ display:block; font-weight:900; color:var(--muted); font-size:11px; margin-bottom:6px; letter-spacing:.04em; }
    .hInp{
      width:100%;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      outline:none;
    }
    .hInpSm{
      width:100%;
      border:1px solid rgba(15,23,42,0.14);
      border-radius:10px;
      padding:8px 10px;
      font-weight:900;
      outline:none;
    }
    .hEditorBlocksHead{
      display:flex; justify-content:space-between; align-items:center;
      margin: 4px 0 10px 0;
    }
    .hEditorBlocksTitle{ font-weight:1000; letter-spacing:.02em; }
    .hEditorBlocksWrap{
      border:1px solid rgba(15,23,42,0.10);
      border-radius:14px;
      overflow:auto;
    }
    .hEditorTable{
      width:100%;
      border-collapse:collapse;
      min-width: 860px;
    }
    .hEditorTable th, .hEditorTable td{
      border-bottom:1px solid rgba(15,23,42,0.08);
      padding:10px;
      text-align:left;
      vertical-align:middle;
      font-weight:900;
    }
    .hEditorTable th{
      background:rgba(15,23,42,0.03);
      color:var(--muted);
      font-size:11px;
      letter-spacing:.04em;
    }
    .hEditorHint{
      margin-top:10px;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
    }
    .hEditorFoot{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding: 14px 18px;
      border-top:1px solid rgba(15,23,42,0.10);
      position:sticky;
      bottom:0;
      background:#fff;
    }
    .hBtn{
      border-radius:999px;
      border:1px solid rgba(15,23,42,0.14);
      background:#fff;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
    }
    .hBtnTiny{ padding:6px 10px; border-radius:10px; }
    .hBtnGhost{ background:rgba(220,38,38,0.06); border:1px solid rgba(220,38,38,0.16); color:var(--accent); }
    .hBtnPrimary{ background:var(--accent); border:1px solid var(--accent); color:#fff; }
    .hBtnDanger{ background:rgba(220,38,38,0.10); border:1px solid rgba(220,38,38,0.22); color:var(--accent); }
.schDl{
      border: 1px solid rgba(15,23,42,0.12);
      background: #fff;
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 950;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .schDl:hover{
      border-color: rgba(15,23,42,0.28);
      background:#fafafa;
    }

    /* Contenedor tabla */
    .schTableWrap{
      padding:0 10px 12px;
      overflow-x: hidden; /* desktop */
    }

    /* Tabla */
    .schTable{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:2px solid rgba(15,23,42,0.18);
      border-radius: 14px;
      overflow:hidden;
      min-width: 0;
    }

    .schTable th, .schTable td{
      border:1px solid var(--schGrid);
      padding: 2px 6px;
      text-align:center;
      vertical-align:middle;
      white-space:normal;
      word-break: normal;
      overflow-wrap: normal;
    }

    /* Encabezado días (usa variables por UNI) */
    .schTable thead th{
      background: var(--schHead);
      color:#fff;
      font-weight:950;
      text-transform:uppercase;
      font-size:11px;
      position:static;
    }
    .schTable .timeHead{
      background: var(--schHead);
      color:#fff;
      font-weight:950;
      font-size:12px;
    }

    .schTable .timeCell{
      background: var(--schTimeBg);
      font-weight:950;
      font-size:12px;
      text-align:left;
      padding-left:10px;
      white-space:nowrap;
    }

    .schCell{
      background: var(--schCell);
      font-weight:950;
      padding: 6px 6px;
    }
    .schEmpty{ background:#fff; }

    .schTable col.timeCol{ width: 92px; }

    /* ===================== CELDA 4 LÍNEAS: ORDENADA + PROFESOR SIN NEGRITA ===================== */
    .cell4{
      width:100%;
      height:100%;
      display:grid;
      grid-template-rows: repeat(4, auto);
      place-content:center;
      row-gap: 2px;
      align-items:center;
      justify-items:center;
    }
    .cell4 .slot{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:0 2px;
      line-height:1.05;
    }
    /* Cursos (arriba) */
    .cell4 .cLine{
      font-size:18px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform:uppercase;
      white-space:nowrap; /* evita “ÁLG 1” partido */
      line-height:1.05;
    }
    /* Profesor (abajo): SIN negrita y ligeramente menor */
    .cell4 .tLine{
      font-size:11px;
      font-weight:500;
      text-transform:uppercase;
      color:#111827;
      white-space:nowrap;
      line-height:1.05;
    }

    /* ===================== COLORES POR UNIVERSIDAD (HORARIOS) ===================== */
    .schCard[data-uni="AGRARIA"]{
      --schHead: var(--schHead_AGR);
      --schCell: var(--schCell_AGR);
    }
    .schCard[data-uni="PUCP"]{
      --schHead: var(--schHead_PUCP);
      --schCell: var(--schCell_PUCP);
    }
    .schCard[data-uni="U.LIMA"]{
      --schHead: var(--schHead_UL);
      --schCell: var(--schCell_UL);
    }
    .schCard[data-uni="ESCOLARES"],
    .schCard[data-cycle="ESCOLARES"]{
      --schHead: var(--schHead_ESC);
      --schCell: var(--schCell_ESC);
    }

    /* ===================== MODO EXPORT PNG (FORMATO HORIZONTAL) ===================== */
    body.exportMode .schCard{
      width: 700px !important;
      max-width: none !important;
    }
    body.exportMode .schTableWrap{
      overflow: visible !important;
      padding: 0 12px 12px !important;
    }
    body.exportMode .schTable{
      width: 100% !important;
      min-width: 0 !important;
    }
    body.exportMode .cell4 .cLine{ font-size:18px !important; }
    body.exportMode .cell4 .tLine{ font-size:11px !important; font-weight:500 !important; }
    body.exportMode .schTable thead th{ font-size:11px !important; }
    body.exportMode .schTable .timeCell{ font-size:12px !important; }

    /* ===================== IMPRESIONES ===================== */
    .iGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    .iItem{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .iItem.disabled{
      opacity: .55;
      filter: grayscale(1);
      cursor: not-allowed;
      user-select:none;
    }

    .iLeft{ min-width:0; }
    .iSalon{
      font-weight:950;
      text-transform:uppercase;
      font-size:12px;
      line-height:1.1;
    }
    .iMeta{
      margin-top:6px;
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      text-transform:uppercase;
    }
    .iNum{
      font-weight:950;
      font-size:28px;
      line-height:1;
      flex:0 0 auto;
    }
    .iLocalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .iKpis{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .iKpiPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fafafa;
      font-weight:950;
      font-size:12px;
      text-transform:uppercase;
    }

    /* ===================== SÍLABOS (NUEVO) ===================== */
    .syWrap{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    .syItem{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      text-decoration:none;
      color: var(--text);
      transition: transform .06s ease, box-shadow .06s ease, border-color .06s ease;
    }
    .syItem:hover{
      transform: translateY(-1px);
      border-color: rgba(15,23,42,0.18);
      box-shadow: 0 16px 40px rgba(15,23,42,0.12);
    }
    .syLeft{ min-width:0; display:flex; flex-direction:column; gap:6px; }
    .syCourse{
      font-weight:950;
      text-transform:uppercase;
      font-size:12px;
      line-height:1.15;
      letter-spacing:.2px;
    }
    .syMeta{
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-weight:900;
      font-size:12px;
      text-transform:uppercase;
      flex-wrap:wrap;
    }
    .syOpen{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,0.12);
      background:#f8fafc;
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
      color: var(--accent2);
    }
    .syOpen:hover{
      border-color: rgba(209,11,11,0.35);
      background: rgba(209,11,11,0.08);
    }

    .syBtns{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .syBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:8px 12px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,0.12);
      background:#f8fafc;
      font-weight:950;
      font-size:12px;
      white-space:nowrap;
      color: var(--accent2);
      text-decoration:none;
      cursor:pointer;
    }
    .syBtn:hover{
      border-color: rgba(209,11,11,0.35);
      background: rgba(209,11,11,0.06);
    }
    .syBtn.disabled{
      opacity:.65;
      pointer-events:none;
      cursor:default;
    }
    .syLocalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .syKpis{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .syKpiPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fafafa;
      font-weight:950;
      font-size:12px;
      text-transform:uppercase;
    }

    /* ===================== RESPONSIVE ===================== */
    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .kpi{ grid-column: span 6; }
      .panel8, .panel6, .panel4{ grid-column: span 12; }
      .chartBox{ height: 360px; }
      .chartBoxTall{ height: 440px; }
      input{ min-width: 220px; }
      .controls{ justify-content:flex-start; }
      .uniCards{ grid-template-columns: 1fr; }
      .schGridWrap{ grid-template-columns: 1fr; }

      /* MÓVIL: más compacto + scroll horizontal */
      .schTableWrap{
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 0 8px 10px;
      }
      .schHead{ padding: 10px 10px 8px; }
      .schHead .loc{ font-size:16px; }
      .schHead .sal{ font-size:12px; }
      .schUniPill{ padding:8px 10px; font-size:12px; }
      .schDl{ padding:7px 9px; font-size:11px; }

      .schTable{ min-width: 820px; }
      .schTable th, .schTable td{ padding: 4px 4px; }
      .schTable thead th{ font-size:10px; }
      .schTable .timeCell{ font-size:11px; padding-left:8px; }
      .schTable col.timeCol{ width: 84px; }

      .cell4{ row-gap: 2px; }
      .cell4 .cLine{ font-size:16px; }
      .cell4 .tLine{ font-size:10px; font-weight:500; }

      /* IMPRESIONES */
      .iGrid{ grid-template-columns: 1fr; }
      .iNum{ font-size:26px; }

      /* SÍLABOS */
      .syWrap{ grid-template-columns: 1fr; }
    }


    /* ===================== AUTH (ADMIN / TUTOR) ===================== */
    .authOverlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
      background: rgba(15,23,42,0.55);
      backdrop-filter: blur(6px);
      z-index: 20000;
      pointer-events:auto;
    }
    .authCard{
      width:min(520px, 96vw);
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      pointer-events:auto;
    }
    .authTitle{ font-weight:950; font-size:16px; margin:0 0 8px 0; text-transform:uppercase; }
    .authSub{ color:var(--muted); font-weight:800; margin:0 0 14px 0; font-size:12px; }
    .roleRow{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .roleBtn{
      flex:1;
      min-width: 160px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:950;
      cursor:pointer;
    }
    .roleBtn.active{ border-color: var(--accent); box-shadow: 0 0 0 3px rgba(209,11,11,0.15); }
    .authRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .authRow input{
      flex:1;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      font-weight:850;
      outline:none;
    }
    .authRow button{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: linear-gradient(90deg,var(--accent2),var(--accent));
      color:#fff;
      font-weight:950;
      cursor:pointer;
    }
    .authErr{ margin-top:10px; color: var(--bad); font-weight:900; font-size:12px; display:none; }

    .userBox{
      margin-top:14px;
      padding:12px;
      border:1px dashed var(--border);
      border-radius: var(--radius);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .userRole{ font-weight:950; font-size:12px; color: var(--muted); text-transform:uppercase; }
    .logoutBtn{
      width:100%;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:950;
      cursor:pointer;
    }


    /* ======================================================================
       ✅ MODO ALUMNO: Más profesional y dinámico (solo visual)
    ====================================================================== */
    body.role-alumno{
      background: radial-gradient(1200px 600px at 15% 0%, rgba(209,11,11,0.10), transparent 55%),
                  radial-gradient(900px 500px at 85% 10%, rgba(164,0,0,0.10), transparent 55%),
                  var(--bg);
    }
    body.role-alumno .app{
      background: transparent;
    }
    body.role-alumno .sidebar{
      border-right: 1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(8px);
    }
    body.role-alumno .brand{
      box-shadow: none;
      border: 1px solid rgba(15,23,42,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,245,245,0.85));
    }
    .alHero{
      grid-column: span 12;
      border-radius: 22px;
      border: 1px solid rgba(15,23,42,0.08);
      background: linear-gradient(135deg, rgba(209,11,11,0.10), rgba(164,0,0,0.06), rgba(255,255,255,0.85));
      box-shadow: 0 22px 55px rgba(15,23,42,0.08);
      overflow: hidden;
    }
    .alHeroInner{
      padding: 22px;
      display: grid;
      grid-template-columns: 1.4fr 0.9fr;
      gap: 18px;
      align-items: stretch;
    }
    .alHeroKicker{
      font-weight: 1000;
      letter-spacing: 0.12em;
      color: rgba(15,23,42,0.55);
      font-size: 12px;
    }
    .alHeroTitle{
      margin-top: 6px;
      font-size: 34px;
      font-weight: 1100;
      line-height: 1.06;
      color: var(--text);
    }
    .alHeroSub{
      margin-top: 10px;
      color: rgba(15,23,42,0.65);
      font-weight: 900;
      max-width: 58ch;
    }
    .alHeroActions{
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .alBtn{
      border: 1px solid rgba(15,23,42,0.10);
      background: #ffffff;
      padding: 10px 14px;
      border-radius: 14px;
      font-weight: 1000;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .alBtn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15,23,42,0.10);
    }
    .alBtnPrimary{
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color: #fff;
      border-color: rgba(0,0,0,0.0);
    }
    .alBtnGhost{
      background: rgba(255,255,255,0.75);
    }
    .alBtnSoft{
      background: rgba(209,11,11,0.08);
      border-color: rgba(209,11,11,0.18);
      color: var(--accent2);
    }
    .alHeroRight{
      display: grid;
      gap: 12px;
    }
    .alStat{
      background: rgba(255,255,255,0.80);
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 18px;
      padding: 14px 14px;
      box-shadow: 0 16px 30px rgba(15,23,42,0.06);
    }
    .alStatLabel{
      color: rgba(15,23,42,0.55);
      font-weight: 1000;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .alStatValue{
      margin-top: 6px;
      font-size: 18px;
      font-weight: 1100;
      color: var(--text);
    }
    .alStatMeta{
      margin-top: 4px;
      color: rgba(15,23,42,0.65);
      font-weight: 900;
      font-size: 13px;
    }

    .alSection{
      border: 1px solid rgba(15,23,42,0.08);
      box-shadow: 0 18px 44px rgba(15,23,42,0.08);
      border-radius: 20px;
    }
    .alSectionHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    .alSectionTitle{
      font-weight: 1100;
      font-size: 16px;
      letter-spacing: 0.06em;
      color: rgba(15,23,42,0.75);
    }
    .alSectionSub{
      margin-top: 6px;
      color: rgba(15,23,42,0.60);
      font-weight: 900;
      max-width: 90ch;
    }
    .alProfileWrap{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 14px;
    }
    .alProfileCard{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      border: 1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.90);
      border-radius: 18px;
      padding: 14px;
    }
    .alAvatar{
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(209,11,11,0.18), rgba(164,0,0,0.10));
      border: 1px solid rgba(209,11,11,0.20);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1200;
      color: var(--accent2);
      font-size: 18px;
      flex: 0 0 auto;
    }
    .alName{
      font-size: 18px;
      font-weight: 1200;
      color: var(--text);
    }
    .alMetaRow{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .alPill{
      display:inline-flex;
      gap: 6px;
      align-items:center;
      background: rgba(15,23,42,0.04);
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 999px;
      padding: 6px 10px;
      font-weight: 950;
      color: rgba(15,23,42,0.72);
      font-size: 12px;
    }
    .alInfoGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .alInfoCard{
      border: 1px solid rgba(15,23,42,0.08);
      background: rgba(255,255,255,0.90);
      border-radius: 18px;
      padding: 14px;
    }
    .alInfoTitle{
      font-weight: 1100;
      color: rgba(15,23,42,0.75);
      letter-spacing: 0.06em;
      margin-bottom: 10px;
      font-size: 13px;
    }
    .alInfoLine{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      padding: 6px 0;
      border-top: 1px dashed rgba(15,23,42,0.10);
    }
    .alInfoLine:first-of-type{
      border-top: none;
      padding-top: 0;
    }
    .alInfoLine span{
      color: rgba(15,23,42,0.55);
      font-weight: 950;
    }
    .alInfoLine b{
      color: rgba(15,23,42,0.80);
      font-weight: 1100;
      text-align:right;
    }

    .alChip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.85);
      font-weight: 1100;
    }
    .alChip.ok{
      border-color: rgba(22,163,74,0.30);
      background: rgba(22,163,74,0.10);
      color: rgba(22,163,74,0.95);
    }
    .alChip.warn{
      border-color: rgba(245,158,11,0.30);
      background: rgba(245,158,11,0.12);
      color: rgba(146,64,14,0.95);
    }
    .alChip.soft{
      border-color: rgba(209,11,11,0.16);
      background: rgba(209,11,11,0.08);
      color: var(--accent2);
    }

    .alScheduleShell .schCard{
      margin-top: 10px;
      box-shadow: none;
      border: 1px solid rgba(15,23,42,0.08);
    }
    .alScheduleShell .schHead{ display:none; }
    .alScheduleTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 18px;
      background: rgba(255,255,255,0.86);
    }
    .alScheduleTitle{
      font-weight: 1200;
      color: var(--text);
    }
    .alScheduleSub{
      color: rgba(15,23,42,0.60);
      font-weight: 950;
      margin-top: 4px;
      font-size: 12px;
    }
    .schTable thead th.isToday{
      outline: 2px solid rgba(209,11,11,0.28);
      outline-offset: -2px;
      border-radius: 8px;
    }
    .schTable td.isTodayCol{
      background: rgba(209,11,11,0.06);
    }

    .alSilaboTools{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .alSilaboTools input{
      flex: 1 1 320px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,0.10);
      font-weight: 950;
      outline: none;
      background: rgba(255,255,255,0.92);
    }
    .alSilaboPill{
      display:inline-flex;
      gap: 8px;
      align-items:center;
      border-radius: 999px;
      padding: 10px 12px;
      border: 1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.92);
      font-weight: 1100;
    }
    .alSyItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 14px;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 16px;
      background: rgba(255,255,255,0.88);
      text-decoration: none;
      color: inherit;
      margin-bottom: 10px;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .alSyItem:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 34px rgba(15,23,42,0.10);
    }
    .alSyCourse{
      font-weight: 1100;
      color: var(--text);
    }
    .alSyMeta{
      margin-top: 6px;
      display:flex;
      gap: 8px;
      align-items:center;
      color: rgba(15,23,42,0.62);
      font-weight: 950;
      font-size: 12px;
    }
    .alSyOpen{
      font-weight: 1100;
      color: var(--accent2);
      background: rgba(209,11,11,0.08);
      border: 1px solid rgba(209,11,11,0.18);
      border-radius: 999px;
      padding: 8px 12px;
      white-space: nowrap;
    }

    .alEmpty{
      border: 1px dashed rgba(15,23,42,0.20);
      background: rgba(255,255,255,0.80);
      border-radius: 18px;
      padding: 18px;
    }
    .alEmptyTitle{
      font-weight: 1200;
      color: var(--text);
    }
    .alEmptyText{
      margin-top: 8px;
      color: rgba(15,23,42,0.62);
      font-weight: 950;
    }
    .alFootNote{
      color: rgba(15,23,42,0.60);
      font-weight: 950;
      padding: 0 6px;
    }

    @media (max-width: 980px){
      .alHeroInner{ grid-template-columns: 1fr; }
      .alProfileWrap{ grid-template-columns: 1fr; }
    }


  /* ===== Alumno: Inicio minimalista + Perfil profesional ===== */
  .alHeroNote{
    margin-top:14px;
    display:flex;
    align-items:center;
    gap:10px;
    color: var(--muted);
    font-weight:900;
    letter-spacing:.1px;
  }
  .alHeroNote .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }

  .alProGrid{
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap:18px;
  }
  @media (max-width: 980px){
    .alProGrid{ grid-template-columns: 1fr; }
  }
  .alProCol{ display:flex; flex-direction:column; gap:18px; }

  .alProCard{
    border: 1px solid rgba(0,0,0,.06);
    border-radius: 20px;
    background: #fff;
    padding: 18px;
    box-shadow: 0 12px 30px rgba(0,0,0,.04);
  }
  .alProHead{
    display:flex;
    gap:14px;
    align-items:center;
    margin-bottom: 14px;
  }
  .alAvatarBig{
    width:52px;
    height:52px;
    border-radius: 16px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:1000;
    background: rgba(177,15,46,.10);
    border: 1px solid rgba(177,15,46,.25);
    color: var(--brand);
    flex: 0 0 auto;
  }
  .alNameBig{
    font-weight: 1100;
    letter-spacing: .2px;
    font-size: 18px;
    line-height: 1.2;
  }
  .alSmall{
    margin-top: 8px;
    display:flex;
    flex-wrap: wrap;
    gap:8px;
  }
  .alTag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 7px 10px;
    border-radius: 999px;
    background: rgba(0,0,0,.03);
    border: 1px solid rgba(0,0,0,.06);
    color: #243047;
    font-weight: 900;
    font-size: 12px;
    white-space: nowrap;
  }
  .alKVGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px 14px;
    margin-top: 6px;
  }
  @media (max-width: 520px){
    .alKVGrid{ grid-template-columns: 1fr; }
  }
  .alKV{
    padding: 10px 12px;
    border-radius: 16px;
    background: rgba(0,0,0,.02);
    border: 1px solid rgba(0,0,0,.05);
    display:flex;
    justify-content: space-between;
    gap: 10px;
  }
  .alKV span{
    color: var(--muted);
    font-weight: 900;
    white-space: nowrap;
  }
  .alKV b{
    color: #0b1020;
    font-weight: 1100;
    text-align:right;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .alProTitle{
    font-weight: 1100;
    letter-spacing:.18px;
    margin-bottom: 10px;
  }
  .alKVList{ display:flex; flex-direction:column; gap:10px; }
  .alKVLine{
    display:flex;
    justify-content: space-between;
    gap: 12px;
    padding-bottom: 10px;
    border-bottom: 1px dashed rgba(0,0,0,.10);
  }
  .alKVLine:last-child{ border-bottom:none; padding-bottom:0; }
  .alKVLine span{ color: var(--muted); font-weight: 900; }
  .alKVLine b{ color:#0b1020; font-weight:1100; text-align:right; }

  .alEmptyMini{
    color: var(--muted);
    font-weight: 900;
    padding: 10px 12px;
    background: rgba(0,0,0,.02);
    border: 1px solid rgba(0,0,0,.06);
    border-radius: 16px;
  }


  /* ===================== EVALUACIONES ===================== */
  .evTopRow{ display:grid; grid-template-columns: 1fr 1.4fr; gap:14px; margin-top:12px; }
  .evBox{ border:1px solid rgba(0,0,0,.06); border-radius: 16px; padding:12px; background:#fff; }
  .evLabel{ color:var(--muted); font-weight:950; font-size:12px; text-transform:uppercase; margin-bottom:10px; }
  .evCourses{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
  .evCourseBtn{ border:1px solid rgba(0,0,0,.10); border-radius: 16px; padding:10px; text-align:left; background:#fff; cursor:pointer; }
  .evCourseBtn.on{ border-color: rgba(209,11,11,0.45); box-shadow: 0 0 0 3px rgba(209,11,11,0.10); background: var(--soft); }
  .evCourseCode{ font-weight:1100; color: var(--accent2); font-size:12px; text-transform:uppercase; }
  .evCourseName{ font-weight:950; font-size:12px; margin-top:4px; text-transform:uppercase; }

  .evList{ display:flex; flex-direction:column; gap:10px; }
  .evItem{ border:1px solid rgba(0,0,0,.10); border-radius: 16px; padding:10px 12px; background:#fff; cursor:pointer; text-align:left; }
  .evItem.on{ border-color: rgba(209,11,11,0.45); box-shadow: 0 0 0 3px rgba(209,11,11,0.10); background: var(--soft); }
  .evItemTop{ display:flex; flex-direction:column; gap:4px; }
  .evItemTitle{ font-weight:1100; font-size:13px; text-transform:uppercase; }
  .evItemMeta{ color:var(--muted); font-weight:900; font-size:12px; text-transform:uppercase; }
  .evItemId{ margin-top:8px; color:#334155; font-weight:900; font-size:12px; }

  .evMuted{ color:var(--muted); font-weight:900; }
  .evError{ color: var(--bad); font-weight:950; margin-top:8px; }

  .evWorkHead{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; margin-bottom:12px; }
  .evWorkTema{ font-weight:1100; font-size:14px; text-transform:uppercase; }
  .evWorkMeta{ color:var(--muted); font-weight:900; font-size:12px; text-transform:uppercase; margin-top:6px; }
  .evEx{ border:1px dashed rgba(0,0,0,.14); border-radius: 16px; padding:12px; background: rgba(0,0,0,.02); margin-bottom:12px; }
  .evLink{ display:inline-flex; align-items:center; gap:8px; text-decoration:none; font-weight:1100; color: var(--accent2); border:1px solid rgba(209,11,11,0.25); background: var(--soft); padding:10px 12px; border-radius: 14px; }
    .evPdf{ width:100%; height:520px; border:1px solid var(--border); border-radius:14px; margin-top:10px; background:#fff; display:none; }
  .evPdf.on{ display:block; }

  .evLink:hover{ border-color: rgba(209,11,11,0.45); background: rgba(209,11,11,0.10); }
  /* --- UX PRO (progreso, navegación, sticky) --- */
  .evProgressWrap{ border:1px solid rgba(0,0,0,.08); border-radius: 18px; padding:12px; background:#fff; margin: 12px 0; }
  .evProgressTop{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
  .evProgressLabel{ font-weight:1100; text-transform:uppercase; font-size:12px; color:#0f172a; }
  .evAutosave{ font-weight:950; font-size:12px; color:var(--muted); text-transform:uppercase; }
  .evProgress{ width:100%; height:10px; background: rgba(0,0,0,.06); border-radius: 999px; overflow:hidden; }
  .evProgressFill{ height:100%; width:0%; background: linear-gradient(90deg, rgba(209,11,11,.95), rgba(250, 94, 94, .95)); border-radius: 999px; transition: width .25s ease; }

  .evNav{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .evNavBtn{ width:36px; height:36px; border-radius: 14px; border:1px solid rgba(0,0,0,.10); background:#fff; cursor:pointer;
             font-weight:1100; }
  .evNavBtn.done{ border-color: rgba(16,185,129,.50); box-shadow: 0 0 0 3px rgba(16,185,129,.12); }
  .evNavBtn:hover{ border-color: rgba(209,11,11,.35); box-shadow: 0 0 0 3px rgba(209,11,11,.10); }

  .evStickyBar{ position: sticky; bottom: 12px; display:flex; align-items:center; justify-content:space-between; gap:12px;
                border:1px solid rgba(0,0,0,.10); border-radius: 18px; padding:12px; background: rgba(255,255,255,.92);
                backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(2,6,23,.08); }
  .evStickyBar .alBtn{ min-width: 210px; }

  .evExRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .evLinkLite{ border-style: solid; background: #fff; }

  @media (max-width: 760px){
    .evPdf{ display:none; height: 380px; }
    .evPdf.on{ display:block; }
    .evStickyBar{ position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 40; }
    .evForm{ padding-bottom: 92px; }
  }


  .evForm{ display:flex; flex-direction:column; gap:12px; margin-top:10px; }
  .evQRow{ border:1px solid rgba(0,0,0,.08); border-radius: 16px; padding:12px; background:#fff; }
  .evQName{ font-weight:1100; text-transform:uppercase; font-size:12px; margin-bottom:10px; color: var(--muted); display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .evQNameSub{ font-weight:900; font-size:11px; color: var(--muted); text-transform:none; }
  .evOpts{ display:flex; gap:10px; flex-wrap:wrap; }
  .evOpt{ display:inline-flex; gap:8px; align-items:center; border:1px solid rgba(0,0,0,.10); border-radius: 999px; padding:8px 10px; font-weight:950; font-size:12px; background:#fafafa; cursor:pointer; user-select:none; }
  .evOpt input{ margin:0; }

  .evSubmitRow{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:8px; }
  .evResultCard{ border-top:1px dashed rgba(0,0,0,.14); margin-top:14px; padding-top:14px; }
  .evScore{ font-weight:1100; font-size:16px; text-transform:uppercase; }
  .evKeyLine{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .evResGrid{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
  .evResRow{ border:1px solid rgba(0,0,0,.08); border-radius: 16px; padding:10px 12px; display:grid; grid-template-columns: 90px 110px 1fr 1fr; gap:10px; align-items:center; background:#fff; }
  .evResQ{ font-weight:1100; text-transform:uppercase; font-size:12px; color: var(--muted); }
  .evResK, .evResD{ font-weight:900; font-size:12px; color:#334155; text-transform:uppercase; }
  .evResA{ font-weight:900; }
  @media (max-width: 980px){
    .evTopRow{ grid-template-columns: 1fr; }
    .evCourses{ grid-template-columns: repeat(2, 1fr); }
    .evResRow{ grid-template-columns: 1fr; }
  }



    /* ===================== PROGRAMA (GANTT) ===================== */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%) translateY(10px);
      background:#0f172a;
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      box-shadow:0 16px 38px rgba(15,23,42,0.25);
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      z-index:9999;
      font-weight:800;
      max-width:min(92vw, 860px);
      text-align:center;
      letter-spacing:.01em;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    .pgTop{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:12px; }
    .pgHint{ margin-top:10px; font-size:12px; color:var(--muted); font-weight:700; }
    .pgSmall{ font-size:12px; color:var(--muted); font-weight:700; }
    .miniRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pgColor{ width:54px; height:34px; padding:2px; border-radius:10px; border:1px solid var(--border); background:#fff; }

    details.pgAdv summary{ cursor:pointer; font-weight:900; }
    .pgAdvBox{ margin-top:10px; border:1px dashed rgba(15,23,42,0.25); border-radius:14px; padding:12px; background:#fafafa; }

    .pgLegend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .pgCard{ padding:12px; border:1px solid var(--border); border-radius:16px; background:var(--card); }
    .pgScroller{ overflow:auto; max-width:100%; cursor:grab; }
    .pgScroller.dragging{ cursor:grabbing; }
    .pgCanvas{ min-width:max-content; padding:12px; }

    .pgGrid{
      display:grid;
      gap:0;
      border:1px solid rgba(15,23,42,0.18);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
      width:max-content;
    }
    .pgLabelCell{
      position:sticky;
      left:0;
      z-index:5;
      background:#f8fafc;
      border-right:1px solid rgba(15,23,42,0.15);
      padding:8px 10px;
      font-weight:1000;
      text-transform:uppercase;
      letter-spacing:.02em;
    }
    .pgMonthHead{ background:#0f172a; color:#fff; }
    .pgDateHead{ background:#f1f5f9; color:#0f172a; }

    .pgMonthCell{
      background:#0f172a;
      color:#fff;
      text-align:center;
      padding:8px 6px;
      font-weight:1000;
      letter-spacing:.02em;
      border-right:1px solid rgba(255,255,255,0.22);
    }
    .pgDateCell{
      background:#f1f5f9;
      text-align:center;
      padding:6px 4px;
      font-weight:900;
      border-right:1px solid rgba(15,23,42,0.12);
      border-top:1px solid rgba(15,23,42,0.12);
      white-space:nowrap;
    }
    .pgWeekCell{
      text-align:center;
      padding:6px 4px;
      font-weight:1000;
      border-right:1px solid rgba(15,23,42,0.12);
      border-top:1px solid rgba(15,23,42,0.12);
    }
    .pgCell{
      text-align:center;
      padding:6px 4px;
      font-weight:1000;
      border-right:1px solid rgba(15,23,42,0.12);
      border-top:1px solid rgba(15,23,42,0.12);
      white-space:nowrap;
    }
    .pgMergeCell{
      text-align:center;
      padding:6px 4px;
      font-weight:1000;
      border-right:1px solid rgba(15,23,42,0.12);
      border-top:1px solid rgba(15,23,42,0.12);
    }
    .pgEvt{
      padding:6px 4px;
      border-right:1px solid rgba(15,23,42,0.12);
      border-top:1px solid rgba(15,23,42,0.12);
      font-size:11px;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:72px;
    }

    .pNiv{ background:rgba(107,191,89,0.22); }
    .pAv { background:rgba(91,141,239,0.22); }
    .pRep{ background:rgba(246,162,39,0.22); }

    .niv{ background:rgba(107,191,89,0.14); }
    .av { background:rgba(91,141,239,0.14); }
    .rep{ background:rgba(246,162,39,0.14); }

    .pgAllWrap{ display:flex; flex-direction:column; gap:14px; }
    .pgAllBlock{ border:1px solid var(--border); border-radius:16px; background:#fff; padding:10px; }
    .pgAllHeader{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px; }
    .pgAllTitle{ font-weight:1000; letter-spacing:.02em; text-transform:uppercase; }
    .pgAllBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .pgAllBody{ overflow:visible; }

    .pgEmpty{ padding:14px; color:var(--muted); font-weight:900; }

    .pgxSettings{
      margin-top:12px;
      border:1px dashed rgba(15,23,42,0.22);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .pgxSetTitle{ font-weight:1100; letter-spacing:.02em; text-transform:uppercase; margin-bottom:10px; }
    .pgxSetGrid{
      display:grid;
      grid-template-columns: repeat(6, minmax(140px, 1fr));
      gap:10px;
      align-items:end;
    }
    .pgxSetGrid label{ display:flex; flex-direction:column; gap:6px; font-weight:1000; color:var(--muted); font-size:12px; }
    .pgxSetGrid input[type="text"], .pgxSetGrid input[type="number"], .pgxSetGrid select{
      padding:10px 10px; border-radius:14px; border:1px solid var(--border); font-weight:950; color:var(--text);
    }
    .pgxSetGrid input[type="color"]{
      width:100%; height:42px; border-radius:14px; border:1px solid var(--border); padding:4px;
      background:#fff;
    }
    .pgxSetGrid .pgxDateField input[type="date"]{
      min-width:0;
      width:100%;
      padding:8px 10px;
      font-size:13px;
    }
    .pgxSetRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;
    }
    .pgxLaneWrap{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap:10px;
    }
    .pgxLaneItem{
      border:1px solid rgba(0,0,0,.08);
      border-radius:14px;
      padding:10px;
      background:#fff;
    }
    .pgxLaneItem .k{ font-weight:1100; text-transform:uppercase; letter-spacing:.02em; font-size:12px; color:var(--muted); }
    .pgxLaneItem input{ width:100%; min-width:0; }
    @media (max-width: 980px){
      .pgxSetGrid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
      .pgxLaneWrap{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    }




  /* ===================== PROGRAMA (HOJA) v1 ===================== */
  .pxSheetWrap{ width:100%; }
  .pxZoom{ display:inline-block; width:max-content; }
  .pxSheetScroll{
    width:100%;
    overflow:auto;
    border:1px solid rgba(15,23,42,0.12);
    border-radius:16px;
    background:#fff;
    max-height: calc(100vh - 180px);
    cursor:grab;
  }
    #view_programa .pxSheetScroll{
      max-height: calc(100vh - 75px);  /* baja este número para que sea más largo */
    }
  .pxSheetScroll.dragging{ cursor:grabbing; user-select:none; -webkit-user-select:none; }
  .pxSheetScroll.dragging *{ user-select:none !important; -webkit-user-select:none !important; }
  body.pgxNoSelect, body.pgxNoSelect *{ user-select:none !important; -webkit-user-select:none !important; }

  .pxSheet{
    border-collapse: collapse;
    width:max-content;
    min-width: 980px;
    background:#fff;
  }
  .pxSheet th, .pxSheet td{
    border:1px solid rgba(15,23,42,0.18);
    padding:6px 8px;
    text-align:center;
    vertical-align:middle;
    font-weight:900;
    white-space:nowrap;
  }
  .pxCorner{
    background:#e5e7eb;
    font-weight:1100;
    text-transform:uppercase;
    letter-spacing:.02em;
    min-width: 220px;
  }
  .pxMonth{
    background:#e5e7eb;
    font-weight:1100;
    text-transform:uppercase;
    letter-spacing:.02em;
  }
  .pxDate{
    background:#f1f5f9;
    font-weight:1100;
  }
  .pxMonthEnd{
    border-right:none !important;
    box-shadow: inset -3px 0 0 rgba(15,23,42,0.55);
  }

/* Encabezados fijos (mes + fecha) dentro del scroll */
.pxHdr1 th{ position:sticky; top:0; z-index:6; }
.pxHdr2 th{ position:sticky; top:34px; z-index:6; }
.pxCorner{ position:sticky; top:0; z-index:7; }

  .pxProg{
    position:sticky;
    left:0;
    z-index:4;
    color:#fff;
    min-width: 44px;
    width:44px;
    padding:0;
  }
  .pxProgV{
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    font-weight:1100;
    letter-spacing:.08em;
    text-transform:uppercase;
    padding:10px 0;
  }

  .pxRowHead{
    position:sticky;
    left:44px; /* ancho de la columna de programa */
    z-index:3;
    background:#fff;
    text-align:left;
    padding-left:10px;
    min-width: 150px;
    width:150px;
    font-weight:1100;
    text-transform:uppercase;
    letter-spacing:.02em;
  }

  .pxActHead{
    text-align:center;
    font-weight:1100;
  }

  .pxW{
    min-width: 62px;
    width:62px;
  }

  .pxWOff{ background:#fff !important; color: transparent; }

  .pxCell{ background:#fff; }
  .pxCellIn{ width:100%; min-width:62px; display:flex; align-items:center; justify-content:center; text-align:center; overflow:hidden; }
  .pxEditable{ cursor:pointer; position:relative; }
  .pxEditable:hover{ outline:3px solid rgba(209,11,11,0.18); outline-offset:-3px; }
  .pxCellSelected{ outline:2px solid #2563eb; outline-offset:-2px; z-index:2; }
  .pxCellRange{ background:rgba(37,99,235,.08) !important; }
  .pxCellEditing input{
    width:100%; border:0; outline:none; text-align:center; font-weight:1000;
    background:transparent; font:inherit;
  }
  .pxFillHandle{
    position:absolute; width:8px; height:8px; right:-1px; bottom:-1px;
    background:#2563eb; border:1px solid #fff; cursor:crosshair;
  }

  /* Marco negro por programa (estilo Excel) */
  .pxPTop > *{ border-top:2px solid rgba(15,23,42,0.80) !important; }
  .pxPBot > *{ border-bottom:2px solid rgba(15,23,42,0.80) !important; }
  tr.pxPRow > *:last-child{ border-right:2px solid rgba(15,23,42,0.80) !important; }
  tr.pxPRow .pxRowHead{ border-left:2px solid rgba(15,23,42,0.80) !important; }
  .pxProg{ border-left:2px solid rgba(15,23,42,0.80) !important; border-top:2px solid rgba(15,23,42,0.80) !important; border-bottom:2px solid rgba(15,23,42,0.80) !important; }

  .pxEtapaCell{ background: rgba(2,6,23,0.04); font-weight:1100; }
  .pxGap td{ border:none !important; height:14px; background:transparent; }


  .pgxMatrixHost{ position:relative; }
  #pgxFsToggle,
  .pgxMatrixFsBadge,
  .pgxMatrixExit{ display:none !important; }
  .pgxMatrixTopBar{ display:none; }
  .pgxMatrixExit{ display:none; }
  .pgxMatrixFsBadge{ display:none; }
  .pgxMatrixHost.isFullscreen{
    position:fixed;
    inset:10px;
    z-index:10035;
    background:#fff;
    border-radius:0;
    box-shadow:0 24px 70px rgba(2,6,23,.28);
    border:1px solid rgba(15,23,42,0.14);
    padding:10px 10px 12px 10px;
    display:grid;
    grid-template-rows:auto minmax(0,1fr);
    gap:10px;
    overflow:hidden;
  }
  .pgxMatrixHost.isFullscreen .pgxMatrixTopBar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    position:sticky;
    top:0;
    left:0;
    right:0;
    z-index:3;
    background:#fff;
    padding:2px 0;
  }
  .pgxMatrixHost.isFullscreen .pgxMatrixFsBadge{
    display:inline-flex;
    align-items:center;
    border-radius:999px;
    border:1px solid rgba(15,23,42,0.14);
    background:#f8fafc;
    padding:6px 10px;
    font-size:12px;
    font-weight:900;
    color:var(--muted);
  }
  .pgxMatrixHost.isFullscreen .pgxMatrixExit{
    display:inline-flex;
    position:fixed;
    top:22px;
    right:22px;
    z-index:10060;
    box-shadow:0 10px 24px rgba(2,6,23,.22);
  }
  .pgxMatrixHost.isFullscreen .pxSheetWrap{height:100%; min-height:0; overflow:hidden;}
  .pgxMatrixHost.isFullscreen .pxSheetScroll{
    width:100%;
    max-width:100%;
    max-height:none !important;
    height:100% !important;
    min-height:0;
    overflow-y:auto;
    overflow-x:scroll;
    scrollbar-gutter: stable both-edges;
    padding-bottom: 64px;
  }
  .pgxMatrixHost.isFullscreen .pxSheetScroll::-webkit-scrollbar:horizontal{ height:14px; }
  .pgxMatrixHost.isFullscreen .pxSheetScroll::-webkit-scrollbar-thumb:horizontal{
    background: rgba(15,23,42,0.35);
    border-radius: 999px;
    border: 3px solid #f8fafc;
  }


  /* Barra HORIZONTAL visible en pantalla completa (si el SO oculta scrollbars) */
  .pgxHNav{ display:none; }
  .pgxHBtn{
    width:40px;
    height:34px;
    border-radius:999px;
    border:1px solid rgba(15,23,42,0.14);
    background:#fff;
    font-weight:1100;
    cursor:pointer;
  }
  .pgxHBtn:hover{ border-color: rgba(209,11,11,0.35); box-shadow: 0 0 0 3px rgba(209,11,11,0.10); }
  .pgxHRange{
    width:100%;
    flex:1;
    appearance:none;
    -webkit-appearance:none;
    height:8px;
    border-radius:999px;
    background: linear-gradient(180deg, rgba(15,23,42,0.20), rgba(15,23,42,0.14));
    outline:none;
  }
  .pgxHRange::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width:18px;
    height:18px;
    border-radius:999px;
    border:1px solid rgba(15,23,42,0.22);
    background:#fff;
    box-shadow:0 4px 14px rgba(2,6,23,.22);
    cursor:pointer;
  }
  .pgxHRange::-moz-range-thumb{
    width:18px;
    height:18px;
    border-radius:999px;
    border:1px solid rgba(15,23,42,0.22);
    background:#fff;
    box-shadow:0 4px 14px rgba(2,6,23,.22);
    cursor:pointer;
  }

  .pgxMatrixHost.isFullscreen .pgxHNav{
    display:flex;
    align-items:center;
    gap:10px;
    position:fixed;
    left:22px;
    right:22px;
    bottom:22px;
    z-index:10055;
    padding:10px 12px;
    border:1px solid rgba(15,23,42,0.14);
    border-radius:999px;
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(10px);
    box-shadow:0 12px 30px rgba(2,6,23,.18);
  }
  @media (max-width: 900px){
    .pxSheetScroll{ max-height: calc(100vh - 160px); }
  }


  /* ===================== MATERIALES CRUDOS (avance) ===================== */
  .mrTop{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
  .mrSelRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .mrKpi{ display:inline-flex; gap:8px; align-items:center; border:1px solid rgba(0,0,0,.10); border-radius:999px; padding:8px 10px; background:#fff; font-weight:1000; }
  .mrProg{ width:220px; height:10px; background:rgba(0,0,0,.08); border-radius:999px; overflow:hidden; }
  .mrProgFill{ height:100%; width:0%; background:linear-gradient(90deg, rgba(22,163,74,.95), rgba(34,197,94,.75)); }
  .mrTable{ width:100%; border-collapse:collapse; margin-top:10px; }
  .mrTable th, .mrTable td{ border:1px solid rgba(0,0,0,.08); padding:8px 10px; text-align:left; }
  .mrTable th{ background:#f8fafc; font-weight:1100; text-transform:uppercase; font-size:12px; }
  .mrDone{ color: var(--ok); font-weight:1100; }
  .mrTodo{ color: var(--muted); font-weight:1100; }
  .mrBtn{ border:1px solid rgba(0,0,0,.10); background:#fff; border-radius:12px; padding:8px 10px; font-weight:1000; cursor:pointer; }
  .mrBtn:hover{ border-color: rgba(209,11,11,.35); box-shadow: 0 0 0 3px rgba(209,11,11,.10); }
  .mrLink{ font-weight:1000; text-decoration:none; }
  .mrLink.disabled{ pointer-events:none; opacity:.45; }
  .mrBtn.disabled{ pointer-events:none; opacity:.45; }

  .mcBarsCompact{
    display:grid;
    grid-template-columns: repeat(3, minmax(110px, 1fr));
    gap:10px;
    margin-bottom:12px;
  }
  .mcTableWrap{
    border:1px solid var(--border);
    border-radius:14px;
    overflow-x:scroll;
    overflow-y:hidden;
    padding-bottom:4px;
  }
  .mcTable{
    width:100%;
    min-width:620px;
    border-collapse:collapse;
    font-weight:900;
  }
  .mcTable th, .mcTable td{
    padding:6px 4px;
    border-bottom:1px solid var(--border);
  }
  .mcStatusCol{ width:52px; text-align:center; font-size:11px; }
  .mcChkCell{ text-align:center; }
  .mcTableWrap input[type="checkbox"]{
    width:14px;
    height:14px;
    accent-color: var(--ok);
    cursor:pointer;
  }
  .mcTableWrap input[type="checkbox"].mcChkReadOnly{
    pointer-events:none;
    cursor:not-allowed;
  }

</style>
</head>

<body>
  <div class="topbar"></div>

  <!-- ===================== ACCESO (ADMIN / TUTOR) ===================== -->
  <div id="authOverlay" class="authOverlay">
    <div class="authCard">
      <p class="authTitle">ACCESO AL PANEL</p>
      <p class="authSub">Seleccione su tipo de acceso. Si es alumno, use su USUARIO y CONTRASEÑA de matrícula.</p>

      <div class="roleRow">
        <button id="roleAdmin" class="roleBtn" type="button">ADMIN</button>
        <button id="roleTutor" class="roleBtn" type="button">TUTOR</button>
        <button id="roleAlumno" class="roleBtn" type="button">ALUMNO</button>
      </div>

      <div class="authRow" id="authUserRow" style="display:none;">
        <input id="authUser" type="text" placeholder="Usuario" autocomplete="username" />
      </div>

      <div class="authRow">
        <input id="authPass" type="password" placeholder="Clave" autocomplete="current-password" />
        <button id="btnLogin" type="button">ENTRAR</button>
      </div>

      <div id="authErr" class="authErr">Datos incorrectos o rol no seleccionado.</div>
    </div>
  </div>

  <div id="appShell" class="app" style="display:none;">
    <aside class="sidebar">
      <div class="brand">
        <img src="logo.png" alt="LA META" onerror="this.style.display='none'"/>
        <div>
          <h1 id="brandTitle">LA META<br/>PANEL DE CONTROL</h1>
          <div class="sub" id="brandSub">Monitoreo de alumnos por local y salón</div>
        </div>
      </div>

      <div class="nav">
        <button id="nav_inicio_alumno">INICIO</button>
        <button id="nav_perfil_alumno">MI PERFIL</button>
        <button id="nav_overview" class="active">RESUMEN GENERAL</button>
        <button id="nav_local">CONTROL DE SEDES</button>
        <button id="nav_table">ALUMNOS</button>
        <button id="nav_horarios">HORARIOS</button>
                <button id="nav_programa">PROGRAMA</button>
<button id="nav_impresiones">IMPRESIONES</button>
        <!-- ✅ NUEVO -->
        <button id="nav_silabos">SÍLABOS</button>
        <button id="nav_evaluaciones">EVALUACIONES</button>
        <button id="nav_materiales">MATERIALES</button>
        <button id="nav_listas">LISTAS</button>
        <button id="nav_reportes">REPORTES</button>

              <button id="nav_notas">NOTAS GENERALES</button>

</div>

      <div class="userBox">
        <div class="userRole" id="userRole">ROL: -</div>
        <button id="btnLogout" class="logoutBtn" type="button">SALIR</button>
      </div>
    </aside>

    <main class="main">
      <div class="headerline">
        <div class="title">
          <h2 id="viewTitle">RESUMEN GENERAL</h2>
          <p id="viewDesc">Panel estructurado para control de matrícula, modalidad y distribución por universidad.</p>
        </div>

        <div class="controls" id="controlsMatricula">
          <select id="fLocal"></select>
          <select id="fUni"></select>
          <select id="fSalon"></select>

          <!-- ✅ NUEVO: filtro de estado SOLO para ALUMNOS (incluye CAMBIO) -->
          <select id="fEstado" style="display:none;"></select>

          <select id="fModalidad"></select>
          <input id="q" type="text" placeholder="Buscar por nombre"/>
</div>
      </div>

      <div id="view_inicio_alumno" class="grid" style="display:none;"></div>
      <div id="view_perfil_alumno" class="grid" style="display:none;"></div>


      <div id="view_overview" class="grid"></div>
      <div id="view_local" class="grid" style="display:none;"></div>
      <div id="view_table" class="grid" style="display:none;"></div>
      <div id="view_horarios" class="grid" style="display:none;"></div>
            <div id="view_programa" class="grid" style="display:none;"></div>
<div id="view_impresiones" class="grid" style="display:none;"></div>
      <!-- ✅ NUEVO -->
      <div id="view_silabos" class="grid" style="display:none;"></div>
      <div id="view_evaluaciones" class="grid" style="display:none;"></div>
      <div id="view_materiales" class="grid" style="display:none;"></div>
      <div id="view_listas" class="grid" style="display:none;"></div>
      <div id="view_reportes" class="grid" style="display:none;"></div>

          <div id="view_notas" class="grid" style="display:none;"></div>
</main>
  </div>

<script>
  // ===================== MATRÍCULA (TU CÓDIGO) =====================
  const SPREADSHEET_ID = "1nHCBQLuJ8RZNtLisvAqD916pcxbUmtqPrMnO4V0ewvs";

  // ===================== EVALUACIONES (BD) =====================
  // 1) Crea un Google Apps Script (Web App) que exponga el API.
  // 2) Pega aquí la URL del deployment (termina en /exec).
  //    Ejemplo: https://script.google.com/macros/s/XXXX/exec
  const EVALS_API_URL = "https://script.google.com/macros/s/AKfycbw5gAetJ9ryJSrM9LULkgtLgpJ-uDPYHmekOUv8TxDYk5TpAhHrc3QH2fM677KNJ2Vy/exec"; // URL Apps Script (Web App /exec)

  // IDs del Google Sheet de Evaluaciones (solo para referencia / validación)
  const EVALS_SPREADSHEET_ID = "1Q3UGJql1UUP8i4wXtSuZ9Dvb8kQZs8tOsIDL9jznUU0";
  const EVALS_CURSOS_GID = 1513385023;
  const EVALS_EVALUACIONES_GID = 1370374081;


    // ===================== ACCESO (ADMIN / TUTOR / ALUMNO) =====================
  // ⚠️ CAMBIA ESTAS CLAVES AQUÍ
  const AUTH_ADMIN_PASS = "202619";
  const AUTH_TUTOR_PASS = "MBMLaMeta";
  const APP_BUILD = "2026-02-26-auth-hotfix-2";

  const ROLE_KEY = "lameta_role";
  const STUDENT_USER_KEY = "lameta_student_user";
  const STUDENT_PROFILE_KEY = "lameta_student_profile";

  let CURRENT_ROLE = null; // "admin" | "tutor" | "alumno"

  function setRole(role){
    CURRENT_ROLE = role;
    try { localStorage.setItem(ROLE_KEY, role); } catch(e){}
    // Si no es alumno, limpia sesión de alumno
    if (role !== "alumno") clearAlumnoSession();
    applyRoleUI();
  }

  function loadRole(){
    let r = null;
    try { r = localStorage.getItem(ROLE_KEY); } catch(e){ r = null; }

    if (r === "admin" || r === "tutor") return r;
    if (r === "alumno"){
      const u = getAlumnoUser();
      return u ? "alumno" : null;
    }
    return null;
  }

  function clearRole(){
    try { localStorage.removeItem(ROLE_KEY); } catch(e){}
    clearAlumnoSession();
    CURRENT_ROLE = null;
  }

  function getAlumnoUser(){
    try { return String(localStorage.getItem(STUDENT_USER_KEY) || "").trim(); } catch(e){ return ""; }
  }

  function getAlumnoProfile(){
    try { return JSON.parse(localStorage.getItem(STUDENT_PROFILE_KEY) || "null"); } catch(e){ return null; }
  }

  function setAlumnoSession(row){
    const usuario = String(row?.usuario || "").trim();
    if (!usuario) return;

    try { localStorage.setItem(STUDENT_USER_KEY, usuario); } catch(e){}

    const uniFromSheet = row?.uni_sheet || "";
    const uni = uniKey(uniFromSheet) || uniKey(uniGroupFromCiclo(row?.ciclo || ""));

    const profile = {
      usuario,
      nombre: row?.nombre || "",
      local: row?.local || "",
      ciclo: row?.ciclo || "",
      uni,
      uni_sheet: row?.uni_sheet || "",
      salon: row?.salon || "",
      modalidad: row?.modalidad || "",
      estado: row?.estado || "",

      // Alumno
      correo: row?.correo_al || row?.correo || "",
      dni: row?.dni_al || row?.dni || "",
      celular: row?.celular_al || row?.celular || "",
      carrera: row?.carrera || "",

      // Apoderado
      nombre_apo: row?.nombre_apo || "",
      cel_apo: row?.cel_apo || "",
      dni_apo: row?.dni_apo || "",
      correo_apo: row?.correo_apo || "",

      updated_at: new Date().toISOString()
    };

    try { localStorage.setItem(STUDENT_PROFILE_KEY, JSON.stringify(profile)); } catch(e){}
  }

  function clearAlumnoSession(){
    try { localStorage.removeItem(STUDENT_USER_KEY); } catch(e){}
    try { localStorage.removeItem(STUDENT_PROFILE_KEY); } catch(e){}
  }

  async function findAlumnoByCredentials(user, pass){
    const u = norm(user);
    const p = norm(pass);
    if (!u || !p) return null;

    const results = await Promise.allSettled(SALONES.map(loadOneSalon));
    for (const r of results){
      if (r.status !== "fulfilled") continue;
      const rows = r.value?.rows || [];
      for (const row of rows){
        if (norm(row.usuario) === u && norm(row.contrasena) === p){
          return row;
        }
      }
    }
    return null;
  }

  function updateAlumnoProfileFromRawRows(){
    if (CURRENT_ROLE !== "alumno") return;
    const u = norm(getAlumnoUser());
    if (!u) return;

    const rows = (state?.rawRows || []);
    const row = rows.find(r => norm(r.usuario) === u && (r.estado==="ACTIVO" || r.estado==="RETIRO"))
             || rows.find(r => norm(r.usuario) === u);

    if (row) setAlumnoSession(row);
  }

  function canAccessView(v){
    // Tutor NO puede ver RESUMEN GENERAL ni CONTROL DE SEDES
    if (CURRENT_ROLE === "tutor" && (v === "overview" || v === "local")) return false;

    // Alumno: entorno limitado (sin materiales)
    if (CURRENT_ROLE === "alumno"){
      return (v === "inicio_alumno" || v === "perfil_alumno" || v === "horarios" || v === "programa" || v === "silabos" || v === "evaluaciones");
    }
    return true;
  }

  function applyRoleUI(){
    // Clase de rol en <body> para estilos por perfil
    document.body.classList.toggle("role-alumno", CURRENT_ROLE === "alumno");
    document.body.classList.toggle("role-tutor", CURRENT_ROLE === "tutor");
    document.body.classList.toggle("role-admin", CURRENT_ROLE === "admin");

    const roleLabel = document.getElementById("userRole");
    const prof = getAlumnoProfile();

    // Etiqueta inferior del sidebar
    const userMini = document.getElementById("userMini");
    const userMiniName = document.getElementById("userMiniName");
    if (userMini && userMiniName){
      if (CURRENT_ROLE === "alumno" && prof){
        userMini.style.display = "";
        userMiniName.textContent = `ALUMNO: ${prof.nombre || prof.usuario || ""}`.trim();
      } else {
        userMini.style.display = "none";
        userMiniName.textContent = "";
      }
    }

    // Chip de rol
    if (roleLabel){
      if (CURRENT_ROLE){
        roleLabel.textContent = "ROL: " + CURRENT_ROLE.toUpperCase();
      } else {
        roleLabel.textContent = "ROL: -";
      }
    }

    const isTutor = (CURRENT_ROLE === "tutor");
    const isAlumno = (CURRENT_ROLE === "alumno");

    const btnInicioAlumno = document.getElementById("nav_inicio_alumno");
    const btnPerfilAlumno = document.getElementById("nav_perfil_alumno");
    const btnOverview = document.getElementById("nav_overview");
    const btnLocal = document.getElementById("nav_local");
    const btnTable = document.getElementById("nav_table");
    const btnHorarios = document.getElementById("nav_horarios");
        const btnPrograma = document.getElementById("nav_programa");
const btnImpr = document.getElementById("nav_impresiones");
    const btnSil = document.getElementById("nav_silabos");
    const btnEval = document.getElementById("nav_evaluaciones");
    const btnMat = document.getElementById("nav_materiales");
    const btnList = document.getElementById("nav_listas");
    const btnRep = document.getElementById("nav_reportes");

        const btnNotas = document.getElementById("nav_notas");
// Mostrar/ocultar por rol
    if (btnInicioAlumno) btnInicioAlumno.style.display = isAlumno ? "" : "none";
    if (btnPerfilAlumno) btnPerfilAlumno.style.display = isAlumno ? "" : "none";

    // Admin/Tutor
    if (btnOverview) btnOverview.style.display = (isTutor || isAlumno) ? "none" : "";
    if (btnLocal) btnLocal.style.display     = (isTutor || isAlumno) ? "none" : "";

    // Alumno no ve módulos administrativos
    if (btnTable) btnTable.style.display = isAlumno ? "none" : "";
    if (btnImpr) btnImpr.style.display   = isAlumno ? "none" : "";
    if (btnList) btnList.style.display   = isAlumno ? "none" : "";
    if (btnRep) btnRep.style.display     = isAlumno ? "none" : "";

        if (btnNotas) btnNotas.style.display   = isAlumno ? "none" : "";
// Disponibles para todos
    if (btnHorarios) btnHorarios.style.display = "";
        if (btnPrograma) btnPrograma.style.display = "";
if (btnSil) btnSil.style.display = "";
    if (btnEval) btnEval.style.display = isAlumno ? "" : "none";

    // Materiales: oculto para alumnos (se habilitará cuando esté listo)
    if (btnMat) btnMat.style.display = isAlumno ? "none" : "";

    // Si la vista actual no está permitida, enviar a fallback
    if (state && state.view && !canAccessView(state.view)){
      setView(isAlumno ? "inicio_alumno" : "table");
    }
  }

  function showAuth(show){
    const o = document.getElementById("authOverlay");
    const app = document.getElementById("appShell");
    if (o) o.style.display = show ? "flex" : "none";
    if (app) app.style.display = show ? "none" : "grid";

    if (show){
      try{ setHorariosMatrixFullscreen(false); }catch(e){}
      try{ closeHorariosCellEditModal(); }catch(e){}
      const hov = document.getElementById("hCellEditOverlay");
      if (hov) hov.style.display = "none";
      const he = document.getElementById("hEditorOverlay");
      if (he) he.style.display = "none";
      const mxHost = document.getElementById("hMatrixHost");
      if (mxHost) mxHost.classList.remove("isFullscreen");
    }
  }

  function initAuth(){
    const saved = loadRole();
    if (saved){
      CURRENT_ROLE = saved;
      showAuth(false);
      applyRoleUI();
      return true;
    }

    showAuth(true);

    let selected = null;
    const bA = document.getElementById("roleAdmin");
    const bT = document.getElementById("roleTutor");
    const bS = document.getElementById("roleAlumno");
    const userRow = document.getElementById("authUserRow");
    const user = document.getElementById("authUser");
    const pass = document.getElementById("authPass");
    const err = document.getElementById("authErr");
    const btn = document.getElementById("btnLogin");
    if (!bA || !bT || !bS || !pass || !btn){
      console.error("AUTH: faltan elementos del formulario de acceso.");
      return false;
    }

    function pick(r){
      selected = r;
      if (bA) bA.classList.toggle("active", r === "admin");
      if (bT) bT.classList.toggle("active", r === "tutor");
      if (bS) bS.classList.toggle("active", r === "alumno");

      if (err) err.style.display = "none";

      const isAlumno = (r === "alumno");
      if (userRow) userRow.style.display = isAlumno ? "" : "none";
      if (pass) pass.placeholder = isAlumno ? "Contraseña" : "Clave";

      if (isAlumno){
        if (user) user.focus();
      } else {
        if (pass) pass.focus();
      }
    }

    function inferSelectedRole(){
      if (selected) return selected;
      if (bA?.classList.contains("active")) return "admin";
      if (bT?.classList.contains("active")) return "tutor";
      if (bS?.classList.contains("active")) return "alumno";
      return null;
    }

    const bindRole = (el, role)=>{
      if (!el) return;
      const cb = (ev)=>{ ev.preventDefault(); pick(role); };
      el.addEventListener("click", cb);
      el.addEventListener("touchstart", cb, { passive:false });
    };
    bindRole(bA, "admin");
    bindRole(bT, "tutor");
    bindRole(bS, "alumno");

    async function doLogin(){
      selected = inferSelectedRole();
      if (!selected){
        if (err){ err.textContent = "Seleccione un rol."; err.style.display = "block"; }
        return;
      }

      if (selected === "admin" || selected === "tutor"){
        const p = String(pass?.value || "");
        const ok = (selected === "admin" && p === AUTH_ADMIN_PASS) || (selected === "tutor" && p === AUTH_TUTOR_PASS);
        if (!ok){
          if (err){ err.textContent = "Clave incorrecta."; err.style.display = "block"; }
          return;
        }
        setRole(selected);
        showAuth(false);
        if (pass) pass.value = "";
        const target = loadSavedView() || state.view;
        if (!canAccessView(target)) setView("table");
        return;
      }

      // alumno
      const u = String(user?.value || "").trim();
      const p = String(pass?.value || "").trim();
      if (!u || !p){
        if (err){ err.textContent = "Ingrese su usuario y contraseña."; err.style.display = "block"; }
        return;
      }

      if (btn){ btn.disabled = true; btn.textContent = "VERIFICANDO…"; }
      let row = null;
      try{
        row = await findAlumnoByCredentials(u, p);
      }finally{
        if (btn){ btn.disabled = false; btn.textContent = "ENTRAR"; }
      }

      if (!row){
        if (err){ err.textContent = "Usuario o contraseña incorrectos."; err.style.display = "block"; }
        return;
      }

      setRole("alumno");
      setAlumnoSession(row);
      showAuth(false);
      if (user) user.value = "";
      if (pass) pass.value = "";
      setView("inicio_alumno");
    }

    if (btn) btn.addEventListener("click", ()=>{ doLogin(); });
    if (pass) pass.addEventListener("keydown", (e)=>{ if (e.key === "Enter") doLogin(); });
    if (user) user.addEventListener("keydown", (e)=>{ if (e.key === "Enter") doLogin(); });

    const overlay = document.getElementById("authOverlay");
    if (overlay && !overlay.dataset.authDelegated){
      overlay.dataset.authDelegated = "1";
      overlay.addEventListener("click", (ev)=>{
        const t = ev.target?.closest ? ev.target.closest("#roleAdmin,#roleTutor,#roleAlumno,#btnLogin") : null;
        if (!t) return;
        if (t.id === "roleAdmin") return pick("admin");
        if (t.id === "roleTutor") return pick("tutor");
        if (t.id === "roleAlumno") return pick("alumno");
        if (t.id === "btnLogin") return doLogin();
      }, true);
    }

    // Por defecto
    pick("admin");
    return false;
  }

const SALONES = [
    { local:"LA MOLINA", ciclo:"AGRARIA",  salon:"AGRARIA LM 1", gid:818929525 },
    { local:"LA MOLINA", ciclo:"AGRARIA",  salon:"AGRARIA LM 2", gid:1576159193 },
    { local:"LA MOLINA", ciclo:"AGRARIA",  salon:"AGRARIA ESCOLAR", gid:938671284 },
    { local:"LA MOLINA", ciclo:"PUCP",     salon:"PUCP LM",     gid:1037962332 },
    { local:"LA MOLINA", ciclo:"U.LIMA",   salon:"U.LIMA LM",   gid:877886853 },
    { local:"LA MOLINA", ciclo:"ADELANTO", salon:"ADELANTO LM", gid:1271606284 },
    { local:"LA MOLINA", ciclo:"PARALELO", salon:"PARALELO LM", gid:1863430245 },

    { local:"SAN BORJA", ciclo:"AGRARIA", salon:"AGRARIA SB",  gid:1870866968 },
    { local:"SAN BORJA", ciclo:"PUCP",    salon:"PUCP SB",     gid:998068235 },
    { local:"SAN BORJA", ciclo:"U.LIMA",  salon:"U.LIMA SB 1", gid:670800187 },
    { local:"SAN BORJA", ciclo:"U.LIMA",  salon:"U.LIMA SB 2", gid:1856014712 },

    { local:"SAN MIGUEL", ciclo:"AGRARIA",  salon:"AGRARIA SM",  gid:511460041 },
    { local:"SAN MIGUEL", ciclo:"PUCP",     salon:"PUCP SM",     gid:1531300183 },
    { local:"SAN MIGUEL", ciclo:"U.LIMA",   salon:"U.LIMA SM 1", gid:1080962628 },
    { local:"SAN MIGUEL", ciclo:"U.LIMA",   salon:"U.LIMA SM 2", gid:679583464 },
    { local:"SAN MIGUEL", ciclo:"ADELANTO", salon:"ADELANTO SM", gid:2120250792 },
    { local:"SAN MIGUEL", ciclo:"PARALELO", salon:"PARALELO SM", gid:721468852 },

    { local:"VIRTUAL", ciclo:"AGRARIA",     salon:"AGRARIA VIRTUAL", gid:1850115978 },
    { local:"VIRTUAL", ciclo:"ESC. U.LIMA", salon:"U.LIMA ESCOLAR",  gid:315999969 },
    { local:"VIRTUAL", ciclo:"U.LIMA",      salon:"U.LIMA VIRTUAL 1",  gid:1667430860 },
    { local:"VIRTUAL", ciclo:"U.LIMA",      salon:"U.LIMA VIRTUAL 2",  gid:951960453 },
  ];

  const AUTO_REFRESH_MS = 30000;




  // ===================== PROGRAMA (HOJA) v1 =====================
  // Objetivo: imitar/optimizar la tabla estilo Excel (PROGRAMACIÓN / FECHA / semanas),
  // con:
  // - Ver UNO / TODOS
  // - Encabezado global por meses + fechas (una sola vez en TODOS)
  // - Bloques por programa con etiqueta vertical (AGRARIA / U.LIMA / PUCP / etc.)
  // - Edición (Admin): click para editar celdas; Edición fina (por semana) / normal (merge por texto)
const PGX_STORE_KEY   = "LM_PROGRAMA_SHEET_V1_STORE";
  const PGX_SYNC_URL   = "https://script.google.com/macros/s/AKfycbxLUjS66__D_zFIq7N34cFXGm1CfiQg4n-N-3leue8ulLmEg-3J_iho5VyBw7aY_afTGw/exec";

  const PGX_ACTIVE_KEY  = "LM_PROGRAMA_SHEET_V1_ACTIVE";
  const PGX_MODE_KEY    = "LM_PROGRAMA_SHEET_V1_MODE";
  const PGX_ZOOM_KEY    = "LM_PROGRAMA_SHEET_V1_ZOOM";
  const PGX_EDIT_KEY    = "LM_PROGRAMA_SHEET_V1_EDIT";
  const PGX_FINE_KEY    = "LM_PROGRAMA_SHEET_V1_FINE";
  const PGX_VIEW_START_KEY = "LM_PROGRAMA_SHEET_V1_VIEW_START";
  const PGX_VIEW_WEEKS_KEY = "LM_PROGRAMA_SHEET_V1_VIEW_WEEKS";

  const PGX_SETTINGS_KEY = "LM_PROGRAMA_SHEET_V1_SETTINGS"; // panel Personalizar (Admin)

  // Toast (mensaje corto)
  function toast(msg){
    const m = String(msg||"").trim();
    if (!m) return;
    let el = document.getElementById("lmToast");
    if (!el){
      el = document.createElement("div");
      el.id = "lmToast";
      el.className = "toast";
      document.body.appendChild(el);
    }
    el.textContent = m;
    el.classList.add("show");
    try{ clearTimeout(el._t); }catch(e){}
    el._t = setTimeout(()=>{ try{ el.classList.remove("show"); }catch(e){} }, 1800);
  }

  function pgxNowISO(){ return new Date().toISOString(); }
  function pgxUuid(){ return "pgx_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

  function pgxCanEdit(){ return CURRENT_ROLE === "admin"; } // edición total solo Admin (tutor: lectura)

  function pgxLoadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    }catch(e){ return fallback; }
  }
  function pgxSaveJSON(key, obj){
    try{ localStorage.setItem(key, JSON.stringify(obj)); }catch(e){}
  }
  function pgxLoadStr(key, fallback){
    try{ return String(localStorage.getItem(key) || fallback || ""); }catch(e){ return String(fallback||""); }
  }
  function pgxSaveStr(key, val){
    try{ localStorage.setItem(key, String(val||"")); }catch(e){}
  }

  function pgxParseDateYMD(ymd){
    const s = String(ymd||"").trim();
    // acepta: YYYY-MM-DD (input date), DD/MM, DD/MM/YYYY, DD-MM-YYYY
    let m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
    if (m){
      const d = new Date(+m[1], (+m[2])-1, +m[3]);
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }
    m = /^(\d{2})\/(\d{2})(?:\/(\d{4}))?$/.exec(s);
    if (m){
      const yy = m[3] ? +m[3] : (new Date()).getFullYear();
      const d = new Date(yy, (+m[2])-1, +m[1]);
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }
    m = /^(\d{2})-(\d{2})-(\d{4})$/.exec(s);
    if (m){
      const d = new Date(+m[3], (+m[2])-1, +m[1]);
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }
    return null;
  }
  function pgxAddDays(d, days){
    const x = new Date(d.getTime());
    x.setDate(x.getDate() + (+days||0));
    return x;
  }
  function pgxFmtDDMM(d){
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    return `${dd}/${mm}`;
  }
  const PGX_MONTHS_ES = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
  function pgxMonthNameES(d){ return PGX_MONTHS_ES[d.getMonth()] || ""; }

  function pgxThemeColors(theme){
    const t = String(theme||"").toUpperCase();
    if (t === "AGRARIA") return {bar:getCss("--schHead_AGR"), cell:getCss("--schCell_AGR")};
    if (t === "PUCP")    return {bar:getCss("--schHead_PUCP"), cell:getCss("--schCell_PUCP")};
    if (t === "U.LIMA" || t === "ULIMA") return {bar:getCss("--schHead_UL"), cell:getCss("--schCell_UL")};
    if (t === "ESCOLARES") return {bar:getCss("--schHead_ESC"), cell:getCss("--schCell_ESC")};
    // default
    return {bar:"#64748b", cell:"#f1f5f9"};
  }


  // Colores por programa (permite override en meta.colors)
  function pgxProgramColors(p){
    const theme = String(p?.meta?.theme||"").toUpperCase();
    const base = pgxThemeColors(theme);
    const o = (p && p.meta && p.meta.colors) ? p.meta.colors : {};
    const bar  = String(o?.bar  || base.bar);
    const cell = String(o?.cell || base.cell);
    const off  = String(o?.off  || "#ffffff");
    return {bar, cell, off};
  }


// Orden fijo de visualización por universidad/tema (siempre):
// AGRARIA → U.LIMA → PUCP → ESCOLARES
function pgxThemeRank(theme){
  const t = String(theme||"").toUpperCase().trim();
  if (t==="AGRARIA") return 1;
  if (t==="U.LIMA" || t==="ULIMA" || t==="UL") return 2;
  if (t==="PUCP") return 3;
  if (t==="ESCOLARES" || t==="ESCOLAR") return 4;
  return 99;
}

// Inserta un programa nuevo respetando el bloque de su tema y el orden global.
function pgxInsertProgramId(store, newProgram){
  const id = newProgram.id;
  const rNew = pgxThemeRank(newProgram?.meta?.theme);
  // índices del mismo tema
  let lastSame = -1;
  for (let i=0;i<store.order.length;i++){
    const p = store.programs[store.order[i]];
    if (!p) continue;
    if (pgxThemeRank(p?.meta?.theme)===rNew) lastSame = i;
  }
  if (lastSame >= 0){
    store.order.splice(lastSame+1, 0, id);
    return;
  }
  // si no existe ese tema, insertar antes del primer tema "mayor"
  let pos = store.order.length;
  for (let i=0;i<store.order.length;i++){
    const p = store.programs[store.order[i]];
    if (!p) continue;
    const r = pgxThemeRank(p?.meta?.theme);
    if (r > rNew){ pos = i; break; }
  }
  store.order.splice(pos, 0, id);
}

  // Ventana visible por programa (para imitar bloques cortos como tu Excel)
  // meta.startWeek / meta.endWeek (1-based, dentro de 1..totalWeeks)
  function pgxProgramWindow(p, totalWeeks){
    const w = Math.max(1, Math.floor(+totalWeeks || 16));
    let s = parseInt(p?.meta?.startWeek ?? 1, 10);
    let e = parseInt(p?.meta?.endWeek   ?? w, 10);
    if (!Number.isFinite(s)) s = 1;
    if (!Number.isFinite(e)) e = w;
    s = Math.max(1, Math.min(w, s));
    e = Math.max(1, Math.min(w, e));
    if (e < s){ const tmp = s; s = e; e = tmp; }
    return {start:s, end:e};
  }

  function pgxMaskWindowCells(values, start, end){
    const arr = Array.isArray(values) ? values : [];
    return arr.map((v,i)=>{
      const wk = i+1;
      if (wk < start || wk > end) return "";
      return String(v||"");
    });
  }

  function pgxMaskWindowSegments(segments, totalWeeks, start, end){
    const seg = Array.isArray(segments) ? segments : [];
    const weeks = [];
    let acc = 0;
    for (const s of seg){
      const sp  = Math.max(0, +s.span || 0);
      const txt = String(s.text || "");
      for (let i=0;i<sp;i++){
        if (acc < totalWeeks) weeks.push(txt);
        acc++;
        if (weeks.length >= totalWeeks) break;
      }
      if (weeks.length >= totalWeeks) break;
    }
    while (weeks.length < totalWeeks) weeks.push("");

    for (let i=0;i<weeks.length;i++){
      const wk = i+1;
      if (wk < start || wk > end) weeks[i] = "";
    }

    // compress
    const out = [];
    let i = 0;
    while (i < weeks.length){
      const t = weeks[i];
      let j = i+1;
      while (j < weeks.length && weeks[j] === t) j++;
      out.push({text:t, span:(j-i)});
      i = j;
    }
    return out;
  }

  function pgxDefaultProgram(name, scope, theme){
    const id = pgxUuid();
    const totalWeeks = 16;

    // helper
    const empty = Array.from({length: totalWeeks}, ()=>"");

    const semana = empty.slice();
    // plantilla base similar a tu imagen (editable luego)
    // 3 semanas SEN + 13 semanas SE
    const mk = (p,i,pad)=> p + String(i).padStart(pad,"0");
    for (let i=0;i<3;i++) semana[i] = mk("SEN", i+1, 1);
    for (let i=0;i<13;i++) semana[3+i] = mk("SE", i+1, 2);

    const reportes = empty.slice();
    for (let i=0;i<3;i++) reportes[i] = mk("RN", i+1, 1);
    for (let i=0;i<13;i++) reportes[3+i] = mk("R", i+1, 1);

    const materiales = empty.slice();
    // ejemplo visual (puedes editar a mano)
    for (let i=0;i<3;i++) materiales[i] = "SEPARATAS";
    for (let i=3;i<8;i++) materiales[i] = "BOLETÍN 1";
    materiales[8] = "SEPARATA";
    for (let i=9;i<12;i++) materiales[i] = "BOLETÍN 2";
    for (let i=12;i<15;i++) materiales[i] = "SEPARATA";
    materiales[15] = "";

    const etapaSegments = [
      { text:"NIVELACIÓN", span:3 },
      { text:"AVANCE TEÓRICO", span:10 },
      { text:"REPASO", span:3 }
    ];

    return {
      id,
      meta:{
        name: String(name||"PROGRAMA").trim().toUpperCase(),
        scope: String(scope||"ALL").trim().toUpperCase(), // ALL / AGRARIA / PUCP / U.LIMA
        theme: String(theme||"AGRARIA").trim().toUpperCase(),
        createdAt: pgxNowISO(),
        updatedAt: pgxNowISO()
      },
      config:{
        etapaSegments,
        lanes:[
          { key:"etapa", label:"Etapa", type:"segments", segments: etapaSegments },
          { key:"semana", label:"Semana", type:"cells", values: semana },
          { key:"simulacro", label:"Simulacro", type:"cells", values: empty.slice() },
          { key:"materiales", label:"Materiales", type:"cells", values: materiales },
          { key:"tutoria", label:"Tutoría", type:"cells", values: empty.slice() },
          { key:"reportes", label:"Reportes", type:"cells", values: reportes },
          { key:"seminario", label:"Seminario", type:"cells", values: empty.slice() },
          { key:"reuniones", label:"Reuniones", type:"cells", values: empty.slice() }
        ]
      }
    };
  }

  function pgxDefaultStore(){
    // Por defecto: cronograma como tu imagen (Lunes 09/02/2026)
    return {
      timeline: { startDate:"2026-02-09", weeks:16 },
      programs: {},
      order: []
    };
  }

  function pgxMarkRev_(store){
    store = store || {};
    store._rev = Date.now();
    return store;
  }

  // ===================== SYNC CENTRAL (Apps Script WebApp) =====================
  // Backend actual: requiere ?module=... (GET) y POST {module, store}
  const LM_SYNC_URL = PGX_SYNC_URL;

  const LM_MODULE_PROGRAMA   = "LM_SHARED_PROGRAMA_STORE_V1";
  const LM_MODULE_HORARIOS   = "LM_SHARED_HORARIOS_STORE_V1";
  const LM_MODULE_MATERIALES = "LM_SHARED_MATERIALES_STORE_V1";

  async function lmRemoteGet_(module){
    if (!LM_SYNC_URL) return null;
    try{
      const res = await fetch(
        LM_SYNC_URL + "?module=" + encodeURIComponent(module) + "&_ts=" + Date.now(),
        { cache:"no-store" }
      );
      if (!res.ok) return null;
      const data = await res.json();
      if (!data || !data.ok) return null;
      return data.store ?? null;
    }catch(_){
      return null;
    }
  }

  async function lmRemoteSet_(module, store){
    if (!LM_SYNC_URL) return false;
    try{
      const res = await fetch(LM_SYNC_URL, {
        method: "POST",
        cache: "no-store",
        body: JSON.stringify({ module, store: store || {} })
      });
      if (!res.ok) return false;
      const data = await res.json();
      return !!(data && data.ok);
    }catch(_){
      return false;
    }
  }

  // Backward-compatible wrappers (PROGRAMA)
  async function pgxRemoteGet_(){ return await lmRemoteGet_(LM_MODULE_PROGRAMA); }
  async function pgxRemoteSet_(store){ return await lmRemoteSet_(LM_MODULE_PROGRAMA, store); }


  function pgxLoadStore(){
    const st = pgxLoadJSON(PGX_STORE_KEY, null);
    if (st && st.timeline && st.programs && st.order) return st;
    return pgxDefaultStore();
  }

  function pgxCollectUiPrefs_(){
    return {
      zoom: pgxLoadStr(PGX_ZOOM_KEY, "0.85"),
      viewStart: pgxGetViewStart ? pgxGetViewStart() : pgxLoadStr(PGX_VIEW_START_KEY, ""),
      viewWeeks: pgxGetViewWeeks ? pgxGetViewWeeks() : (+pgxLoadStr(PGX_VIEW_WEEKS_KEY, "0")||0),
      mode: pgxLoadStr(PGX_MODE_KEY, "todos"),
      activeId: pgxLoadStr(PGX_ACTIVE_KEY, "")
    };
  }

  function pgxApplyUiPrefs_(ui){
    try{
      if (!ui || typeof ui !== "object") return;
      if (ui.zoom) pgxSaveStr(PGX_ZOOM_KEY, String(ui.zoom));
      if (typeof ui.viewStart !== "undefined") pgxSaveStr(PGX_VIEW_START_KEY, String(ui.viewStart||""));
      if (typeof ui.viewWeeks !== "undefined") pgxSaveStr(PGX_VIEW_WEEKS_KEY, String(+ui.viewWeeks||0));
      if (ui.mode) pgxSaveStr(PGX_MODE_KEY, String(ui.mode||"todos"));
      if (typeof ui.activeId !== "undefined") pgxSaveStr(PGX_ACTIVE_KEY, String(ui.activeId||""));
    }catch(_){}
  }
  function pgxSaveStore(store){
    store = store || {};
    store._ui = pgxCollectUiPrefs_();   // ✅ comparte zoom / fecha / semanas también
    store = pgxMarkRev_(store);
    pgxSaveJSON(PGX_STORE_KEY, store);

    // sincroniza a remoto en background (compartido)
    pgxRemoteSet_(store);
  }

  async function pgxSyncPullOnce_(){
  const remote = await pgxRemoteGet_();
  if (!remote || !remote.timeline || !remote.programs || !remote.order) return;

  const local = pgxLoadJSON(PGX_STORE_KEY, null);
  const rrev = +remote._rev || 0;
  const lrev = +(local && local._rev) || 0;

  let shouldApply = false;

  // Si no hay store local válido, aplica remoto
  if (!local || !local.timeline || !local.programs || !local.order){
    shouldApply = true;
  } else if (rrev > lrev){
    shouldApply = true;
  } else if (rrev && rrev === lrev){
    // mismo _rev pero contenido distinto (casos raros / caché)
    try{
      shouldApply = (JSON.stringify(remote) !== JSON.stringify(local));
    }catch(e){
      shouldApply = true;
    }
  }

  if (shouldApply){
    pgxApplyUiPrefs_(remote && remote._ui);
    pgxSaveJSON(PGX_STORE_KEY, remote);
    if (typeof renderPrograma === "function"){
      renderPrograma();
    }
    if (typeof toast === "function") toast("Programa actualizado.");
  }
}


  // Pull periódico para ver cambios de otros (quasi-tiempo real)
  pgxSyncPullOnce_();
  setInterval(()=>{ pgxSyncPullOnce_(); }, 5000);
  schSyncPullOnce_();
  setInterval(()=>{ schSyncPullOnce_(); }, 7000);
  mcSyncPullOnce_();
  setInterval(()=>{ mcSyncPullOnce_(); }, 9000);
  document.addEventListener("visibilitychange", ()=>{
    if (!document.hidden) pgxSyncPullOnce_();
  });

function pgxEnsure(){
    const store = pgxLoadStore();
    const baseWeeks = pgxTotalWeeks();
    if (!store.order.length && pgxCanEdit()){
      const p1 = pgxDefaultProgram("AG REGULAR 1", "AGRARIA", "AGRARIA");
      p1.meta.startWeek = 1;
      p1.meta.endWeek = store.timeline.weeks;
      const p2 = pgxDefaultProgram("U.LIMA", "U.LIMA", "U.LIMA");
      // Ventana visible por defecto (imita bloque corto)
      p2.meta.startWeek = 8;
      p2.meta.endWeek = 11;
      // U.LIMA: deja en blanco semanas 1-7 y 12-16 para que imite el bloque corto (editable)
      try{
        const seg = [{text:"", span:7},{text:"REPASO", span:4},{text:"", span:5}];
        p2.config.lanes.find(x=>x.key==="etapa").segments = seg;
        p2.config.etapaSegments = seg;
        // semana: ejemplo SE05-SE07 y SER (editable)
        const s = p2.config.lanes.find(x=>x.key==="semana").values;
        for (let i=0;i<s.length;i++) s[i]="";
        s[7]="SE05"; s[8]="SE06"; s[9]="SE07"; s[10]="SER";
        const sim = p2.config.lanes.find(x=>x.key==="simulacro").values;
        for (let i=0;i<sim.length;i++) sim[i]="";
        sim[7]="S05"; sim[8]="S06"; sim[9]="S07"; sim[10]="SR";
        const rep = p2.config.lanes.find(x=>x.key==="reportes").values;
        for (let i=0;i<rep.length;i++) rep[i]="";
        rep[7]="R05"; rep[8]="R06"; rep[9]="R07"; rep[10]="R08";
        const mat = p2.config.lanes.find(x=>x.key==="materiales").values;
        for (let i=0;i<mat.length;i++) mat[i]="";
      }catch(e){}

      const p3 = pgxDefaultProgram("TALENTO", "PUCP", "PUCP");
      // Ventana visible por defecto (según ejemplo)
      p3.meta.startWeek = 1;
      p3.meta.endWeek = 13;
      // TALENTO: plantilla base vacía (editar luego)
      try{
        const seg3 = [{text:"REPASO", span:1},{text:"", span:15}];
        p3.config.lanes.find(x=>x.key==="etapa").segments = seg3;
        p3.config.etapaSegments = seg3;
        // limpiar todo
        p3.config.lanes.forEach(l=>{
          if (l.type==="cells") l.values = Array.from({length: store.timeline.weeks}, ()=>"");
        });
      }catch(e){}

      store.programs[p1.id]=p1;
      store.programs[p2.id]=p2;
      store.programs[p3.id]=p3;
      store.order=[p1.id,p2.id,p3.id];
      pgxSaveStore(store);
      pgxSaveStr(PGX_ACTIVE_KEY, p1.id);
      pgxSaveStr(PGX_MODE_KEY, "ALL");
      pgxSaveStr(PGX_ZOOM_KEY, "0.85");
      pgxSaveStr(PGX_EDIT_KEY, "0");
      pgxSaveStr(PGX_FINE_KEY, "0");
      pgxSaveStr(PGX_SETTINGS_KEY, "0");
    }
  }

  function pgxGetMode(){
    const m = pgxLoadStr(PGX_MODE_KEY, "ALL").toUpperCase();
    return (m==="ONE" || m==="ALL") ? m : "ALL";
  }
  function pgxSetMode(m){ pgxSaveStr(PGX_MODE_KEY, String(m||"ALL").toUpperCase()); }

  function pgxGetActiveId(){
    return pgxLoadStr(PGX_ACTIVE_KEY, "");
  }
  function pgxSetActiveId(id){ pgxSaveStr(PGX_ACTIVE_KEY, String(id||"")); }

  function pgxGetZoom(){
    const z = parseFloat(pgxLoadStr(PGX_ZOOM_KEY, "0.85"));
    if (!Number.isFinite(z)) return 0.85;
    return Math.max(0.55, Math.min(1.25, z));
  }

  function pgxZoomOption(z){
    const n = parseFloat(z);
    const opts = ["1","0.95","0.90","0.85","0.80","0.75","0.70"];
    if (!Number.isFinite(n)) return "0.85";
    let best = opts[0];
    let bestD = 1e9;
    for (const s of opts){
      const v = parseFloat(s);
      const d = Math.abs(v - n);
      if (d < bestD){ bestD = d; best = s; }
    }
    return best;
  }
  function pgxSetZoom(z){
    const allowed = ["0.55","0.60","0.65","0.70","0.75","0.80","0.85","0.90","0.95","1","1.05","1.10","1.15","1.20","1.25"];
    let v = +z;
    if (!Number.isFinite(v)) v = 0.85;
    v = Math.max(0.55, Math.min(1.25, v));
    // redondeo estable para que el <select> no quede en blanco
    let s = (Math.round(v*100)/100).toFixed(2);
    s = s.replace(/\.00$/,"").replace(/0$/,"");
    if (!allowed.includes(s)){
      // busca el más cercano
      let best = allowed[0], bestd = 1e9;
      for (const a of allowed){
        const d = Math.abs(parseFloat(a)-v);
        if (d<bestd){ bestd=d; best=a; }
      }
      s = best;
    }
    pgxSaveStr(PGX_ZOOM_KEY, s);
  }

  function pgxGetEditOn(){ return pgxLoadStr(PGX_EDIT_KEY, "0") === "1"; }
  function pgxSetEditOn(on){ pgxSaveStr(PGX_EDIT_KEY, on ? "1":"0"); }

  function pgxGetFineOn(){ return pgxLoadStr(PGX_FINE_KEY, "0") === "1"; }
  function pgxSetFineOn(on){ pgxSaveStr(PGX_FINE_KEY, on ? "1":"0"); }


  function pgxGetViewStart(){ return pgxLoadStr(PGX_VIEW_START_KEY, ""); }
  function pgxSetViewStart(v){ pgxSaveStr(PGX_VIEW_START_KEY, String(v||"")); }

  function pgxGetViewWeeks(){
    const v = +pgxLoadStr(PGX_VIEW_WEEKS_KEY, "0");
    return (v && v>0) ? v : 0; // 0 = usar baseWeeks
  }
  function pgxSetViewWeeks(w){
    const n = Math.max(0, Math.floor(+w||0));
    pgxSaveStr(PGX_VIEW_WEEKS_KEY, String(n));
  }


  function pgxGetSettingsOpen(){ return pgxLoadStr(PGX_SETTINGS_KEY, "0") === "1"; }
  function pgxSetSettingsOpen(on){ pgxSaveStr(PGX_SETTINGS_KEY, on ? "1":"0"); }



function pgxUpgradeProgram(p, baseWeeks){
  try{
    if (!p || !p.config || !Array.isArray(p.config.lanes)) return p;
    const keys = new Set(p.config.lanes.map(x=>String(x.key||"").toLowerCase()));
    // normaliza longitudes
    p.config.lanes.forEach(l=>{
      if (l.type==="cells"){
        const old = Array.isArray(l.values)? l.values:[];
        l.values = Array.from({length: baseWeeks}, (_,i)=> String(old[i]||""));
      }
    });
    return p;
  }catch(e){ return p; }
}

  function pgxProgramsForRole(){
    const store = pgxLoadStore();
    const baseWeeks = pgxTotalWeeks();
    const role = String(CURRENT_ROLE||"").toLowerCase();
    const uni = (role==="alumno") ? String((getAlumnoProfile()||{}).uni||"").toUpperCase() : "";

    const out = [];
    for (const id of store.order){
      let p = store.programs[id];
      if (p) p = pgxUpgradeProgram(p, baseWeeks);
      if (!p) continue;

      if (pgxCanEdit()){ out.push(p); continue; }

      const sc = String(p.meta?.scope||"ALL").toUpperCase();
      if (sc==="ALL") { out.push(p); continue; }
      if (role==="alumno"){
        if (uni && uni===sc) out.push(p);
      }else{
        // tutor: ver todos
        out.push(p);
      }
    }
    return out;
  }

  function pgxTotalWeeks(){
    const store = pgxLoadStore();
    const w = +store.timeline?.weeks || 16;
    return Math.max(1, Math.floor(w));
  }

  function pgxTimelineDates(){
    const store = pgxLoadStore();
    const baseWeeks = pgxTotalWeeks();
    const total = pgxTotalWeeks();
    const start = pgxParseDateYMD(String(store.timeline?.startDate||""));
    if (!start) return null;
    return Array.from({length: total}, (_,i)=>pgxAddDays(start, i*7));
  }

  function pgxMonthRuns(dates){
    if (!dates || !dates.length) return [];
    const runs = [];
    let curKey="", curLab="", curSpan=0;
    for (let i=0;i<dates.length;i++){
      const d = dates[i];
      const key = `${d.getFullYear()}-${d.getMonth()}`;
      const lab = pgxMonthNameES(d);
      if (key !== curKey){
        if (curSpan>0) runs.push({label:curLab, span:curSpan});
        curKey=key; curLab=lab; curSpan=1;
      }else curSpan++;
    }
    if (curSpan>0) runs.push({label:curLab, span:curSpan});
    return runs;
  }

  function pgxMonthEnds(dates){
    const ends = new Set();
    if (!dates) return ends;
    for (let i=0;i<dates.length;i++){
      const a = dates[i], b = dates[i+1];
      if (i===dates.length-1 || a.getMonth()!==b.getMonth() || a.getFullYear()!==b.getFullYear()){
        ends.add(i+1); // week number 1-based
      }
    }
    return ends;
  }

  function pgxGroupValues(values, fine){
    // values: array length weeks
    const out = [];
    const n = values.length;
    if (fine){
      for (let i=0;i<n;i++) out.push({text:String(values[i]||""), start:i+1, span:1});
      return out;
    }
    let i=0;
    while (i<n){
      const t = String(values[i]||"");
      let j=i+1;
      while (j<n && String(values[j]||"")===t) j++;
      out.push({text:t, start:i+1, span:(j-i)});
      i=j;
    }
    return out;
  }


  function pgxWeekDiff(a, b){
    // diferencia en semanas (redondeada) entre dos fechas (a - b)
    if (!a || !b) return 0;
    const ms = a.getTime() - b.getTime();
    return Math.round(ms / (7*24*60*60*1000));
  }

  function pgxRenderSheet(programs, mode){
    const store = pgxLoadStore();
    const baseWeeks = pgxTotalWeeks();

    const z = pgxGetZoom();
    const fine = pgxGetFineOn();
    const edit = pgxCanEdit() && pgxGetEditOn();

    const viewStartStr = pgxGetViewStart() || String(store.timeline?.startDate||"");
    const viewWeeksRaw = pgxGetViewWeeks() || baseWeeks;
    const displayWeeks = Math.max(1, Math.floor(+viewWeeksRaw || baseWeeks));

    const baseStart0 = pgxParseDateYMD(String(viewStartStr||""));

    // ✅ Encabezado FIJO: usa SOLO la fecha global (no se mueve por programas)
    const baseStart = baseStart0 || new Date();

    // ✅ Offset por programa (en semanas) respecto al encabezado fijo
    const offsets = new Map();
    for (const p of (programs||[])){
      const pStart = pgxParseDateYMD(String(p?.meta?.startDate||"")) || baseStart0 || baseStart;
      const off = pgxWeekDiff(pStart, baseStart); // puede ser negativo
      offsets.set(p.id, off);
    }

    const manualDates = Array.isArray(store.timeline?.manualDates) ? store.timeline.manualDates : null;
    // Fechas visibles del encabezado (ventana global fija)
    const dates = Array.from({length: displayWeeks}, (_,i)=>pgxAddDays(baseStart, i*7));
    const monthRuns = pgxMonthRuns(dates);
    const monthEnds = pgxMonthEnds(dates);


    let _accM = 0;
    const headMonths = monthRuns.length
      ? monthRuns.map((r)=>{
          _accM += (+r.span||0);
          const cls = (_accM < displayWeeks) ? "pxMonth pxMonthEnd" : "pxMonth";
          return `<th class="${cls}" colspan="${r.span}">${escapeHtml(r.label)}</th>`;
        }).join("")
      : `<th class="pxMonth" colspan="${displayWeeks}">—</th>`;

    const headDates = (manualDates && manualDates.length === displayWeeks)
      ? manualDates.map((s,i)=>{
          const wk = i+1;
          const cls = "pxDate";
          const txt = String(s||"").trim() || (dates[i] ? pgxFmtDDMM(dates[i]) : String(wk));
          return `<th class="${cls}">${escapeHtml(txt)}</th>`;
        }).join("")
      : dates.map((d,i)=>{
          const wk = i+1;
          const cls = "pxDate";
          return `<th class="${cls}">${escapeHtml(pgxFmtDDMM(d))}</th>`;
        }).join("");

    const thead = `
      <thead>
        <tr class="pxHdr1">
          <th class="pxCorner" colspan="2" rowspan="2">PROGRAMACIÓN</th>
          ${headMonths}
        </tr>
        <tr class="pxHdr2">
          ${headDates}
        </tr>
      </thead>
    `;

    const OUT = "__PGX_OUT__"; // marcador interno (no visible), evita merges fuera de ventana/fecha

    function segToWeekTexts(segments, n){
      const seg = Array.isArray(segments) ? segments : [];
      const out = [];
      let acc = 0;
      for (const s of seg){
        const sp  = Math.max(0, +s.span || 0);
        const txt = String(s.text || "");
        for (let i=0;i<sp;i++){
          if (acc < n) out.push(txt);
          acc++;
          if (out.length >= n) break;
        }
        if (out.length >= n) break;
      }
      while (out.length < n) out.push("");
      return out.slice(0, n);
    }

    function compressToSegments(arr){
      const out = [];
      let i=0;
      while (i < arr.length){
        const t = arr[i];
        let j=i+1;
        while (j < arr.length && arr[j] === t) j++;
        out.push({text:t, span:(j-i), start:(i+1)});
        i=j;
      }
      return out;
    }

    // ✅ cuerpo por programa
    const colCount = 2 + displayWeeks;
    const tbodyRows = (programs||[]).map((p,progIdx)=>{
      const name = String(p.meta?.name||"PROGRAMA").toUpperCase();
      const colors = pgxProgramColors(p);
      const win = pgxProgramWindow(p, baseWeeks);
      const wStart = win.start;
      const wEnd   = win.end;

      const off = offsets.get(p.id) || 0;

      // normaliza lanes (longitud baseWeeks)
      const lanes0 = (p.config?.lanes||[]).slice();
      const laneRows = lanes0.filter(l=>l && l.key && l.label && String(l.key||"").toLowerCase()!=="eventos");

      laneRows.forEach(l=>{
        if (l.type==="cells"){
          const v = Array.isArray(l.values) ? l.values : [];
          if (v.length !== baseWeeks){
            l.values = Array.from({length: baseWeeks}, (_,i)=> String(v[i]||""));
          }
        }
        if (l.type==="segments"){
          const seg0 = Array.isArray(l.segments) ? l.segments : [];
          // asegurar sumatoria == baseWeeks
          let sum = seg0.reduce((a,s)=>a+(+s.span||0),0);
          const seg = seg0.slice();
          if (sum < baseWeeks) seg.push({text:"", span:(baseWeeks-sum)});
          if (sum > baseWeeks){
            let acc=0; const out=[];
            for (const s of seg){
              const sp = +s.span||0;
              if (!sp) continue;
              if (acc + sp <= baseWeeks){ out.push(s); acc += sp; }
              else{
                const rem = baseWeeks - acc;
                if (rem>0) out.push({text:s.text, span:rem});
                acc = baseWeeks;
                break;
              }
            }
            l.segments = out;
          } else {
            l.segments = seg;
          }
        }
      });

      const rowSpan = 1 + laneRows.length;
      const progCell = `
        <th class="pxProg" rowspan="${rowSpan}" style="background:${colors.bar};">
          <div class="pxProgV">${escapeHtml(name)}</div>
        </th>
      `;

      // ACTIVIDAD (semana local, alineada por fecha inicio del programa)
      const actCells = Array.from({length: displayWeeks}, (_,i)=>{
        const gw = i+1;
        const localW = gw - off;
        const inLocal = (localW >= 1 && localW <= baseWeeks);
        const inWin   = inLocal && (localW >= wStart && localW <= wEnd);

        let cls = "pxW";
        if (!inWin) cls += " pxWOff";

        const bg  = inWin ? colors.cell : colors.off;
        const lbl = inWin ? String(localW) : "";

        return `<td class="${cls}" style="background:${bg}; font-weight:1000;">${lbl}</td>`;
      }).join("");

      const actRow = `
        <tr class="pxActRow pxPRow pxPTop">
          ${progCell}
          <th class="pxRowHead pxActHead" style="background:${colors.bar}; color:#fff;">ACTIVIDAD</th>
          ${actCells}
        </tr>
      `;

      const laneHtml = laneRows.map((l,li)=>{
        const gridRow = progIdx*100 + li + 1;
        const label = String(l.label||"").trim();
        const isLast = (li === laneRows.length-1);
        const rowCls = "pxPRow" + (isLast ? " pxPBot" : "");

        // ETAPA (segments) – no editable (pero centrado)
        if (l.type==="segments"){
          const weekTxt = segToWeekTexts(l.segments, baseWeeks);

          // aplicar ventana y mapear a global
          const g = Array.from({length: displayWeeks}, ()=>OUT);
          for (let lw=1; lw<=baseWeeks; lw++){
            const gi = off + (lw-1);
            if (gi < 0 || gi >= displayWeeks) continue;
            if (lw < wStart || lw > wEnd){ g[gi] = OUT; continue; }
            g[gi] = String(weekTxt[lw-1]||"");
          }

          const segs = compressToSegments(g);
          const tds = segs.map(s=>{
            const sp = +s.span||1;
            const txt = String(s.text||"");
            if (txt === OUT){
              const cls = "pxSeg pxWOff";
              return `<td class="${cls}" colspan="${sp}" style="background:${colors.off};">&nbsp;</td>`;
            }
            return `<td class="pxSeg pxEtapaCell" colspan="${sp}">${escapeHtml(txt) || "&nbsp;"}</td>`;
          }).join("");

          return `
            <tr class="${rowCls}">
              <th class="pxRowHead">${escapeHtml(label)}</th>
              ${tds}
            </tr>
          `;
        }

        // CELDAS (editable)
        const vals = Array.isArray(l.values) ? l.values : Array.from({length: baseWeeks}, ()=>"");

        const g = Array.from({length: displayWeeks}, ()=>OUT);
        for (let lw=1; lw<=baseWeeks; lw++){
          const gi = off + (lw-1);
          if (gi < 0 || gi >= displayWeeks) continue;
          if (lw < wStart || lw > wEnd){ g[gi] = OUT; continue; }
          g[gi] = String(vals[lw-1]||"");
        }

        const tds = (edit ? g.map((txt,idx)=>({text:String(txt||""),span:1,start:idx+1})) : pgxGroupValues(g, fine)).map(gr=>{
          const txt = String(gr.text||"");
          const sp  = +gr.span||1;
          const gStart = +gr.start||1;

          const isOut = (txt === OUT);
          const localStart = gStart - off; // 1-based
          const okLocal = (localStart >= 1 && localStart <= baseWeeks);

          const canEdit = edit && !isOut && okLocal && sp===1;

          const data = !canEdit ? "" :
            `data-pgid="${escapeHtml(p.id)}" data-lane="${escapeHtml(l.key)}" data-week="${localStart}" data-gridrow="${gridRow}" data-gridcol="${gStart}" data-value="${escapeHtml(txt)}"`;

          const cls = "pxCell" + (canEdit ? " pxEditable" : "") + (isOut ? " pxWOff" : "");
          const content = isOut ? "&nbsp;" : (escapeHtml(txt) || "&nbsp;");

          const bgStyle = isOut ? `background:${colors.off};` : `background:#ffffff;`;
          return `<td class="${cls}" colspan="${sp}" ${data} style="${bgStyle}"><div class="pxCellIn">${content}</div></td>`;
        }).join("");

        return `
          <tr class="${rowCls}">
            <th class="pxRowHead">${escapeHtml(label)}</th>
            ${tds}
          </tr>
        `;
      }).join("");

      return actRow + laneHtml + `<tr class="pxGap"><td colspan="${colCount}" aria-hidden="true"></td></tr>`;
    }).join("");

    const tbody = `<tbody>${tbodyRows}</tbody>`;

    return `
      <div class="pxSheetWrap">
        <div class="pxSheetScroll" id="pgxScroll">
          <div class="pxZoom" style="zoom:${z};">
            <table class="pxSheet">
              ${thead}
              ${tbody}
            </table>
          </div>
        </div>
      </div>
    `;
  }


  function pgxFillProgramSelect(programs){
    const sel = document.getElementById("pgxProgram");
    if (!sel) return;
    const active = pgxGetActiveId() || (programs[0]?.id||"");
    sel.innerHTML = programs.map(p=>{
      const nm = String(p.meta?.name||"PROGRAMA").toUpperCase();
      const sc = String(p.meta?.scope||"ALL").toUpperCase();
      return `<option value="${escapeHtml(p.id)}">${escapeHtml(nm)}</option>`;
    }).join("");
    sel.value = active;
  }

  function pgxApplyHeaderUI(){
    const mode  = document.getElementById("pgxMode");
    const sel   = document.getElementById("pgxProgram");
    const zoom  = document.getElementById("pgxZoom");
    const start = document.getElementById("pgxStart");
    const weeks = document.getElementById("pgxWeeks");
    const apply = document.getElementById("pgxApply");
    const edit  = document.getElementById("pgxEdit");

    const fine = document.getElementById("pgxFine");
    const fill = document.getElementById("pgxFill");
    const btnNew = document.getElementById("pgxNew");
    const btnDel = document.getElementById("pgxDel");
    const btnJson = document.getElementById("pgxJson");
    const btnSet = document.getElementById("pgxSettingsBtn");
    const btnDates = document.getElementById("pgxDates");
    const btnSave = document.getElementById("pgxSave");
    const btnCreate = document.getElementById("pgxCreate");
    const createType = document.getElementById("pgxCreateType");

    const store = pgxLoadStore();
    const baseWeeks = pgxTotalWeeks();
    const vStart = pgxGetViewStart() || String(store.timeline?.startDate||"");
    const vWeeks = pgxGetViewWeeks() || baseWeeks;
    if (start) start.value = String(vStart||"");
    if (weeks) weeks.value = String(vWeeks||baseWeeks);
    
    // Calcula FIN solo para visualización (start + weeks)
    const endInp = document.getElementById("pgxEnd");
    if (endInp){
      const sd = pgxParseDateYMD(String(vStart||""));
      const wv = Math.max(1, Math.floor(+vWeeks||baseWeeks));
      if (sd){
        const ed = new Date(sd.getTime() + (wv-1)*7*24*60*60*1000);
        const yyyy = ed.getFullYear();
        const mm = String(ed.getMonth()+1).padStart(2,"0");
        const dd = String(ed.getDate()).padStart(2,"0");
        endInp.value = `${yyyy}-${mm}-${dd}`;
      } else endInp.value = "";
    }
if (zoom) zoom.value = pgxZoomOption(pgxGetZoom());
    if (mode) mode.value = pgxGetMode();

    const admin = pgxCanEdit();
    const editOn = admin && pgxGetEditOn();

    if (edit){
      edit.style.display = admin ? "" : "none";
      edit.textContent = editOn ? "EDITANDO" : "EDITAR";
      edit.classList.toggle("primary", editOn);
    }
// Navegación de fechas visible fuera del editor
    [start, weeks, apply].forEach(el=>{ if (el) el.style.display = ""; });

    if (admin){
      // Controles de vista avanzados solo dentro de editar
      [mode, sel, zoom, fine, fill, btnSave, createType, btnCreate, btnSet, btnDel].forEach(el=>{ if (el) el.style.display = editOn ? "" : "none"; });
      // Avanzados escondidos para simplificar
      [btnNew, btnJson, btnDates].forEach(el=>{ if (el) el.style.display = "none"; });
    } else {
      [mode, zoom].forEach(el=>{ if (el) el.style.display = ""; });
      if (sel) sel.style.display = "none";
      [fine, fill, btnNew, btnDel, btnJson, btnSet, btnDates, btnSave, createType, btnCreate].forEach(el=>{ if (el) el.style.display = "none"; });
    }

    if (admin && sel && mode) sel.style.display = (mode.value==="ONE") ? "" : "none";
    if (btnSet && admin){
      btnSet.textContent = (editOn && pgxGetSettingsOpen()) ? "OCULTAR PERSONALIZAR" : "PERSONALIZAR";
    }
  }


  function pgxSegmentsFromPrompt(raw, totalWeeks){
    const s = String(raw||"").trim();
    if (!s) return null;
    const parts = s.split("|").map(x=>x.trim()).filter(Boolean);
    const seg = [];
    for (const p of parts){
      const idx = p.lastIndexOf(":");
      if (idx < 0) continue;
      const txt = String(p.slice(0, idx)||"").trim();
      const span = parseInt(String(p.slice(idx+1)||"").trim(), 10);
      if (!Number.isFinite(span) || span < 1) continue;
      seg.push({text:txt, span});
    }
    if (!seg.length) return null;

    let sum = seg.reduce((a,x)=>a+(+x.span||0),0);
    if (sum < totalWeeks) seg.push({text:"", span:(totalWeeks-sum)});
    if (sum > totalWeeks){
      let acc=0; const out=[];
      for (const s2 of seg){
        const sp = +s2.span||0;
        if (!sp) continue;
        if (acc+sp<=totalWeeks){ out.push(s2); acc+=sp; }
        else{
          const rem = totalWeeks-acc;
          if (rem>0) out.push({text:s2.text, span:rem});
          acc=totalWeeks; break;
        }
      }
      return out;
    }
    return seg;
  }

  // Normaliza string a input[type=color]
  function pgxToColor(s){
    const v = String(s||"").trim();
    if (/^#[0-9a-fA-F]{6}$/.test(v)) return v;
    const m = /^rgba?\((\d+),\s*(\d+),\s*(\d+)/.exec(v);
    if (m){
      const r = pgxClamp255(m[1]); const g = pgxClamp255(m[2]); const b = pgxClamp255(m[3]);
      return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,"0")).join("");
    }
    return "#64748b";
  }
  function pgxClamp255(x){
    const n = parseInt(x,10);
    if (!Number.isFinite(n)) return 0;
    return Math.max(0, Math.min(255, n));
  }

  function pgxRenderSettings(programs){
    const wrap = document.getElementById("pgxSettings");
    if (!wrap) return;
    if (!pgxCanEdit() || !pgxGetEditOn()){ wrap.style.display="none"; return; }
    // En modo edición siempre se muestra el panel
    wrap.style.display = "";


    // Respeta el toggle PERSONALIZAR
    const open = !!pgxGetSettingsOpen();
    if (!open){ wrap.style.display = "none"; wrap.innerHTML = ""; return; }
    const active = pgxGetActiveId() || (programs[0]?.id||"");
    const p = programs.find(x=>x.id===active) || programs[0];
    if (!p){ wrap.innerHTML=""; return; }

    const totalWeeks = pgxTotalWeeks();
    const win = pgxProgramWindow(p, totalWeeks);
    const colors = pgxProgramColors(p);

    const lanes = (p.config?.lanes||[]).filter(l=>l && l.key && l.label && String(l.key||"").toLowerCase()!=="eventos");
    const laneHtml = lanes.map(l=>`
      <div class="pgxLaneItem">
        <div class="k">${escapeHtml(l.key)}</div>
        <input type="text" data-lane-key="${escapeHtml(l.key)}" value="${escapeHtml(l.label)}"/>
      </div>
    `).join("");

    wrap.innerHTML = `
      <div class="pgxSetTitle">PERSONALIZAR PROGRAMA</div>

      <div class="pgxSetGrid">
        <label>PROGRAMA
          <select id="pgsPick">
            ${programs.map(pp=>{
              const nm = String(pp.meta?.name||"PROGRAMA").toUpperCase();
              return `<option value="${escapeHtml(pp.id)}"${pp.id===p.id?" selected":""}>${escapeHtml(nm)}</option>`;
            }).join("")}
          </select>
        </label>

        <label>NOMBRE
          <input id="pgsName" type="text" value="${escapeHtml(String(p.meta?.name||""))}"/>
        </label>

        <label>SCOPE
          <select id="pgsScope">
            ${["ALL","AGRARIA","PUCP","U.LIMA"].map(x=>`<option value="${x}"${String(p.meta?.scope||"ALL").toUpperCase()===x?" selected":""}>${x}</option>`).join("")}
          </select>
        </label>

        <label>TEMA
          <select id="pgsTheme">
            ${["AGRARIA","U.LIMA","PUCP","ESCOLARES"].map(x=>`<option value="${x}"${String(p.meta?.theme||"AGRARIA").toUpperCase()===x?" selected":""}>${x}</option>`).join("")}
          </select>
        </label>


        <label class="pgxDateField">INICIO PROGRAMA (EDICIÓN)
          <input id="pgsStartDate" type="date" value="${escapeHtml(String(p.meta?.startDate||""))}"/>
        </label>

        <label class="pgxDateField">FIN PROGRAMA (EDICIÓN)
          <input id="pgsEndDate" type="date" value="${escapeHtml(String(p.meta?.endDate||""))}"/>
        </label>

<label>SEMANA INICIO PROGRAMA
          <input id="pgsStartW" type="number" min="1" max="${totalWeeks}" value="${win.start}"/>
        </label>

        <label>SEMANA FIN PROGRAMA
          <input id="pgsEndW" type="number" min="1" max="${totalWeeks}" value="${win.end}"/>
        </label>

        <label>COLOR BARRA
          <input id="pgsBar" type="color" value="${pgxToColor(colors.bar)}"/>
        </label>

        <label>COLOR SEMANA
          <input id="pgsCell" type="color" value="${pgxToColor(colors.cell)}"/>
        </label>

        <label>COLOR FUERA VENTANA
          <input id="pgsOff" type="color" value="${pgxToColor(colors.off)}"/>
        </label>
      </div>

      <div class="pgxSetRow">
        <button id="pgsSave" class="btn ghost" type="button">GUARDAR</button>
        <button id="pgsEtapa" class="btn ghost" type="button">EDITAR ETAPA</button>
        <button id="pgsResetCols" class="btn ghost" type="button">RESET COLORES</button>
        <button id="pgsDelete" class="btn ghost" type="button">ELIMINAR PROGRAMA</button>
      </div>

      <div class="pgxSetTitle" style="margin-top:14px;">NOMBRES DE FILAS</div>
      <div class="pgxLaneWrap" id="pgsLaneWrap">${laneHtml}</div>

      <div style="margin-top:10px; color:var(--muted); font-weight:900;">
        Tip: “EDITAR ETAPA” usa formato <b>TEXTO:SPAN|TEXTO:SPAN</b>. Ej: NIVELACIÓN:3|AVANCE TEÓRICO:10|REPASO:3
      </div>
    `;

    // ✅ Auto: al cambiar INICIO/FIN, ajusta SEMANA INICIO/FIN para edición rápida
    function pgxAutoWeeksFromDates(){
      const sStr = String(document.getElementById("pgsStartDate")?.value||"").trim();
      const eStr = String(document.getElementById("pgsEndDate")?.value||"").trim();
      const sD = pgxParseDateYMD(sStr);
      const eD = pgxParseDateYMD(eStr);
      if (!sD || !eD) return;
      let a = sD, b = eD;
      if (b.getTime() < a.getTime()){ const t=a; a=b; b=t; }
      const span = Math.max(1, Math.floor((b.getTime()-a.getTime())/(7*24*60*60*1000)) + 1);
      const tw = pgxTotalWeeks();
      const endW = Math.max(1, Math.min(tw, span));
      const sWEl = document.getElementById("pgsStartW");
      const eWEl = document.getElementById("pgsEndW");
      if (sWEl) sWEl.value = "1";
      if (eWEl) eWEl.value = String(endW);
    }
    document.getElementById("pgsStartDate")?.addEventListener("change", pgxAutoWeeksFromDates);
    document.getElementById("pgsEndDate")?.addEventListener("change", pgxAutoWeeksFromDates);

    // wire
    document.getElementById("pgsPick")?.addEventListener("change", (e)=>{
      pgxSetActiveId(String(e.target.value||""));
      renderPrograma();
    });

    document.getElementById("pgsSave")?.addEventListener("click", ()=>{
      const store = pgxLoadStore();
    const baseWeeks = pgxTotalWeeks();
      const id = pgxGetActiveId();
      const pp = store.programs[id];
      if (!pp) return;

      pp.meta = pp.meta || {};
      pp.meta.name  = String(document.getElementById("pgsName")?.value||"").trim().toUpperCase() || "PROGRAMA";
      pp.meta.scope = String(document.getElementById("pgsScope")?.value||"ALL").trim().toUpperCase();
      pp.meta.theme = String(document.getElementById("pgsTheme")?.value||"AGRARIA").trim().toUpperCase();



      // ✅ NUEVO: fecha inicio independiente por programa (YYYY-MM-DD). Vacío = usa BASE.
      const sd = String(document.getElementById("pgsStartDate")?.value||"").trim();
      if (sd) pp.meta.startDate = sd; else delete pp.meta.startDate;
      const ed = String(document.getElementById("pgsEndDate")?.value||"").trim();
      if (ed) pp.meta.endDate = ed; else delete pp.meta.endDate;
const tw = pgxTotalWeeks();
      let sW = parseInt(document.getElementById("pgsStartW")?.value||"1",10);
      let eW = parseInt(document.getElementById("pgsEndW")?.value||String(tw),10);
      if (!Number.isFinite(sW)) sW = 1;
      if (!Number.isFinite(eW)) eW = tw;
      sW = Math.max(1, Math.min(tw, sW));
      eW = Math.max(1, Math.min(tw, eW));
      if (eW < sW){ const tmp=sW; sW=eW; eW=tmp; }
      pp.meta.startWeek = sW;
      pp.meta.endWeek = eW;

      pp.meta.colors = pp.meta.colors || {};
      pp.meta.colors.bar  = String(document.getElementById("pgsBar")?.value||"").trim();
      pp.meta.colors.cell = String(document.getElementById("pgsCell")?.value||"").trim();
      pp.meta.colors.off  = String(document.getElementById("pgsOff")?.value||"").trim();

      const wrap2 = document.getElementById("pgsLaneWrap");
      const lanes2 = (pp.config?.lanes||[]);
      if (wrap2){
        wrap2.querySelectorAll("input[data-lane-key]").forEach(inp=>{
          const k = String(inp.getAttribute("data-lane-key")||"");
          const v = String(inp.value||"").trim();
          const l = lanes2.find(x=>String(x.key||"")===k);
          if (l && v) l.label = v;
        });
      }

      pp.meta.updatedAt = pgxNowISO();
      store.programs[id]=pp;
      pgxSaveStore(store);
      toast("Guardado.");
      renderPrograma();
    });

    document.getElementById("pgsEtapa")?.addEventListener("click", ()=>{
      const store = pgxLoadStore();
    const baseWeeks = pgxTotalWeeks();
      const id = pgxGetActiveId();
      const pp = store.programs[id];
      if (!pp) return;

      const tw = pgxTotalWeeks();
      const curSeg = (pp.config?.lanes||[]).find(x=>x.key==="etapa")?.segments || [];
      const curStr = curSeg.map(s=>`${String(s.text||"").trim()}:${+s.span||0}`).join("|");
      const raw = prompt("Editar ETAPA (TEXTO:SPAN|...). Suma debe ser "+tw+".", curStr);
      if (raw===null) return;
      const seg = pgxSegmentsFromPrompt(raw, tw);
      if (!seg){ alert("Formato inválido."); return; }

      const lane = (pp.config?.lanes||[]).find(x=>x.key==="etapa");
      if (lane){
        lane.segments = seg;
        pp.config.etapaSegments = seg;
      }
      pp.meta.updatedAt = pgxNowISO();
      store.programs[id]=pp;
      pgxSaveStore(store);
      toast("Etapa actualizada.");
      renderPrograma();
    });

    document.getElementById("pgsResetCols")?.addEventListener("click", ()=>{
      const store = pgxLoadStore();
      const id = pgxGetActiveId();
      const pp = store.programs[id];
      if (!pp) return;
      if (pp.meta) delete pp.meta.colors;
      pp.meta.updatedAt = pgxNowISO();
      store.programs[id]=pp;
      pgxSaveStore(store);
      toast("Colores reseteados.");
      renderPrograma();
    });

    document.getElementById("pgsDelete")?.addEventListener("click", ()=>{
      const store = pgxLoadStore();
      const id = pgxGetActiveId();
      if (!id || !store.programs[id]) return;
      const label = String(store.programs[id]?.meta?.name||"PROGRAMA").toUpperCase();
      if (!confirm(`¿Eliminar programa ${label}?`)) return;
      delete store.programs[id];
      store.order = (store.order||[]).filter(x=>x!==id);
      pgxSaveStore(store);
      toast("Colores reseteados.");
      renderPrograma();
      pgxScheduleRelayout();
    try{ setTimeout(()=>{ try{ pgxWireHNav(); }catch(e){} }, 0); }catch(e){}
  });

    document.getElementById("pgsName")?.addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        document.getElementById("pgsSave")?.click();
      }
    });
  }



  let PGX_DEFAULT_MODE_APPLIED = false;

  function pgxScheduleRelayout(){
    const sc = document.getElementById("pgxScroll");
    if (!sc) return;
    requestAnimationFrame(()=>{
      try{ fitProgramaMatrixHeight(); }catch(e){}
      void sc.offsetHeight;
      try{ pgxWireHNav(); }catch(e){}
    });
  }

  function fitProgramaMatrixHeight(){
    const sc = document.getElementById("pgxScroll");
    if (!sc) return;
    sc.style.height = "";
    sc.style.maxHeight = "calc(100vh - 230px)";
    sc.style.width = "100%";
    sc.style.maxWidth = "100%";
  }

  function pgxNextProgramName(cycle, store){
    const names = (store.order||[]).map(id=>String(store.programs?.[id]?.meta?.name||"").toUpperCase());
    let maxN = 0;
    for (const n of names){
      const m = new RegExp(`^${cycle.replace('.','\.')}\s*(\d+)?$`).exec(n.trim());
      if (!m) continue;
      const num = m[1] ? parseInt(m[1],10) : 1;
      if (num > maxN) maxN = num;
    }
    return `${cycle} ${Math.max(2, maxN+1)}`;
  }

  function pgxCreateProgramFlow(){
    if (!pgxCanEdit() || !pgxGetEditOn()) return;
    const kind = String(document.getElementById("pgxCreateType")?.value||"AGRARIA").toUpperCase();
    const allowed = ["AGRARIA","U.LIMA","PUCP","ESCOLARES"];
    if (!allowed.includes(kind)) return;
    const store = pgxLoadStore();
    const autoName = pgxNextProgramName(kind, store);
    const customName = prompt("Nombre del nuevo programa:", autoName);
    if (customName===null) return;
    const name = String(customName||"").trim().toUpperCase() || autoName;
    const p = pgxDefaultProgram(name, kind, kind);
    store.programs[p.id]=p;
    pgxInsertProgramId(store, p);
    pgxSaveStore(store);
    pgxSetActiveId(p.id);
    pgxSetMode("ONE");
    pgxSetSettingsOpen(true);
    renderPrograma();
    requestAnimationFrame(()=>{
      const nameInput = document.getElementById("pgsName");
      if (nameInput){ nameInput.focus(); nameInput.select(); }
    });
    toast("Programa creado. Puedes editar el nombre en PERSONALIZAR.");
  }

  function pgxEnsureProgramaLayout(){
    const el = document.getElementById("view_programa");
    if (!el || el.dataset.ready==="1") return;

    // ✅ Por defecto: SIEMPRE iniciar en "TODOS" (no persiste ONE al recargar)
    if (!PGX_DEFAULT_MODE_APPLIED){
      try{ pgxSetMode("ALL"); }catch(e){}
      PGX_DEFAULT_MODE_APPLIED = true;
    }

    el.innerHTML = `
      <div class="card panel12">
        <div class="cardtitle">PROGRAMA</div>
        <div class="controls" style="justify-content:flex-start; gap:10px; flex-wrap:wrap;">
          <button id="pgxEdit" class="btn ghost" type="button">EDITAR</button>
          <select id="pgxProgram"></select>

          <select id="pgxZoom">
            <option value="1">ZOOM: 100%</option>
            <option value="0.95">ZOOM: 95%</option>
            <option value="0.90">ZOOM: 90%</option>
            <option value="0.85">ZOOM: 85%</option>
            <option value="0.80">ZOOM: 80%</option>
            <option value="0.75">ZOOM: 75%</option>
            <option value="0.70">ZOOM: 70%</option>
          </select>

          <button id="pgxFine" class="btn ghost" type="button">EDICIÓN FINA: OFF</button>
          <button id="pgxFill" class="btn ghost" type="button">RELLENAR RANGO</button>

          <input id="pgxStart" type="date" style="min-width:160px;" />
                    <input id="pgxEnd" type="date" style="min-width:160px;" />

          <input id="pgxWeeks" type="number" min="1" step="1" style="width:110px;" />
          <button id="pgxApply" class="btn ghost" type="button">APLICAR</button>

          <button id="pgxNew" class="btn ghost" type="button">+ NUEVO</button>
          <button id="pgxDel" class="btn ghost" type="button">ELIMINAR</button>
          <button id="pgxJson" class="btn ghost" type="button">EDITOR JSON</button>
          <button id="pgxSettingsBtn" class="btn ghost" type="button">PERSONALIZAR</button>
          <button id="pgxDates" class="btn ghost" type="button">FECHAS MANUAL</button>
          <button id="pgxSave" class="btn ghost" type="button">GUARDAR</button>

          <select id="pgxCreateType">
            <option value="AGRARIA">CICLO: AGRARIA</option>
            <option value="U.LIMA">CICLO: U.LIMA</option>
            <option value="PUCP">CICLO: PUCP</option>
            <option value="ESCOLARES">CICLO: ESCOLARES</option>
          </select>
          <button id="pgxCreate" class="btn ghost" type="button">+ CREAR PROGRAMA</button>
        </div>

        <div class="pgHint" id="pgxHint" style="margin-top:8px;"></div>
        <div id="pgxSettings" class="pgxSettings" style="display:none;"></div>
      </div>

      <div class="card panel12">
        <div id="pgxMatrixHost" class="pgxMatrixHost">
          <div id="pgxCanvas"></div>

          <div id="pgxHNav" class="pgxHNav" aria-label="Desplazamiento horizontal">
            <button id="pgxHLeft" class="pgxHBtn" type="button">◀</button>
            <input id="pgxHRange" class="pgxHRange" type="range" min="0" max="0" value="0" step="1"/>
            <button id="pgxHRight" class="pgxHBtn" type="button">▶</button>
          </div>
        </div>
      </div>
    `;

    const mode = document.getElementById("pgxMode");
    const prog = document.getElementById("pgxProgram");
    const zoom = document.getElementById("pgxZoom");
    const edit = document.getElementById("pgxEdit");
    const fine = document.getElementById("pgxFine");
    const btnFill = document.getElementById("pgxFill");
    const btnApply = document.getElementById("pgxApply");
    const btnNew = document.getElementById("pgxNew");
    const btnDel = document.getElementById("pgxDel");
    const btnJson = document.getElementById("pgxJson");
    const btnSet = document.getElementById("pgxSettingsBtn");
    const btnDates = document.getElementById("pgxDates");
    const btnSave = document.getElementById("pgxSave");
    const btnCreate = document.getElementById("pgxCreate");

    if (mode) mode.addEventListener("change", ()=>{ pgxSetMode(mode.value); pgxSaveStore(pgxLoadStore()); renderPrograma(); pgxScheduleRelayout(); });
    if (prog) prog.addEventListener("change", ()=>{ pgxSetActiveId(prog.value); pgxSaveStore(pgxLoadStore()); renderPrograma(); pgxScheduleRelayout(); });
    if (zoom) zoom.addEventListener("change", ()=>{ pgxSetZoom(zoom.value); pgxSaveStore(pgxLoadStore()); renderPrograma(); pgxScheduleRelayout(); });

    if (edit){
      edit.addEventListener("click", ()=>{
        if (!pgxCanEdit()) return;
        const on = !pgxGetEditOn();
        pgxSetEditOn(on);
        pgxSetSettingsOpen(on);
        if (on) pgxSetMode("ALL");
        if (!on) pgxSetFineOn(false);
        renderPrograma();
        pgxScheduleRelayout();
      });
    }

    if (fine){ fine.addEventListener("click", ()=>{ pgxSetFineOn(!pgxGetFineOn()); renderPrograma(); pgxScheduleRelayout(); }); }
    if (btnFill){
      btnFill.addEventListener("click", ()=>{
        if (!pgxCanEdit() || !pgxGetEditOn()) return;
        const store = pgxLoadStore();
        const pid = pgxGetActiveId();
        const p = store.programs[pid];
        if (!p) return;
        const lanes = (p.config?.lanes||[]).filter(l=>l && l.type==="cells");
        const laneKeys = lanes.map(l=>String(l.key||"")).filter(Boolean);
        const raw = prompt("RELLENAR RANGO (LANE,INICIO,FIN,TEXTO). LANES: "+laneKeys.join(", "), "semana,1,3,SEN1");
        if (raw===null) return;
        const parts = String(raw||"").split(",").map(x=>String(x||"").trim());
        if (parts.length < 4){ alert("Formato inválido. Usa: LANE,INICIO,FIN,TEXTO"); return; }
        const laneKeyIn = String(parts[0]||"").trim();
        const startW0 = parseInt(parts[1],10);
        const endW0 = parseInt(parts[2],10);
        const seed = parts.slice(3).join(",").trim();
        const lane = lanes.find(l=>String(l.key||"").toLowerCase()===laneKeyIn.toLowerCase()) || lanes.find(l=>String(l.label||"").toLowerCase()===laneKeyIn.toLowerCase());
        if (!lane){ alert("LANE no encontrada: "+laneKeyIn); return; }
        const tw = pgxTotalWeeks();
        let a = Number.isFinite(startW0)?startW0:1;
        let b = Number.isFinite(endW0)?endW0:tw;
        a=Math.max(1,Math.min(tw,a)); b=Math.max(1,Math.min(tw,b));
        if (b<a){ const t=a; a=b; b=t; }
        if (!seed){ alert("TEXTO vacío."); return; }
        const list = seed.includes("|") ? seed.split("|").map(x=>x.trim()).filter(Boolean) : null;
        const m = /^(.+?)(\d+)$/.exec(seed);
        const hasNum = !!m;
        const vals = Array.isArray(lane.values) ? lane.values : [];
        const pad = hasNum ? String(m[2]||"").length : 0;
        const baseNum = hasNum ? parseInt(m[2],10) : 0;
        const pref = hasNum ? String(m[1]||"") : seed;
        for (let w=a; w<=b; w++){
          let v = seed;
          if (list){ const idx=(w-a)%list.length; v=list[idx]; }
          else if (hasNum){ v=pref + String(baseNum+(w-a)).padStart(pad,"0"); }
          else v=pref;
          const i=w-1; if (i>=0 && i<tw) vals[i]=v;
        }
        lane.values = vals;
        p.meta.updatedAt = pgxNowISO();
        store.programs[pid] = p;
        pgxSaveStore(store);
        toast("Rango rellenado.");
        renderPrograma();
      });
    }

    if (btnApply){
      btnApply.addEventListener("click", ()=>{
        const s = String(document.getElementById("pgxStart")?.value||"").trim();
        const e = String(document.getElementById("pgxEnd")?.value||"").trim();
        let w = Math.max(1, Math.floor(+document.getElementById("pgxWeeks")?.value||16));
        if (s) pgxSetViewStart(s);
        // Si se define FIN (solo visualización), recalcula semanas automáticamente.
        if (s && e){
          const sd = pgxParseDateYMD(s);
          const ed = pgxParseDateYMD(e);
          if (sd && ed){
            const diff = Math.max(0, ed.getTime() - sd.getTime());
            const wk = Math.ceil(diff / (7*24*60*60*1000)) + 1;
            w = Math.max(1, Math.floor(wk));
            const wkInp = document.getElementById("pgxWeeks");
            if (wkInp) wkInp.value = String(w);
          }
        }
        pgxSetViewWeeks(w);
        renderPrograma();
        toast("Vista actualizada.");
        pgxSaveStore(pgxLoadStore());
        pgxScheduleRelayout();
      });
    }

    if (btnNew){ btnNew.addEventListener("click", ()=>{ if (!pgxCanEdit()||!pgxGetEditOn()) return; const name = prompt("Nombre del nuevo programa:", "NUEVO PROGRAMA"); if(!name) return; const kind=(prompt("Tipo (AGRARIA / U.LIMA / PUCP / ESCOLARES):", "AGRARIA")||"AGRARIA").toUpperCase(); const allowed=["AGRARIA","U.LIMA","PUCP","ESCOLARES"]; const theme=allowed.includes(kind)?kind:"AGRARIA"; const scope=theme; const store=pgxLoadStore(); const baseWeeks=pgxTotalWeeks(); const p=pgxDefaultProgram(name,scope,theme); const w=baseWeeks; p.config.lanes.forEach(l=>{ if(l.type==="cells") l.values=Array.from({length:w},(_,i)=>String(l.values?.[i]||"")); }); store.programs[p.id]=p; pgxInsertProgramId(store,p); pgxSaveStore(store); pgxSetActiveId(p.id); pgxSetMode("ONE"); renderPrograma(); toast("Programa creado."); pgxScheduleRelayout(); }); }
    if (btnDel){ btnDel.addEventListener("click", ()=>{ if(!pgxCanEdit()||!pgxGetEditOn()) return; const id=pgxGetActiveId(); if(!id) return; if(!confirm("¿Eliminar este programa?")) return; const store=pgxLoadStore(); delete store.programs[id]; store.order=store.order.filter(x=>x!==id); pgxSaveStore(store); pgxSetActiveId(store.order[0]||""); renderPrograma(); toast("Programa eliminado."); pgxScheduleRelayout(); }); }
    if (btnJson){ btnJson.addEventListener("click", ()=>{ if(!pgxCanEdit()||!pgxGetEditOn()) return; const id=pgxGetActiveId(); const store=pgxLoadStore(); const baseWeeks=pgxTotalWeeks(); let p=store.programs[id]; if(p) p=pgxUpgradeProgram(p,baseWeeks); if(!p) return; const raw=prompt("Editor JSON (pega JSON válido). Sugerencia: copia primero para respaldo.", JSON.stringify(p,null,2)); if(!raw) return; try{ const obj=JSON.parse(raw); if(!obj||!obj.id) throw new Error(); obj.meta=obj.meta||{}; obj.meta.updatedAt=pgxNowISO(); store.programs[obj.id]=obj; if(!store.order.includes(obj.id)) store.order.push(obj.id); pgxSaveStore(store); pgxSetActiveId(obj.id); renderPrograma(); toast("JSON guardado."); pgxScheduleRelayout(); }catch(e){ alert("JSON inválido. No se guardó."); } }); }
    if (btnSet){ btnSet.addEventListener("click", ()=>{ if(!pgxCanEdit()||!pgxGetEditOn()) return; pgxSetSettingsOpen(!pgxGetSettingsOpen()); renderPrograma(); pgxScheduleRelayout(); }); }
    if (btnDates){ btnDates.addEventListener("click", ()=>{ if(!pgxCanEdit()||!pgxGetEditOn()) return; const store=pgxLoadStore(); const baseWeeks=pgxTotalWeeks(); const cur=Array.isArray(store.timeline?.manualDates)?store.timeline.manualDates:[]; const raw=prompt("Pega las FECHAS (dd/mm) separadas por coma para cada semana (total "+baseWeeks+").", cur.join(",")); if(raw===null) return; const t=String(raw||"").trim(); if(!t){ if(store.timeline) delete store.timeline.manualDates; pgxSaveStore(store); toast("Fechas manuales eliminadas."); renderPrograma(); pgxScheduleRelayout(); return; } const parts=t.split(",").map(x=>x.trim()).filter(Boolean); if(parts.length!==baseWeeks){ alert("Cantidad inválida: se esperaban "+baseWeeks+" fechas y recibí "+parts.length+"."); return; } store.timeline.manualDates=parts; pgxSaveStore(store); toast("Fechas manuales guardadas."); renderPrograma(); pgxScheduleRelayout(); }); }

    if (btnSave){ btnSave.addEventListener("click", ()=>{ if(!pgxCanEdit()||!pgxGetEditOn()) return; const store=pgxLoadStore(); pgxSaveStore(store); pgxGridState.dirty=false; toast("Guardado."); }); }
    if (btnCreate){ btnCreate.addEventListener("click", pgxCreateProgramFlow); }

    el.dataset.ready="1";
  }


  const pgxGridState = {
    selected:null,
    range:null,
    editing:null,
    dragFill:null,
    history:[],
    redo:[],
    dirty:false,
  };

  function pgxPushHistory(change){
    if (!change) return;
    pgxGridState.history.push(change);
    if (pgxGridState.history.length > 200) pgxGridState.history.shift();
    pgxGridState.redo = [];
  }

  function pgxApplyCellValue(store, cell, value){
    if (!cell) return false;
    const p = store.programs[cell.pgid];
    if (!p) return false;
    const lane = (p.config?.lanes||[]).find(x=>String(x.key||"")===cell.lane);
    if (!lane || lane.type!=="cells") return false;
    const arr = Array.isArray(lane.values) ? lane.values : [];
    const idx = cell.week - 1;
    if (idx < 0 || idx >= arr.length) return false;
    arr[idx] = String(value||"");
    lane.values = arr;
    p.meta = p.meta || {};
    p.meta.updatedAt = pgxNowISO();
    store.programs[cell.pgid] = p;
    return true;
  }

  function pgxCellCtxFromTd(td){
    if (!td) return null;
    const pgid = String(td.getAttribute("data-pgid")||"");
    const lane = String(td.getAttribute("data-lane")||"");
    const week = +td.getAttribute("data-week")||0;
    const row = +td.getAttribute("data-gridrow")||0;
    const col = +td.getAttribute("data-gridcol")||0;
    if (!pgid || !lane || !week) return null;
    return {pgid,lane,week,row,col};
  }

  function pgxGetEditableCells(){
    return Array.from(document.querySelectorAll('#pgxCanvas td.pxEditable'));
  }

  function pgxFindCellByPos(row,col){
    return document.querySelector(`#pgxCanvas td.pxEditable[data-gridrow="${row}"][data-gridcol="${col}"]`);
  }

  function pgxSetSelectedCell(td, extend=false){
    if (!td) return;
    const ctx = pgxCellCtxFromTd(td);
    if (!ctx) return;
    if (!extend || !pgxGridState.selected){
      pgxGridState.selected = ctx;
      pgxGridState.range = {r1:ctx.row,c1:ctx.col,r2:ctx.row,c2:ctx.col};
    } else {
      pgxGridState.range = {r1:pgxGridState.selected.row,c1:pgxGridState.selected.col,r2:ctx.row,c2:ctx.col};
    }
    pgxRefreshSelectionUi();
  }

  function pgxRefreshSelectionUi(){
    const all = pgxGetEditableCells();
    all.forEach(td=>{ td.classList.remove('pxCellSelected','pxCellRange'); td.querySelector('.pxFillHandle')?.remove(); });
    const rg = pgxGridState.range;
    if (rg){
      const rMin = Math.min(rg.r1, rg.r2), rMax = Math.max(rg.r1, rg.r2);
      const cMin = Math.min(rg.c1, rg.c2), cMax = Math.max(rg.c1, rg.c2);
      all.forEach(td=>{
        const r = +td.getAttribute('data-gridrow')||0;
        const c = +td.getAttribute('data-gridcol')||0;
        if (r>=rMin && r<=rMax && c>=cMin && c<=cMax) td.classList.add('pxCellRange');
      });
    }
    const sel = pgxGridState.selected ? pgxFindCellByPos(pgxGridState.selected.row, pgxGridState.selected.col) : null;
    if (sel){
      sel.classList.add('pxCellSelected');
      const h = document.createElement('span');
      h.className = 'pxFillHandle';
      h.title = 'Arrastrar para rellenar';
      sel.appendChild(h);
    }
  }

  function pgxStartEditing(td){
    const ctx = pgxCellCtxFromTd(td);
    if (!ctx) return;
    pgxGridState.editing = ctx;
    const cur = td.getAttribute('data-value') || td.textContent || '';
    td.classList.add('pxCellEditing');
    td.innerHTML = `<input type="text" value="${escapeHtml(cur)}" />`;
    const inp = td.querySelector('input');
    if (!inp) return;
    inp.focus(); inp.select();
  }

  function pgxCommitEditing(save){
    const ed = pgxGridState.editing;
    if (!ed) return;
    const td = pgxFindCellByPos(ed.row, ed.col);
    if (!td) { pgxGridState.editing = null; return; }
    const inp = td.querySelector('input');
    const nextVal = inp ? String(inp.value||'') : '';
    const prevVal = String(td.getAttribute('data-value')||'');
    pgxGridState.editing = null;
    if (save && nextVal !== prevVal){
      const store = pgxLoadStore();
      if (pgxApplyCellValue(store, ed, nextVal)){
        pgxPushHistory({cells:[{...ed,before:prevVal,after:nextVal}]});
        pgxGridState.dirty = true;
        pgxSaveStore(store);
      }
    }
    renderPrograma();
  }

  function pgxCellsInRange(){
    const rg = pgxGridState.range;
    if (!rg) return [];
    const rMin = Math.min(rg.r1, rg.r2), rMax = Math.max(rg.r1, rg.r2);
    const cMin = Math.min(rg.c1, rg.c2), cMax = Math.max(rg.c1, rg.c2);
    const out=[];
    for (let r=rMin;r<=rMax;r++) for (let c=cMin;c<=cMax;c++){
      const td = pgxFindCellByPos(r,c); if (td) out.push(td);
    }
    return out;
  }

  function pgxCopySelection(){
    const cells = pgxCellsInRange();
    if (!cells.length) return '';
    const rows = new Map();
    cells.forEach(td=>{
      const r = +td.getAttribute('data-gridrow')||0;
      const c = +td.getAttribute('data-gridcol')||0;
      if (!rows.has(r)) rows.set(r, new Map());
      rows.get(r).set(c, String(td.getAttribute('data-value')||''));
    });
    return Array.from(rows.keys()).sort((a,b)=>a-b).map(r=>{
      const cols = rows.get(r);
      return Array.from(cols.keys()).sort((a,b)=>a-b).map(c=>cols.get(c)||'').join('\t');
    }).join('\n');
  }

  function pgxPasteTSV(text){
    if (!pgxGridState.selected) return;
    const rows = String(text||'').replace(/\r/g,'').split('\n').filter((_,i,a)=>!(i===a.length-1 && a[i]==='')).map(r=>r.split('\t'));
    if (!rows.length) return;
    const base = pgxGridState.selected;
    const store = pgxLoadStore();
    const changes=[];
    rows.forEach((cols,ri)=>{
      cols.forEach((val,ci)=>{
        const td = pgxFindCellByPos(base.row+ri, base.col+ci);
        const ctx = pgxCellCtxFromTd(td);
        if (!ctx) return;
        const before = String(td.getAttribute('data-value')||'');
        const after = String(val||'');
        if (before===after) return;
        if (pgxApplyCellValue(store, ctx, after)) changes.push({...ctx,before,after});
      });
    });
    if (!changes.length) return;
    pgxPushHistory({cells:changes});
    pgxGridState.dirty = true;
    pgxSaveStore(store);
    renderPrograma();
  }

  function pgxApplyFill(fromCtx,toCtx){
    if (!fromCtx || !toCtx) return;
    const td = pgxFindCellByPos(fromCtx.row, fromCtx.col);
    if (!td) return;
    const seed = String(td.getAttribute('data-value')||'');
    const rMin = Math.min(fromCtx.row,toCtx.row), rMax=Math.max(fromCtx.row,toCtx.row);
    const cMin = Math.min(fromCtx.col,toCtx.col), cMax=Math.max(fromCtx.col,toCtx.col);
    const store = pgxLoadStore();
    const changes=[];
    for (let r=rMin;r<=rMax;r++) for (let c=cMin;c<=cMax;c++){
      const cellTd = pgxFindCellByPos(r,c);
      const ctx = pgxCellCtxFromTd(cellTd);
      if (!ctx) continue;
      const before = String(cellTd.getAttribute('data-value')||'');
      if (before===seed) continue;
      if (pgxApplyCellValue(store, ctx, seed)) changes.push({...ctx,before,after:seed});
    }
    if (!changes.length) return;
    pgxPushHistory({cells:changes});
    pgxGridState.dirty = true;
    pgxSaveStore(store);
    renderPrograma();
  }

  function pgxUndoRedo(isRedo){
    const from = isRedo ? pgxGridState.redo : pgxGridState.history;
    const to = isRedo ? pgxGridState.history : pgxGridState.redo;
    const entry = from.pop();
    if (!entry) return;
    const store = pgxLoadStore();
    for (const cell of entry.cells||[]){
      pgxApplyCellValue(store, cell, isRedo ? cell.after : cell.before);
    }
    to.push(entry);
    pgxGridState.dirty = true;
    pgxSaveStore(store);
    renderPrograma();
  }

  function pgxWireCellEditing(){
    const canvas = document.getElementById("pgxCanvas");
    if (!canvas) return;
    if (canvas.dataset.editWired==="1") return;
    canvas.dataset.editWired="1";

    canvas.addEventListener('click',(e)=>{
      const td = e.target?.closest ? e.target.closest('td.pxEditable') : null;
      if (!td || !pgxCanEdit() || !pgxGetEditOn()) return;
      pgxSetSelectedCell(td, e.shiftKey);
    });

    canvas.addEventListener('dblclick',(e)=>{
      const td = e.target?.closest ? e.target.closest('td.pxEditable') : null;
      if (!td || !pgxCanEdit() || !pgxGetEditOn()) return;
      pgxSetSelectedCell(td);
      pgxStartEditing(td);
    });

    canvas.addEventListener('mousedown',(e)=>{
      const handle = e.target?.closest ? e.target.closest('.pxFillHandle') : null;
      if (!handle || !pgxGridState.selected) return;
      e.preventDefault();
      pgxGridState.dragFill = {...pgxGridState.selected};
    });

    canvas.addEventListener('mouseover',(e)=>{
      if (!pgxGridState.dragFill) return;
      const td = e.target?.closest ? e.target.closest('td.pxEditable') : null;
      if (!td) return;
      pgxSetSelectedCell(td, true);
    });

    window.addEventListener('mouseup',()=>{
      if (!pgxGridState.dragFill || !pgxGridState.selected) return;
      pgxApplyFill(pgxGridState.dragFill, pgxGridState.selected);
      pgxGridState.dragFill = null;
    });

    document.addEventListener('keydown',(e)=>{
      if (!pgxCanEdit() || !pgxGetEditOn() || state.view !== 'programa') return;
      const sel = pgxGridState.selected;
      if (!sel) return;

      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='c'){
        const t = pgxCopySelection();
        if (t) navigator.clipboard?.writeText(t);
        e.preventDefault();
        return;
      }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='v') return;
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); pgxUndoRedo(false); return; }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='y'){ e.preventDefault(); pgxUndoRedo(true); return; }

      if (pgxGridState.editing){
        if (e.key==='Enter'){ e.preventDefault(); pgxCommitEditing(true); }
        if (e.key==='Escape'){ e.preventDefault(); pgxCommitEditing(false); }
        return;
      }

      if (e.key==='Enter'){
        e.preventDefault();
        const td = pgxFindCellByPos(sel.row, sel.col);
        if (td) pgxStartEditing(td);
        return;
      }

      const next = {row:sel.row,col:sel.col};
      if (e.key==='ArrowUp') next.row--;
      else if (e.key==='ArrowDown') next.row++;
      else if (e.key==='ArrowLeft') next.col--;
      else if (e.key==='ArrowRight') next.col++;
      else return;
      e.preventDefault();
      const td = pgxFindCellByPos(next.row, next.col);
      if (td) pgxSetSelectedCell(td, e.shiftKey);
    });

    canvas.addEventListener('paste',(e)=>{
      if (!pgxCanEdit() || !pgxGetEditOn()) return;
      const txt = e.clipboardData?.getData('text/plain');
      if (!txt) return;
      e.preventDefault();
      pgxPasteTSV(txt);
    });
  }


  let PGX_INIT_RENDER_DONE = false;

  function renderPrograma(){
    pgxEnsure();
    pgxEnsureProgramaLayout();

    const programs = pgxProgramsForRole();
    if (!programs.length){
      const canvas = document.getElementById("pgxCanvas");
      if (canvas) canvas.innerHTML = `<div class="pgEmpty">No hay programas configurados.</div>`;
      return;
    }

    // Al iniciar: mostrar TODOS por defecto (sin filtro de programa único)
    if (!PGX_INIT_RENDER_DONE){
      pgxSetMode("ALL");
      PGX_INIT_RENDER_DONE = true;
    }
    const editOn = pgxCanEdit() && pgxGetEditOn();
    if (editOn && pgxGetMode() !== "ALL") pgxSetMode("ALL");
    const mode = editOn ? "ALL" : pgxGetMode();

    // Active (solo para selects/edición, no para filtrar al inicio)
    const active = pgxGetActiveId() || programs[0].id;
    if (!pgxGetActiveId()) pgxSetActiveId(active);

    pgxFillProgramSelect(programs);
    pgxApplyHeaderUI();


    // Panel PERSONALIZAR (solo ADMIN en edición)
    try{ if (typeof pgxRenderSettings === "function") pgxRenderSettings(programs); }catch(e){}
    const canvas = document.getElementById("pgxCanvas");
    if (!canvas) return;

    const prevSc = document.getElementById("pgxScroll");
    const prevSL = prevSc ? prevSc.scrollLeft : 0;
    const prevST = prevSc ? prevSc.scrollTop  : 0;

    if (mode === "ONE"){
      const p = programs.find(x=>x.id===active) || programs[0];
      canvas.innerHTML = pgxRenderSheet([p], "ONE");
    } else {
      canvas.innerHTML = pgxRenderSheet(programs, "ALL");
    }

    // restaurar scroll (evita que vuelva al inicio al re-render)
    const scNew0 = document.getElementById("pgxScroll");
    if (scNew0){ scNew0.scrollLeft = prevSL; scNew0.scrollTop = prevST; }

    // scroll interno + drag
    const sc = document.getElementById("pgxScroll");
    if (sc){
      // Drag scroll
      // Reutiliza la función enableDragScroll existente si está, o usa una local.
      try{
        if (typeof enableDragScroll === "function") enableDragScroll(sc);
        else {
          // fallback ligero
          let down=false,sx=0,sy=0,sl=0,st=0;
          sc.addEventListener("mousedown",(ev)=>{
            if (ev.button!==0) return;
            ev.preventDefault();
            down=true; sc.classList.add("dragging"); sx=ev.pageX; sy=ev.pageY; sl=sc.scrollLeft; st=sc.scrollTop;
            document.body.classList.add("pgxNoSelect");
          });
          window.addEventListener("mouseup",()=>{down=false; sc.classList.remove("dragging"); document.body.classList.remove("pgxNoSelect");});
          sc.addEventListener("mousemove",(ev)=>{
            if(!down) return;
            ev.preventDefault();
            sc.scrollLeft = sl - (ev.pageX - sx);
            sc.scrollTop  = st - (ev.pageY - sy);
          });
        }
      
    try{ pgxWireHNav(); }catch(e){}

    }catch(e){}
    }

    pgxWireCellEditing();
    if (pgxCanEdit() && pgxGetEditOn()) pgxRefreshSelectionUi();
    try{ pgxScheduleRelayout(); }catch(e){}
  }



  // Sincroniza un control visible para desplazamiento horizontal (modo pantalla completa)
  function pgxWireHNav(){
    const nav = document.getElementById("pgxHNav");
    const range = document.getElementById("pgxHRange");
    if (!nav || !range) return;

    const syncRange = ()=>{
      const sc = document.getElementById("pgxScroll");
      if (!sc) return;
      const max = Math.max(0, sc.scrollWidth - sc.clientWidth);
      range.max = String(max);
      range.value = String(Math.min(max, sc.scrollLeft));
      range.disabled = (max <= 0);
    };

    // Wiring 1 vez
    if (nav.dataset.wired !== "1"){
      const btnL = document.getElementById("pgxHLeft");
      const btnR = document.getElementById("pgxHRight");

      const scrollByAmt = (dir)=>{
        const sc = document.getElementById("pgxScroll");
        if (!sc) return;
        const amt = Math.max(180, Math.floor(sc.clientWidth * 0.75));
        sc.scrollLeft = Math.max(0, Math.min(sc.scrollWidth, sc.scrollLeft + dir*amt));
      };

      if (btnL) btnL.addEventListener("click", ()=>scrollByAmt(-1));
      if (btnR) btnR.addEventListener("click", ()=>scrollByAmt( 1));

      const onRange = ()=>{
        const sc = document.getElementById("pgxScroll");
        if (!sc) return;
        sc.scrollLeft = +range.value || 0;
      };
      range.addEventListener("input", onRange);
      range.addEventListener("change", onRange);

      window.addEventListener("resize", ()=>{ try{ pgxWireHNav(); }catch(e){} }, { passive:true });

      nav.dataset.wired = "1";
    }

    syncRange();
    requestAnimationFrame(syncRange);

    // Sync del scroll actual
    const sc = document.getElementById("pgxScroll");
    if (!sc) return;
    if (sc.dataset.hnavWired !== "1"){
      sc.addEventListener("scroll", ()=>{
        syncRange();
      }, { passive:true });
      sc.dataset.hnavWired = "1";
    }
  }

// ===================== IMPRESIONES (NUEVO) =====================
  const IMPRESIONES_GID = 281158959; // hoja "IMPRESIONES"

  const UNI_COLORS = {
    "PUCP": getCss("--pucp"),
    "U.LIMA": getCss("--ulima"),
    "AGRARIA": getCss("--agraria"),
    "ESCOLARES": getCss("--schHead_ESC"),
    "ADELANTO/PARALELO": getCss("--accent2"),
  };

  function getCss(varName){
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }

  const MOD_COLORS = {
    "PRESENCIAL": getCss("--pres"),
    "VIRTUAL": getCss("--virt"),
  };

  const EST_COLORS = {
    "ACTIVO": getCss("--ok"),
    "RETIRO": getCss("--bad"),
    "CAMBIO": getCss("--warn"),
  };

  function uniGroupFromCiclo(ciclo){
    const c = String(ciclo||"").trim().toUpperCase();
    if (c === "AGRARIA") return "AGRARIA";
    if (c === "PUCP") return "PUCP";
    return "U.LIMA";
  }


  // Normaliza universidades (evita fallos por mayúsculas, puntos o variantes como UNALM/AGRARIA)
  function uniKey(raw){
    const u0 = norm(raw).toUpperCase();
    const u = u0.replace(/\s+/g,"").replace(/[\._-]/g,""); // ULIMA, UNALM, etc.
    if (!u) return "";
    if (u.includes("PUCP")) return "PUCP";
    if (u.includes("AGRARIA") || u.includes("UNALM")) return "AGRARIA";
    if (u.includes("ULIMA")) return "U.LIMA";
    // fallback razonable
    if (u0.includes("U.LIMA")) return "U.LIMA";
    if (u0.includes("AGRARIA")) return "AGRARIA";
    if (u0.includes("UNALM")) return "AGRARIA";
    if (u0.includes("PUCP")) return "PUCP";
    return u0;
  }
  const HEAD = {
    NOMBRES_A: "NOMBRES COMPLETOS",
    NOMBRES_B: "NOMBRE COMPLETO",
    NOMBRES_C: "NOMBRES",
    MODALIDAD: "MODALIDAD",
    ESTADO: "ESTADO",
  };

  function csvUrl(gid){
    return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${gid}`;
  }

  function parseCSVLine(line){
    const out = [];
    let cur = "", inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"'){
        if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === "," && !inQ){
        out.push(cur); cur = "";
      } else cur += ch;
    }
    out.push(cur);
    return out.map(x => String(x ?? "").trim());
  }

  function norm(s){ return String(s ?? "").replace(/\s+/g," ").trim(); }
  function low(s){ return norm(s).toLowerCase(); }
  function uniq(arr){ return [...new Set(arr)]; }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fillSelectKeep(selId, values, labelAll){
    const sel = document.getElementById(selId);
    const prev = sel.value || "__ALL__";
    sel.innerHTML = "";

    const all = document.createElement("option");
    all.value = "__ALL__";
    all.textContent = labelAll;
    sel.appendChild(all);

    for (const v of values){
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    }

    const exists = Array.from(sel.options).some(o => o.value === prev);
    sel.value = exists ? prev : "__ALL__";
  }

  function normalizeEstado(x){
    const s = low(x);
    if (s.includes("reti") || s.includes("retir")) return "RETIRO";
    if (s.includes("cambi")) return "CAMBIO";
    if (s.includes("activ")) return "ACTIVO";
    return "CAMBIO";
  }

  function normalizeModalidad(x, localFallback){
    const s = low(x);
    if (s.includes("virtual") || s.includes("online") || s.includes("remot")) return "VIRTUAL";
    if (s.includes("pres") || s.includes("aula")) return "PRESENCIAL";
    return (localFallback === "VIRTUAL") ? "VIRTUAL" : "PRESENCIAL";
  }

  function dedupeMatriculaByName(rows){
    const best = new Map();
    const score = (estado) => estado==="ACTIVO" ? 2 : 1;
    for (const r of rows){
      const key = low(r.nombre);
      if (!key) continue;
      const cur = best.get(key);
      if (!cur || score(r.estado) > score(cur.estado)) best.set(key, r);
    }
    return [...best.values()];
  }

  // ============================ PLUGIN DONUT OUTSIDE ============================
  const donutOutsideLabels = {
    id: "donutOutsideLabels",
    afterDatasetsDraw(chart, args, pluginOptions){
      const opt = pluginOptions || {};
      if (chart.config.type !== "doughnut") return;

      const ctx = chart.ctx;
      const dsIndex = opt.datasetIndex ?? 0;
      const dataset = chart.data.datasets[dsIndex];
      if (!dataset) return;

      const meta = chart.getDatasetMeta(dsIndex);
      if (!meta || !meta.data || !meta.data.length) return;

      const values = dataset.data.map(v => +v || 0);
      const total = values.reduce((a,b)=>a+b,0) || 1;

      const minPct = opt.minPercent ?? 6;
      const lineColor = opt.lineColor ?? "rgba(15,23,42,0.55)";
      const fontSize = opt.fontSize ?? 14;
      const fontWeight = opt.fontWeight ?? 950;
      const textColor = opt.textColor ?? "#111827";
      const strokeColor = opt.textStrokeColor ?? "#ffffff";
      const strokeW = opt.textStrokeWidth ?? 4;
      const extra = opt.outsideOffset ?? 30;
      const horiz = opt.horizOffset ?? 22;

      const area = chart.chartArea;
      const minX = area.left + 6;
      const maxX = area.right - 6;
      const minY = area.top + 6;
      const maxY = area.bottom - 6;

      const left = [];
      const right = [];

      meta.data.forEach((arc, i) => {
        const v = values[i];
        if (!v) return;

        const pct = (v/total)*100;
        if (pct >= minPct) return;

        const {x, y, startAngle, endAngle, outerRadius} = arc.getProps(
          ["x","y","startAngle","endAngle","outerRadius"], true
        );

        const angle = (startAngle + endAngle) / 2;
        const cos = Math.cos(angle);
        const sin = Math.sin(angle);

        const x1 = x + cos * (outerRadius + 2);
        const y1 = y + sin * (outerRadius + 2);

        let x2 = x + cos * (outerRadius + extra);
        let y2 = y + sin * (outerRadius + extra);

        x2 = Math.max(minX, Math.min(maxX, x2));
        y2 = Math.max(minY, Math.min(maxY, y2));

        const side = (cos >= 0) ? "right" : "left";
        const label = `${v} (${Math.round(pct)}%)`;

        (side==="right" ? right : left).push({
          x1, y1, x2, y2, side, label,
          targetY: y2
        });
      });

      function spread(items){
        items.sort((a,b)=>a.targetY - b.targetY);
        const gap = opt.minGap ?? 18;
        for (let k=1;k<items.length;k++){
          if (items[k].targetY - items[k-1].targetY < gap){
            items[k].targetY = items[k-1].targetY + gap;
          }
        }
        for (const it of items){
          it.targetY = Math.max(minY, Math.min(maxY, it.targetY));
        }
      }
      spread(left); spread(right);

      ctx.save();
      ctx.font = `${fontWeight} ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
      ctx.fillStyle = textColor;
      ctx.strokeStyle = lineColor;
      ctx.lineWidth = 1.2;

      function drawItem(it){
        const align = (it.side==="right") ? "left" : "right";
        let x3 = it.x2 + (it.side==="right" ? horiz : -horiz);
        let y3 = it.targetY;

        x3 = Math.max(minX, Math.min(maxX, x3));
        y3 = Math.max(minY, Math.min(maxY, y3));

        ctx.beginPath();
        ctx.moveTo(it.x1, it.y1);
        ctx.lineTo(it.x2, y3);
        ctx.lineTo(x3, y3);
        ctx.stroke();

        ctx.textAlign = align;
        ctx.textBaseline = "middle";

        ctx.save();
        ctx.lineWidth = strokeW;
        ctx.strokeStyle = strokeColor;
        ctx.strokeText(it.label, x3, y3);
        ctx.restore();

        ctx.fillStyle = textColor;
        ctx.fillText(it.label, x3, y3);
      }

      left.forEach(drawItem);
      right.forEach(drawItem);
      ctx.restore();
    }
  };
// ===================== PERSISTENCIA DE VISTA (FIX) =====================
const VIEW_STORAGE_KEY = "LA_META_CURRENT_VIEW";
const ALLOWED_VIEWS = ["inicio_alumno","perfil_alumno","overview","local","table","horarios","programa","impresiones","silabos","evaluaciones","materiales","listas","reportes"];

function saveView(v){
  try { localStorage.setItem(VIEW_STORAGE_KEY, v); } catch(e){}
}

function loadSavedView(){
  try { return localStorage.getItem(VIEW_STORAGE_KEY) || ""; }
  catch(e){ return ""; }
}


  const state = {
    view: "overview",
    rawRows: [],
    canonical: [],
    cambiosRows: [],
    filtered: [],

    // IMPRESIONES (nuevo)
    imprRows: [],
    imprUpdatedAt: null,

    // EVALUACIONES (nuevo)
    evalCourses: [],
    evalEvals: [],           // cache completo (opcional)
    evalByCourse: new Map(), // course_code -> evals
    evalSelCourse: null,
    evalSelEval: null,
    evalLastResult: null,
    evalInProgress: false,
    ch_over_estado: null,
    ch_over_modalidad: null,
    ch_over_uni_stack: null,

    ch_loc_activos_salon: null,
    ch_loc_retiros_salon: null,
    booted: false
  };
  // ✅ Safe chart plugin registration (no bloquear AUTH si CDN falla)
  try{
    if (window.Chart){
      if (window.ChartDataLabels) window.Chart.register(window.ChartDataLabels);
      // plugin propio
      window.Chart.register(donutOutsideLabels);
    }
  } catch(e){ console.warn('Charts init (non-fatal):', e); }

  const GRID = "rgba(15,23,42,0.10)";
  const TICK = "#64748b";

  function mkDoughnutWithLabels(canvasId, labels, values, colors, outsideOpts){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;


    if (!window.Chart) return null;

    return new Chart(canvas, {
      type: "doughnut",
      data: {
        labels,
        datasets:[{
          data: values,
          backgroundColor: colors,
          borderColor:"rgba(15,23,42,0.06)",
          borderWidth:1,
          hoverOffset: 6
        }]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        cutout: "62%",
        layout:{ padding:{ top: 20, right: 56, bottom: 20, left: 56 } },
        plugins:{
          legend:{ position:"bottom", labels:{ color:TICK, font:{ weight:"900" } } },
          tooltip:{ enabled:true },
          datalabels:{
            color:"#111827",
            textStrokeColor:"#ffffff",
            textStrokeWidth:4,
            font:{ weight:"950", size: 14 },
            formatter:(v, ctx)=>{
              const data = ctx.chart.data.datasets[0].data || [];
              const total = data.reduce((a,b)=>a+(+b||0),0) || 1;
              const p = (v/total)*100;
              if (!v) return "";
              if (p < ((outsideOpts?.minPercent) ?? 6)) return "";
              return `${v} (${Math.round(p)}%)`;
            }
          },
          donutOutsideLabels: outsideOpts || { minPercent: 6 }
        }
      }
    });
  }

  function mkBarReadable(canvasId, titleLabel){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;


    if (!window.Chart) return null;

    return new Chart(canvas, {
      type:"bar",
      data:{
        labels: [],
        datasets:[{
          label: titleLabel,
          data: [],
          backgroundColor: [],
          borderColor: [],
          borderWidth: 1.5,
          borderRadius: 12,
          maxBarThickness: 70
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        layout:{ padding:{ top: 26, right: 10, left: 10, bottom: 10 } },
        plugins:{
          legend:{ display:false },
          tooltip:{ enabled:true },
          datalabels:{
            color:"#111827",
            textStrokeColor:"#ffffff",
            textStrokeWidth:4,
            font:{ weight:"950", size: 15 },
            anchor:"end",
            align:(ctx)=>{
              const v = ctx.dataset.data[ctx.dataIndex] || 0;
              return v <= 2 ? "end" : "center";
            },
            offset:(ctx)=>{
              const v = ctx.dataset.data[ctx.dataIndex] || 0;
              return v <= 2 ? 2 : 0;
            },
            clamp:true,
            clip:false,
            formatter:(v)=> (v>0) ? v : ""
          }
        },
        scales:{
          x:{
            ticks:{
              color:TICK,
              font:{ weight:"900" },
              autoSkip: false,
              maxRotation: 30,
              minRotation: 0,
              callback: function(val){
                const s = String(this.getLabelForValue(val) || "");
                return s.length > 18 ? (s.slice(0,18) + "…") : s;
              }
            },
            grid:{ color:GRID }
          },
          y:{
            beginAtZero:true,
            ticks:{ color:TICK, font:{ weight:"900" } },
            grid:{ color:GRID }
          }
        }
      }
    });
  }

  function mkStackedUni(canvasId){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;


    if (!window.Chart) return null;

    return new Chart(canvas, {
      type:"bar",
      data:{
        labels: ["AGRARIA","U.LIMA","PUCP","ESCOLARES"],
        datasets:[
          {
            label:"ACTIVOS",
            data:[0,0,0],
            backgroundColor:"rgba(76,175,80,0.18)",
            borderColor:"rgba(76,175,80,0.25)",
            borderWidth:1.2,
            borderRadius:10,
            stack:"s1"
          },
          {
            label:"RETIROS",
            data:[0,0,0],
            backgroundColor:"rgba(220,38,38,0.25)",
            borderColor:"rgba(220,38,38,0.35)",
            borderWidth:1.2,
            borderRadius:10,
            stack:"s1"
          },
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        layout:{ padding:{ top: 30, right: 10, left: 10, bottom: 10 } },
        plugins:{
          legend:{ position:"bottom", labels:{ color:TICK, font:{ weight:"900" } } },
          tooltip:{ enabled:true },
          datalabels:{
            color:"#111827",
            textStrokeColor:"#ffffff",
            textStrokeWidth:4,
            font:{ weight:"950", size: 13 },
            anchor:(ctx)=> ctx.datasetIndex === 0 ? "center" : "end",
            align:(ctx)=>  ctx.datasetIndex === 0 ? "center" : "end",
            offset:(ctx)=> ctx.datasetIndex === 0 ? 0 : 4,
            clamp:true,
            clip:false,
            formatter:(v)=> (!v || v<=0) ? "" : v
          }
        },
        scales:{
          x:{ stacked:true, ticks:{ color:TICK, font:{ weight:"900" } }, grid:{ color:GRID } },
          y:{ stacked:true, beginAtZero:true, ticks:{ color:TICK, font:{ weight:"900" } }, grid:{ color:GRID } }
        }
      }
    });
  }

  function setChartData(chart, labels, values, colors){
    if (!chart) return;
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    if (colors){
      chart.data.datasets[0].backgroundColor = colors;
      chart.data.datasets[0].borderColor = colors;
    }
    chart.update("none");
  }

  // ============================ NAV ============================
  function setView(v){
    if (!canAccessView(v)){
      // Bloqueo por rol: redirige a fallback
      v = (CURRENT_ROLE === "alumno") ? "inicio_alumno" : "table";
    }
    state.view = v;
    if (v !== "evaluaciones") state.evalInProgress = false;
    saveView(v);

    if (v !== "horarios"){
      try{ setHorariosMatrixFullscreen(false); }catch(e){}
      try{ closeHorariosCellEditModal(); }catch(e){}
    }

    const t = (id, on)=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle("active", !!on);
    };
    t("nav_inicio_alumno", v==="inicio_alumno");
    t("nav_perfil_alumno", v==="perfil_alumno");
    t("nav_overview", v==="overview");
    t("nav_local", v==="local");
    t("nav_table", v==="table");
    t("nav_horarios", v==="horarios");
        t("nav_programa", v==="programa");
t("nav_impresiones", v==="impresiones");
    t("nav_silabos", v==="silabos");
    t("nav_evaluaciones", v==="evaluaciones");
    t("nav_materiales", v==="materiales");
    t("nav_listas", v==="listas");
    t("nav_reportes", v==="reportes");

        t("nav_notas", v==="notas");
const s = (id, on)=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = on ? "" : "none";
    };
    s("view_inicio_alumno", v==="inicio_alumno");
    s("view_perfil_alumno", v==="perfil_alumno");
    s("view_overview", v==="overview");
    s("view_local", v==="local");
    s("view_table", v==="table");
    s("view_horarios", v==="horarios");
        s("view_programa", v==="programa");
s("view_impresiones", v==="impresiones");
    s("view_silabos", v==="silabos");
    s("view_evaluaciones", v==="evaluaciones");
    s("view_materiales", v==="materiales");
    s("view_listas", v==="listas");
    s("view_reportes", v==="reportes");

        s("view_notas", v==="notas");
// controles matrícula visibles solo en vistas de administración
    const cm = document.getElementById("controlsMatricula");
    if (cm){
      cm.style.display =
        (v==="inicio_alumno" || v==="horarios" || v==="programa" || v==="impresiones" || v==="silabos" || v==="evaluaciones" || v==="materiales" || v==="listas" || v==="reportes" || v==="notas") ? "none" : "";
    }

    // estado solo visible en ALUMNOS (tabla) y no para rol alumno
    const est = document.getElementById("fEstado");
    if (est){
      est.style.display = (v==="table" && CURRENT_ROLE !== "alumno") ? "" : "none";
    }

    const titles = {
      inicio_alumno: ["INICIO", "Acceso rápido para alumnos: perfil, horarios y sílabos."],
      perfil_alumno: ["MI PERFIL", "Datos del alumno registrados en su matrícula."],
      overview: ["RESUMEN GENERAL", "Panel estructurado para control de alumnos en todos los locales y salones."],
      local: ["CONTROL DE SEDES", "Monitoreo por sede."],
      table: ["ALUMNOS", "Listado completo de alumnos de La Meta."],
      horarios: ["HORARIOS", "Horarios de todos los ciclos de La Meta."],
            programa: ["PROGRAMA", "Programación de todos los ciclos que maneja La Meta."],
impresiones: ["IMPRESIONES", "Registros y control de impresiones de cada salón."],
      silabos: ["SÍLABOS", "Repositorio de sílabos por universidad y curso."],
      evaluaciones: ["EVALUACIONES", "Evaluaciones por curso (5 preguntas). Envío automático y nota 0–20."],
      materiales: ["MATERIALES", "Accesos a carpetas de materiales por universidad."],
      listas: ["LISTAS", "Listas por salón."],
      reportes: ["REPORTES", "Envío y acceso a carpeta de acumulación de reportes por salón."],
      notas: ["NOTAS GENERALES", "Accesos rápidos a notas generales por universidad."]
    };
    const title = document.getElementById("viewTitle");
    const desc = document.getElementById("viewDesc");
    if (title) title.textContent = (titles[v] ? titles[v][0] : "PANEL");
    if (desc) desc.textContent  = (titles[v] ? titles[v][1] : "");

    // Si está en CONTROL DE SEDES: deshabilitar filtros de Uni y Salón (solo local)
    const uniSel = document.getElementById("fUni");
    const salSel = document.getElementById("fSalon");

    if (v === "local"){
      if (uniSel){ uniSel.value="__ALL__"; uniSel.disabled = true; }
      if (salSel){ salSel.value="__ALL__"; salSel.disabled = true; }
    } else if (v !== "horarios" && v !== "impresiones" && v !== "silabos" && v !== "evaluaciones"){
      if (uniSel) uniSel.disabled = false;
      if (salSel) salSel.disabled = false;
    }

    // Recalcular opciones de salón solo en vistas de matrícula
    if (v !== "horarios" && v !== "impresiones" && v !== "silabos" && v !== "evaluaciones"){
      rebuildSalonOptions();
    }

    render();
  }

  // ============================ FILTERS (MATRÍCULA) ============================

  function initFilters(){
    const locals = uniq(SALONES.map(s=>s.local)).sort();
    fillSelectKeep("fLocal", locals, "LOCAL: TODOS");
    fillSelectKeep("fUni", ["AGRARIA","U.LIMA","PUCP","ESCOLARES"], "UNIVERSIDAD: TODAS");
    rebuildSalonOptions();
    fillSelectKeep("fModalidad", ["PRESENCIAL","VIRTUAL"], "MODALIDAD: TODAS");

    // ✅ Estado para tabla (incluye CAMBIO)
    fillSelectKeep("fEstado", ["ACTIVO","RETIRO","CAMBIO"], "ESTADO: TODOS");
  }

  function getBaseForCurrentView(){
    // Overview/Local: solo matrícula (ACTIVO/RETIRO) dedupe
    if (state.view !== "table"){
      return state.canonical.slice();
    }

    // Tabla: permitir CAMBIO y TODOS
    const fEstado = document.getElementById("fEstado").value;

    if (fEstado === "CAMBIO"){
      return state.cambiosRows.slice();
    }
    if (fEstado === "ACTIVO" || fEstado === "RETIRO"){
      return state.canonical.filter(r=>r.estado===fEstado);
    }
    // TODOS (tabla): activos+retiros dedupe + cambios (sin dedupe)
    return state.canonical.concat(state.cambiosRows);
  }

  function rebuildSalonOptions(){
    const fLocal = document.getElementById("fLocal").value;
    const fUni = document.getElementById("fUni").value;

    let base = getBaseForCurrentView();
    if (fLocal !== "__ALL__") base = base.filter(r=>r.local===fLocal);
    if (fUni !== "__ALL__") base = base.filter(r=>uniGroupFromCiclo(r.ciclo)===fUni);

    const salones = uniq(base.map(r=>r.salon)).sort();
    fillSelectKeep("fSalon", salones, "SALÓN: TODOS");
  }

  function applyFilters(){
    const fLocal = document.getElementById("fLocal").value;
    const fUni   = document.getElementById("fUni").value;
    const fSalon = document.getElementById("fSalon").value;
    const fMod   = document.getElementById("fModalidad").value;
    const q      = low(document.getElementById("q").value);

    let base = getBaseForCurrentView();

    base = base.filter(r=>{
      if (fLocal!=="__ALL__" && r.local!==fLocal) return false;
      if (fUni!=="__ALL__" && uniGroupFromCiclo(r.ciclo)!==fUni) return false;
      if (fSalon!=="__ALL__" && r.salon!==fSalon) return false;
      if (fMod!=="__ALL__" && r.modalidad!==fMod) return false;

      if (q){
        const blob = low([r.nombre, r.local, r.ciclo, r.salon, r.modalidad, r.estado].join(" | "));
        if (!blob.includes(q)) return false;
      }
      return true;
    });

    state.filtered = base;
  }

  // ============================ LAYOUTS (MATRÍCULA) ============================
  function ensureOverviewLayout(){
    const el = document.getElementById("view_overview");
    if (el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card kpi">
        <div class="label">TOTAL DE ALUMNOS</div>
        <div class="value" id="k_total">0</div>
        <div class="hint">ACTIVOS + RETIROS</div>
      </div>

      <div class="card kpi">
        <div class="label">ACTIVOS</div>
        <div class="value" id="k_act">0</div>
      </div>

      <div class="card kpi">
        <div class="label">RETIROS</div>
        <div class="value" id="k_ret">0</div>
      </div>

      <div class="card kpi">
        <div class="label">CAMBIOS (TRASLADOS)</div>
        <div class="value" id="k_cam">0</div>
        <div class="hint">NO SUMA AL TOTAL</div>
      </div>

      <div class="card panel8">
        <div class="cardtitle">
          ESTADO Y MODALIDAD
          <div class="panelHint">
            <span class="pill"><span class="dot agraria"></span>AGRARIA</span>
            <span class="pill"><span class="dot pucp"></span>PUCP</span>
            <span class="pill"><span class="dot ulima"></span>U.LIMA</span>
          </div>
        </div>
        <div class="grid" style="margin-top:0;">
          <div class="card panel6" style="box-shadow:none; border:1px solid var(--border);">
            <div class="cardtitle">ESTADO</div>
            <div class="chartBox"><canvas id="over_estado"></canvas></div>
          </div>
          <div class="card panel6" style="box-shadow:none; border:1px solid var(--border);">
            <div class="cardtitle">MODALIDAD</div>
            <div class="chartBox"><canvas id="over_modalidad"></canvas></div>
          </div>
        </div>
      </div>

      <div class="card panel4">
        <div class="cardtitle">RESUMEN POR UNIVERSIDAD</div>
        <div class="chartBoxTall"><canvas id="over_uni_stack"></canvas></div>

        <div class="uniCards">
          <div class="uniCard">
            <img src="logo_agraria.png" alt="AGRARIA" onerror="this.style.display='none'">
            <div class="t">
              <div class="name">AGRARIA</div>
              <div class="nums">
                <span class="pill" style="border-color:rgba(76,175,80,0.35); background:rgba(76,175,80,0.10);">Activos: <b id="uA_act">0</b></span>
                <span class="pill">Retiros: <b id="uA_ret">0</b></span>
              </div>
            </div>
          </div>

          <div class="uniCard">
            <img src="logo_pucp.png" alt="PUCP" onerror="this.style.display='none'">
            <div class="t">
              <div class="name">PUCP</div>
              <div class="nums">
                <span class="pill" style="border-color:rgba(110,168,218,0.50); background:rgba(110,168,218,0.12);">Activos: <b id="uP_act">0</b></span>
                <span class="pill">Retiros: <b id="uP_ret">0</b></span>
              </div>
            </div>
          </div>

          <div class="uniCard">
            <img src="logo_ulima.png" alt="U.LIMA" onerror="this.style.display='none'">
            <div class="t">
              <div class="name">U.LIMA</div>
              <div class="nums">
                <span class="pill" style="border-color:rgba(255,153,0,0.55); background:rgba(255,153,0,0.12);">Activos: <b id="uL_act">0</b></span>
                <span class="pill">Retiros: <b id="uL_ret">0</b></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    state.ch_over_estado = mkDoughnutWithLabels(
      "over_estado",
      ["ACTIVO","RETIRO","CAMBIO"],
      [0,0,0],
      [EST_COLORS.ACTIVO, EST_COLORS.RETIRO, EST_COLORS.CAMBIO],
      { minPercent: 6, outsideOffset: 34, horizOffset: 26, minGap: 20, fontSize: 14 }
    );

    state.ch_over_modalidad = mkDoughnutWithLabels(
      "over_modalidad",
      ["PRESENCIAL","VIRTUAL"],
      [0,0],
      [MOD_COLORS.PRESENCIAL, MOD_COLORS.VIRTUAL],
      { minPercent: 10, outsideOffset: 28, horizOffset: 22, minGap: 18, fontSize: 14 }
    );

    state.ch_over_uni_stack = mkStackedUni("over_uni_stack");
    el.dataset.ready = "1";
  }

  function ensureLocalLayout(){
    const el = document.getElementById("view_local");
    if (el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card kpi">
        <div class="label">TOTAL (LOCAL)</div>
        <div class="value" id="lk_total">0</div>
        <div class="hint">ACTIVOS + RETIROS</div>
      </div>

      <div class="card kpi">
        <div class="label">ACTIVOS (LOCAL)</div>
        <div class="value" id="lk_act">0</div>
      </div>

      <div class="card kpi">
        <div class="label">RETIROS (LOCAL)</div>
        <div class="value" id="lk_ret">0</div>
      </div>

      <div class="card kpi">
        <div class="label">CAMBIOS (LOCAL)</div>
        <div class="value" id="lk_cam">0</div>
        <div class="hint">NO SUMA AL TOTAL</div>
      </div>

      <div class="card panel12">
        <div class="cardtitle">
          ACTIVOS POR SALÓN (LOCAL)
          <div class="panelHint">
            <span class="dot agraria"></span>AGRARIA
            <span class="dot ulima"></span>U.LIMA
            <span class="dot pucp"></span>PUCP
            <span class="dot escolares"></span>ESCOLARES
            <span class="dot" style="background:var(--accent2);"></span>ADELANTO / PARALELO
          </div>
        </div>
        <div class="chartBoxTall"><canvas id="loc_activos_salon"></canvas></div>
      </div>

      <div class="card panel12">
        <div class="cardtitle">RETIROS POR SALÓN (LOCAL)</div>
        <div class="chartBoxTall"><canvas id="loc_retiros_salon"></canvas></div>
      </div>

      <div class="card panel12">
        <div class="cardtitle">DETALLE (SALONES)</div>
        <div style="overflow:auto; max-height: 55vh;">
          <table>
            <thead>
              <tr>
                <th>LOCAL</th>
                <th>UNIVERSIDAD</th>
                <th>SALÓN</th>
                <th>ACTIVOS</th>
                <th>RETIROS</th>
                <th>TOTAL</th>
                <th>CAMBIOS</th>
              </tr>
            </thead>
            <tbody id="loc_table_salon"></tbody>
          </table>
        </div>
      </div>
    `;

    state.ch_loc_activos_salon = mkBarReadable("loc_activos_salon", "ACTIVOS");
    state.ch_loc_retiros_salon = mkBarReadable("loc_retiros_salon", "RETIROS");

    el.dataset.ready = "1";
  }

  function ensureTableLayout(){
    const el = document.getElementById("view_table");
    if (el.dataset.ready === "1") return;

    const isTutor = (CURRENT_ROLE === "tutor");

    const theadTutor = `
      <tr>
        <th>NOMBRE</th>
        <th>LOCAL</th>
        <th>UNIVERSIDAD</th>
        <th>SALÓN</th>
        <th>MODALIDAD</th>
        <th>ESTADO</th>
        <th>USUARIO</th>
        <th>CONTRASEÑA</th>
      </tr>
    `;

    const theadAdmin = `
      <tr>
        <th>NOMBRES</th>
        <th>APELLIDOS</th>
        <th>NOMBRES COMPLETOS</th>
        <th>LOCAL</th>
        <th>UNIVERSIDAD</th>
        <th>SALÓN</th>
        <th>MODALIDAD</th>
        <th>ESTADO</th>

        <th>CORREO</th>
        <th>DNI</th>
        <th>CELULAR</th>
        <th>EDAD</th>
        <th>PROVINCIA</th>
        <th>DISTRITO</th>
        <th>COLEGIO</th>
        <th>DISTRITO DE COLEGIO</th>

        <th>ACADEMIA</th>
        <th>PREPARACIÓN</th>
        <th>¿CÓMO SE ENTERÓ?</th>
        <th>CARRERA</th>

        <th>FECHA INSCRIPCIÓN</th>
        <th>FECHA INICIO</th>
        <th>FECHA RETIRO</th>
        <th>OBSERVACIONES</th>

        <th>PADRE/APODERADO</th>
        <th>CEL APODERADO</th>
        <th>CORREO APODERADO</th>
        <th>DNI APODERADO</th>

        <th>USUARIO</th>
        <th>CONTRASEÑA</th>
      </tr>
    `;

    el.innerHTML = `
      <div class="card panel12">
        <div class="cardtitle">ALUMNOS</div>
        <div style="overflow:auto; max-height: 75vh;">
          <table>
            <thead>
              ${isTutor ? theadTutor : theadAdmin}
            </thead>
            <tbody id="tb_body"></tbody>
          </table>
        </div>
      </div>
    `;

    el.dataset.ready = "1";
  }

  function renderOverview(){
    ensureOverviewLayout();

    // ✅ overview siempre con matrícula ACTIVO/RETIRO (NO CAMBIO)
    const prevView = state.view;
    state.view = "overview";
    applyFilters();
    state.view = prevView;

    const rows = state.filtered;

    const act = rows.filter(r=>r.estado==="ACTIVO").length;
    const ret = rows.filter(r=>r.estado==="RETIRO").length;
    const total = act + ret;

    const fLocal = document.getElementById("fLocal").value;
    const fUni   = document.getElementById("fUni").value;
    const fSalon = document.getElementById("fSalon").value;
    const fMod   = document.getElementById("fModalidad").value;
    const q      = low(document.getElementById("q").value);

    let cambiosBase = state.cambiosRows;
    if (fLocal!=="__ALL__") cambiosBase = cambiosBase.filter(r=>r.local===fLocal);
    if (fUni!=="__ALL__") cambiosBase = cambiosBase.filter(r=>uniGroupFromCiclo(r.ciclo)===fUni);
    if (fSalon!=="__ALL__") cambiosBase = cambiosBase.filter(r=>r.salon===fSalon);
    if (fMod!=="__ALL__") cambiosBase = cambiosBase.filter(r=>r.modalidad===fMod);
    if (q){
      cambiosBase = cambiosBase.filter(r=>{
        const blob = low([r.nombre, r.local, r.ciclo, r.salon, r.modalidad, r.estado].join(" | "));
        return blob.includes(q);
      });
    }
    const cambiosUnique = uniq(cambiosBase.map(r=>low(r.nombre))).filter(Boolean).length;

    const pres = rows.filter(r=>r.modalidad==="PRESENCIAL").length;
    const virt = rows.filter(r=>r.modalidad==="VIRTUAL").length;

    document.getElementById("k_total").textContent = total.toLocaleString("es-PE");
    document.getElementById("k_act").textContent = act.toLocaleString("es-PE");
    document.getElementById("k_ret").textContent = ret.toLocaleString("es-PE");
    document.getElementById("k_cam").textContent = cambiosUnique.toLocaleString("es-PE");

    state.ch_over_estado.data.datasets[0].data = [act, ret, cambiosUnique];
    state.ch_over_estado.update("none");

    state.ch_over_modalidad.data.datasets[0].data = [pres, virt];
    state.ch_over_modalidad.update("none");

    const aAct = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="AGRARIA" && r.estado==="ACTIVO").length;
    const aRet = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="AGRARIA" && r.estado==="RETIRO").length;

    const pAct = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="PUCP" && r.estado==="ACTIVO").length;
    const pRet = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="PUCP" && r.estado==="RETIRO").length;

    const lAct = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="U.LIMA" && r.estado==="ACTIVO").length;
    const lRet = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="U.LIMA" && r.estado==="RETIRO").length;

    document.getElementById("uA_act").textContent = aAct;
    document.getElementById("uA_ret").textContent = aRet;

    document.getElementById("uP_act").textContent = pAct;
    document.getElementById("uP_ret").textContent = pRet;

    document.getElementById("uL_act").textContent = lAct;
    document.getElementById("uL_ret").textContent = lRet;

    state.ch_over_uni_stack.data.datasets[0].data = [aAct, pAct, lAct];
    state.ch_over_uni_stack.data.datasets[1].data = [aRet, pRet, lRet];
    state.ch_over_uni_stack.update("none");
  }

  function cycleOrderRankForControlSedes(salon, ciclo){
    const raw = `${String(ciclo||"")} ${String(salon||"")}`.toUpperCase();
    if (raw.includes("ADELANTO") || raw.includes("PARALELO")) return 4;
    if (raw.includes("ESCOLAR") || raw.includes("ESC.")) return 3;
    if (raw.includes("AGRARIA")) return 0;
    if (raw.includes("U.LIMA") || raw.includes("U LIMA") || raw.includes("ULIMA")) return 1;
    if (raw.includes("PUCP")) return 2;
    return 5;
  }

  function localOrderRankForControlSedes(local){
    const t = String(local||"").toUpperCase();
    if (t === "LA MOLINA") return 0;
    if (t === "SAN MIGUEL") return 1;
    if (t === "SAN BORJA") return 2;
    if (t === "VIRTUAL") return 3;
    return 9;
  }

  function uniDisplayForControlSedes(salon, ciclo){
    const raw = `${String(ciclo||"")} ${String(salon||"")}`.toUpperCase();
    if (raw.includes("ADELANTO") || raw.includes("PARALELO")) return "ADELANTO/PARALELO";
    if (raw.includes("ESCOLAR") || raw.includes("ESC.")) return "ESCOLARES";
    if (raw.includes("AGRARIA")) return "AGRARIA";
    if (raw.includes("PUCP")) return "PUCP";
    return "U.LIMA";
  }

  function renderLocal(){
    ensureLocalLayout();

    const fLocal = document.getElementById("fLocal").value;
    const fMod   = document.getElementById("fModalidad").value;
    const q      = low(document.getElementById("q").value);

    let salonesLocal = SALONES
      .filter(s => (fLocal==="__ALL__" ? true : s.local === fLocal))
      .map(s => s.salon);
    salonesLocal = uniq(salonesLocal);

    salonesLocal.sort((a,b)=>{
      const ca = SALONES.find(x => x.salon===a && (fLocal==="__ALL__" ? true : x.local===fLocal));
      const cb = SALONES.find(x => x.salon===b && (fLocal==="__ALL__" ? true : x.local===fLocal));

      const la = localOrderRankForControlSedes(ca?.local || "");
      const lb = localOrderRankForControlSedes(cb?.local || "");
      if (la !== lb) return la - lb;

      const ra = cycleOrderRankForControlSedes(a, ca?.ciclo || "");
      const rb = cycleOrderRankForControlSedes(b, cb?.ciclo || "");
      if (ra !== rb) return ra - rb;

      return String(a||"").localeCompare(String(b||""), "es");
    });

    // local = matrícula dedupe (sin cambios)
    let baseMat = state.canonical;
    if (fLocal!=="__ALL__") baseMat = baseMat.filter(r=>r.local===fLocal);
    if (fMod!=="__ALL__") baseMat = baseMat.filter(r=>r.modalidad===fMod);
    if (q){
      baseMat = baseMat.filter(r=>{
        const blob = low([r.nombre, r.local, r.ciclo, r.salon, r.modalidad, r.estado].join(" | "));
        return blob.includes(q);
      });
    }

    const act = baseMat.filter(r=>r.estado==="ACTIVO").length;
    const ret = baseMat.filter(r=>r.estado==="RETIRO").length;
    const total = act + ret;

    let baseCam = state.cambiosRows;
    if (fLocal!=="__ALL__") baseCam = baseCam.filter(r=>r.local===fLocal);
    if (fMod!=="__ALL__") baseCam = baseCam.filter(r=>r.modalidad===fMod);
    if (q){
      baseCam = baseCam.filter(r=>{
        const blob = low([r.nombre, r.local, r.ciclo, r.salon, r.modalidad, r.estado].join(" | "));
        return blob.includes(q);
      });
    }
    const cambiosUnique = uniq(baseCam.map(r=>low(r.nombre))).filter(Boolean).length;

    document.getElementById("lk_total").textContent = total.toLocaleString("es-PE");
    document.getElementById("lk_act").textContent = act.toLocaleString("es-PE");
    document.getElementById("lk_ret").textContent = ret.toLocaleString("es-PE");
    document.getElementById("lk_cam").textContent = cambiosUnique.toLocaleString("es-PE");

    const activosPorSalon = salonesLocal.map(s => baseMat.filter(r=>r.salon===s && r.estado==="ACTIVO").length);
    const activosColors = salonesLocal.map(s=>{
      const conf = SALONES.find(x => x.salon===s && (fLocal==="__ALL__" ? true : x.local===fLocal));
      const uni = uniDisplayForControlSedes(s, conf?.ciclo || "");
      return UNI_COLORS[uni] || UNI_COLORS["AGRARIA"];
    });

    const retirosPorSalon = salonesLocal.map(s => baseMat.filter(r=>r.salon===s && r.estado==="RETIRO").length);
    const retirosColors = salonesLocal.map(_ => "#dc2626");

    setChartData(state.ch_loc_activos_salon, salonesLocal, activosPorSalon, activosColors);
    setChartData(state.ch_loc_retiros_salon, salonesLocal, retirosPorSalon, retirosColors);

    const tbody = document.getElementById("loc_table_salon");
    tbody.innerHTML = salonesLocal.map(s=>{
      const rs = baseMat.filter(r=>r.salon===s);
      const a = rs.filter(r=>r.estado==="ACTIVO").length;
      const r = rs.filter(r=>r.estado==="RETIRO").length;
      const t = a + r;

      const conf = SALONES.find(x => x.salon === s && (fLocal==="__ALL__" ? true : x.local===fLocal));
      const uni = uniDisplayForControlSedes(s, conf?.ciclo || rs[0]?.ciclo || "");

      const c = uniq(baseCam.filter(x=>x.salon===s).map(x=>low(x.nombre))).filter(Boolean).length;
      const loc = (fLocal==="__ALL__" ? (conf?.local || rs[0]?.local || "") : fLocal);

      return `
        <tr>
          <td>${escapeHtml(loc)}</td>
          <td>${escapeHtml(uni)}</td>
          <td>${escapeHtml(s)}</td>
          <td>${a}</td>
          <td>${r}</td>
          <td>${t}</td>
          <td>${c}</td>
        </tr>
      `;
    }).join("");
  }

  function renderTable(){
    ensureTableLayout();
    applyFilters();

    const isTutor = (CURRENT_ROLE === "tutor");
    const rows = state.filtered;

    const tbody = document.getElementById("tb_body");

    if (isTutor){
      tbody.innerHTML = rows.slice(0,1200).map(r=>`
        <tr>
          <td>${escapeHtml(r.nombre)}</td>
          <td>${escapeHtml(r.local)}</td>
          <td>${escapeHtml(uniGroupFromCiclo(r.ciclo))}</td>
          <td>${escapeHtml(r.salon)}</td>
          <td>${escapeHtml(r.modalidad)}</td>
          <td>${escapeHtml(r.estado)}</td>
          <td>${escapeHtml(r.usuario || "")}</td>
          <td>${escapeHtml(r.contrasena || "")}</td>
        </tr>
      `).join("");
      return;
    }

        // ADMIN: mostrar estructura nueva (si falta un campo, queda vacío)
    tbody.innerHTML = rows.slice(0,1200).map(r=>{
      const uni = r.uni_sheet || uniGroupFromCiclo(r.ciclo);
      return `
      <tr>
        <td>${escapeHtml(r.nombres || "")}</td>
        <td>${escapeHtml(r.apellidos || "")}</td>
        <td>${escapeHtml(r.nombres_completos || r.nombre || "")}</td>
        <td>${escapeHtml(r.local)}</td>
        <td>${escapeHtml(uni)}</td>
        <td>${escapeHtml(r.salon)}</td>
        <td>${escapeHtml(r.modalidad)}</td>
        <td>${escapeHtml(r.estado)}</td>

        <td>${escapeHtml(r.correo_al || "")}</td>
        <td>${escapeHtml(r.dni_al || "")}</td>
        <td>${escapeHtml(r.celular_al || "")}</td>
        <td>${escapeHtml(r.edad || "")}</td>
        <td>${escapeHtml(r.provincia || "")}</td>
        <td>${escapeHtml(r.distrito || "")}</td>
        <td>${escapeHtml(r.colegio || "")}</td>
        <td>${escapeHtml(r.distrito_colegio || "")}</td>

        <td>${escapeHtml(r.academia || "")}</td>
        <td>${escapeHtml(r.preparacion || "")}</td>
        <td>${escapeHtml(r.como_entero || "")}</td>
        <td>${escapeHtml(r.carrera || "")}</td>

        <td>${escapeHtml(r.fecha_inscripcion || "")}</td>
        <td>${escapeHtml(r.fecha_inicio || "")}</td>
        <td>${escapeHtml(r.fecha_retiro || "")}</td>
        <td>${escapeHtml(r.observaciones || "")}</td>

        <td>${escapeHtml(r.nombre_apo || "")}</td>
        <td>${escapeHtml(r.cel_apo || "")}</td>
        <td>${escapeHtml(r.correo_apo || "")}</td>
        <td>${escapeHtml(r.dni_apo || "")}</td>

        <td>${escapeHtml(r.usuario || "")}</td>
        <td>${escapeHtml(r.contrasena || "")}</td>
      </tr>
      `;
    }).join("");
  }

  // ===================== IMPRESIONES (NUEVO) =====================
  // ===================== IMPRESIONES (NUEVO) =====================
  const IMP_LOCALS = ["LA MOLINA","SAN MIGUEL","SAN BORJA"];

  function toInt(x){
    const n = parseInt(String(x||"").replace(/[^\d]/g,""), 10);
    return Number.isFinite(n) ? n : 0;
  }

  function inferUniFromSalonLabel(label){
    const s = String(label||"").toUpperCase();
    if (s.includes("ESCOLAR")) return "ESCOLARES";
    if (s.includes("AGRARIA")) return "AGRARIA";
    if (s.includes("U.LIMA") || s.includes("U LIMA") || s.includes("ULIMA")) return "U.LIMA";
    if (s.includes("PUCP")) return "PUCP";
    return "OTRO";
  }

  /**
   * Reglas solicitadas:
   * 1) Quitar "ACTUALIZADO" (ya no se muestra en UI)
   * 2) OTRO: punto ROJO + número ROJO (mismo color)
   * 3) PARALELO: mostrar etiqueta "U.LIMA" pero en ROJO (no naranja)
   * 4) Orden fijo en cada local: AGRARIA -> U.LIMA -> PUCP -> ESCOLARES -> ADELANTO/PARALELO
   */
  function imprMetaFromSalon(salon){
    const s = String(salon||"").toUpperCase();

    // Caso especial: PARALELO/ADELANTO -> etiqueta ADELANTO / PARALELO en rojo
    if (s.includes("PARALELO") || s.includes("ADELANTO")){
      const red = getCss("--accent2");
      return { group: 4, label: "ADELANTO / PARALELO", dot: red, num: red };
    }

    const uni = inferUniFromSalonLabel(salon);

    if (uni === "AGRARIA"){
      const c = getCss("--agraria");
      return { group: 0, label: "AGRARIA", dot: c, num: c };
    }
    if (uni === "U.LIMA"){
      const c = getCss("--ulima");
      return { group: 1, label: "U.LIMA", dot: c, num: c };
    }
    if (uni === "PUCP"){
      const c = getCss("--pucp");
      return { group: 2, label: "PUCP", dot: c, num: c };
    }
    if (uni === "ESCOLARES"){
      const c = getCss("--schHead_ESC");
      return { group: 3, label: "ESCOLARES", dot: c, num: c };
    }

    // OTRO (ej: ADELANTO): punto ROJO + número ROJO
    const red = getCss("--accent2");
    return { group: 4, label: "OTRO", dot: red, num: red };
  }

  function parseImpresionesCSV(csvText){
    const lines = csvText.split(/\r?\n/).filter(l=>l.trim().length>0);
    const grid = lines.map(parseCSVLine).map(r=>r.map(norm));

    // buscar fila cabecera donde aparezcan LA MOLINA / SAN MIGUEL / SAN BORJA
    let headerRow = -1;
    for (let r=0; r<Math.min(grid.length, 40); r++){
      const rowU = grid[r].map(x=>String(x||"").toUpperCase());
      const hits = IMP_LOCALS.filter(L => rowU.includes(L)).length;
      if (hits >= 2){ headerRow = r; break; }
    }
    if (headerRow < 0) return [];

    const rowU = grid[headerRow].map(x=>String(x||"").toUpperCase());
    const cols = []; // { local, colSalon, colCount }
    for (const loc of IMP_LOCALS){
      const c = rowU.indexOf(loc);
      if (c >= 0){
        cols.push({ local: loc, colSalon: c, colCount: c+1 });
      }
    }
    if (!cols.length) return [];

    const out = [];
    for (let r=headerRow+1; r<grid.length; r++){
      const anySalon = cols.some(cc => norm(grid[r][cc.colSalon] || "").length > 0);
      const anyCount = cols.some(cc => norm(grid[r][cc.colCount] || "").length > 0);
      if (!anySalon && !anyCount) continue;

      for (const cc of cols){
        const salon = norm(grid[r][cc.colSalon] || "");
        if (!salon) continue;

        const up = salon.toUpperCase();
        if (up.includes("IMPRESION")) continue; // evita encabezados del estilo "# IMPRESIONES"

        const count = toInt(grid[r][cc.colCount] || "0");
        out.push({ local: cc.local, salon, count });
      }
    }

    // dedupe por (local + salon), manteniendo el último
    const best = new Map();
    for (const it of out){
      const k = `${it.local}||${it.salon}`.toUpperCase();
      best.set(k, it);
    }
    return [...best.values()];
  }

  function ensureImpresionesLayout(){
    const el = document.getElementById("view_impresiones");
    if (el.dataset.ready === "1") return;

    // ✅ Se quitó el pill de ACTUALIZADO
    el.innerHTML = `
      <div class="card panel12">
        <div class="cardtitle">FILTRO</div>
        <div class="controls" style="justify-content:flex-start;">
          <select id="iLocal"></select>
          <button id="iReset">VER TODO</button>
        </div>
        <div class="panelHint" style="margin-top:10px;">
          <span class="pill"><span class="dot agraria"></span>AGRARIA</span>
          <span class="pill"><span class="dot ulima"></span>U.LIMA</span>
          <span class="pill"><span class="dot pucp"></span>PUCP</span>
          <span class="pill"><span class="dot escolares"></span>ESCOLARES</span>
          <span class="pill"><span class="dot" style="background:${getCss("--accent2")};"></span>ADELANTO / PARALELO</span>
        </div>
      </div>

      <div class="card panel12">
        <div class="iLocalHead">
          <div class="cardtitle" style="margin:0;">RESUMEN GENERAL</div>
          <div class="iKpis">
            <span class="iKpiPill">TOTAL: <b id="iTotal">0</b></span>
            <span class="iKpiPill">SALONES: <b id="iSalones">0</b></span>
          </div>
        </div>
      </div>

      <div class="panel12" id="iBlocks"></div>
    `;

    document.getElementById("iReset").addEventListener("click", ()=>{
      document.getElementById("iLocal").value = "__ALL__";
      renderImpresiones();
    });
    document.getElementById("iLocal").addEventListener("change", renderImpresiones);

    el.dataset.ready = "1";
  }

  function renderImpresiones(){
    ensureImpresionesLayout();

    const locals = uniq(state.imprRows.map(x=>x.local)).sort((a,b)=>a.localeCompare(b,"es"));
    fillSelectKeep("iLocal", locals, "LOCAL: TODOS");

    const fLocal = document.getElementById("iLocal").value;

    let rows = state.imprRows.slice();
    if (fLocal !== "__ALL__") rows = rows.filter(x=>x.local === fLocal);

    const total = rows.reduce((a,b)=>a+(+b.count||0),0);
    document.getElementById("iTotal").textContent = total.toLocaleString("es-PE");
    document.getElementById("iSalones").textContent = rows.length.toLocaleString("es-PE");

    // agrupar por local
    const byLocal = new Map();
    for (const r of rows){
      if (!byLocal.has(r.local)) byLocal.set(r.local, []);
      byLocal.get(r.local).push(r);
    }

    // Orden local fijo
    const LOCAL_ORDER = ["LA MOLINA","SAN MIGUEL","SAN BORJA","VIRTUAL"];
    const orderedLocals = [...byLocal.keys()].sort((a,b)=>{
      const ia = LOCAL_ORDER.indexOf(a); const ib = LOCAL_ORDER.indexOf(b);
      return (ia<0?999:ia) - (ib<0?999:ib);
    });

    // Orden de tarjetas dentro de cada local:
    // AGRARIA (0) -> U.LIMA (1) -> PUCP (2) -> ESCOLARES (3) -> ADELANTO/PARALELO (4)
    function itemSortKey(it){
      const meta = imprMetaFromSalon(it.salon);
      return [meta.group, String(it.salon||"").toUpperCase()];
    }

    const blocks = orderedLocals.map(loc=>{
      const list = byLocal.get(loc).slice().sort((a,b)=>{
        const ka = itemSortKey(a);
        const kb = itemSortKey(b);
        if (ka[0] !== kb[0]) return ka[0] - kb[0];
        return ka[1].localeCompare(kb[1], "es");
      });

      const subTotal = list.reduce((x,y)=>x+(+y.count||0),0);

      const items = list.map(it=>{
        const meta = imprMetaFromSalon(it.salon);

        return `
          <div class="iItem">
            <div class="iLeft">
              <div class="iSalon">${escapeHtml(it.salon)}</div>
              <div class="iMeta">
                <span class="dot" style="background:${meta.dot};"></span>
                <span>${escapeHtml(meta.label)}</span>
              </div>
            </div>
            <div class="iNum" style="color:${meta.num};">
              ${(+it.count||0).toLocaleString("es-PE")}
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="card panel12">
          <div class="iLocalHead">
            <div class="cardtitle" style="margin:0;">${escapeHtml(loc)}</div>
            <div class="iKpis">
              <span class="iKpiPill">TOTAL: <b>${subTotal.toLocaleString("es-PE")}</b></span>
              <span class="iKpiPill">SALONES: <b>${list.length}</b></span>
            </div>
          </div>
          <div class="iGrid">${items}</div>
        </div>
      `;
    }).join("");

    document.getElementById("iBlocks").innerHTML = blocks || `
      <div class="card panel12">
        <div class="cardtitle">SIN DATOS</div>
        <div style="color:var(--muted); font-weight:900;">No se encontraron registros en IMPRESIONES.</div>
      </div>
    `;
  }

  async function loadImpresiones(){
    try{
      const url = csvUrl(IMPRESIONES_GID) + "&v=" + Date.now();
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("HTTP "+res.status);
      const text = await res.text();

      state.imprRows = parseImpresionesCSV(text);
      state.imprUpdatedAt = Date.now(); // se conserva, pero ya no se muestra en pantalla
    } catch(e){
      console.error("IMPRESIONES:", e);
      state.imprRows = state.imprRows || [];
    }
  }
  // ===================== FIN IMPRESIONES =====================

  // ===================== SÍLABOS (NUEVO) =====================
  const SILABOS = {
    "AGRARIA": [
      { name:"RAZ. MATEMÁTICO", url:"https://docs.google.com/spreadsheets/d/18p6FOxX2w4DxgG1eVXdAUt9q-56EIfTyYDbEC4J0G9Y/edit?gid=11988891#gid=11988891" },
      { name:"RAZ. VERBAL", url:"https://docs.google.com/spreadsheets/d/1hSp4h3q_p0lWWYIBD_Zlr08e_JSM57SDi3Ih6Kl790Q/edit" },
      { name:"ARITMÉTICA", url:"https://docs.google.com/spreadsheets/d/1QsTH-iYZe7fTl_5KpDVbsvYUrfx_k1EI2NZyhS-jrMc/edit?usp=drive_link" },
      { name:"ÁLGEBRA", url:"https://docs.google.com/spreadsheets/d/1OvggaurE7NZ0bWwom7zdyFWZNz8d4RC6Rb89fVRBkpw/edit?usp=drive_link" },
      { name:"GEOMETRÍA", url:"https://docs.google.com/spreadsheets/d/1jAhW0n4DCqK44Kfir4pG5O7XQOuR0UyxoSOjcSdL-I8/edit?usp=drive_link" },
      { name:"TRIGONOMETRÍA", url:"https://docs.google.com/spreadsheets/d/196t9OpyGDiYFiNqTNmGfH0GAoPzSUxILmM0Yzwp1WOY/edit?usp=drive_link" },
      { name:"FÍSICA", url:"https://docs.google.com/spreadsheets/d/1SZix5q-IYn1jzGuuY-AXhmNkSInXAVDXXK4_iKF2hg4/edit?usp=drive_link" },
      { name:"QUÍMICA", url:"https://docs.google.com/spreadsheets/d/168lg1yWf8mlHmXHn6XBlf98s6M5VWeAUDynZM1UjaEg/edit?usp=drive_link" },
      { name:"BIOLOGÍA", url:"https://docs.google.com/spreadsheets/d/1BamXi4aUPrpt0dk7s0azz1MUGq6rNIphUuklsR7a9DA/edit?usp=drive_link" },
      { name:"ECONOMÍA", url:"https://docs.google.com/spreadsheets/d/1HO6fhyzqK9nwkCFgzAmVD47IVtYxlv-DxMicuQpL2b0/edit?usp=drive_link" },
      { name:"HISTORIA", url:"https://docs.google.com/spreadsheets/d/1lMvIMdCwRk0RxQGfopKtcCSGIotVseGLx-_s826LNIs/edit?usp=drive_link" },
      { name:"GEOGRAFÍA", url:"https://docs.google.com/spreadsheets/d/1UZnm5r-6wGFZv6XmdxjhunIDWnqoKInrz2_9X62p_Fs/edit?usp=drive_link" },
    ],
    "PUCP": [
      { name:"TEXTOS", url:"https://docs.google.com/spreadsheets/d/1Wbbg2jAYKAagf8epDjH696R-coee2RVsOSpQBHuKEbw/edit?usp=drive_link" },
      { name:"NÚMEROS Y OPERACIONES", url:"https://docs.google.com/spreadsheets/d/1TaImYwfp_qphpQpRMD0APTeBTaI4TtE--JPaiQwwsgo/edit?usp=drive_link" },
      { name:"ÁLGEBRA", url:"https://docs.google.com/spreadsheets/d/1PkkyMje9KL_PbRtRyA8qVNCzmea2DCMOrkUVTiL_q1g/edit?usp=drive_link" },
      { name:"GEOMETRÍA Y MEDIDA", url:"https://docs.google.com/spreadsheets/d/1bouIIMS6Vf084r6Ki-ODPo9QGrzXP09RNmZ64xlYf3M/edit?usp=drive_link" },
      { name:"ESTADÍSTICA", url:"https://docs.google.com/spreadsheets/d/1bEZDZNcYG7WtVN23KLWMsyVGaceW_GuVwkcw9JrRZ04/edit?usp=drive_link" },
      { name:"HABILIDAD OPERATIVA", url:"https://docs.google.com/spreadsheets/d/1guIMTzQJqhfyfcl46NxF-zcPuO37m-TM3U4EsNGN_4k/edit?usp=drive_link" },
    ],
    "U.LIMA": [
      { name:"RAZ. MATEMÁTICO", url:"https://docs.google.com/spreadsheets/d/12Z20sVKqSanxX2sw9cQ_jT0HroEV-fzz4RWLEKvVQYY/edit?gid=11988891#gid=11988891" },
      { name:"ÁLGEBRA", url:"https://docs.google.com/spreadsheets/d/1SXpr5vnKQaEnxBpiauxBTyBzN_iSnAso1A7EpVOXy1E/edit" },
      { name:"GEOMETRÍA Y TRIGONOMETRÍA", url:"https://docs.google.com/spreadsheets/d/1PX97aFUQy_yzugcQ7c4Fgpg3-xHA-Eb7VFOK-MFUcc0/edit?gid=11988891#gid=11988891" },
      { name:"ARITMÉTICA", url:"https://docs.google.com/spreadsheets/d/1N_eSBLRHiUcE5EevFw4pnnC-4tV_pPmm1bp7o8DtE04/edit" },
      { name:"RAZ. VERBAL", url:"https://docs.google.com/spreadsheets/d/10akBiiuoasqVOMfv7g1uHiMKBJ_PHYUjR98fQMqzyQA/edit" },
      { name:"TEXTOS", url:"https://docs.google.com/spreadsheets/d/1vgmeTjdoPPfzauwUhqWcCdr6j7UWodDSWhtmX9P-lG0/edit" },
      { name:"LENGUAJE", url:"https://docs.google.com/spreadsheets/d/1e79bVVbVYL7QdFLiMWFMdDGYQrz1ye9FQAHVxcPUyUU/edit" },
      { name:"PROCESOS", url:"https://docs.google.com/spreadsheets/d/1ISwc2A8G-jISa5ni-oebxF6D8C2l0O0QJkD8eKTPcjI/edit" },
      { name:"HABILIDAD OPERATIVA", url:"https://docs.google.com/spreadsheets/d/1SebdIqWuN8y1Rt9ypqu5Q3TZfh91_EpP6RwAV5i8oCw/edit" },
    ]
  };

  function uniDot(uni){
    if (uni==="AGRARIA") return getCss("--agraria");
    if (uni==="U.LIMA") return getCss("--ulima");
    if (uni==="PUCP") return getCss("--pucp");
    if (uni==="ESCOLARES") return getCss("--schHead_ESC");
    return getCss("--ulima");
  }

  function ensureSilabosLayout(){
    const el = document.getElementById("view_silabos");
    if (el.dataset.ready === "1") return;

    // Alumno: solo su universidad
    if (CURRENT_ROLE === "alumno"){
      el.innerHTML = `
        <div class="card panel12 alSection">
          <div class="alSectionHead">
            <div>
              <div class="alSectionTitle">MI SÍLABO</div>
              <div class="alSectionSub">Se muestran únicamente los cursos de su universidad.</div>
            </div>
            <div class="alSectionTools">
              <button class="alBtn alBtnGhost" id="sBackHome">Volver a Inicio</button>
            </div>
          </div>
          <div class="alSilaboTools" style="margin-top:12px;">
            <input id="sQ" type="text" placeholder="Buscar curso dentro de mi sílabo (ej: álgebra, física, textos)"/>
            <div class="alSilaboPill" id="sUniPill">—</div>
          </div>
        </div>

        <div class="card panel12">
          <div class="syLocalHead">
            <div class="cardtitle" style="margin:0;">RESUMEN</div>
            <div class="syKpis">
              <span class="syKpiPill">CURSOS: <b id="sTotal">0</b></span>
              <span class="syKpiPill">UNIVERSIDAD: <b id="sUniOnly">—</b></span>
            </div>
          </div>
        </div>

        <div class="panel12" id="sBlocks"></div>
      `;

      const b = document.getElementById("sBackHome");
      if (b) b.addEventListener("click", ()=>setView("inicio_alumno"));
      const q = document.getElementById("sQ");
      if (q) q.addEventListener("input", renderSilabos);

      el.dataset.ready = "1";
      return;
    }

    // Admin/Tutor: filtros completos
    el.innerHTML = `
      <div class="card panel12">
        <div class="cardtitle">FILTROS</div>
        <div class="controls" style="justify-content:flex-start;">
          <select id="sUni"></select>
          <input id="sQ" type="text" placeholder="Buscar curso (ej: álgebra, física, textos)"/>
          <button id="sReset">VER TODO</button>
        </div>
        <div class="panelHint" style="margin-top:10px;">
          <span class="pill"><span class="dot agraria"></span>AGRARIA</span>
          <span class="pill"><span class="dot ulima"></span>U.LIMA</span>
          <span class="pill"><span class="dot pucp"></span>PUCP</span>
          <span class="pill"><span class="dot escolares"></span>ESCOLARES</span>
        </div>
        <div class="panelHint" style="margin-top:8px; color:var(--muted);">
        </div>
      </div>

      <div class="card panel12">
        <div class="syLocalHead">
          <div class="cardtitle" style="margin:0;">RESUMEN GENERAL</div>
          <div class="syKpis">
            <span class="syKpiPill">CURSOS: <b id="sTotal">0</b></span>
            <span class="syKpiPill">UNIVERSIDADES: <b id="sUnis">4</b></span>
          </div>
        </div>
      </div>

      <div class="panel12" id="sBlocks"></div>
    `;

    fillSelectKeep("sUni", ["AGRARIA","U.LIMA","PUCP","ESCOLARES"], "UNIVERSIDAD: TODAS");

    document.getElementById("sReset").addEventListener("click", ()=>{
      document.getElementById("sUni").value="__ALL__";
      document.getElementById("sQ").value="";
      renderSilabos();
    });
    document.getElementById("sUni").addEventListener("change", renderSilabos);
    document.getElementById("sQ").addEventListener("input", renderSilabos);

    el.dataset.ready = "1";
  }

  function renderSilabos(){
    ensureSilabosLayout();

    // Alumno: forzar su universidad
    if (CURRENT_ROLE === "alumno"){
      const prof = getAlumnoProfile();
      const q = low(document.getElementById("sQ")?.value || "");
      const blocksWrap = document.getElementById("sBlocks");
      const totalEl = document.getElementById("sTotal");
      const uniOnlyEl = document.getElementById("sUniOnly");
      const uniPill = document.getElementById("sUniPill");

      if (!blocksWrap) return;

      if (!prof){
        blocksWrap.innerHTML = `<div class="card panel12" style="box-shadow:none;">
          <div class="cardtitle">SIN PERFIL</div>
          <div style="color:var(--muted); font-weight:900;">Cierre sesión y vuelva a ingresar.</div>
        </div>`;
        if (totalEl) totalEl.textContent = "0";
        if (uniOnlyEl) uniOnlyEl.textContent = "-";
        if (uniPill) uniPill.textContent = "-";
        return;
      }

      const uni = uniKey(prof.uni || prof.uni_sheet || prof.ciclo || "") || (prof.uni || "-");
      let list = (SILABOS[uni] || []).slice();
      if (q) list = list.filter(x => low(x.name).includes(q));

      if (uniOnlyEl) uniOnlyEl.textContent = uni;
      if (totalEl) totalEl.textContent = String(list.length);
      if (uniPill){
        uniPill.innerHTML = `<span class="dot" style="background:${uniDotColor(uni)};"></span><b>${escapeHtml(uni)}</b>`;
      }

      const items = list.map(it=>{
        return `
          <a class="syItem" href="${escapeHtml(it.url)}" target="_blank" rel="noopener noreferrer">
            <div class="syLeft">
              <div class="syCourse">${escapeHtml(it.name)}</div>
              <div class="syMeta">
                <span class="dot" style="background:${uniDotColor(uni)};"></span>
                <span>${escapeHtml(uni)}</span>
              </div>
            </div>
            <div class="syOpen">ABRIR EXCEL</div>
          </a>
        `;
      }).join("");

      blocksWrap.innerHTML = `
        <div class="card panel12">
          <div class="syLocalHead">
            <div class="cardtitle" style="margin:0;">${escapeHtml(uni)}</div>
            <div class="syKpis">
              <span class="syKpiPill">CURSOS: <b>${list.length}</b></span>
            </div>
          </div>
          <div class="syWrap">
            ${items || `<div class="card panel12" style="box-shadow:none;">
              <div class="cardtitle">SIN RESULTADOS</div>
              <div style="color:var(--muted); font-weight:900;">No se encontraron cursos con el filtro actual.</div>
            </div>`}
          </div>
        </div>
      `;
      return;
    }

    // Admin/Tutor: filtros normales
    const fUni = document.getElementById("sUni").value;
    const q = low(document.getElementById("sQ").value);

    const uniOrder = ["AGRARIA","U.LIMA","PUCP","ESCOLARES"];
    let unis = uniOrder.slice();
    if (fUni !== "__ALL__") unis = unis.filter(u=>u===fUni);

    let totalCourses = 0;

    const blocks = unis.map(uni=>{
      const dot = uniDot(uni);
      let list = (SILABOS[uni] || []).slice();

      if (q){
        list = list.filter(x => low(x.name).includes(q));
      }

      totalCourses += list.length;

      const items = list.map(it=>{
        return `
          <a class="syItem" href="${escapeHtml(it.url)}" target="_blank" rel="noopener noreferrer">
            <div class="syLeft">
              <div class="syCourse">${escapeHtml(it.name)}</div>
              <div class="syMeta">
                <span class="dot" style="background:${dot};"></span>
                <span>${escapeHtml(uni)}</span>
              </div>
            </div>
            <div class="syOpen">ABRIR EXCEL</div>
          </a>
        `;
      }).join("");

      return `
        <div class="card panel12">
          <div class="syLocalHead">
            <div class="cardtitle" style="margin:0;">
              ${escapeHtml(uni)}
            </div>
            <div class="syKpis">
              <span class="syKpiPill">CURSOS: <b>${list.length}</b></span>
            </div>
          </div>
          <div class="syWrap">
            ${items || `<div class="card panel12" style="box-shadow:none;">
              <div class="cardtitle">SIN RESULTADOS</div>
              <div style="color:var(--muted); font-weight:900;">No se encontraron cursos con el filtro actual.</div>
            </div>`}
          </div>
        </div>
      `;
    }).join("");

    const sBlocks = document.getElementById("sBlocks");
    if (sBlocks) sBlocks.innerHTML = blocks;

    const sTotal = document.getElementById("sTotal");
    if (sTotal) sTotal.textContent = String(totalCourses);
  }
  // ===================== FIN SÍLABOS =====================

  // ===================== EVALUACIONES (NUEVO) =====================
  // Requiere Google Apps Script (Web App) para:
  // - Listar cursos y evaluaciones SIN exponer claves antes de rendir
  // - Recibir respuestas, calcular nota (0–20) y devolver claves tras enviar

  function apiUrlWithParams(baseUrl, params){
    const u = new URL(baseUrl);
    Object.entries(params || {}).forEach(([k,v])=>{
      if (v === undefined || v === null) return;
      u.searchParams.set(k, String(v));
    });
    return u.toString();
  }

  async function evalApiGet(action, params){
    if (!EVALS_API_URL){
      throw new Error("EVALS_API_URL no configurado. Pegue la URL del Apps Script (/exec). ");
    }
    const url = apiUrlWithParams(EVALS_API_URL, { action, ...params, _ts: Date.now() });
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const js = await res.json();
    if (!js || js.ok !== true) throw new Error(js?.error || "Respuesta inválida del API");
    return js.data;
  }

  async function evalApiPost(payload){
    if (!EVALS_API_URL){
      throw new Error("EVALS_API_URL no configurado. Pegue la URL del Apps Script (/exec). ");
    }
    // Importante: NO fijar Content-Type=application/json (provoca preflight CORS en algunos navegadores).
    // Enviamos como text/plain (simple request) y el Apps Script igual parsea el JSON.
    const res = await fetch(EVALS_API_URL, {
      method:"POST",
      body: JSON.stringify(payload || {})
    });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const js = await res.json();
    if (!js || js.ok !== true) throw new Error(js?.error || "Respuesta inválida del API");
    return js.data;
  }

  // ===================== EVALUACIONES: DRAFT (no borrar marcado) =====================
  // Guarda respuestas marcadas localmente para que NO se pierdan por refresh/scroll.
  function draftKey_(alumnoId, evalId){
    return `metapp_draft__${alumnoId || "anon"}__${evalId || "none"}`;
  }
  function loadDraft_(alumnoId, evalId){
    try{
      const raw = localStorage.getItem(draftKey_(alumnoId, evalId));
      return raw ? JSON.parse(raw) : { q1:"", q2:"", q3:"", q4:"", q5:"" };
    }catch(_){
      return { q1:"", q2:"", q3:"", q4:"", q5:"" };
    }
  }
  function saveDraft_(alumnoId, evalId, draft){
    try{ localStorage.setItem(draftKey_(alumnoId, evalId), JSON.stringify(draft || {})); }catch(_){}
  }
  function clearDraft_(alumnoId, evalId){
    try{ localStorage.removeItem(draftKey_(alumnoId, evalId)); }catch(_){}
  }
  function answeredCount_(draft){
    let c = 0;
    for (let i=1;i<=5;i++){
      const v = String(draft?.["q"+i] || "").trim();
      if (v) c++;
    }
    return c;
  }
  function updateEvalProgressUI_(draft){
    const c = answeredCount_(draft);
    const pct = Math.round((c/5)*100);
    const fill = document.getElementById("evProgressFill");
    const count = document.getElementById("evAnsweredCount");
    if (fill) fill.style.width = pct + "%";
    if (count) count.textContent = String(c);

    // marcar navegación
    const nav = document.getElementById("evNav");
    if (nav){
      nav.querySelectorAll(".evNavBtn").forEach(btn=>{
        const q = Number(btn.getAttribute("data-q") || "0");
        const v = String(draft?.["q"+q] || "").trim();
        btn.classList.toggle("done", !!v);
      });
    }
  }
  function wireDraftAutosave_(alumnoId, evalId){
    const draft = loadDraft_(alumnoId, evalId);
    updateEvalProgressUI_(draft);

    const hint = document.getElementById("evAutosave");
    function stamp(){
      if (!hint) return;
      const t = new Date();
      const hh = String(t.getHours()).padStart(2,"0");
      const mm = String(t.getMinutes()).padStart(2,"0");
      hint.textContent = "Guardado " + hh + ":" + mm;
    }

    for (let i=1;i<=5;i++){
      const q = "q"+i;
      document.querySelectorAll(`#evWork input[name="${q}"]`).forEach(inp=>{
        inp.addEventListener("change", ()=>{
          const sel = document.querySelector(`#evWork input[name="${q}"]:checked`);
          draft[q] = sel ? String(sel.value||"") : "";
          saveDraft_(alumnoId, evalId, draft);
          updateEvalProgressUI_(draft);
          stamp();
        }, { passive:true });
      });
    }

    // navegación 1..5
    const nav = document.getElementById("evNav");
    if (nav){
      nav.querySelectorAll(".evNavBtn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const q = Number(btn.getAttribute("data-q") || "0");
          const row = document.getElementById("evQ"+q);
          if (row) row.scrollIntoView({ behavior:"smooth", block:"start" });
        });
      });
    }

    // toggle PDF
    const tbtn = document.getElementById("evTogglePdf");
    const iframe = document.getElementById("evPdfFrame");
    if (tbtn && iframe){
      // En móvil, ocultar por defecto para no incomodar; en laptop, mostrar.
      if (window.innerWidth <= 760){
        iframe.classList.remove("on");
        tbtn.textContent = "VER PDF";
      } else {
        iframe.classList.add("on");
        tbtn.textContent = "OCULTAR PDF";
      }

      tbtn.addEventListener("click", ()=>{
        iframe.classList.toggle("on");
        tbtn.textContent = iframe.classList.contains("on") ? "OCULTAR PDF" : "VER PDF";
      });
    }
  }

  function ensureEvaluacionesLayout(){
    const el = document.getElementById("view_evaluaciones");
    if (!el) return;
    if (el.dataset.ready === "1") return;

    // Solo rol alumno (por diseño)
    el.innerHTML = `
      <div class="card panel12 alSection">
        <div class="alSectionHead">
          <div>
            <div class="alSectionTitle">EVALUACIONES</div>
            <div class="alSectionSub">Elige un curso, luego una evaluación (5 preguntas). Nota 0–20.</div>
          </div>
          <div class="alSectionTools">
            <button class="alBtn alBtnGhost" id="eBackHome">Volver a Inicio</button>
          </div>
        </div>

        <div class="evTopRow">
          <div class="evBox">
            <div class="evLabel">CURSO</div>
            <div id="evCourses" class="evCourses"></div>
          </div>
          <div class="evBox">
            <div class="evLabel">EVALUACIONES DEL CURSO</div>
            <div id="evList" class="evList"></div>
          </div>
        </div>
      </div>

      <div class="card panel12" id="evWork">
        <div class="cardtitle">SELECCIONA UNA EVALUACIÓN</div>
        <div class="evMuted">Primero elige un curso y luego una evaluación.</div>
      </div>
    `;

    const b = document.getElementById("eBackHome");
    if (b) b.addEventListener("click", ()=>setView("inicio_alumno"));

    el.dataset.ready = "1";
  }

  function fmtFechaES(fechaRaw){
    // Acepta: dd/mm/yyyy, yyyy-mm-dd, Date string
    const s = String(fechaRaw||"").trim();
    if (!s) return "";
    // dd/mm/yyyy
    const m1 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m1){
      const dd = m1[1].padStart(2,"0");
      const mm = m1[2].padStart(2,"0");
      const yy = m1[3];
      return `${dd}/${mm}/${yy}`;
    }
    // yyyy-mm-dd
    const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (m2){
      return `${m2[3]}/${m2[2]}/${m2[1]}`;
    }
    return s;
  }

  async function loadEvalCourses(){
    if (state.evalCourses && state.evalCourses.length) return state.evalCourses;
    const data = await evalApiGet("courses");
    state.evalCourses = Array.isArray(data) ? data : [];
    return state.evalCourses;
  }

  async function loadEvalsForCourse(course_code){
    const key = String(course_code||"").trim();
    if (!key) return [];
    if (state.evalByCourse && state.evalByCourse.has(key)){
      return state.evalByCourse.get(key);
    }
    const data = await evalApiGet("evaluations", { course_code: key });
    const list = Array.isArray(data) ? data : [];
    if (!state.evalByCourse) state.evalByCourse = new Map();
    state.evalByCourse.set(key, list);
    return list;
  }

  async function loadEvalStatusForSelected(){
    // Consulta si el alumno ya envió esta evaluación (para bloquear reenvío y mostrar su nota).
    const prof = getAlumnoProfile() || {};
    const ev = state.evalSelEval || null;
    if (!prof.usuario || !ev?.eval_id) { state.evalLastResult = null; return null; }
    try{
      const out = await evalApiGet("status", { alumno_id: prof.usuario, eval_id: ev.eval_id });
      state.evalLastResult = out || null;
      return state.evalLastResult;
    } catch(_){
      state.evalLastResult = null;
      return null;
    }
  }

  function renderEvalCourses(courses){
    const wrap = document.getElementById("evCourses");
    if (!wrap) return;

    const sel = state.evalSelCourse;
    const items = (courses || []).map(c=>{
      const code = c.course_code;
      const name = c.course_name;
      const on = (sel && sel.course_code === code);
      return `<button class="evCourseBtn ${on ? "on":""}" data-course="${escapeHtml(code)}" type="button">
        <div class="evCourseCode">${escapeHtml(code)}</div>
        <div class="evCourseName">${escapeHtml(name)}</div>
      </button>`;
    }).join("");

    wrap.innerHTML = items || `<div class="evMuted">No hay cursos cargados.</div>`;

    wrap.querySelectorAll("button[data-course]").forEach(b=>{
      b.addEventListener("click", async ()=>{
        const code = b.getAttribute("data-course");
        const course = (state.evalCourses||[]).find(x=>x.course_code===code) || { course_code:code, course_name:code };
        state.evalSelCourse = course;
        state.evalSelEval = null;
        state.evalLastResult = null;
        state.evalInProgress = false;
        renderEvaluaciones();
      });
    });
  }


  function renderEvalList(evals){
    const wrap = document.getElementById("evList");
    const work = document.getElementById("evWork");
    if (!wrap) return;

    if (!state.evalSelCourse){
      wrap.innerHTML = `<div class="evMuted">Selecciona un curso.</div>`;
      if (work){
        work.innerHTML = `<div class="cardtitle">SELECCIONA UN CURSO</div><div class="evMuted">Elige uno de los 12 cursos.</div>`;
      }
      return;
    }

    const selId = state.evalSelEval?.eval_id || null;

    const raw = (evals || []).slice();

    function dateKey_(x){
      const s = String(x||"").trim();
      // dd/mm/yyyy
      let m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m){
        const dd = m[1].padStart(2,"0");
        const mm = m[2].padStart(2,"0");
        const yy = m[3];
        return `${yy}${mm}${dd}`;
      }
      // yyyy-mm-dd
      m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) return `${m[1]}${m[2]}${m[3]}`;
      // yyyymmdd
      if (/^\d{8}$/.test(s)) return s;
      return "";
    }

    function bloqueOrder_(b){
      const s = String(b||"").trim().toUpperCase();
      if (s === "A") return 1;
      if (s === "B") return 2;
      if (s === "C") return 3;
      return 99;
    }

    // Regla: el alumno verá como máximo 2 evaluaciones del curso.
    // Seleccionamos la FECHA más reciente y mostramos hasta 2 bloques de esa fecha (A,B,C en orden).
    const enriched = raw.map(ev=>({ ...ev, _dkey: dateKey_(ev.fecha) }));
    const maxKey = enriched.reduce((acc, x)=> (x._dkey && x._dkey > acc ? x._dkey : acc), "");
    const list = enriched
      .filter(x=> (maxKey ? x._dkey === maxKey : true))
      .sort((a,b)=>{
        const oa = bloqueOrder_(a.bloque);
        const ob = bloqueOrder_(b.bloque);
        if (oa !== ob) return oa - ob;
        return String(a.eval_id||"").localeCompare(String(b.eval_id||""));
      })
      .slice(0, 2)
      .map(x=>{ const y = { ...x }; delete y._dkey; return y; });

    // Guardamos la lista visible para que el click funcione aunque haya re-render/auto-refresh
    state.evalVisibleEvals = list;

    const items = (list || []).map(ev=>{
      const on = (selId && selId === ev.eval_id);
      const f = fmtFechaES(ev.fecha);
      const bb = String(ev.bloque||"").toUpperCase();
      return `<button class="evItem ${on ? "on":""}" data-eval="${escapeHtml(ev.eval_id)}" type="button">
        <div class="evItemTop">
          <div class="evItemTitle">${escapeHtml(ev.tema || "Evaluación")}</div>
          <div class="evItemMeta">${escapeHtml(f)} • Bloque ${escapeHtml(bb)}</div>
        </div>
        <div class="evItemId">${escapeHtml(ev.eval_id)}</div>
      </button>`;
    }).join("");

    wrap.innerHTML = items || `<div class="evMuted">No hay evaluaciones ACTIVAS para este curso.</div>`;

    // Delegación de eventos (más robusto que listeners por botón)
    wrap.onclick = async (e)=>{
      const btn = e.target.closest('button[data-eval]');
      if (!btn) return;

      const id = String(btn.getAttribute("data-eval") || "");
      const ev = (state.evalVisibleEvals || []).find(x=>String(x.eval_id)===id) || null;

      state.evalSelEval = ev;
      state.evalLastResult = null;

      // Marcar seleccionado en la lista
      wrap.querySelectorAll('button[data-eval]').forEach(b=>{
        b.classList.toggle("on", String(b.getAttribute("data-eval")||"") === id);
      });

      await loadEvalStatusForSelected();
      state.evalInProgress = !(state.evalLastResult && state.evalLastResult.already_submitted);

      renderEvaluacionWork();

      // Llevar al formulario para que el alumno sienta que "abrió" la evaluación
      const workEl = document.getElementById("evWork");
      if (workEl) workEl.scrollIntoView({ behavior:"smooth", block:"start" });
    };

    if (!state.evalSelEval && work){
      work.innerHTML = `<div class="cardtitle">SELECCIONA UNA EVALUACIÓN</div>
        <div class="evMuted">Curso: <b>${escapeHtml(state.evalSelCourse.course_name || state.evalSelCourse.course_code)}</b></div>`;
    }
  }

function mkQuestionRow(qi, draft, disabled){
    const n = qi + 1;
    const name = `q${n}`;
    const opts = ["A","B","C","D","E"];
    const cur = String(draft?.[name] || "").trim().toUpperCase();

    const radios = opts.map(o=>{
      const chk = (cur === o) ? "checked" : "";
      const dis = disabled ? "disabled" : "";
      return `
        <label class="evOpt">
          <input type="radio" name="${name}" value="${o}" ${chk} ${dis}>
          <span>${o}</span>
        </label>
      `;
    }).join("");

    // Si el alumno no marca nada, se considera "en blanco" automáticamente (sin mostrar opción extra).
    return `
      <div class="evQRow" id="evQ${n}">
        <div class="evQName">
          <span>Pregunta ${n}</span>
          <span class="evQNameSub">Marca A–E (si no respondes, queda en blanco)</span>
        </div>
        <div class="evOpts">${radios}</div>
      </div>
    `;
  }

  function renderEvaluacionWork(){
    const work = document.getElementById("evWork");
    if (!work) return;

    const prof = getAlumnoProfile();
    if (!prof){
      work.innerHTML = `<div class="cardtitle">SIN PERFIL</div>
        <div class="evMuted">Cierre sesión y vuelva a ingresar.</div>`;
      return;
    }

    if (!state.evalSelCourse || !state.evalSelEval){
      work.innerHTML = `<div class="cardtitle">SELECCIONA UNA EVALUACIÓN</div>
        <div class="evMuted">Primero elige un curso y luego una evaluación.</div>`;
      return;
    }

    const ev = state.evalSelEval;
    const prev = state.evalLastResult || null;
    const locked = !!(prev && prev.already_submitted);
    const alumnoId = String(prof.usuario || prof.dni || prof.codigo || prof.nombre || "anon").trim() || "anon";

    // Draft: restaura lo marcado si hay refresh
    const draft = loadDraft_(alumnoId, ev.eval_id);
    const qRows = [0,1,2,3,4].map(i=>mkQuestionRow(i, draft, locked)).join("");
    const f = fmtFechaES(ev.fecha);
    const bb = String(ev.bloque||"").toUpperCase();

    const link = String(ev.link_ejercicios||"").trim();
    const showCfg = String(ev.mostrar_ejercicios||"").trim();
    // Si no configuraste mostrar_ejercicios, pero sí hay link, por defecto mostramos el botón.
    const showEx = (showCfg === "" ? (link !== "") : (showCfg.toUpperCase() === "TRUE"));

    function toDrivePreviewUrl(u){
      const s = String(u||"").trim();
      if (!s) return "";
      // Convierte link "view" a "preview" para embebido (Drive).
      const m = s.match(/https?:\/\/drive\.google\.com\/file\/d\/([^/]+)/);
      if (m) return `https://drive.google.com/file/d/${m[1]}/preview`;
      return s;
    }

    const previewUrl = toDrivePreviewUrl(link);


        work.innerHTML = `
      <div class="cardtitle">
        <span>EVALUACIÓN</span>
        <span class="panelHint">${escapeHtml(state.evalSelCourse.course_name || state.evalSelCourse.course_code)} • ${escapeHtml(f)} • Bloque ${escapeHtml(bb)}</span>
      </div>

      <div class="evWorkHead">
        <div>
          <div class="evWorkTema">${escapeHtml(ev.tema || "Evaluación")}</div>
          <div class="evWorkMeta">ID: <b>${escapeHtml(ev.eval_id)}</b> • Alumno: <b>${escapeHtml(prof.nombre || prof.usuario)}</b></div>
        </div>
        <div class="evWorkActions">
          <button class="alBtn alBtnGhost" id="evReload">Recargar</button>
        </div>
      </div>

      <div class="evProgressWrap">
        <div class="evProgressTop">
          <div class="evProgressLabel"><b><span id="evAnsweredCount">0</span></b>/5 respondidas</div>
          <div class="evAutosave" id="evAutosave">Guardado</div>
        </div>
        <div class="evProgress"><div class="evProgressFill" id="evProgressFill"></div></div>
        <div class="evNav" id="evNav">
          <button type="button" class="evNavBtn" data-q="1">1</button>
          <button type="button" class="evNavBtn" data-q="2">2</button>
          <button type="button" class="evNavBtn" data-q="3">3</button>
          <button type="button" class="evNavBtn" data-q="4">4</button>
          <button type="button" class="evNavBtn" data-q="5">5</button>
        </div>
      </div>

      <div class="evEx">
        ${showEx && link ? `
          <div class="evExRow">
            <a class="evLink" href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">ABRIR EJERCICIOS</a>
            ${previewUrl ? `<button class="evLink evLinkLite" id="evTogglePdf" type="button">VER PDF</button>` : ``}
          </div>
          ${previewUrl ? `<iframe class="evPdf on" id="evPdfFrame" src="${escapeHtml(previewUrl)}" loading="lazy"></iframe>` : ``}
          <div class="evMuted">Si no marcas una pregunta, se considera en blanco.</div>
        ` : `
          <div class="evMuted"><b>Ejercicios ocultos.</b> Responde sin ver ejercicios.</div>
          <div class="evMuted">Si no marcas una pregunta, se considera en blanco.</div>
        `}
      </div>

      <div class="evForm">
        ${qRows}
      </div>

      <div class="evStickyBar">
        <button class="alBtn" id="evSend" type="button">${locked ? "YA ENVIADO" : "ENVIAR RESPUESTAS"}</button>
        <div class="evMuted" id="evSendMsg"></div>
      </div>

      <div id="evResult"></div>
    `;

    const rbtn = document.getElementById("evReload");
    if (rbtn){
      rbtn.addEventListener("click", async ()=>{
        const code = state.evalSelCourse?.course_code;
        if (code && state.evalByCourse) state.evalByCourse.delete(code);
        await renderEvaluaciones(true);
      });
    }


    // Draft autosave + progreso (evita pérdida de marcado por auto-refresh)
    if (!locked){
      state.evalInProgress = true;
      wireDraftAutosave_(alumnoId, ev.eval_id);
    } else {
      state.evalInProgress = false;
      updateEvalProgressUI_(draft);
      const sb = document.getElementById("evSend");
      if (sb) sb.disabled = true;
    }


    // Envío (bind aquí para que siempre funcione al seleccionar una evaluación)
    {
      const sendBtn = document.getElementById("evSend");
      const msg = document.getElementById("evSendMsg");
      const resBox = document.getElementById("evResult");

      if (sendBtn){
        if (locked){
          sendBtn.disabled = true;
          sendBtn.onclick = null;
        } else {
          sendBtn.disabled = false;
          sendBtn.onclick = async ()=>{
            // Evita doble click
            if (state.evalSubmitting) return;
            state.evalSubmitting = true;

            let sentOk = false;
            try{
              if (msg) msg.textContent = "Enviando...";
              sendBtn.disabled = true;

              const answers = {};
              for (let i=1;i<=5;i++){
                const sel = document.querySelector(`#evWork input[name="q${i}"]:checked`);
                answers[`q${i}`] = sel ? String(sel.value||"") : "";
              }

              const payload = {
                action: "submit",
                alumno_id: String(prof.usuario || ""),
                alumno_nombre: String(prof.nombre || ""),
                course_code: String(state.evalSelCourse.course_code || ""),
                eval_id: String(ev.eval_id || ""),
                answers
              };

              const out = await evalApiPost(payload);
              sentOk = true;
              state.evalLastResult = out;
              state.evalInProgress = false;
              clearDraft_(String(prof.usuario||""), String(ev.eval_id||""));

              // Mostrar resultado (nota + claves)
              if (resBox){
                resBox.innerHTML = renderEvalResult(out);
                resBox.scrollIntoView({ behavior:"smooth", block:"start" });
              }

              // Bloquear re-envío
              document.querySelectorAll('#evWork input[type="radio"]').forEach(i=>{ i.disabled = true; });
              sendBtn.textContent = "YA ENVIADO";
              sendBtn.disabled = true;
              sendBtn.onclick = null;

              const nota = (out && out.score !== undefined) ? out.score : "";
              if (msg){
                msg.innerHTML = `${out?.already_submitted ? "Ya rendiste esta evaluación." : "Enviado."} Nota: <b>${escapeHtml(String(nota))}</b> / 20.`;
              }
            } catch(err){
              console.error(err);
              if (msg) msg.textContent = "Error: " + (err?.message || err);
              if (resBox) resBox.innerHTML = `<div class="evError">No se pudo enviar. Revise el Apps Script y permisos del Sheet.</div>`;
              sendBtn.disabled = false;
            } finally {
              state.evalSubmitting = false;
              if (!sentOk) sendBtn.disabled = false;
            }
          };
        }
      }
    }


    // Si ya existe envío previo, bloquear y mostrar resultado inmediatamente
    if (prev && prev.already_submitted){
      const sendBtn = document.getElementById("evSend");
      const msg = document.getElementById("evSendMsg");
      const resBox = document.getElementById("evResult");
      if (sendBtn){
        sendBtn.disabled = true;
        sendBtn.textContent = "YA ENVIADO";
      }
      document.querySelectorAll('#evWork input[type="radio"]').forEach(i=>{ i.disabled = true; });
      if (msg) msg.innerHTML = `Ya rendiste esta evaluación. Nota: <b>${escapeHtml(String(prev.score))}</b> / 20.`;
      if (resBox) resBox.innerHTML = renderEvalResult(prev);
      if (resBox) resBox.scrollIntoView({ behavior:"smooth", block:"start" });
    }
  }

  function renderEvalResult(out){
    if (!out) return "";
    const score = out.score;
    const max = out.max || 20;
    const detail = out.detail || [];
    const keys = out.keys || {};

    const rows = (detail || []).map(d=>{
      const q = escapeHtml(d.q || "");
      const ans = (d.ans === "" ? "—" : escapeHtml(d.ans));
      const key = escapeHtml(d.key || "");
      const delta = (d.delta>=0 ? "+"+d.delta : String(d.delta));
      const ok = d.ok ? "ok" : (d.ans==="" ? "soft" : "warn");
      const label = d.ok ? "CORRECTO" : (d.ans==="" ? "SIN RESPUESTA" : "INCORRECTO");
      return `
        <div class="evResRow">
          <div class="evResQ">${q}</div>
          <div class="evResA"><span class="alChip ${ok}">${ans}</span></div>
          <div class="evResK">Clave: <b>${key}</b></div>
          <div class="evResD">${label} (${delta})</div>
        </div>
      `;
    }).join("");

    return `
      <div class="evResultCard">
        <div class="evScore">NOTA: <b>${escapeHtml(String(score))}</b> / ${escapeHtml(String(max))}</div>
        <div class="evMuted">Regla: correcta +4, incorrecta -1, blanco 0. (Acotado 0–20)</div>

        <div class="evKeyLine">
          <span class="pill">CLAVES:</span>
          <span class="pill">Q1 <b>${escapeHtml(keys.q1 || "")}</b></span>
          <span class="pill">Q2 <b>${escapeHtml(keys.q2 || "")}</b></span>
          <span class="pill">Q3 <b>${escapeHtml(keys.q3 || "")}</b></span>
          <span class="pill">Q4 <b>${escapeHtml(keys.q4 || "")}</b></span>
          <span class="pill">Q5 <b>${escapeHtml(keys.q5 || "")}</b></span>
        </div>

        <div class="evResGrid">
          ${rows}
        </div>
      </div>
    `;
  }

  async function renderEvaluaciones(forceReload, softUpdate){
    ensureEvaluacionesLayout();

    const work = document.getElementById("evWork");
    const listWrap = document.getElementById("evList");
    const coursesWrap = document.getElementById("evCourses");

    if (CURRENT_ROLE !== "alumno"){
      if (work){
        work.innerHTML = `<div class="cardtitle">NO DISPONIBLE</div><div class="evMuted">Este módulo está habilitado solo para alumnos.</div>`;
      }
      if (coursesWrap) coursesWrap.innerHTML = "";
      if (listWrap) listWrap.innerHTML = "";
      return;
    }

    try{
      if (forceReload){
        state.evalCourses = [];
        state.evalByCourse = new Map();
      }
      const courses = await loadEvalCourses();
      renderEvalCourses(courses);

      if (!state.evalSelCourse && courses && courses.length){
        state.evalSelCourse = courses[0];
      }

      if (state.evalSelCourse){
        const evals = await loadEvalsForCourse(state.evalSelCourse.course_code);
        renderEvalList(evals);
      } else {
        renderEvalList([]);
      }

      if (state.evalSelEval && !softUpdate){
        renderEvaluacionWork();
      }

      // Si es actualización automática mientras el alumno está resolviendo, no tocar el formulario.
      if (softUpdate){
        return;
      }

    } catch(err){
      console.error(err);
      if (work){
        work.innerHTML = `<div class="cardtitle">CONFIGURACIÓN PENDIENTE</div>
          <div class="evError">${escapeHtml(err?.message || String(err))}</div>
          <div class="evMuted">Solución: despliega el Apps Script (Web App) y pega su URL en <b>EVALS_API_URL</b>.</div>`;
      }
      if (coursesWrap) coursesWrap.innerHTML = `<div class="evMuted">—</div>`;
      if (listWrap) listWrap.innerHTML = `<div class="evMuted">—</div>`;
    }
  }

  // ===================== FIN EVALUACIONES =====================

// ===================== MATERIALES (NUEVO) =====================
const MATERIALES = [
  { uni:"AGRARIA",   url:"https://drive.google.com/drive/folders/1pDEZ0rG3l27snsgp4UGo0qaS5irT2f2d?usp=sharing" },
  { uni:"U.LIMA",    url:"https://drive.google.com/drive/folders/1bFR0PRaSJFGnSJy6Ii6jU8SvHKCJrC9n" },
  { uni:"PUCP",      url:"https://drive.google.com/drive/folders/1FfUL4GEiHALYEOhBHTJA3SzHVotRGv0k?usp=sharing" },
  { uni:"ESCOLARES", url:"" },
];

// ===================== NOTAS GENERALES (NUEVO) =====================
const NOTAS_GENERALES = [
  // ✅ PUCP
  { id:"PUCP",   uni:"PUCP",   label:"NOTAS GENERALES PUCP",   url:"https://docs.google.com/spreadsheets/d/1FF_AIzA4cEKk1p9nWd0DziIyHx5XDzoY3luP7wlRweU/edit?usp=drive_link" },

  // ✅ U.LIMA
  { id:"ULIMA",  uni:"U.LIMA", label:"NOTAS GENERALES U.LIMA", url:"https://docs.google.com/spreadsheets/d/1iEGRZBKnuS32i1wdZKMy5EPKJNE0hrgD2-2cISZn5cI/edit?usp=drive_link" },

  // ⏳ AGRARIA (pendiente: cuando exista, pega aquí el enlace)
  { id:"AGRARIA", uni:"AGRARIA", label:"NOTAS GENERALES AGRARIA", url:"https://docs.google.com/spreadsheets/d/1q5PWgltXQBVcwQpwFqvkxtjGKP8HDlfWzZFs8zByFCo/edit?usp=drive_link" },
];

function ensureNotasLayout(){
  const el = document.getElementById("view_notas");
  if (!el || el.dataset.ready === "1") return;

  el.innerHTML = `
    <div class="card panel12">
      <div class="cardtitle">NOTAS GENERALES</div>
      <div style="color:var(--muted); font-weight:900; margin-bottom:12px;">
      </div>
      <div class="iGrid" id="notasGrid"></div>
    </div>
  `;
  el.dataset.ready = "1";
}

function renderNotasGenerales(){
  ensureNotasLayout();

  const grid = document.getElementById("notasGrid");
  if (!grid) return;

  const notasOrdered = NOTAS_GENERALES.slice().sort((a,b)=>{
    const rank = (u)=>{
      const t = String(u||"").toUpperCase();
      if (t.includes("AGRARIA")) return 0;
      if (t.includes("U.LIMA") || t.includes("ULIMA")) return 1;
      if (t.includes("PUCP")) return 2;
      if (t.includes("ESCOLAR")) return 3;
      return 9;
    };
    const ra = rank(a.uni);
    const rb = rank(b.uni);
    if (ra !== rb) return ra - rb;
    return String(a.label||"").localeCompare(String(b.label||""), "es");
  });

  grid.innerHTML = notasOrdered.map(x => {
    const dot =
      x.uni === "AGRARIA" ? getCss("--agraria") :
      x.uni === "PUCP"    ? getCss("--pucp") :
                            getCss("--ulima");

    const url = String(x.url || "").trim();
    if (url){
      return `
        <a class="iItem" href="${escapeHtml(url)}" target="_blank" rel="noopener"
           style="text-decoration:none; color:inherit;">
          <div class="iLeft">
            <div class="iSalon">${escapeHtml(x.label)}</div>
            <div class="iMeta">
              <span class="dot" style="background:${dot};"></span>
              <span>${escapeHtml(x.uni)}</span>
            </div>
          </div>
          <div class="iNum" style="color:${dot};">→</div>
        </a>
      `;
    }
    return `
      <div class="iItem disabled" title="Pendiente: no hay enlace configurado aún.">
        <div class="iLeft">
          <div class="iSalon">${escapeHtml(x.label)}</div>
          <div class="iMeta">
            <span class="dot" style="background:${dot};"></span>
            <span>${escapeHtml(x.uni)} (PENDIENTE)</span>
          </div>
        </div>
        <div class="iNum" style="color:${dot};">—</div>
      </div>
    `;
  }).join("");
}




function ensureMaterialesLayout(){
  const el = document.getElementById("view_materiales");
  if (el.dataset.ready === "1") return;

  el.innerHTML = `
    <div class="card panel12">
      <div class="cardtitle">MATERIALES</div>
      <div style="color:var(--muted); font-weight:900; margin-bottom:12px;">
        Acceso directo a carpetas por universidad (materiales listos / trabajados).
      </div>
      <div class="iGrid" id="matGrid"></div>
    </div>

    <div class="card panel12" id="matCursoCard">
      <div class="cardtitle">CONTROL DE MATERIALES POR CURSO</div>
      <div style="color:var(--muted); font-weight:900; margin-bottom:10px;">
        Cada <b>CURSO</b> usa la estructura del <b>PROGRAMA</b>: se listan las semanas (códigos de la fila <b>Semana</b>)
        y se marcan 3 estados: <b>RECIBIDO</b>, <b>DIAGRAMADO</b> e <b>IMPRESO</b>.
      </div>

      <div class="mrTop">
        <div class="mrSelRow">
          <select id="mcProgram"></select>
          <select id="mcCourse"></select>
<input id="mcLink" type="text" placeholder="Link carpeta del CURSO (Drive)" style="min-width:360px;"/>
          <button id="mcSaveLink" class="mrBtn" type="button">GUARDAR</button>
          <a id="mcOpenLink" class="mrBtn" target="_blank" rel="noopener" style="text-decoration:none; display:inline-flex; align-items:center;">ABRIR</a>
        </div>

        <div class="mrSelRow">
          <button id="mcAllRec" class="mrBtn" type="button">RECIBIDO: TODO</button>
          <button id="mcAllDia" class="mrBtn" type="button">DIAGRAMADO: TODO</button>
          <button id="mcAllImp" class="mrBtn" type="button">IMPRESO: TODO</button>
          <button id="mcClear"  class="mrBtn" type="button">LIMPIAR</button>

          <span class="mrKpi">REC: <b id="mcRecPct">0%</b></span>
          <span class="mrKpi">DIA: <b id="mcDiaPct">0%</b></span>
          <span class="mrKpi">IMP: <b id="mcImpPct">0%</b></span>
        </div>
      </div>

      <div class="mrBody" id="matCursoBody"></div>
    </div>
  `;

  // events
  document.getElementById("mcProgram")?.addEventListener("change", renderMateriales);
  document.getElementById("mcCourse")?.addEventListener("change", renderMateriales);
  document.getElementById("mcFilter")?.addEventListener("change", renderMateriales);

  document.getElementById("mcSaveLink")?.addEventListener("click", ()=>{
    const pid = document.getElementById("mcProgram").value || "__ALL__";
    const cid = document.getElementById("mcCourse").value || "";
    if (pid === "__ALL__" || !cid) return toast("Selecciona PROGRAMA y CURSO.");
    const url = String(document.getElementById("mcLink").value||"").trim();
    const st = mcLoadStore();
    if (!st.links) st.links = {};
    if (!st.links[pid0]) st.links[pid0] = {};
    st.links[pid0][cid0] = url;
    mcSaveStore(st);
    toast("Link guardado.");
    renderMateriales();
  });

  document.getElementById("mcAllRec")?.addEventListener("click", ()=> mcMarkAllColumn("rec", true));
  document.getElementById("mcAllDia")?.addEventListener("click", ()=> mcMarkAllColumn("dia", true));
  document.getElementById("mcAllImp")?.addEventListener("click", ()=> mcMarkAllColumn("imp", true));
  document.getElementById("mcClear")?.addEventListener("click", ()=> mcClearAll());

  el.dataset.ready = "1";
}

// --- Store (curso x semana x estado)
const MC_STORE_KEY = "LM_MAT_CURSOS_V1";

function mcLoadStore(){
  try{ return JSON.parse(localStorage.getItem(MC_STORE_KEY) || '{"links":{},"status":{}}'); }
  catch(e){ return {links:{}, status:{}}; }
}
function mcSaveStore(st){
  try{ localStorage.setItem(MC_STORE_KEY, JSON.stringify(st||{links:{},status:{}})); }catch(e){}
  // push a store compartido
  mcSyncPush_(st||{links:{},status:{}});
}


// --- Sync central (MATERIALES - control por curso)
async function mcSyncPullOnce_(){
  const remote = await lmRemoteGet_(LM_MODULE_MATERIALES);
  if (!remote || typeof remote !== "object") return;
  try{
    localStorage.setItem(MC_STORE_KEY, JSON.stringify(remote));
  }catch(_){}
  // si está abierta la vista materiales, repinta
  if (typeof state !== "undefined" && state && state.view === "materiales" && typeof renderMateriales === "function"){
    renderMateriales();
  }
}
async function mcSyncPush_(st){
  try{
    await lmRemoteSet_(LM_MODULE_MATERIALES, st || {links:{}, status:{}});
  }catch(_){}
}

// --- Cursos por defecto (AGRARIA / AG REGULAR)
function mcCoursesForProgram(programId){
  const list = (typeof pgxProgramsForRole === "function") ? pgxProgramsForRole() : [];
  const p = list.find(x=>x.id===programId);
  const theme = String(p?.meta?.theme||"").toUpperCase();

  if (theme !== "AGRARIA") return [];

  return [
    { id:"RV",        name:"RAZONAMIENTO VERBAL" },
    { id:"TXT",       name:"TEXTOS" },
    { id:"RM",        name:"RAZONAMIENTO MATEMÁTICO" },
    { id:"ALG",       name:"ÁLGEBRA" },
    { id:"GEO",       name:"GEOMETRÍA" },
    { id:"TRIG",      name:"TRIGONOMETRÍA" },
    { id:"ARI",       name:"ARITMÉTICA" },
    { id:"FIS",       name:"FÍSICA" },
    { id:"QUI",       name:"QUÍMICA" },
    { id:"BIO",       name:"BIOLOGÍA" },
    { id:"ECO",       name:"ECONOMÍA" },
    { id:"HIS",       name:"HISTORIA" },
    { id:"GEOG",      name:"GEOGRAFÍA" },
    { id:"REF_MAT",   name:"REFORZAMIENTO DE MATEMÁTICAS" },
  ];
}

function mcWeekCodes(programId){
  // Lee la fila "Semana" del módulo PROGRAMA (códigos únicos, no vacíos).
  const store = (typeof pgxLoadStore === "function") ? pgxLoadStore() : null;
  const p = store && store.programs ? store.programs[programId] : null;
  if (!p) return [];

  const lane = (p.config?.lanes||[]).find(l=>String(l.key||"").toLowerCase()==="semana");
  const vals = Array.isArray(lane?.values) ? lane.values : [];

  const out = [];
  const seen = new Set();
  for (const v of vals){
    const s = String(v||"").trim();
    if (!s) continue;
    if (seen.has(s)) continue;
    seen.add(s);
    out.push(s);
  }
  return out;
}

function mcEnsureStatus(st, pid, cid){
  if (!st.status) st.status = {};
  if (!st.status[pid]) st.status[pid] = {};
  if (!st.status[pid][cid]) st.status[pid][cid] = {};
  return st.status[pid][cid];
}

function mcGetFlags(st, pid, cid, code){
  const map = mcEnsureStatus(st, pid, cid);
  if (!map[code]) map[code] = {rec:false, dia:false, imp:false};
  const o = map[code];
  return {rec:!!o.rec, dia:!!o.dia, imp:!!o.imp};
}

function mcGetFlag(st, pid, cid, code, field){
  const f = mcGetFlags(st, pid, cid, code);
  return !!(f && f[field]);
}


function mcSetFlag(st, pid, cid, code, field, val){
  const map = mcEnsureStatus(st, pid, cid);
  if (!map[code]) map[code] = {rec:false, dia:false, imp:false};
  map[code][field] = !!val;
}

function mcProgress(stOrPid, pidOrCid, cidOrNull, codesOrNull){
  // Soporta llamadas antiguas y nuevas.
  let st, pid, cid, codes;
  if (typeof stOrPid === "string"){
    pid = stOrPid;
    cid = String(pidOrCid||"");
    st = mcLoadStore();
    codes = mcWeekCodes(pid);
  }else{
    st = stOrPid || mcLoadStore();
    pid = String(pidOrCid||"");
    cid = String(cidOrNull||"");
    codes = Array.isArray(codesOrNull) ? codesOrNull : mcWeekCodes(pid);
  }

  const map = (st.status && st.status[pid] && st.status[pid][cid]) ? st.status[pid][cid] : {};
  const total = (codes && codes.length) ? codes.length : 0;

  let rec=0, dia=0, imp=0;
  for (const c of (codes||[])){
    const o = map[c] || {};
    if (o.rec) rec++;
    if (o.dia) dia++;
    if (o.imp) imp++;
  }
  const pct = (x)=> total ? Math.round((x/total)*100) : 0;
  return {total, rec, dia, imp, recPct:pct(rec), diaPct:pct(dia), impPct:pct(imp)};
}

function mcSelected(){
  const pid = document.getElementById("mcProgram")?.value || "__ALL__";
  const cid = document.getElementById("mcCourse")?.value || "";
  return {pid, cid};
}

function mcMarkAllColumn(field, val){
  const {pid, cid} = mcSelected();
  if (pid === "__ALL__" || !cid) return toast("Selecciona PROGRAMA y CURSO.");
  const codes = mcWeekCodes(pid);
  if (!codes.length) return toast("No hay semanas (códigos) para marcar. Completa la fila Semana en PROGRAMA.");

  const st = mcLoadStore();
  codes.forEach(code=> mcSetFlag(st, pid, cid, code, field, val));
  mcSaveStore(st);
  renderMateriales();
}

function mcClearAll(){
  const {pid, cid} = mcSelected();
  if (pid === "__ALL__" || !cid) return toast("Selecciona PROGRAMA y CURSO.");
  const st = mcLoadStore();
  if (st.status && st.status[pid] && st.status[pid][cid]) st.status[pid][cid] = {};
  mcSaveStore(st);
  renderMateriales();
}


function renderMateriales(){
  ensureMaterialesLayout();

  // ===== tarjetas de carpetas (accesos directos) =====
  const grid = document.getElementById("matGrid");
  if (grid){
    const MAT_UNI_ORDER = ["AGRARIA","U.LIMA","PUCP","ESCOLARES"];
    const MAT_UNI_COLOR = {
      "AGRARIA": getCss("--agraria"),
      "U.LIMA": getCss("--ulima"),
      "PUCP": getCss("--pucp"),
      "ESCOLARES": getCss("--schHead_ESC")
    };

    const orderedMaterials = MAT_UNI_ORDER.map(u=>{
      const found = (MATERIALES||[]).find(x=>String(x.uni||"").toUpperCase()===u);
      return found || { uni:u, url:"" };
    });

    grid.innerHTML = orderedMaterials.map(x=>{
      const u = String(x.uni||"").toUpperCase();
      const dot = MAT_UNI_COLOR[u] || getCss("--accent");
      const href = String(x.url||"").trim();
      const isReady = !!href;
      const caption = isReady ? "ABRIR CARPETA" : "CARPETA PENDIENTE";

      return `
        <a class="iItem${isReady ? "" : " disabled"}" href="${escapeHtml(isReady ? href : "#")}" target="_blank" rel="noopener"
           style="text-decoration:none; color:inherit;">
          <div class="iLeft">
            <div class="iSalon">${escapeHtml(u)}</div>
            <div class="iMeta">
              <span class="dot" style="background:${dot};"></span>
              <span>${caption}</span>
            </div>
          </div>
          <div class="iNum" style="color:${dot};">${isReady ? "⟶" : "—"}</div>
        </a>
      `;
    }).join("");
  }

  // ===== CONTROL POR CURSO (flujo profesional) =====
  const card = document.getElementById("matCursoCard");
  if (!card) return;

  const allowedUni = ["AGRARIA","U.LIMA","PUCP","ESCOLARES"];
  const roleLower = String(CURRENT_ROLE||"").toLowerCase();
  const canEdit = (roleLower === "admin"); // edición de estructura (solo Admin)
  const canWork = (roleLower === "admin" || roleLower === "tutor"); // marcar estados (Tutor/Admin)
  const MAT_EDIT_KEY = "LM_MAT_EDIT_MODE";
  const matEditDefault = (roleLower === "tutor");
  const matEditOn = (localStorage.getItem(MAT_EDIT_KEY) ?? (matEditDefault ? "1" : "0")) === "1";

  const store = pgxLoadStore();
    const baseWeeks = pgxTotalWeeks();
  const programsAll = (typeof pgxProgramsForRole==="function") ? pgxProgramsForRole() : [];
  const byUni = (uni)=> programsAll.filter(p=>String(p?.meta?.scope||"ALL").toUpperCase()===uni);

  const COURSES = {
    "AGRARIA":[
      "Razonamiento Verbal","Textos","Razonamiento Matemático","Álgebra","Geometría","Trigonometría","Aritmética",
      "Física","Química","Biología","Economía","Historia","Geografía","Reforzamiento de Matemáticas"
    ],
    "U.LIMA":["(Definir cursos U.LIMA)"],
    "PUCP":[  "Habilidad Operativa",
  "Estadística",
  "Geometría y Medida",
  "Números y Operaciones",
  "Textos",
  "Álgebra"],
    "ESCOLARES":["(Definir cursos escolares)"]
  };

  const UNI_KEY="LM_MAT_UI_UNI";
  const PROG_KEY="LM_MAT_UI_PROG";
  const COURSE_KEY="LM_MAT_UI_COURSE";

  const curUni = (localStorage.getItem(UNI_KEY) || "AGRARIA").toUpperCase();
  const uni = allowedUni.includes(curUni) ? curUni : "AGRARIA";

  const uniPrograms = byUni(uni);
  const progIdSaved = localStorage.getItem(PROG_KEY) || "";
  const prog = uniPrograms.find(p=>p.id===progIdSaved) || uniPrograms[0] || null;

  const courses = COURSES[uni] || [];
  const savedCourse = localStorage.getItem(COURSE_KEY) || "";
  const course = courses.includes(savedCourse) ? savedCourse : (courses[0]||"");

  // helpers
  function fmtDM(d){
    if (!d) return "";
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    return `${dd}/${mm}`;
  }

  function getSemanaCodes(p){
    const baseWeeks = pgxTotalWeeks();
    const lane = (p?.config?.lanes||[]).find(x=>String(x.key||"").toLowerCase()==="semana");
    const v = Array.isArray(lane?.values) ? lane.values : [];
    return Array.from({length:baseWeeks}, (_,i)=> String(v[i]||`SEM${i+1}`));
  }
  function getPlannedRange(p){
    const baseWeeks = pgxTotalWeeks();
    const win = (typeof pgxProgramWindow==="function") ? pgxProgramWindow(p, baseWeeks) : {start:1,end:baseWeeks};
    let wStart = Math.max(1, Math.min(baseWeeks, +win.start || 1));
    let wEnd   = Math.max(wStart, Math.min(baseWeeks, +win.end || baseWeeks));

    let first = Infinity;
    let last  = 0;

    const lanes = (p?.config?.lanes||[]).filter(l=>l && l.type==="cells");
    for (const l of lanes){
      const vals = Array.isArray(l.values) ? l.values : [];
      for (let i=wStart-1; i<=wEnd-1; i++){
        const s = String(vals[i]||"").trim();
        if (!s) continue;
        if ((i+1) < first) first = i+1;
        if ((i+1) > last)  last  = i+1;
      }
    }
    if (first === Infinity) first = wStart;
    if (last === 0) last = wEnd;

    first = Math.max(wStart, Math.min(first, wEnd));
    last  = Math.max(first, Math.min(last, wEnd));
    return {first, last, wStart, wEnd};
  }

  function mcProgressRange(st, pid, cid, codes, first, last){
    const map = (st.status && st.status[pid] && st.status[pid][cid]) ? st.status[pid][cid] : {};
    const total = Math.max(0, (last - first + 1));

    let rec=0, dia=0, imp=0, weekOk=0;
    for (let i=first-1; i<=last-1; i++){
      const code = String(codes[i] || `SEM${i+1}`);
      const o = map[code] || {};
      if (o.rec) rec++;
      if (o.dia) dia++;
      if (o.imp) imp++;
      if (o.rec && o.dia && o.imp) weekOk++;
    }
    const pct = (x)=> total ? Math.round((x/total)*100) : 0;
    return {total, rec, dia, imp, weekOk, recPct:pct(rec), diaPct:pct(dia), impPct:pct(imp), weekOkPct:pct(weekOk)};
  }


  const uniBtnColor = (u)=>{
    const uc = String(u||"").toUpperCase();
    if (uc === "AGRARIA") return getCss("--agraria");
    if (uc === "U.LIMA") return getCss("--ulima");
    if (uc === "PUCP") return getCss("--pucp");
    return getCss("--schHead_ESC");
  };
  const uniButtonsHtml = allowedUni.map(u=>{
    const c = uniBtnColor(u);
    const active = (u === uni);
    const bg = active ? `${c}1A` : "#fff";
    return `<button class="btn ${active?"primary":"ghost"}" type="button" data-uni="${escapeHtml(u)}" style="border-color:${c}; color:${c}; background:${bg};">${escapeHtml(u)}</button>`;
  }).join("");

  // build UI
  card.innerHTML = `
    <div class="cardtitle">CONTROL DE MATERIALES</div>
    <div style="color:var(--muted); font-weight:900; margin-bottom:12px;">
      Flujo: <b>Universidad</b> → <b>Programa</b> → <b>Curso</b>. Las semanas muestran <b>código</b> y <b>fecha</b> según el programa.
      ${canWork ? "" : "<br/><b>Solo lectura</b>: para actualizar estados, ingresa como Tutor o Admin."}
    </div>

    <div class="mrTop" style="gap:10px;">
      <div class="mrSelRow" style="flex-wrap:wrap;">
        ${uniButtonsHtml}
      </div>

      <div class="mrSelRow" style="flex-wrap:wrap;">
        <label style="font-weight:950; color:var(--muted);">PROGRAMA
          <select id="mcP2" style="margin-left:8px; padding:8px 10px; border-radius:12px; border:1px solid var(--border); font-weight:900;">
            ${(uniPrograms.length?uniPrograms:[{id:"",meta:{name:"(Sin programas)"} }]).map(p=>`<option value="${escapeHtml(p.id||"")}">${escapeHtml(String(p?.meta?.name||"").toUpperCase()||"(SIN PROGRAMAS)")}</option>`).join("")}
          </select>
        </label>

        <label style="font-weight:950; color:var(--muted);">CURSO
          <select id="mcC2" style="margin-left:8px; padding:8px 10px; border-radius:12px; border:1px solid var(--border); font-weight:900;">
            ${(courses.length?courses:["(Sin cursos)"]).map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(String(c).toUpperCase())}</option>`).join("")}
          </select>
        </label>

        <a id="mcOpen2" class="btn folder" target="_blank" rel="noopener" style="margin-left:6px; text-decoration:none;">📁 CARPETA</a>
        ${(canEdit && matEditOn) ? '<input id="mcLink2" type="text" placeholder="Link carpeta (Drive)" style="min-width:320px; padding:8px 10px; border-radius:12px; border:1px solid var(--border); font-weight:900;"/><button id="mcSaveLink2" class="btn ghost" type="button">GUARDAR LINK</button>' : ""}

${canWork ? `<button id="mcEditBtn" class="btn ${matEditOn?'primary':'ghost'}" type="button" style="margin-left:6px;">${matEditOn?'EDITANDO':'EDITAR'}</button>` : ""}
      </div>
    </div>

    <div id="mcBody2" style="margin-top:12px;"></div>
  `;

  // wire uni buttons
  card.querySelectorAll("button[data-uni]").forEach(b=>{
    b.addEventListener("click", ()=>{
      localStorage.setItem(UNI_KEY, String(b.getAttribute("data-uni")||"AGRARIA"));
      localStorage.removeItem(PROG_KEY);
      localStorage.removeItem(COURSE_KEY);
      renderMateriales();
    });
  });

  // set selects values
  const selP = card.querySelector("#mcP2");
  const selC = card.querySelector("#mcC2");
  if (selP) selP.value = prog ? prog.id : "";
  if (selC) selC.value = course || (courses[0]||"");

  // link de carpeta por curso (Admin configura; Tutor/Alumno abre)
  const st0 = mcLoadStore();
  const pid0 = String(selP?.value||"");
  const cid0 = String(selC?.value||"");
  const curUrl = String((st0.links && st0.links[pid0] && st0.links[pid0][cid0]) ? st0.links[pid0][cid0] : "").trim();
  const openBtn = card.querySelector("#mcOpen2");
  const linkInp = card.querySelector("#mcLink2");
  const saveBtn = card.querySelector("#mcSaveLink2");

  if (openBtn){
    if (curUrl){
      openBtn.setAttribute("href", curUrl);
      openBtn.classList.remove("disabled");
      openBtn.style.pointerEvents = "";
      openBtn.style.opacity = "1";
    }else{
      openBtn.setAttribute("href", "#");
      openBtn.style.pointerEvents = "none";
      openBtn.style.opacity = "0.55";
      openBtn.title = "Sin link configurado (Admin).";
    }
  }
  if (linkInp) linkInp.value = curUrl;

  saveBtn?.addEventListener("click", ()=>{
    if (!canEdit) return toast("Solo Admin puede configurar links.");
    const url = String(linkInp?.value||"").trim();
    const st = mcLoadStore();
    if (!st.links) st.links = {};
    if (!st.links[pid0]) st.links[pid0] = {};
    st.links[pid0][cid0] = url;
    mcSaveStore(st);
    toast("Link guardado.");
    renderMateriales();
  });

  selP?.addEventListener("change", ()=>{
    localStorage.setItem(PROG_KEY, String(selP.value||""));
    renderMateriales();
  });
  selC?.addEventListener("change", ()=>{
    localStorage.setItem(COURSE_KEY, String(selC.value||""));
    renderMateriales();
  });

  // toggle edición de materiales (marcar checkboxes)
  const eb = card.querySelector("#mcEditBtn");
  eb?.addEventListener("click", ()=>{
    const now = (localStorage.getItem(MAT_EDIT_KEY) === "1");
    localStorage.setItem(MAT_EDIT_KEY, now ? "0" : "1");
    renderMateriales();
  });

  const body = card.querySelector("#mcBody2");
  if (!body) return;

  if (!prog || !prog.id){
    body.innerHTML = `<div class="pgEmpty">No hay programas para <b>${escapeHtml(uni)}</b>. Crea uno en <b>PROGRAMA</b> (Admin).</div>`;
    return;
  }

  const pid = prog.id;
  const cid = String(selC?.value||"");

  // dates per program
  const pStart = pgxParseDateYMD(String(prog?.meta?.startDate||"")) || pgxParseDateYMD(String(store.timeline?.startDate||"")) || new Date();
  const codes = getSemanaCodes(prog);
  const range = getPlannedRange(prog);

  // progress
  const st = mcLoadStore();
  const pr = mcProgressRange(st, pid, cid, codes, range.first, range.last);

  const progBars = `
    <div class="mcBarsCompact">
      ${[
        {k:"rec", t:"RECIBIDO", v:pr.recPct},
        {k:"dia", t:"DIAGRAMADO", v:pr.diaPct},
        {k:"imp", t:"IMPRESO", v:pr.impPct},
              ].map(o=>`
        <div style="border:1px solid var(--border); border-radius:14px; padding:10px 12px; background:#fff;">
          <div style="display:flex; justify-content:space-between; align-items:center; font-weight:950; margin-bottom:6px;">
            <span>${o.t}</span><span>${o.v}%</span>
          </div>
          <div style="height:10px; border-radius:999px; background:rgba(15,23,42,0.10); overflow:hidden;">
            <div style="height:10px; width:${o.v}%; background:linear-gradient(90deg,var(--accent2),var(--accent));"></div>
          </div>
          <div style="margin-top:6px; color:var(--muted); font-weight:850; font-size:12px;">
            ${o.k==="imp" ? "Estado final del material." : "Progreso intermedio."}
          </div>
        </div>
      `).join("")}
    </div>
  `;

  const rows = [];
  const totalW = Math.max(0, (range.last - range.first + 1));
  for (let i=range.first-1, idx=1; i<=range.last-1; i++, idx++){
    const code = String(codes[i] || `SEM${i+1}`);
    const date = fmtDM(pgxAddDays(pStart, i*7));
    const rec = !!mcGetFlag(st, pid, cid, code, "rec");
    const dia = !!mcGetFlag(st, pid, cid, code, "dia");
    const imp = !!mcGetFlag(st, pid, cid, code, "imp");

    const wkDone = (rec && dia && imp);
    const wkPct  = Math.round(((+rec + +dia + +imp)/3)*100);
    const semClass = (wkPct>=100)?"s100":(wkPct>=67)?"s67":(wkPct>=33)?"s33":"s0";

    const disCls = (canWork && matEditOn) ? "" : "mcChkReadOnly";
    const roAttr = (canWork && matEditOn) ? "" : "data-ro='1' tabindex='-1'";
    rows.push(`
      <tr>
        <td style="font-weight:950;">${idx}</td>
        <td>${escapeHtml(date)}</td>
        <td style="font-weight:950;">${escapeHtml(code)}</td>

        <td><span class="semBadge ${semClass}"><span class="semDot"></span>${wkPct}%</span></td>

        <td class="mcChkCell"><input type="checkbox" class="${disCls}" ${roAttr} data-code="${escapeHtml(code)}" data-field="rec" ${rec?"checked":""}></td>
        <td class="mcChkCell"><input type="checkbox" class="${disCls}" ${roAttr} data-code="${escapeHtml(code)}" data-field="dia" ${dia?"checked":""}></td>
        <td class="mcChkCell"><input type="checkbox" class="${disCls}" ${roAttr} data-code="${escapeHtml(code)}" data-field="imp" ${imp?"checked":""}></td>
      </tr>
    `);
  }

  body.innerHTML = `
    <div class="mrTop" style="margin:0;">
      <div class="mrKpi">${escapeHtml(String(prog.meta?.name||"PROGRAMA").toUpperCase())} · <b>${escapeHtml(String(cid||"CURSO").toUpperCase())}</b> · Inicio: <b>${escapeHtml(fmtDM(pgxAddDays(pStart,(range.first-1)*7)))}</b> · Fin: <b>${escapeHtml(fmtDM(pgxAddDays(pStart,(range.last-1)*7)))}</b></div>
    </div>

    ${progBars}

    <div class="mcTableWrap">
      <table class="mcTable">
        <thead>
          <tr style="background:#f1f5f9;">
            <th>#</th>
            <th>FECHA</th>
            <th>SEMANA</th>
            <th>SEM%</th>
            <th class="mcStatusCol">RECIBIDO</th>
            <th class="mcStatusCol">DIAGRAMADO</th>
            <th class="mcStatusCol">IMPRESO</th>
          </tr>
        </thead>
        <tbody>
          ${rows.length ? rows.join("") : `<tr><td colspan="7" style="padding:14px; color:var(--muted); font-weight:950;">No hay filas para este filtro.</td></tr>`}
        </tbody>
      </table>
    </div>

    <div style="margin-top:10px; color:var(--muted); font-weight:900;">
    </div>
  `;

  // wire checkboxes
  body.querySelectorAll('input[type=checkbox][data-code][data-field]').forEach(ch=>{
    ch.addEventListener("change", ()=>{
      if (ch.dataset.ro === "1"){
        renderMateriales();
        return;
      }
      const code = String(ch.getAttribute("data-code")||"");
      const field = String(ch.getAttribute("data-field")||"");
      const st2 = mcLoadStore();
      mcSetFlag(st2, pid, cid, code, field, !!ch.checked);
      mcSaveStore(st2);
      renderMateriales();
    });
  });
}



// ===================== LISTAS (NUEVO) =====================
const LISTAS = [
  // ================= LA MOLINA =================
  { local:"LA MOLINA", name:"AGRARIA 1", url:"https://docs.google.com/spreadsheets/d/1DaCwdvXjHWK5u24aObF9YFBaO2M65_ANj2XOgc2hJxg/edit?usp=drive_link" },
  { local:"LA MOLINA", name:"AGRARIA 2", url:"https://docs.google.com/spreadsheets/d/12Ti_WVsDCYC9HM4K58l0fFpbK3bAs4ffXQUPpQ0-nOA/edit?usp=drive_link" },
  { local:"LA MOLINA", name:"AGRARIA ESCOLAR", url:"" },
  { local:"LA MOLINA", name:"PUCP",      url:"https://docs.google.com/spreadsheets/d/11ccHJmPBzkCuWgMWfUKwRfOUgyWG4_8a2rM8Ur_BYq0/edit?usp=drive_link" },
  { local:"LA MOLINA", name:"U.LIMA 1",    url:"https://docs.google.com/spreadsheets/d/1y3hfwo3NYmrShRNBOdwLCwM9AUd9Aj2YoJtfgvlZrOY/edit?usp=drive_web&ouid=109996193497961946614" },
  { local:"LA MOLINA", name:"PARALELO",  url:"https://docs.google.com/spreadsheets/d/1uqJMpS3_QY6DmvnDjatf8tWcArf8kCtyYjIt7mSpJXU/edit?usp=drive_web&ouid=109996193497961946614" },
  { local:"LA MOLINA", name:"ADELANTO",  url:"https://docs.google.com/spreadsheets/d/1k6oglFw7pd-XqFyv4NZf5xl0MM7PYZ507vuSFkp6uFU/edit?gid=1104164959#gid=1104164959" },

  // ================= SAN MIGUEL =================
  { local:"SAN MIGUEL", name:"AGRARIA 1",   url:"https://docs.google.com/spreadsheets/d/1NuFkT0EX-gPqbblJbFV7sNVGiJyhurZ-Yj120ocqaHc/edit?usp=drive_link" },
  { local:"SAN MIGUEL", name:"PUCP",      url:"https://docs.google.com/spreadsheets/d/1a2H6-1tUwosj2cRCXQ_kzcfT0CILTIJLomS-xcr7WsM/edit?usp=drive_link" },
  { local:"SAN MIGUEL", name:"U.LIMA 1",  url:"https://docs.google.com/spreadsheets/d/1epSbc_HEN0VfVQXE581x6uU-QcuDZ0kESwL5WlRwYgU/edit?usp=drive_web&ouid=109996193497961946614" },
  { local:"SAN MIGUEL", name:"U.LIMA 2",  url:"https://docs.google.com/spreadsheets/d/1--AqnIDhIdZvbeIUjYC_BPwdHHHOAhSIqOnmIODNUkU/edit?usp=drive_web&ouid=109996193497961946614" },
  { local:"SAN MIGUEL", name:"PARALELO",  url:"https://docs.google.com/spreadsheets/d/1KlFuLnC99juHJoI7VT9Ez6cVN3c-X76eZzcZS17IXqM/edit?gid=1104164959#gid=1104164959" },
  { local:"SAN MIGUEL", name:"ADELANTO",  url:"https://docs.google.com/spreadsheets/d/1SrjJdlBjeNf12I0XFZ0FuripltmSNNmPOa_bTD0pZa8/edit?usp=drive_web&ouid=109996193497961946614" },

  // ================= SAN BORJA =================
  { local:"SAN BORJA", name:"AGRARIA 1",   url:"https://docs.google.com/spreadsheets/d/1YLu1uP2kR1SwjVPWPKSgcbSKomCkdlItLn5AyAP3j8A/edit?usp=drive_link" },
  { local:"SAN BORJA", name:"PUCP",      url:"https://docs.google.com/spreadsheets/d/1MUPBs6yAWzUgU02Qz2PnJ-kVmVtS82XdM89IXlnwF8g/edit?usp=drive_link" },
  { local:"SAN BORJA", name:"U.LIMA 1",  url:"https://docs.google.com/spreadsheets/d/1yPhbG38WC0tl97qQ5LXahAS2L6jqSdga6u3vAkuneC0/edit?usp=drive_web&ouid=109996193497961946614" },
  { local:"SAN BORJA", name:"U.LIMA 2",  url:"https://docs.google.com/spreadsheets/d/1BJSLmUr2ECAfanxuI2py0R2Yi_eqovmkHuLcUNgMFSw/edit?usp=drive_web&ouid=109996193497961946614" },

  // ================= VIRTUAL =================
  { local:"VIRTUAL", name:"AGRARIA",   url:"https://docs.google.com/spreadsheets/d/1A06U7wDDHBmRrxnlai4hm5shaNJcF9qjWRa8xcusZVg/edit?usp=drive_link" },
    { local:"VIRTUAL", name:"U.LIMA 1",  url:"https://docs.google.com/spreadsheets/d/1o22eorhLJWwKU3gyZgkB204MBVZX5tQ11jP3p73ll3s/edit?gid=1104164959#gid=1104164959" },
  { local:"VIRTUAL", name:"U.LIMA 2",  url:"https://docs.google.com/spreadsheets/d/1KGhDGI2tKrXs2sf29m2_y0ft6P7VtKyq4rNU_rWTMSE/edit?gid=1104164959#gid=1104164959" },
  { local:"VIRTUAL", name:"ESCOLAR",   url:"https://docs.google.com/spreadsheets/d/15JJwUgf7WARdS4yBjUPAxkUigrPXm3LjTqrFJBI1mxE/edit?usp=drive_web&ouid=109996193497961946614" },
];
const LISTAS_LOCAL_ORDER = ["LA MOLINA","SAN MIGUEL","SAN BORJA","VIRTUAL"];

function sortListasByLocalOrder(values){
  return values.slice().sort((a,b)=>{
    const ia = LISTAS_LOCAL_ORDER.indexOf(a);
    const ib = LISTAS_LOCAL_ORDER.indexOf(b);
    return (ia<0?999:ia) - (ib<0?999:ib);
  });
}

function ensureListasLayout(){
  const el = document.getElementById("view_listas");
  if (el.dataset.ready === "1") return;

  el.innerHTML = `
    <div class="card panel12">
      <div class="cardtitle">FILTROS</div>
      <div class="controls" style="justify-content:flex-start;">
        <select id="lLocal"></select>
        <input id="lQ" type="text" placeholder="Buscar (ej: agraria, pucp, paralelo, adelanto)"/>
        <button id="lReset">VER TODO</button>
      </div>
    </div>

    <div class="card panel12">
      <div class="syLocalHead">
        <div class="cardtitle" style="margin:0;">RESUMEN</div>
        <div class="syKpis">
          <span class="syKpiPill">ENLACES: <b id="lTotal">0</b></span>
          <span class="syKpiPill">SEDES: <b id="lLocs">0</b></span>
        </div>
      </div>
    </div>

    <div class="panel12" id="lBlocks"></div>
  `;

  const locals = uniq(LISTAS.map(x=>x.local));
  fillSelectKeep("lLocal", sortListasByLocalOrder(locals), "LOCAL: TODOS");

  document.getElementById("lReset").addEventListener("click", ()=>{
    document.getElementById("lLocal").value="__ALL__";
    document.getElementById("lQ").value="";
    renderListas();
  });
  document.getElementById("lLocal").addEventListener("change", renderListas);
  document.getElementById("lQ").addEventListener("input", renderListas);

  el.dataset.ready = "1";
}
function listaMetaFromName(name){
  const s = String(name || "").toUpperCase();

  // Caso atípico: ADELANTO / PARALELO => rojizo diferenciado al final
  if (s.includes("PARALELO") || s.includes("ADELANTO")){
    const red = getCss("--accent2");
    return { group: 4, dot: red, label: "ADELANTO / PARALELO" };
  }

  // AGRARIA => verde
  if (s.includes("AGRARIA")){
    const c = getCss("--agraria");
    return { group: 0, dot: c, label: "AGRARIA" };
  }

  // ESCOLARES => color escolar
  if (s.includes("ESCOLAR") || s.includes("ESC.")){
    const c = getCss("--schHead_ESC");
    return { group: 3, dot: c, label: "ESCOLARES" };
  }

  // U.LIMA => naranja
  if (s.includes("U.LIMA") || s.includes("U LIMA") || s.includes("ULIMA") || s.includes("LIMA")){
    const c = getCss("--ulima");
    return { group: 1, dot: c, label: "U.LIMA" };
  }

  // PUCP => azul
  if (s.includes("PUCP")){
    const c = getCss("--pucp");
    return { group: 2, dot: c, label: "PUCP" };
  }

  // Si algo no calza, lo mandamos al final en rojizo
  const red = getCss("--accent2");
  return { group: 5, dot: red, label: "OTRO" };
}

function renderListas(){
  ensureListasLayout();

  const fLocal = document.getElementById("lLocal").value;
  const q = low(document.getElementById("lQ").value);

  let base = LISTAS.slice();
  if (fLocal !== "__ALL__") base = base.filter(x=>x.local===fLocal);
  if (q) base = base.filter(x => low(x.name).includes(q) || low(x.local).includes(q));

  // agrupar por local (orden fijo)
  const byLocal = new Map();
  for (const it of base){
    if (!byLocal.has(it.local)) byLocal.set(it.local, []);
    byLocal.get(it.local).push(it);
  }

  const orderedLocals = [...byLocal.keys()].sort((a,b)=>{
    const ia = LISTAS_LOCAL_ORDER.indexOf(a);
    const ib = LISTAS_LOCAL_ORDER.indexOf(b);
    return (ia<0?999:ia) - (ib<0?999:ib);
  });

  let totalLinks = 0;

  const blocks = orderedLocals.map(loc=>{
    const list = byLocal.get(loc).slice().sort((a,b)=>{
      const ma = listaMetaFromName(a.name);
      const mb = listaMetaFromName(b.name);
      if (ma.group !== mb.group) return ma.group - mb.group;
      return String(a.name||"").localeCompare(String(b.name||""), "es");
    });

    totalLinks += list.length;

const items = list.map(it=>{
  const meta = listaMetaFromName(it.name);

  return `
    <a class="syItem" href="${escapeHtml(it.url)}" target="_blank" rel="noopener noreferrer">
      <div class="syLeft">
        <div class="syCourse">${escapeHtml(it.name)}</div>
        <div class="syMeta">
          <span class="dot" style="background:${meta.dot};"></span>
          <span>${escapeHtml(loc)}</span>
        </div>
      </div>
      <div class="syOpen">ABRIR</div>
    </a>
  `;
}).join("");


    return `
      <div class="card panel12">
        <div class="syLocalHead">
          <div class="cardtitle" style="margin:0;">${escapeHtml(loc)}</div>
          <div class="syKpis">
            <span class="syKpiPill">ENLACES: <b>${list.length}</b></span>
          </div>
        </div>
        <div class="syWrap">
          ${items || `<div class="card panel12" style="box-shadow:none;">
            <div class="cardtitle">SIN RESULTADOS</div>
            <div style="color:var(--muted); font-weight:900;">No hay listas con el filtro actual.</div>
          </div>`}
        </div>
      </div>
    `;
  }).join("");

  document.getElementById("lTotal").textContent = totalLinks.toLocaleString("es-PE");
  document.getElementById("lLocs").textContent  = orderedLocals.length.toLocaleString("es-PE");
  document.getElementById("lBlocks").innerHTML  = blocks || `
    <div class="card panel12">
      <div class="cardtitle">SIN DATOS</div>
      <div style="color:var(--muted); font-weight:900;">No se encontraron listas para mostrar.</div>
    </div>
  `;
}
// ===================== FIN LISTAS =====================

// ===================== REPORTES (NUEVO) =====================
// ✅ Pega tus enlaces en el campo reporte y carpeta (deja "" si aún no tienes el link).
// ✅ Se mantiene el ORDEN solicitado: AGRARIA, U.LIMA, PUCP, ESCOLARES y luego ADELANTO/PARALELO.
const REPORTES = [
  // ================= LA MOLINA =================
  { local:"LA MOLINA", name:"AGRARIA LM 1",      reporte:"https://colab.research.google.com/drive/1JRbVPMcHo11e5Q3xmBvF4ZGJUJ3-PMbe?usp=drive_link" , carpeta:"https://drive.google.com/drive/folders/1HL2DJaMf2vT_DbLzBjGzV84UstzWyzLn?usp=drive_link" },
  { local:"LA MOLINA", name:"AGRARIA LM 2",      reporte:"https://colab.research.google.com/drive/1-nCsEiJvFYCOeHlNaYVGNPWrYs79cGYN?usp=drive_link" , carpeta:"https://drive.google.com/drive/folders/1IrYwFVCr-wnM_F_1R_t6WR1l710Hmt5l?usp=drive_link" },
  { local:"LA MOLINA", name:"AGRARIA ESCOLAR",  reporte:"", carpeta:"" },
  { local:"LA MOLINA", name:"PUCP LM",           reporte:"https://colab.research.google.com/drive/1Edgesw6yJC1vD7J44Sq7ZMqouXImuINU" , carpeta:"https://drive.google.com/drive/folders/1L-q9DsaMC-1CGOzTgvsfq3ynpp1rT0aB?usp=drive_link" },
  { local:"LA MOLINA", name:"U.LIMA LM",         reporte:"https://colab.research.google.com/drive/1TU7HoBroIBo7XONr4hifgd0r3gzKQbd1" , carpeta:"https://drive.google.com/drive/folders/1qm3hOeoaVThu8CHL6TdJvgKuhhm89Iu_?usp=drive_link" },
  { local:"LA MOLINA", name:"ADELANTO LM",       reporte:"https://colab.research.google.com/drive/1GmBZNfVlXi7z6DUTg3hnVMiW0DlONKJ-" , carpeta:"https://drive.google.com/drive/folders/1_pfkbWLqGj7xBXn4_u967d7qYQzNFicF?usp=drive_link" },

  // ================= SAN MIGUEL =================
  { local:"SAN MIGUEL", name:"AGRARIA SM",       reporte:"https://colab.research.google.com/drive/1C__V_81I9fH1ftZ8zH8yMBvIpBtLGZF7" , carpeta:"https://drive.google.com/drive/folders/1GZiz03ezHkJJyO1lc5d4hwf0x53Tkg2N?usp=drive_link" },
  { local:"SAN MIGUEL", name:"PUCP SM",          reporte:"https://colab.research.google.com/drive/1roEJq2NiU4pQB8rsbhDKvR_g8wjCKgoi" , carpeta:"https://drive.google.com/drive/folders/1te_o0tJvqNoT_hRdcww1-COq6_AQ1DjE?usp=drive_link" },
  { local:"SAN MIGUEL", name:"U.LIMA SM 1",      reporte:"https://colab.research.google.com/drive/1wLAf1p8LmF4dI-qLVjTv8Ax0XmJH2vHr" , carpeta:"https://drive.google.com/drive/folders/1-gdGNSuaG0MVx-zgX87QT2VZipdO7VZ3?usp=drive_link" },
  { local:"SAN MIGUEL", name:"U.LIMA SM 2",      reporte:"https://colab.research.google.com/drive/1AKoWoQ4LzXg7DCJNF_Vaqw9kmUXxuuWu" , carpeta:"https://drive.google.com/drive/folders/1tx-fLVA6MXtqah0yQbXXPNfjUrxUE7Kd?usp=drive_link" },
  { local:"SAN MIGUEL", name:"ADELANTO SM",      reporte:"https://colab.research.google.com/drive/1K_LFFycdNc6KS_LMCb5-2groejZlvBXI" , carpeta:"https://drive.google.com/drive/folders/1D5j3HXKQW1vz5Ybz3Wh0yZsf_jz4XZ6x?usp=drive_link" },

  // ================= SAN BORJA =================
  { local:"SAN BORJA",  name:"AGRARIA SB",       reporte:"https://colab.research.google.com/drive/1AqLVAqCWepspc6rZ_LeH83Jhl7wVls7-" , carpeta:"https://drive.google.com/drive/folders/1HqI3RCFvou5nRZOK3xGl-qU0IKXYlIik?usp=drive_link" },
  { local:"SAN BORJA",  name:"PUCP SB",          reporte:"https://colab.research.google.com/drive/1czyfJSMFAMdDkjXvI8t3UPNO9KfzGtIC" , carpeta:"https://drive.google.com/drive/folders/1QpADvW35TgiQuDIsKUUY0fRrVAYEhjgh?usp=drive_link" },
  { local:"SAN BORJA",  name:"U.LIMA SB 1",      reporte:"https://colab.research.google.com/drive/1mElja6XYJ25gG10y-UneEgjUFEDK-i-M" , carpeta:"https://drive.google.com/drive/folders/1R_GbiotTzataJiPhLV9ZbOs3NJ4ibE_0?usp=drive_link" },
  { local:"SAN BORJA",  name:"U.LIMA SB 2",      reporte:"https://colab.research.google.com/drive/19KkIWlb1oNy4VoRCflfv6GWXPlQNO6-u" , carpeta:"https://drive.google.com/drive/folders/1gKBqvM2nxMPi8DQUqLis8nTl2LV25P0M?usp=drive_link" },

  // ================= VIRTUAL =================
  { local:"VIRTUAL",    name:"AGRARIA VIRTUAL",  reporte:"https://colab.research.google.com/drive/1pe6pOzBlAiv9mAlizK9NWS7Lo77HEy0x" , carpeta:"https://drive.google.com/drive/folders/1MZVzC4Kxuon_M8BvacwrBtbp2QZ7UBqq?usp=drive_link" },
  { local:"VIRTUAL",    name:"U.LIMA VIRTUAL 1",   reporte:"https://colab.research.google.com/drive/1-AOKPLGxlb2OWCoMDrAA0kXCZRj3hrNI" , carpeta:"https://drive.google.com/drive/folders/131teXY1AltFA4PGYY1msEOeeeVp9WWsl?usp=drive_link" },
  { local:"VIRTUAL",    name:"U.LIMA VIRTUAL 2",   reporte:"https://colab.research.google.com/drive/1tX_yYM7H1s_dHACnLoPJo4kTePWVc8jJ" , carpeta:"https://drive.google.com/drive/folders/1fYQyxhYac63WuQDkbIZoR0wGfyaxguPP?usp=drive_link" },
  { local:"VIRTUAL",    name:"U.LIMA ESCOLAR",   reporte:"https://colab.research.google.com/drive/1Wmj0Py2AdOihL_hXZCT-kfbj2ezqvbDe" , carpeta:"https://drive.google.com/drive/folders/19kY1ivbtRcFLSXlox_2mlnsoCjxKlHp4?usp=drive_link" },
];

function ensureReportesLayout(){
  const el = document.getElementById("view_reportes");
  if (el.dataset.ready === "1") return;

  el.innerHTML = `
    <div class="card panel12">
      <div class="cardtitle">FILTROS</div>
      <div class="controls" style="justify-content:flex-start;">
        <select id="rLocal"></select>
        <input id="rQ" type="text" placeholder="Buscar (ej: agraria, escolar, pucp, u.lima, paralelo, adelanto, virtual)"/>
        <button id="rReset">VER TODO</button>
      </div>
    </div>

    <div class="card panel12">
      <div class="syLocalHead">
        <div class="cardtitle" style="margin:0;">RESUMEN</div>
        <div class="syKpis">
          <span class="syKpiPill">AULAS: <b id="rTotal">0</b></span>
          <span class="syKpiPill">SEDES: <b id="rLocs">0</b></span>
        </div>
      </div>
    </div>

    <div class="panel12" id="rBlocks"></div>
  `;

  const locals = uniq(REPORTES.map(x=>x.local));
  fillSelectKeep("rLocal", sortListasByLocalOrder(locals), "LOCAL: TODOS");

  document.getElementById("rReset").addEventListener("click", ()=>{
    document.getElementById("rLocal").value="__ALL__";
    document.getElementById("rQ").value="";
    renderReportes();
  });
  document.getElementById("rLocal").addEventListener("change", renderReportes);
  document.getElementById("rQ").addEventListener("input", renderReportes);

  el.dataset.ready = "1";
}

function renderReportes(){
  ensureReportesLayout();

  const fLocal = document.getElementById("rLocal").value;
  const q = low(document.getElementById("rQ").value);

  let base = REPORTES.slice();
  if (fLocal !== "__ALL__") base = base.filter(x=>x.local===fLocal);
  if (q) base = base.filter(x => low(x.name).includes(q) || low(x.local).includes(q));

  // agrupar por local (orden fijo)
  const byLocal = new Map();
  for (const it of base){
    if (!byLocal.has(it.local)) byLocal.set(it.local, []);
    byLocal.get(it.local).push(it);
  }

  const orderedLocals = [...byLocal.keys()].sort((a,b)=>{
    const ia = LISTAS_LOCAL_ORDER.indexOf(a);
    const ib = LISTAS_LOCAL_ORDER.indexOf(b);
    return (ia<0?999:ia) - (ib<0?999:ib);
  });

  let total = 0;

  const blocks = orderedLocals.map(loc=>{
    const list = byLocal.get(loc).slice().sort((a,b)=>{
      const ma = listaMetaFromName(a.name);
      const mb = listaMetaFromName(b.name);
      if (ma.group !== mb.group) return ma.group - mb.group;
      return String(a.name||"").localeCompare(String(b.name||""), "es");
    });

    total += list.length;

    const items = list.map(it=>{
      const meta = listaMetaFromName(it.name);

      const rep = (it.reporte && String(it.reporte).trim()) ? String(it.reporte).trim() : "";
      const car = (it.carpeta && String(it.carpeta).trim()) ? String(it.carpeta).trim() : "";

      const repBtn = rep
        ? `<a class="syBtn" href="${escapeHtml(rep)}" target="_blank" rel="noopener noreferrer">REPORTE</a>`
        : `<span class="syBtn disabled">REPORTE</span>`;

      const carBtn = car
        ? `<a class="syBtn" href="${escapeHtml(car)}" target="_blank" rel="noopener noreferrer">CARPETA</a>`
        : `<span class="syBtn disabled">CARPETA</span>`;

      return `
        <div class="syItem">
          <div class="syLeft">
            <div class="syCourse">${escapeHtml(it.name)}</div>
            <div class="syMeta">
              <span class="dot" style="background:${meta.dot};"></span>
              <span>${escapeHtml(loc)}</span>
            </div>
          </div>
          <div class="syBtns">
            ${repBtn}
            ${carBtn}
          </div>
        </div>
      `;
    }).join("");

    return `
      <div class="card panel12">
        <div class="syLocalHead">
          <div class="cardtitle" style="margin:0;">${escapeHtml(loc)}</div>
          <div class="syKpis">
            <span class="syKpiPill">AULAS: <b>${list.length}</b></span>
          </div>
        </div>
        <div class="syWrap">
          ${items || `<div class="card panel12" style="box-shadow:none;">
            <div class="cardtitle">SIN RESULTADOS</div>
            <div style="color:var(--muted); font-weight:900;">No hay aulas con el filtro actual.</div>
          </div>`}
        </div>
      </div>
    `;
  }).join("");

  document.getElementById("rTotal").textContent = total.toLocaleString("es-PE");
  document.getElementById("rLocs").textContent  = orderedLocals.length.toLocaleString("es-PE");
  document.getElementById("rBlocks").innerHTML  = blocks || `
    <div class="card panel12">
      <div class="cardtitle">SIN DATOS</div>
      <div style="color:var(--muted); font-weight:900;">No se encontraron reportes para mostrar.</div>
    </div>
  `;
}
// ===================== FIN REPORTES =====================

  // ===================== HORARIOS =====================
  const DAYS = ["LUNES","MARTES","MIÉRCOLES","JUEVES","VIERNES","SÁBADO"];

  const TIME_ROWS = [
    { start:"08:00", end:"08:30", label:"8:00 - 8:30" },
    { start:"08:30", end:"09:00", label:"8:30 - 9:00" },
    { start:"09:00", end:"09:30", label:"9:00 - 9:30" },

    { start:"09:30", end:"09:50", label:"9:30 - 9:50" },
    { start:"09:50", end:"10:00", label:"" },

    { start:"10:00", end:"10:30", label:"10:00 - 10:30" },
    { start:"10:30", end:"11:00", label:"10:30 - 11:00" },
    { start:"11:00", end:"11:30", label:"11:00 - 11:30" },

    { start:"11:30", end:"11:50", label:"11:30 - 11:50" },
    { start:"11:50", end:"12:00", label:"" },

    { start:"12:00", end:"12:30", label:"12:00 - 12:30" },
    { start:"12:30", end:"13:00", label:"12:30 - 13:00" },
    { start:"13:00", end:"13:30", label:"13:00 - 13:30" },

    { start:"13:30", end:"13:50", label:"13:30 - 13:50" },
    { start:"13:50", end:"15:00", label:"13:50 - 15:00" },

    { start:"15:00", end:"15:30", label:"15:00 - 15:30" },
    { start:"15:30", end:"16:00", label:"15:30 - 16:00" },
    { start:"16:00", end:"16:30", label:"16:00 - 16:30" },
    { start:"16:30", end:"17:00", label:"16:30 - 17:00" },

    { start:"17:00", end:"17:30", label:"17:00 - 17:30" },
    { start:"17:30", end:"18:00", label:"17:30 - 18:00" },
  ];

  const TIME_MARKS = (()=>{
    const marks = TIME_ROWS.map(r=>r.start);
    marks.push(TIME_ROWS[TIME_ROWS.length-1].end);
    return marks;
  })();
  function idxMark(t){ return TIME_MARKS.indexOf(t); }

  function normalizeDayKey(d){
    const x = String(d||"").trim().toUpperCase();
    if (x==="MIERCOLES") return "MIÉRCOLES";
    if (x==="SABADO") return "SÁBADO";
    return x;
  }

  // “ÁLG 1” / “RV 2” / “FÍS 1” / “G&M 1” / “G&T 2” => 1 sola línea
  function isCodePlusNumber(tokens){
    if (tokens.length !== 2) return false;
    const left = tokens[0];
    const right = tokens[1];
    const num = /^[0-9]+$/.test(right);
    if (!num) return false;

    // ✅ acepta & y puntos (G&M, G&T, REF.)
    const okLeft = /^[A-ZÁÉÍÓÚÑ&\.]{2,}$/.test(left);
    return okLeft;
  }

  // Convierte course en 1–3 líneas (slots 1–3). Docente siempre slot 4.
  function courseToLines(courseRaw){
    let s = norm(courseRaw || "");
    if (!s) return [];

    // Forzado manual por el usuario
    if (s.includes("\n")){
      return s.split("\n").map(norm).filter(Boolean).slice(0,3);
    }
    if (s.includes(" / ")){
      return s.split(" / ").map(norm).filter(Boolean).slice(0,3);
    }

    const tokens = s.split(" ").map(norm).filter(Boolean);

    // ✅ Caso “REF. ÁLG 2” o “REF RM 2”:
    // REF. arriba, “ÁLG 2” al centro (como bloque), profesor abajo
    const t0 = (tokens[0] || "").toUpperCase();
    const isRef = (t0 === "REF" || t0 === "REF." || t0.startsWith("REF."));
    if (isRef && tokens.length >= 2){
      const rest = tokens.slice(1);
      if (isCodePlusNumber(rest.slice(0,2)) && rest.length === 2){
        return [tokens[0], `${rest[0]} ${rest[1]}`];
      }
      // si no es code+num, lo dejamos como segunda línea completa
      return [tokens[0], rest.join(" ")].slice(0,3);
    }

    // “ÁLG 1” => una línea
    if (isCodePlusNumber(tokens)) return [`${tokens[0]} ${tokens[1]}`];

    // 1 token => una línea
    if (tokens.length === 1) return [tokens[0]];

    // 2 tokens => dos líneas
    if (tokens.length === 2) return [tokens[0], tokens[1]];

    // 3 o más => tres líneas (máximo)
    return [tokens[0], tokens[1], tokens.slice(2).join(" ")].slice(0,3);
  }

  function renderCell4(courseRaw, teacherRaw){
    const lines = courseToLines(courseRaw);
    const teacher = norm(teacherRaw || "");

    // ✅ Reglas de colocación:
    // - 1 línea => centro (slot2)
    // - 2 líneas => arriba + centro (slot1 + slot2)  [más ordenado]
    // - 3 líneas => slot1 + slot2 + slot3
    let slot1 = "", slot2 = "", slot3 = "";
    if (lines.length === 3){
      slot1 = lines[0]; slot2 = lines[1]; slot3 = lines[2];
    } else if (lines.length === 2){
      slot1 = lines[0]; slot2 = lines[1];
    } else if (lines.length === 1){
      slot2 = lines[0];
    }

    return `
      <div class="cell4">
        <div class="slot"><div class="cLine">${escapeHtml(slot1)}</div></div>
        <div class="slot"><div class="cLine">${escapeHtml(slot2)}</div></div>
        <div class="slot"><div class="cLine">${escapeHtml(slot3)}</div></div>
        <div class="slot"><div class="tLine">${teacher ? escapeHtml(teacher) : "&nbsp;"}</div></div>
      </div>
    `;
  }

  function buildScheduleMatrix(schedule){
    const rows = TIME_ROWS.map(()=> {
      const o = {};
      DAYS.forEach(d=>o[d] = { kind:"empty" });
      return o;
    });

    for (const b of (schedule.blocks||[])){
      const day = normalizeDayKey(b.day);
      if (!DAYS.includes(day)) continue;

      const s = idxMark(b.start);
      const e = idxMark(b.end);
      if (s < 0 || e < 0 || e <= s) continue;

      const rowStart = TIME_ROWS.findIndex(r=>r.start === b.start);
      if (rowStart < 0) continue;

      let span = 0;
      for (let i=rowStart; i<TIME_ROWS.length; i++){
        const row = TIME_ROWS[i];
        span++;
        if (row.end === b.end) break;
        const nextMark = idxMark(row.end);
        if (nextMark >= e) break;
      }

      rows[rowStart][day] = {
        kind:"start",
        rowspan: span,
        block: {
          course: b.course || "",
          teacher: b.teacher || ""
        }
      };

      for (let k=1; k<span; k++){
        const rr = rowStart + k;
        if (rr >= TIME_ROWS.length) break;
        rows[rr][day] = { kind:"skip" };
      }
    }

    return rows;
  }

  function uniDotColor(uni){
    if (uni==="AGRARIA") return getCss("--agraria");
    if (uni==="PUCP") return getCss("--pucp");
    if (uni==="ESCOLARES") return getCss("--schHead_ESC");
    return getCss("--ulima");
  }

  function getCornerLabelByCycle(cycle){
    const c = String(cycle||"").toUpperCase();
    if (c.startsWith("AGRARIA_") || c === "AGRARIA") return "AG";
    if (c.startsWith("ULIMA_") || c === "U.LIMA") return "UL";
    if (c.startsWith("PUCP_") || c === "PUCP") return "PUCP";
    if (c.startsWith("ESCOLARES_") || c === "ESCOLARES") return "ESC";
    return "AG";
  }

  function scheduleToHtmlCard(s){
    const dot = uniDotColor(s.uni);
    const matrix = buildScheduleMatrix(s);

    const colgroup = `
      <colgroup>
        <col class="timeCol">
        ${DAYS.map(()=>`<col>`).join("")}
      </colgroup>
    `;

    const thead = `
      <thead>
        <tr>
          <th class="timeHead">${escapeHtml(s.cornerLabel || "AG")}</th>
          ${DAYS.map(d=>`<th>${escapeHtml(d)}</th>`).join("")}
        </tr>
      </thead>
    `;

    const tbody = matrix.map((rowObj, i)=>{
      const timeLabel = TIME_ROWS[i].label;
      const timeCell = `<td class="timeCell">${escapeHtml(timeLabel)}</td>`;

      const tds = DAYS.map(d=>{
        const cell = rowObj[d];
        if (cell.kind === "skip") return "";
        if (cell.kind === "start"){
          return `
            <td class="schCell" rowspan="${cell.rowspan}">
              ${renderCell4(cell.block.course, cell.block.teacher)}
            </td>
          `;
        }
        return `<td class="schEmpty"></td>`;
      }).join("");

      return `<tr>${timeCell}${tds}</tr>`;
    }).join("");

    return `
      <div class="schCard" data-id="${escapeHtml(s.id)}" data-local="${escapeHtml(s.local)}" data-uni="${escapeHtml(s.uni)}" data-salon="${escapeHtml(s.salon)}">
        <div class="schHead">
          <div class="hLeft">
            <p class="loc">${escapeHtml(s.local)}</p>
            <p class="sal">${escapeHtml(s.salon)}</p>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <div class="schUniPill">
              <span class="b" style="background:${dot};"></span>
              ${escapeHtml(s.uni)}
            </div>
            <button class="schDl" data-sid="${escapeHtml(s.id)}">DESCARGAR PNG</button>${(CURRENT_ROLE==="admin" && HORARIOS_EDIT_MODE) ? `<button class="schEdit" data-sid="${escapeHtml(s.id)}">EDITAR</button>` : ``}
          </div>
        </div>

        <div class="schTableWrap">
          <table class="schTable">
            ${colgroup}
            ${thead}
            <tbody>${tbody}</tbody>
          </table>
        </div>
      </div>
    `;
  }

  // ===================== ORDEN DE HORARIOS =====================
  const LOCAL_ORDER = ["LA MOLINA","SAN MIGUEL","SAN BORJA","VIRTUAL"];
  const UNI_ORDER = ["AGRARIA","U.LIMA","PUCP","ESCOLARES"];

  function sortSchedules(list){
    const idxLoc = (x)=> {
      const i = LOCAL_ORDER.indexOf(x.local);
      return i<0 ? 999 : i;
    };
    const idxUni = (x)=> {
      const i = UNI_ORDER.indexOf(x.uni);
      return i<0 ? 999 : i;
    };
    return list.slice().sort((a,b)=>{
      const dl = idxLoc(a) - idxLoc(b);
      if (dl !== 0) return dl;
      const du = idxUni(a) - idxUni(b);
      if (du !== 0) return du;
      return String(a.salon||"").localeCompare(String(b.salon||""), "es");
    });
  }

  /* ======================================================================
    HORARIOS (SCHEDULES)
  ====================================================================== */
  let SCHEDULES = sortSchedules([
    // ========================= AGRARIA =========================
    {
      id:"AGR_LM_1",
      local:"LA MOLINA",
      uni:"AGRARIA",
      salon:"AGRARIA LM 1",
      blocks:[
        { day:"LUNES",     start:"08:00", end:"09:50", course:"HIS",   teacher:"RIOJA H." },
        { day:"MARTES",    start:"08:00", end:"09:50", course:"ECO",   teacher:"SOTO F." },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"RV",    teacher:"TABER" },
        { day:"JUEVES",    start:"08:00", end:"09:50", course:"GEO",   teacher:"TORRES" },
        { day:"VIERNES",   start:"08:00", end:"09:50", course:"FÍS 1", teacher:"RUBEN" },

        { day:"LUNES",     start:"10:00", end:"11:50", course:"GGF",     teacher:"RIOJA" },
        { day:"MARTES",    start:"10:00", end:"11:50", course:"ARI",     teacher:"DIAZ" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"REF MAT", teacher:"ÁNGEL" },
        { day:"JUEVES",    start:"10:00", end:"11:50", course:"TRI",     teacher:"TORRES" },
        { day:"VIERNES",   start:"10:00", end:"11:50", course:"FÍS 2",   teacher:"RUBEN" },

        { day:"LUNES",   start:"12:00", end:"13:50", course:"QUÍ", teacher:"COSTA" },
        { day:"MARTES",  start:"12:00", end:"13:50", course:"ÁLG", teacher:"UCANCIAL" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"TUT", teacher:"ALLYSON" },
        { day:"JUEVES",  start:"12:00", end:"13:50", course:"BIO", teacher:"LUYO" },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"RM",  teacher:"OBANDO" },
      ]
    },

    {
      id:"AGR_LM_2",
      local:"LA MOLINA",
      uni:"AGRARIA",
      salon:"AGRARIA LM 2",
      blocks:[
        { day:"LUNES",     start:"08:00", end:"09:50", course:"QUÍ 1",       teacher:"COSTA" },
        { day:"MARTES",    start:"08:00", end:"09:50", course:"ARI",         teacher:"DIAZ" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"REF. MATES",  teacher:"ANGEL" },
        { day:"JUEVES",    start:"08:00", end:"09:50", course:"BIO 1",       teacher:"LUYO" },
        { day:"VIERNES",   start:"08:00", end:"09:50", course:"RM 1",        teacher:"OBANDO" },
        { day:"SÁBADO",    start:"08:00", end:"11:00", course:"SIM",         teacher:"" },

        { day:"LUNES",     start:"10:00", end:"11:50", course:"QUÍ 2",   teacher:"COSTA" },
        { day:"MARTES",    start:"10:00", end:"11:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"RV 1",  teacher:"TABER" },
        { day:"JUEVES",    start:"10:00", end:"11:50", course:"BIO 2", teacher:"LUYO" },
        { day:"VIERNES",   start:"10:00", end:"11:50", course:"RM 2", teacher:"OBANDO" },

        { day:"LUNES",     start:"12:00", end:"13:50", course:"HIS", teacher:"RIOJA" },
        { day:"MARTES",    start:"12:00", end:"13:50", course:"EVAS",  teacher:"JASON" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"RV 2",  teacher:"TABER" },
        { day:"JUEVES",    start:"12:00", end:"13:50", course:"TRI",   teacher:"TORRES" },
        { day:"VIERNES",   start:"12:00", end:"13:50", course:"FIS 1",  teacher:"RUEBN" },

        { day:"LUNES",     start:"15:00", end:"17:00", course:"GGF",   teacher:"RIOJA" },
        { day:"MARTES",    start:"15:00", end:"17:00", course:"ECO",   teacher:"SOTO" },
        { day:"MIÉRCOLES", start:"15:00", end:"17:00", course:"GEO",   teacher:"TORRES" },
        { day:"JUEVES",    start:"15:00", end:"17:00", course:"ÁLG 2", teacher:"UCANCIAL" },
        { day:"VIERNES",   start:"15:00", end:"17:00", course:"FÍS 2", teacher:"RUBEN" },
      ]
    },

    {
      id:"AGR_ESC_LM",
      local:"LA MOLINA",
      uni:"AGRARIA",
      salon:"AGRARIA ESCOLAR",
      blocks:[]
    },

    {
      id:"AGR_SM",
      local:"SAN MIGUEL",
      uni:"AGRARIA",
      salon:"AGRARIA SM",
      blocks:[
        { day:"LUNES",     start:"08:00", end:"09:50", course:"RM",    teacher:"OBANDO" },
        { day:"MARTES",    start:"08:00", end:"09:50", course:"BIO",   teacher:"ZERILLO" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"HIS",   teacher:"RIOJA H." },
        { day:"JUEVES",    start:"08:00", end:"09:50", course:"QUÍ 1", teacher:"COSTA" },
        { day:"VIERNES",   start:"08:00", end:"09:50", course:"RV 1", teacher:"TABER" },

        { day:"LUNES",     start:"10:00", end:"11:50", course:"GEO",   teacher:"JULCA" },
        { day:"MARTES",    start:"10:00", end:"11:50", course:"TRI",   teacher:"JULCA" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"GGF",   teacher:"RIOJA" },
        { day:"JUEVES",    start:"10:00", end:"11:50", course:"QUÍ 2", teacher:"COSTA" },
        { day:"VIERNES",   start:"10:00", end:"11:50", course:"REF. MATES", teacher:"MARCELA" },

        { day:"LUNES",     start:"12:00", end:"13:50", course:"TUT",  teacher:"" },
        { day:"VIERNES",   start:"12:00", end:"13:50", course:"RV 2", teacher:"TABER" },

        { day:"MARTES",    start:"13:00", end:"15:00", course:"FÍS 1", teacher:"RUBEN" },
        { day:"MIÉRCOLES", start:"13:00", end:"15:00", course:"ECO",   teacher:"SOTO F." },
        { day:"JUEVES",    start:"13:00", end:"15:00", course:"ARI",   teacher:"DIAZ" },
      ]
    },

    {
      id:"AGR_SB",
      local:"SAN BORJA",
      uni:"AGRARIA",
      salon:"AGRARIA SB",
      blocks:[
        { day:"LUNES",     start:"08:00", end:"09:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"MARTES",    start:"08:00", end:"09:50", course:"FÍS 1", teacher:"GÓNGORA" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"BIO 1", teacher:"LUYO" },
        { day:"JUEVES",    start:"08:00", end:"09:50", course:"RM 2",  teacher:"OBANDO" },
        { day:"VIERNES",   start:"08:00", end:"09:50", course:"GEO",   teacher:"JULCA" },

        { day:"LUNES",     start:"10:00", end:"11:50", course:"ARI",   teacher:"DIAZ" },
        { day:"MARTES",    start:"10:00", end:"11:50", course:"FÍS 2", teacher:"GÓNGORA" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"BIO 2", teacher:"LUYO" },
        { day:"JUEVES",    start:"10:00", end:"11:50", course:"REF MAT", teacher:"OBANDO" },
        { day:"VIERNES",   start:"10:00", end:"11:50", course:"TRI",   teacher:"JULCA" },

        { day:"LUNES",     start:"12:00", end:"13:50", course:"RV 1",  teacher:"TABER" },
        { day:"MARTES",    start:"12:00", end:"13:50", course:"RV 2",  teacher:"TABER" },
        { day:"VIERNES",     start:"12:00", end:"13:50", course:"TXT",  teacher:"ZAVALA" },
        { day:"MIÉRCOLES", start:"13:00", end:"15:00", course:"HIS",   teacher:"RIOJA" },
        { day:"JUEVES",    start:"13:00", end:"15:00", course:"QUI 1", teacher:"COSTA" },

        { day:"LUNES",     start:"15:00", end:"17:00", course:"ÁLG 2", teacher:"UCANCIAL" },
        { day:"MARTES",    start:"15:00", end:"17:00", course:"RM 1",  teacher:"OBANDO" },
        { day:"MIÉRCOLES", start:"15:00", end:"17:00", course:"GGF",   teacher:"RIOJA" },
        { day:"JUEVES",    start:"15:00", end:"17:00", course:"QUÍ 2", teacher:"COSTA" },
        { day:"VIERNES",    start:"15:00", end:"17:00", course:"TUT", teacher:"" },
      ]
    },

    {
      id:"AGR_VIRT",
      local:"VIRTUAL",
      uni:"AGRARIA",
      salon:"AGRARIA VIRTUAL",
      blocks:[
        { day:"LUNES",     start:"08:00", end:"09:50", course:"RM",    teacher:"OBANDO" },
        { day:"MARTES",    start:"08:00", end:"09:50", course:"BIO",   teacher:"ZERILLO" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"HIS",   teacher:"RIOJA H." },
        { day:"JUEVES",    start:"08:00", end:"09:50", course:"QUÍ 1", teacher:"COSTA" },
        { day:"VIERNES",   start:"08:00", end:"09:50", course:"FÍS 1", teacher:"RUBEN" },

        { day:"LUNES",     start:"10:00", end:"11:50", course:"GEO",   teacher:"TORRES" },
        { day:"MARTES",    start:"10:00", end:"11:50", course:"TRI",   teacher:"JULCA" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"GGF",   teacher:"RIOJA" },
        { day:"JUEVES",    start:"10:00", end:"11:50", course:"QUÍ 2", teacher:"COSTA" },
        { day:"VIERNES",   start:"10:00", end:"11:50", course:"FÍS 2", teacher:"RUBEN" },

        { day:"LUNES",     start:"12:00", end:"13:50", course:"TUT",  teacher:"ALLYSON" },
        { day:"VIERNES",   start:"12:00", end:"13:50", course:"RV 2", teacher:"TABER" },

        { day:"MARTES",    start:"13:00", end:"15:00", course:"FÍS 1", teacher:"RUBEN" },
        { day:"MIÉRCOLES", start:"13:00", end:"15:00", course:"ECO",   teacher:"SOTO F." },
        { day:"JUEVES",    start:"13:00", end:"15:00", course:"ARI",   teacher:"DIAZ" },
      ]
    },

    // ========================= PUCP =========================
    {
      id:"PUCP_LM",
      local:"LA MOLINA",
      uni:"PUCP",
      salon:"PUCP LM",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"SOL", teacher:"TORRES" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"PRE N&O", teacher:"CHAMBI R." },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"TXT 1", teacher:"ZAVALA" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"G&M 1", teacher:"TORRES" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"PRE TXT", teacher:"TABER" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"PRE ÁLG", teacher:"OBANDO" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"TXT 2", teacher:"ZAVALA" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"G&M", teacher:"ÁNGEL" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"REF. G&M 2", teacher:"TORRES" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"N&O 1", teacher:"DÍAZ P." },
        { day:"MARTES", start:"12:00", end:"13:50", course:"N&O 2", teacher:"DÍAZ P." },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"HOP", teacher:"CHAMBI J." },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"ÁLG 2", teacher:"UCANCIAL" },
        { day:"VIERNES", start:"12:00", end:"14:00", course:"SIM", teacher:"" },

        { day:"MARTES", start:"15:00", end:"17:00", course:"EST", teacher:"DÍAZ P." },
        { day:"MIÉRCOLES", start:"15:00", end:"17:00", course:"PRÁC", teacher:"CHAMBI J." },
      ]
    },

    {
      id:"PUCP_SM",
      local:"SAN MIGUEL",
      uni:"PUCP",
      salon:"PUCP SM",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"TXT 1", teacher:"ZAVALA" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"G&M 1", teacher:"JULCA" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"N&O 1", teacher:"DÍAZ" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"PRE ÁLG", teacher:"MARCELA" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"TXT 2", teacher:"ZAVALA" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"PRE TXT", teacher:"VALDIVIA" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"ÁLG 2", teacher:"UCANCIAL" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"N&O 2", teacher:"DÍAZ" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"PRE TXT", teacher:"JARA" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"SOL", teacher:"MARCELA" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"G&M 2", teacher:"JULCA" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"PRE G&M", teacher:"JULCA" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"PRE N&O", teacher:"TORERO" },
        { day:"VIERNES", start:"12:00", end:"14:00", course:"SIM", teacher:"" },

        { day:"MARTES", start:"15:00", end:"17:00", course:"EST", teacher:"JULCA" },
        { day:"JUEVES", start:"15:00", end:"17:00", course:"PRÁC", teacher:"TORERO" },
      ]
    },

    {
      id:"PUCP_SB",
      local:"SAN BORJA",
      uni:"PUCP",
      salon:"PUCP SB",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"SOL", teacher:"CHAMBI J." },
        { day:"MARTES", start:"08:00", end:"09:50", course:"RM 1", teacher:"OBANDO" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"ARI 1", teacher:"DÍAZ P." },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"G&M 1", teacher:"JULCA" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"LEN", teacher:"ZAVALA" },
        { day:"SÁBADO", start:"08:00", end:"10:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"RV", teacher:"TABER" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"REF. ÁLG", teacher:"DÍAZ J." },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"G&M 2", teacher:"JULCA" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"PRO", teacher:"ZAVALA" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"ÁLG 2", teacher:"UCANCIAL" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"RM 2", teacher:"OBANDO" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"ARI 2", teacher:"DÍAZ P." },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"REF. RM", teacher:"OBANDO" },
        { day:"VIERNES", start:"12:00", end:"15:00", course:"REF. ARI", teacher:"SOTO" },

        { day:"MARTES", start:"15:00", end:"17:00", course:"PRE ÁLG", teacher:"ÁNGEL" },
        { day:"MIÉRCOLES", start:"15:00", end:"17:00", course:"PRE N&O", teacher:"PERCY D." },
        { day:"JUEVES", start:"15:00", end:"17:00", course:"PRE G&M", teacher:"ÁNGEL" },
      ]
    },

    // ========================= U.LIMA =========================
    {
      id:"UL_LM",
      local:"LA MOLINA",
      uni:"U.LIMA",
      salon:"U.LIMA LM",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"RV", teacher:"TABER" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"ARI 1", teacher:"CHAMBI J." },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"LEN", teacher:"VALDIVIA" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"REF RM", teacher:"SOTO" },
        { day:"SÁBADO", start:"08:00", end:"10:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"SOL", teacher:"TORRES" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"RM 1", teacher:"CHAMBI R." },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"ARI 2", teacher:"CHAMBI J." },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"ÁLG 2", teacher:"UCANCIAL" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"ARI", teacher:"SOTO" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"G&T 1", teacher:"TORRES" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"RM 2", teacher:"CHAMBI R." },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"REF. G&T", teacher:"ÁNGEL" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"HOP", teacher:"ÁNGEL" },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"G&T 2", teacher:"TORRES" },

        { day:"JUEVES", start:"15:00", end:"17:00", course:"VIRT PRO", teacher:"RIOJA" },
      ]
    },

    {
      id:"UL_SM_1",
      local:"SAN MIGUEL",
      uni:"U.LIMA",
      salon:"U.LIMA SM 1",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"G&T 1", teacher:"JULCA" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"ARI 1", teacher:"CHAMBI J." },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"RM 1", teacher:"SOTO" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"HOP", teacher:"TORERO" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"LEN", teacher:"JARA" },
        { day:"SÁBADO", start:"08:00", end:"10:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"SOL", teacher:"MARCELA" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"REF G&T", teacher:"JULCA" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"RM 2", teacher:"SOTO" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"REF. RM", teacher:"CHAMBI R." },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"RV", teacher:"TABER" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"G&T 2", teacher:"JULCA" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"ARI 2", teacher:"CHAMBI J." },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"REF. ARI", teacher:"MARCO" },
        { day:"VIERNES", start:"13:00", end:"15:00", course:"ÁLG 2", teacher:"UCANCIAL" },

        { day:"MARTES", start:"15:00", end:"17:00", course:"VIRT PRO", teacher:"RIOJA" },
      ]
    },

    {
      id:"UL_SM_2",
      local:"SAN MIGUEL",
      uni:"U.LIMA",
      salon:"U.LIMA SM 2",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"SOL", teacher:"MARCELA" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"LEN", teacher:"VALDIVIA" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"G&T 1", teacher:"JULCA" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"RM 1", teacher:"CHAMBI R." },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"ÁLG 1", teacher:"MARCO CH." },
        { day:"SÁBADO", start:"08:00", end:"10:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"ARI 1", teacher:"OBANDO" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"REF. RM", teacher:"CHAMBI J." },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"G&T 2", teacher:"JULCA" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"HOP", teacher:"TORERO" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"ÁLG 2", teacher:"MARCO CH." },

        { day:"LUNES", start:"12:00", end:"13:50", course:"ARI 2", teacher:"OBANDO" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"REF. ARI", teacher:"MARCO CH." },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"REF. ÁLG", teacher:"MARCELA" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"RM 2", teacher:"CHAMBI R." },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"RV", teacher:"JARA" },

        { day:"MARTES", start:"16:00", end:"18:00", course:"VIRT PRO", teacher:"RIOJA" },
      ]
    },

    {
      id:"UL_SB_1",
      local:"SAN BORJA",
      uni:"U.LIMA",
      salon:"U.LIMA SB 1",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"SOL", teacher:"CHAMBI J." },
        { day:"MARTES", start:"08:00", end:"09:50", course:"RM 1", teacher:"OBANDO" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"ARI 1", teacher:"DÍAZ" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"G&T 1", teacher:"JULCA" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"LEN", teacher:"ZAVALA" },
        { day:"SÁBADO", start:"08:00", end:"10:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"RV", teacher:"TABER" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"REF. ÁLG", teacher:"DÍAZ J." },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"G&T 2", teacher:"JULCA" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"TXT", teacher:"ZAVALA" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"ÁLG 2", teacher:"UCANCIAL" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"RM 2", teacher:"OBANDO" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"ARI 2", teacher:"DÍAZ" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"REF. RM", teacher:"OBANDO" },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"REF. ARI", teacher:"SOTO" },

        { day:"MARTES", start:"16:00", end:"18:00", course:"VIRT PRO", teacher:"RIOJA" },
        { day:"MIÉRCOLES", start:"15:00", end:"17:00", course:"PRÁCT", teacher:"DÍAZ" },
      ]
    },

    {
      id:"UL_SB_2",
      local:"SAN BORJA",
      uni:"U.LIMA",
      salon:"U.LIMA SB 2",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"SOL", teacher:"DÍAZ" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"RV", teacher:"TABER" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"REF. ARI", teacher:"DÍAZ J." },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"REF. G&T", teacher:"ÁNGEL" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"SÁBADO", start:"08:00", end:"10:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"ARI 1", teacher:"CHAMBI J." },
        { day:"MARTES", start:"10:00", end:"11:50", course:"RM 1", teacher:"SOTO" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"HOP", teacher:"DÍAZ" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"LEN", teacher:"VALDIVIA" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"ÁLG 2", teacher:"UCANCIAL" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"ARI 2", teacher:"CHAMBI J." },
        { day:"MARTES", start:"12:00", end:"13:50", course:"RM 2", teacher:"SOTO" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"ÁLG 1", teacher:"DÍAZ J." },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"G&T 1", teacher:"JULCA" },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"G&T 2", teacher:"JULCA" },

        { day:"MARTES", start:"16:00", end:"18:00", course:"VIRT PRO", teacher:"RIOJA" },
        { day:"JUEVES", start:"15:00", end:"17:00", course:"PRÁCT", teacher:"OBANDO" },
      ]
    },

    {
      id:"UL_ESC",
      local:"VIRTUAL",
      uni:"U.LIMA",
      salon:"U.LIMA ESCOLAR",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"SOL", teacher:"MARCELA" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"LEN", teacher:"VALDIVIA" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"G&T 1", teacher:"JULCA" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"RM 1", teacher:"CHAMBI R." },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"ÁLG 1", teacher:"MARCO CH." },
        { day:"SÁBADO", start:"08:00", end:"10:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"ARI 1", teacher:"OBANDO" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"REF. RM", teacher:"CHAMBI J." },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"G&T 2", teacher:"JULCA" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"HOP", teacher:"TORERO" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"ÁLG 2", teacher:"MARCO CH." },

        { day:"LUNES", start:"12:00", end:"13:50", course:"ARI 2", teacher:"OBANDO" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"REF. ARI", teacher:"MARCO CH." },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"REF. ÁLG", teacher:"MARCELA" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"RM 2", teacher:"CHAMBI R." },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"RV", teacher:"JARA" },

        { day:"MARTES", start:"16:00", end:"18:00", course:"VIRT PRO", teacher:"RIOJA" },
        { day:"JUEVES", start:"15:00", end:"17:00", course:"PRÁCT", teacher:"DÍAZ P." },
      ]
    },

        {
      id:"UL_VIRT_1",
      local:"VIRTUAL",
      uni:"U.LIMA",
      salon:"U.LIMA VIRTUAL 1",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"G&T 1", teacher:"JULCA" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"ARI 1", teacher:"CHAMBI J." },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"RM 1", teacher:"SOTO" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"HOP", teacher:"TORERO" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"LEN", teacher:"JARA" },
        { day:"SÁBADO", start:"08:00", end:"10:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"SOL", teacher:"MARCELA" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"REF G&T", teacher:"JULCA" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"RM 2", teacher:"SOTO" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"REF. RM", teacher:"CHAMBI R." },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"RV", teacher:"TABER" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"G&T 2", teacher:"JULCA" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"ARI 2", teacher:"CHAMBI J." },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"ÁLG 1", teacher:"UCANCIAL" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"REF. ARI", teacher:"MARCO" },
        { day:"VIERNES", start:"13:00", end:"15:00", course:"ÁLG 2", teacher:"UCANCIAL" },

        { day:"MARTES", start:"15:00", end:"17:00", course:"VIRT PRO", teacher:"RIOJA" },
      ]
    },

    {
      id:"UL_VIRT_2",
      local:"VIRTUAL",
      uni:"U.LIMA",
      salon:"U.LIMA VIRTUAL 2",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"SOL", teacher:"MARCELA" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"LEN", teacher:"VALDIVIA" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"G&T 1", teacher:"JULCA" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"RM 1", teacher:"CHAMBI R." },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"ÁLG 1", teacher:"MARCO CH." },
        { day:"SÁBADO", start:"08:00", end:"10:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"ARI 1", teacher:"OBANDO" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"REF. RM", teacher:"CHAMBI J." },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"G&T 2", teacher:"JULCA" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"HOP", teacher:"TORERO" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"ÁLG 2", teacher:"MARCO CH." },

        { day:"LUNES", start:"12:00", end:"13:50", course:"ARI 2", teacher:"OBANDO" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"REF. ARI", teacher:"MARCO CH." },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"REF. ÁLG", teacher:"MARCELA" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"RM 2", teacher:"CHAMBI R." },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"RV", teacher:"JARA" },

        { day:"MARTES", start:"16:00", end:"18:00", course:"VIRT PRO", teacher:"RIOJA" },
      ]
    },
  ]);



  // ===================== HORARIOS (PERSISTENCIA) =====================
  const SCHEDULES_KEY = "LM_SCHEDULES_v1";

  function isValidScheduleObj(x){
    if (!x || typeof x !== "object") return false;
    if (!x.id || !x.local || !x.uni || !x.salon) return false;
    if (!Array.isArray(x.blocks)) return false;
    // validar bloques mínimamente (deben alinearse a TIME_MARKS)
    for (const b of x.blocks){
      if (!b) return false;
      if (!b.day || !b.start || !b.end) return false;
      const is = idxMark(b.start);
      const ie = idxMark(b.end);
      if (is < 0 || ie < 0) return false;
      if (is >= ie) return false;
    }
    return true;
  }

  function loadSchedules(){
    try{
      const raw = localStorage.getItem(SCHEDULES_KEY);
      if (!raw) return null;
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return null;
      const cleaned = arr.filter(isValidScheduleObj);
      if (!cleaned.length) return null;
      return cleaned;
    }catch(e){ return null; }
  }

  function saveSchedules(){
    try{ localStorage.setItem(SCHEDULES_KEY, JSON.stringify(SCHEDULES)); }catch(e){}
    // push a store compartido
    schSyncPush_();
  }

  (function initSchedules(){
    const saved = loadSchedules();
    if (saved) SCHEDULES = sortSchedules(saved);
  })()

  // ===================== HORARIOS (SYNC CENTRAL) =====================
  async function schSyncPullOnce_(){
    const remote = await lmRemoteGet_(LM_MODULE_HORARIOS);
    if (!Array.isArray(remote) || !remote.length) return;
    try{
      localStorage.setItem(SCHEDULES_KEY, JSON.stringify(remote));
    }catch(_){}
    try{
      SCHEDULES = sortSchedules(remote);
    }catch(_){}
    // refresca UI si corresponde
    if (typeof state !== "undefined" && state && state.view === "horarios" && typeof renderHorarios === "function"){
      renderHorarios();
    }
  }

  async function schSyncPush_(){
    try{
      await lmRemoteSet_(LM_MODULE_HORARIOS, Array.isArray(SCHEDULES) ? SCHEDULES : []);
    }catch(_){}
  }

;

  // ===================== HORARIOS (UX) =====================
  // Ajusta altura del contenedor de matriz para que el scroll horizontal sea visible siempre,
  // y habilita navegación “arrastrando” (drag-to-scroll).
  function fitHorariosMatrixHeight(){
    const mx = document.getElementById("schMatrix");
    if (!mx) return;
    // Si está oculto, no calcular
    if (mx.style.display === "none") return;

    const r = mx.getBoundingClientRect();
    // deja un margen inferior para que no quede pegado al borde
    const avail = window.innerHeight - r.top - 18;
    if (avail > 280){
      mx.style.maxHeight = avail + "px";
    }
  }

  function enableHorariosDragScroll(){
    const mx = document.getElementById("schMatrix");
    if (!mx) return;
    if (mx.dataset.dragReady === "1") return;
    mx.dataset.dragReady = "1";

    let down = false;
    let startX = 0, startY = 0;
    let sl = 0, st = 0;

    mx.addEventListener("mousedown", (e)=>{
      // No activar arrastre si el usuario está clickeando un control (botones, selects, etc.)
      const t = e.target;
      if (t && (t.closest("button") || t.closest("select") || t.closest("a") || t.closest("input") || t.closest("textarea"))) return;
      if (e.button !== 0) return; // solo click izquierdo
      down = true;
      mx.classList.add("dragging");
      startX = e.pageX;
      startY = e.pageY;
      sl = mx.scrollLeft;
      st = mx.scrollTop;
    });

    window.addEventListener("mouseup", ()=>{
      if (!down) return;
      down = false;
      mx.classList.remove("dragging");
    });

    mx.addEventListener("mousemove", (e)=>{
      if (!down) return;
      e.preventDefault();
      const dx = e.pageX - startX;
      const dy = e.pageY - startY;
      mx.scrollLeft = sl - dx;
      mx.scrollTop  = st - dy;
    });
  }

  // one-time resize hook
  if (!window.__LM_HORARIOS_RESIZE){
    window.__LM_HORARIOS_RESIZE = true;
    window.addEventListener("resize", ()=>{
      try{ fitHorariosMatrixHeight(); }catch(e){}
    });
  }



  function applyHorariosZoom(){
    const mx = document.getElementById("schMatrix");
    const sel = document.getElementById("hZoom");
    if (!mx || !sel) return;
    const v = Number(sel.value || 100);
    const z = Math.max(70, Math.min(100, v));
    mx.style.setProperty("--mxZoom", String(z/100));
    try{ fitHorariosMatrixHeight(); }catch(e){}
  }

function ensureHorariosLayout(){
    const el = document.getElementById("view_horarios");
    if (el.dataset.ready === "1") return;

    // Entorno alumno: solo su horario
    if (CURRENT_ROLE === "alumno"){
      el.innerHTML = `
        <div class="card panel12 alSection">
          <div class="alSectionHead">
            <div>
              <div class="alSectionTitle">MI HORARIO</div>
              <div class="alSectionSub">Vista exclusiva para su matrícula (sin filtros).</div>
            </div>
            <div class="alSectionTools">
              <button class="alBtn alBtnGhost" id="hBackHome">Volver a Inicio</button>
            </div>
          </div>
          <div id="hAlumnoMeta" class="panelHint" style="margin-top:8px;"></div>
        </div>
        <div class="panel12">
          <div class="schGridWrap" id="schGrid"></div>
        </div>
      `;

      const b = document.getElementById("hBackHome");
      if (b) b.addEventListener("click", ()=>setView("inicio_alumno"));

      el.dataset.ready = "1";
      return;
    }

    // Admin/Tutor: vista MATRIZ + filtros (lista opcional)
    el.innerHTML = `
      <div class="card panel12 horariosFiltersCard">
        <div class="cardtitle">VISTA Y FILTROS</div>
        <div class="controls" style="justify-content:flex-start;">
          <select id="hViewMode">
            <option value="matrix">VISTA: MATRIZ</option>
            <option value="list">VISTA: LISTA</option>
          </select>

          <select id="hZoom">
            <option value="100">ZOOM: 100%</option>
            <option value="95">ZOOM: 95%</option>
            <option value="90">ZOOM: 90%</option>
            <option value="85">ZOOM: 85%</option>
            <option value="80">ZOOM: 80%</option>
          </select>

          <select id="hLocal"></select>
          <select id="hUni"></select>
          <select id="hSalon"></select>

          ${(CURRENT_ROLE==="admin") ? `<button id="hEditToggle" class="hEditBtn">EDITAR</button><button id="hNewSch" class="hEditBtnGhost" style="display:none;">+ NUEVO</button>` : ``}

          <button id="hFsToggle" class="hFsBtn">PANTALLA COMPLETA</button>
        </div>

        ${(CURRENT_ROLE==="admin") ? `<div id="hEditBar" class="hEditBar" style="display:none;">Modo edición activo: usa <b>EDITAR</b> en una tarjeta para modificar bloques.</div>` : ``}

        <div class="panelHint hUniBadges" id="hUniBadges">
          <span class="pill hUniBadge" data-uni="AGRARIA"><span class="dot agraria"></span>AGRARIA</span>
          <span class="pill hUniBadge" data-uni="U.LIMA"><span class="dot ulima"></span>U.LIMA</span>
          <span class="pill hUniBadge" data-uni="PUCP"><span class="dot pucp"></span>PUCP</span>
          <span class="pill hUniBadge" data-uni="ESCOLARES"><span class="dot escolares"></span>ESCOLARES</span>
        </div>
      </div>

      <div class="panel12">
        <div id="hMatrixHost" class="hMatrixHost">
          <div class="hMatrixTopBar">
            <span class="hMatrixFsBadge">MODO PANTALLA COMPLETA</span>
            <button id="hFsExit" class="hFsBtn hMatrixExit">SALIR PANTALLA COMPLETA</button>
          </div>
          <div id="schMatrix" class="schMatrixWrap" style="display:none;"></div>
        </div>
        <div class="schGridWrap" id="schGrid"></div>
      </div>
    `;

    const locals = uniq(SCHEDULES.map(s=>s.local));
    fillSelectKeep("hLocal", sortByLocalOrder(locals), "LOCAL: TODOS");
    fillSelectKeep("hUni", ["AGRARIA","U.LIMA","PUCP","ESCOLARES"], "UNIVERSIDAD: TODAS");

    // defaults
    document.getElementById("hLocal").value = "__ALL__";
    document.getElementById("hUni").value = "__ALL__";

    // vista por defecto: matriz (persistente)
    const VM_KEY = "LM_HORARIOS_VIEWMODE_v1";
    const vm = (localStorage.getItem(VM_KEY) || "matrix");
    document.getElementById("hViewMode").value = (vm === "list" ? "list" : "matrix");

    // zoom por defecto (matriz): persistente
    const Z_KEY = "LM_HORARIOS_ZOOM_v1";
    const z0 = (localStorage.getItem(Z_KEY) || "85");
    if (document.getElementById("hZoom")){
      document.getElementById("hZoom").value = (["100","95","90","85","80"].includes(z0) ? z0 : "85");
    }

    rebuildHorariosSalonOptions();
    document.getElementById("hSalon").value = "__ALL__";

    const rer = ()=>renderHorarios();

    document.getElementById("hViewMode").addEventListener("change", ()=>{
      try{ localStorage.setItem(VM_KEY, document.getElementById("hViewMode").value); }catch(e){}
      rer();
    });

    if (document.getElementById("hZoom")){
      document.getElementById("hZoom").addEventListener("change", ()=>{
        try{ localStorage.setItem("LM_HORARIOS_ZOOM_v1", document.getElementById("hZoom").value); }catch(e){}
        applyHorariosZoom();
      });
    }

    document.getElementById("hLocal").addEventListener("change", ()=>{
      rebuildHorariosSalonOptions();
      rer();
    });
    document.getElementById("hUni").addEventListener("change", ()=>{
      rebuildHorariosSalonOptions();
      rer();
    });

    const fsTgl = document.getElementById("hFsToggle");
    const fsExit = document.getElementById("hFsExit");
    if (fsTgl) fsTgl.addEventListener("click", ()=>setHorariosMatrixFullscreen());
    if (fsExit) fsExit.addEventListener("click", ()=>setHorariosMatrixFullscreen(false));

    // Admin: modo edición (UI limpia)
    if (CURRENT_ROLE === "admin"){
      const tgl = document.getElementById("hEditToggle");
      const neu = document.getElementById("hNewSch");
      const bar = document.getElementById("hEditBar");

      const applyEditUi = ()=>{
        if (bar) bar.style.display = HORARIOS_EDIT_MODE ? "" : "none";
        if (tgl) tgl.textContent = HORARIOS_EDIT_MODE ? "SALIR EDICIÓN" : "EDITAR";
        if (neu) neu.style.display = HORARIOS_EDIT_MODE ? "" : "none";
      };

      if (tgl){
        tgl.addEventListener("click", ()=>{
          HORARIOS_EDIT_MODE = !HORARIOS_EDIT_MODE;
          try{ localStorage.setItem("LM_HORARIOS_EDITMODE_v1", HORARIOS_EDIT_MODE ? "1" : "0"); }catch(e){}
          applyEditUi();
          renderHorarios(); // refrescar tarjetas con botón EDITAR
        });
      }
      if (neu){
        neu.addEventListener("click", ()=>openHorariosEditor(null, true));
      }

      // restaurar estado
      try{
        HORARIOS_EDIT_MODE = (localStorage.getItem("LM_HORARIOS_EDITMODE_v1") === "1");
      }catch(e){ HORARIOS_EDIT_MODE = false; }
      applyEditUi();
    }

    // UX: ajustar altura y habilitar drag-to-scroll en matriz
    try{
      // se ejecuta después de que el DOM ya esté armado
      setTimeout(()=>{
        enableHorariosDragScroll();
        fitHorariosMatrixHeight();
      }, 0);
    }catch(e){}
el.dataset.ready = "1";
  }

  function sortByLocalOrder(values){
    return values.slice().sort((a,b)=>{
      const ia = LOCAL_ORDER.indexOf(a); const ib = LOCAL_ORDER.indexOf(b);
      return (ia<0?999:ia) - (ib<0?999:ib);
    });
  }


  function rebuildHorariosSalonOptions(){
    const fLocal = document.getElementById("hLocal").value;
    const fUni = document.getElementById("hUni").value;

    let base = SCHEDULES.slice();
    if (fLocal !== "__ALL__") base = base.filter(s=>s.local===fLocal);
    if (fUni !== "__ALL__") base = base.filter(s=>s.uni===fUni);

    const salones = uniq(base.map(s=>s.salon)).sort((a,b)=>a.localeCompare(b,"es"));
    fillSelectKeep("hSalon", salones, "SALÓN: TODOS");
  }
  let HORARIOS_MATRIX_FULLSCREEN = false;

  function setHorariosMatrixFullscreen(force){
    const host = document.getElementById("hMatrixHost");
    const tgl = document.getElementById("hFsToggle");
    if (!host || !tgl) return;
    const next = (typeof force === "boolean") ? force : !HORARIOS_MATRIX_FULLSCREEN;
    HORARIOS_MATRIX_FULLSCREEN = !!next;
    host.classList.toggle("isFullscreen", HORARIOS_MATRIX_FULLSCREEN);
    tgl.textContent = HORARIOS_MATRIX_FULLSCREEN ? "SALIR PANTALLA COMPLETA" : "PANTALLA COMPLETA";
    if (!HORARIOS_MATRIX_FULLSCREEN){
      host.scrollTop = 0;
      host.scrollLeft = 0;
    }
    try{ fitHorariosMatrixHeight(); }catch(e){}
  }

  function localCodeFromName(local){
    if (local === "LA MOLINA") return "LM";
    if (local === "SAN MIGUEL") return "SM";
    if (local === "SAN BORJA") return "SB";
    return "VIRT";
  }

  function baseColumnKeyForSchedule(sch){
    if (sch.uni === "AGRARIA"){
      if (String(sch.salon||"").toUpperCase().includes("ESCOLAR")) return "ESCOLARES";
      if (sch.id === "AGR_LM_2" || String(sch.salon||"").includes(" 2") || String(sch.salon||"").includes("LM 2")) return "AGRARIA_2";
      return "AGRARIA_1";
    }
    if (sch.uni === "U.LIMA"){
      const id = String(sch.id||"");
      const sal = String(sch.salon||"");
      if (sal.toUpperCase().includes("ESC") || id.includes("UL_ESC")) return "ESCOLARES";
      if (id.endsWith("_2") || sal.includes(" 2") || id.includes("_SM_2") || id.includes("_SB_2") || id.includes("_VIRT_2")) return "ULIMA_2";
      return "ULIMA_1";
    }
    if (sch.uni === "PUCP") return "PUCP";
    return "ESCOLARES";
  }

  function expandColKeyForLocal(local, baseKey){
    const lc = localCodeFromName(local);
    if (baseKey === "AGRARIA_1") return `AGRARIA_${lc}_1`;
    if (baseKey === "AGRARIA_2") return `AGRARIA_${lc}_2`;
    if (baseKey === "ULIMA_1") return `ULIMA_${lc}_1`;
    if (baseKey === "ULIMA_2") return `ULIMA_${lc}_2`;
    if (baseKey === "PUCP") return `PUCP_${lc}`;
    if (baseKey === "ESCOLARES") return `ESCOLARES_${lc}`;
    return `${baseKey}_${lc}`;
  }

  function matrixColumnKeyForSchedule(sch){
    return expandColKeyForLocal(sch.local, baseColumnKeyForSchedule(sch));
  }

  function scheduleCardKey(local, colKey){
    return `${local}||${colKey}`;
  }

  function cycleTypeFromColKey(colKey){
    const c = String(colKey||"").toUpperCase();
    if (c.startsWith("AGRARIA_")) return "AGRARIA";
    if (c.startsWith("ULIMA_")) return "U.LIMA";
    if (c.startsWith("PUCP_")) return "PUCP";
    if (c.startsWith("ESCOLARES_")) return "ESCOLARES";
    if (c === "AGRARIA" || c === "U.LIMA" || c === "PUCP" || c === "ESCOLARES") return c;
    return "AGRARIA";
  }

  function inferSalonByCardKey(local, colKey, fallback){
    const t = cycleTypeFromColKey(colKey);
    const lc = localCodeFromName(local);
    if (t === "AGRARIA") return `AGRARIA ${lc}${String(colKey).endsWith("_2") ? " 2" : " 1"}`;
    if (t === "U.LIMA") return `ULIMA ${lc}${String(colKey).endsWith("_2") ? " 2" : " 1"}`;
    if (t === "PUCP") return `PUCP ${lc}`;
    if (t === "ESCOLARES") return `ESCOLARES ${lc}`;
    return fallback || `${t} ${lc}`;
  }

  function buildPlaceholderSchedule(local, colKey, colLabel){
    const fullColKey = expandColKeyForLocal(local, colKey);
    return {
      id: `__PH__${fullColKey}`,
      local,
      uni: cycleTypeFromColKey(fullColKey),
      salon: inferSalonByCardKey(local, fullColKey, colLabel),
      blocks: [],
      __isPlaceholder: true,
      __colKey: fullColKey,
      __cardKey: scheduleCardKey(local, fullColKey)
    };
  }

  function scheduleIdentityFromCardKey(cardKey){
    const parts = String(cardKey||"").split("||");
    const local = parts[0] || "VIRTUAL";
    const colKey = parts[1] || expandColKeyForLocal(local, "ESCOLARES");
    const uni = cycleTypeFromColKey(colKey);
    const lc = localCodeFromName(local);
    const id = `SCH_${String(colKey).replace(/[^A-Z0-9_]+/g,"_")}`;
    return { id, local, uni, salon: inferSalonByCardKey(local, colKey, ""), colKey, cardKey: scheduleCardKey(local, colKey) };
  }

  function scheduleCardHtmlWithMeta(s){
    const colKey = String(s.__colKey || matrixColumnKeyForSchedule(s));
    const cardKey = String(s.__cardKey || scheduleCardKey(s.local, colKey));
    const uniType = cycleTypeFromColKey(colKey);
    const view = Object.assign({}, s, {
      uni: uniType,
      salon: inferSalonByCardKey(s.local, colKey, s.salon),
      cornerLabel: getCornerLabelByCycle(colKey)
    });
    let html = scheduleToHtmlCard(view);
    html = html.replace('<div class="schCard"', `<div class="schCard" data-cycle="${escapeAttr(colKey)}" data-colkey="${escapeAttr(colKey)}" data-cardkey="${escapeAttr(cardKey)}"`);
    if (s.__isPlaceholder){
      const identity = scheduleIdentityFromCardKey(cardKey);
      html = html
        .replace('data-id="'+escapeHtml(s.id)+'"', `data-id="${escapeHtml(identity.id)}"`)
        .replace('data-uni="'+escapeHtml(view.uni)+'"', `data-uni="${escapeHtml(identity.uni)}"`)
        .replace('data-salon="'+escapeHtml(view.salon)+'"', `data-salon="${escapeHtml(identity.salon)}"`)
        .replace('data-local="'+escapeHtml(view.local)+'"', `data-local="${escapeHtml(identity.local)}"`)
        .replace('<div class="schCard"', `<div class="schCard" data-placeholder="1"`)
        .replace(/data-sid="[^"]*"/g, `data-sid="${escapeAttr(identity.id)}"`);
    }
    return html;
  }

  function renderHorarios(){
    ensureHorariosLayout();

    // Alumno: forzar horario propio (sin filtros)
    if (CURRENT_ROLE === "alumno"){
      const prof = getAlumnoProfile();
      const grid = document.getElementById("schGrid");
      const meta = document.getElementById("hAlumnoMeta");
      if (!grid) return;

      if (!prof){
        grid.innerHTML = `<div class="card panel12" style="box-shadow:none;">
          <div class="cardtitle">SIN PERFIL</div>
          <div style="color:var(--muted); font-weight:900;">No se encontró tu matrícula.</div>
        </div>`;
        if (meta) meta.innerHTML = `<span class="pill"><span class="dot" style="background:var(--danger);"></span>Sin datos de usuario</span>`;
        return;
      }

      const own = SCHEDULES.find(x => x.salon === prof.salon && x.local === prof.local && x.uni === prof.uni);
      if (!own){
        grid.innerHTML = `<div class="card panel12" style="box-shadow:none;">
          <div class="cardtitle">HORARIO NO ENCONTRADO</div>
          <div style="color:var(--muted); font-weight:900;">No hay horario configurado para tu salón.</div>
        </div>`;
        if (meta) meta.innerHTML = `<span class="pill"><span class="dot" style="background:var(--danger);"></span>${escapeHtml(prof.local)} / ${escapeHtml(prof.uni)} / ${escapeHtml(prof.salon)}</span>`;
        return;
      }

      grid.innerHTML = scheduleCardHtmlWithMeta(Object.assign({}, own, { __colKey: matrixColumnKeyForSchedule(own) }));
      if (meta) meta.innerHTML = `
        <span class="pill"><span class="dot" style="background:var(--ok);"></span>${escapeHtml(prof.local)}</span>
        <span class="pill"><span class="dot" style="background:${prof.uni==="AGRARIA" ? "var(--agraria)" : (prof.uni==="PUCP" ? "var(--pucp)" : "var(--ulima)")}"></span>${escapeHtml(prof.uni)}</span>
        <span class="pill">${escapeHtml(prof.salon)}</span>
      `;
      return;
    }

    // Admin/Tutor: vista
    const mode = (document.getElementById("hViewMode") ? document.getElementById("hViewMode").value : "matrix");
    const fLocal = document.getElementById("hLocal").value;
    const fUni   = document.getElementById("hUni").value;
    const fSalon = document.getElementById("hSalon").value;

    let base = SCHEDULES.slice();
    if (fLocal !== "__ALL__") base = base.filter(s=>s.local===fLocal);
    if (fUni !== "__ALL__") base = base.filter(s=>s.uni===fUni);

    const grid = document.getElementById("schGrid");
    const mx   = document.getElementById("schMatrix");

    if (mode === "list"){
      // LISTA: aplica también salón
      let list = base.slice();
      if (fSalon !== "__ALL__") list = list.filter(s=>s.salon===fSalon);

      list = sortSchedules(list);

      if (mx) mx.style.display = "none";
      setHorariosMatrixFullscreen(false);
      if (grid) grid.style.display = "";
      if (grid) grid.innerHTML = list.map(x=>scheduleCardHtmlWithMeta(Object.assign({}, x, { __colKey: matrixColumnKeyForSchedule(x) }))).join("");
      try{ bindHorariosCellTargets(); }catch(e){}
      return;
    }

    // MATRIZ: ignora filtro de salón (para mantener alineación)
    if (mx) mx.style.display = "";
    if (grid) grid.style.display = "none";

    if (document.getElementById("hSalon")){
      document.getElementById("hSalon").value = "__ALL__";
    }

    const LOCS = ["LA MOLINA","SAN MIGUEL","SAN BORJA","VIRTUAL"];
    const COLS = [
      { key:"AGRARIA_1", label:"AGRARIA 1" },
      { key:"AGRARIA_2", label:"AGRARIA 2" },
      { key:"ULIMA_1",   label:"U.LIMA 1" },
      { key:"ULIMA_2",   label:"U.LIMA 2" },
      { key:"PUCP",      label:"PUCP" },
      { key:"ESCOLARES", label:"ESCOLARES" },
    ];

    // index
    const by = new Map();
    for (const sch of base){
      const ck = matrixColumnKeyForSchedule(sch);
      if (!by.has(ck)) by.set(ck, []);
      by.get(ck).push(sch);
    }

    const headCells = COLS.map(c=>`<div class="mxHead">${escapeHtml(c.label)}</div>`).join("");

    const rows = LOCS.map(loc=>{
      const cells = COLS.map(c=>{
        const key = expandColKeyForLocal(loc, c.key);
        const list = sortSchedules((by.get(key) || []).slice());
        const inner = list.length
          ? list.map(scheduleCardHtmlWithMeta).join("")
          : scheduleCardHtmlWithMeta(buildPlaceholderSchedule(loc, c.key, c.label));
        return `<div class="mxCell">${inner}</div>`;
      }).join("");
      return `<div class="mxRowHead">${escapeHtml(loc)}</div>${cells}`;
    }).join("");

    if (mx){
      mx.innerHTML = `
        <div class="schMatrix">
          <div class="mxCorner"></div>
          ${headCells}
          ${rows}
        </div>
      `;
      try{ applyHorariosZoom(); }catch(e){}
      try{ requestAnimationFrame(()=>fitHorariosMatrixHeight()); }catch(e){}
      try{ bindHorariosCellTargets(); }catch(e){}
    }
  }


  let HORARIOS_CELL_EDIT_CTX = null;

  function ensureHorariosCellEditModal(){
    if (document.getElementById("hCellEditOverlay")) return;
    const el = document.createElement("div");
    el.id = "hCellEditOverlay";
    el.className = "hCellEditOverlay";
    el.style.display = "none";
    el.innerHTML = `
      <div class="hCellEditModal" role="dialog" aria-modal="true">
        <div class="hCellEditHead">
          <div>
            <div class="hCellEditTitle" id="hCellEditTitle">Edición rápida</div>
            <div class="hCellEditSub" id="hCellEditSub">Ajusta día y horas sin cambiar el formato visual del horario.</div>
          </div>
          <button id="hCellEditClose" class="hBtn hBtnTiny">✕</button>
        </div>
        <div class="hCellEditBody">
          <div>
            <label class="hLbl">DÍA</label>
            <select id="hceDay" class="hInp"></select>
          </div>
          <div>
            <label class="hLbl">HORA INICIO</label>
            <select id="hceStart" class="hInp"></select>
          </div>
          <div>
            <label class="hLbl">HORA FIN</label>
            <select id="hceEnd" class="hInp"></select>
          </div>
          <div class="full">
            <label class="hLbl">CURSO</label>
            <input id="hceCourse" class="hInp" placeholder="Ej: RV / ÁLG 1" />
          </div>
        </div>
        <div class="hCellEditFoot">
          <button id="hCellEditCancel" class="hBtn">CANCELAR</button>
          <button id="hCellEditSave" class="hBtn hBtnPrimary">GUARDAR</button>
        </div>
      </div>
    `;
    document.body.appendChild(el);

    const close = ()=>closeHorariosCellEditModal();
    document.getElementById("hCellEditClose").addEventListener("click", close);
    document.getElementById("hCellEditCancel").addEventListener("click", close);
    document.getElementById("hCellEditSave").addEventListener("click", saveHorariosCellEditModal);
    el.addEventListener("click", (e)=>{ if (e.target === el) close(); });

    const daySel = document.getElementById("hceDay");
    daySel.innerHTML = DAYS.map(d=>`<option value="${d}">${d}</option>`).join("");
    const marksHtml = TIME_MARKS.map(t=>`<option value="${t}">${t}</option>`).join("");
    document.getElementById("hceStart").innerHTML = marksHtml;
    document.getElementById("hceEnd").innerHTML = marksHtml;
  }

  function openHorariosCellEditModal(ctx){
    if (CURRENT_ROLE !== "admin" || !HORARIOS_EDIT_MODE) return;
    ensureHorariosCellEditModal();
    HORARIOS_CELL_EDIT_CTX = ctx || null;
    if (!HORARIOS_CELL_EDIT_CTX) return;

    const ov = document.getElementById("hCellEditOverlay");
    const ttl = document.getElementById("hCellEditTitle");
    const sub = document.getElementById("hCellEditSub");
    const day = normalizeDayKey(ctx.day || "LUNES");
    if (ttl) ttl.textContent = `Edición rápida · ${String(ctx.scheduleId || "HORARIO")}`;
    if (sub) sub.textContent = `Celda ${day} ${String(ctx.start||"")} - ${String(ctx.end||"")}`;
    document.getElementById("hceDay").value = day;
    document.getElementById("hceCourse").value = String(ctx.course || "");
    document.getElementById("hceStart").value = ctx.start || "08:00";
    document.getElementById("hceEnd").value = ctx.end || "09:50";

    ov.style.display = "flex";
    setTimeout(()=>{ const c = document.getElementById("hceCourse"); if (c){ c.focus(); c.select(); } }, 0);
  }

  function closeHorariosCellEditModal(){
    const ov = document.getElementById("hCellEditOverlay");
    if (ov) ov.style.display = "none";
    HORARIOS_CELL_EDIT_CTX = null;
  }

  function saveHorariosCellEditModal(){
    if (CURRENT_ROLE !== "admin" || !HORARIOS_EDIT_MODE || !HORARIOS_CELL_EDIT_CTX) return;

    const day = normalizeDayKey(document.getElementById("hceDay").value);
    const course = document.getElementById("hceCourse").value.trim();
    const start = document.getElementById("hceStart").value;
    const end = document.getElementById("hceEnd").value;

    const is = idxMark(start);
    const ie = idxMark(end);
    if (!DAYS.includes(day) || is < 0 || ie < 0 || is >= ie){
      alert("Rango horario inválido.");
      return;
    }
    if (!course){
      alert("Ingresa el nombre del curso.");
      return;
    }

    let sch = null;
    if (HORARIOS_CELL_EDIT_CTX.cardKey){
      sch = SCHEDULES.find(x=>scheduleCardKey(x.local, matrixColumnKeyForSchedule(x))===HORARIOS_CELL_EDIT_CTX.cardKey) || null;
    }
    if (!sch && HORARIOS_CELL_EDIT_CTX.scheduleId){
      sch = SCHEDULES.find(x=>x.id===HORARIOS_CELL_EDIT_CTX.scheduleId) || null;
    }
    if (!sch){
      if (HORARIOS_CELL_EDIT_CTX.cardKey){
        const iden = scheduleIdentityFromCardKey(HORARIOS_CELL_EDIT_CTX.cardKey);
        sch = { id: iden.id, local: iden.local, uni: iden.uni, salon: iden.salon, blocks: [] };
        SCHEDULES.push(sch);
      }else if (HORARIOS_CELL_EDIT_CTX.isPlaceholder){
        const fallbackKey = scheduleCardKey(HORARIOS_CELL_EDIT_CTX.phLocal, HORARIOS_CELL_EDIT_CTX.phColKey);
        const iden = scheduleIdentityFromCardKey(fallbackKey);
        sch = { id: iden.id, local: iden.local, uni: iden.uni, salon: iden.salon, blocks: [] };
        SCHEDULES.push(sch);
      }else{
        alert("No se encontró el horario.");
        return;
      }
    }

    const prev = HORARIOS_CELL_EDIT_CTX.blockIndex;
    const teacher = (prev >= 0 && sch.blocks[prev]) ? String(sch.blocks[prev].teacher || "") : "";
    const nextBlock = { day, start, end, course, teacher };

    if (prev >= 0 && sch.blocks[prev]){
      sch.blocks[prev] = nextBlock;
    }else{
      sch.blocks.push(nextBlock);
    }

    sch.blocks = sch.blocks.slice().sort((a,b)=>{
      const dd = DAYS.indexOf(normalizeDayKey(a.day)) - DAYS.indexOf(normalizeDayKey(b.day));
      if (dd !== 0) return dd;
      return idxMark(a.start) - idxMark(b.start);
    });

    SCHEDULES = sortSchedules(SCHEDULES);
    saveSchedules();
    closeHorariosCellEditModal();
    renderHorarios();
  }

  function bindHorariosCellTargets(){
    const cards = Array.from(document.querySelectorAll(".schCard"));
    cards.forEach(card=>{
      card.classList.remove("hEditEnabled");
      Array.from(card.querySelectorAll(".hCellEditable")).forEach(td=>td.classList.remove("hCellEditable"));

      const sid = card.getAttribute("data-id");
      const cardKey = card.getAttribute("data-cardkey") || "";
      const isPlaceholder = (card.getAttribute("data-placeholder") === "1");
      const sch = SCHEDULES.find(x=>x.id===sid) || {
        id: sid,
        local: card.getAttribute("data-local") || "",
        uni: card.getAttribute("data-uni") || "",
        salon: card.getAttribute("data-salon") || "",
        blocks: []
      };

      const matrix = buildScheduleMatrix(sch);
      const rows = Array.from(card.querySelectorAll("tbody tr"));
      rows.forEach((tr, r)=>{
        const tds = Array.from(tr.querySelectorAll("td"));
        if (!tds.length) return;
        let ptr = 1;
        DAYS.forEach((d)=>{
          const cell = matrix[r][d];
          if (!cell || cell.kind === "skip") return;
          const td = tds[ptr++];
          if (!td) return;
          td.classList.add("hCellEditable");
          td.dataset.day = d;
          td.dataset.start = TIME_ROWS[r].start;
          td.dataset.end = (cell.kind === "start") ? TIME_ROWS[Math.min(TIME_ROWS.length-1, r + Number(cell.rowspan||1) - 1)].end : TIME_ROWS[r].end;
          td.dataset.course = (cell.kind === "start" && cell.block) ? String(cell.block.course||"") : "";
          td.dataset.blockIndex = "-1";
          if (cell.kind === "start"){
            const idx = (sch.blocks||[]).findIndex(b=>normalizeDayKey(b.day)===d && b.start===td.dataset.start && b.end===td.dataset.end && String(b.course||"")===td.dataset.course);
            td.dataset.blockIndex = String(idx);
          }
          td.dataset.scheduleId = sid;
          td.dataset.cardKey = cardKey;
          if (isPlaceholder){
            td.dataset.placeholder = "1";
            td.dataset.phLocal = card.getAttribute("data-local") || "";
            td.dataset.phColKey = card.getAttribute("data-colkey") || "";
          }
        });
      });

      if (CURRENT_ROLE === "admin" && HORARIOS_EDIT_MODE) card.classList.add("hEditEnabled");
    });
  }



  // ===================== HORARIOS (EDICIÓN) =====================
  let HORARIOS_EDIT_MODE = false; // solo Admin
  let HORARIOS_EDIT_CURRENT_ID = null;
  let HORARIOS_EDIT_IS_NEW = false;
  function fillSelectPlain(selId, values){
    const sel = document.getElementById(selId);
    if (!sel) return;
    const prev = sel.value;
    sel.innerHTML = "";
    for (const v of values){
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    }
    if (prev && values.includes(prev)) sel.value = prev;
  }


  function ensureHorariosEditorModal(){
    if (document.getElementById("hEditorOverlay")) return;
    const el = document.createElement("div");
    el.id = "hEditorOverlay";
    el.className = "hEditorOverlay";
    el.style.display = "none";
    el.innerHTML = `
      <div class="hEditorModal">
        <div class="hEditorHead">
          <div>
            <div class="hEditorTitle" id="hEditorTitle">EDITAR HORARIO</div>
            <div class="hEditorSub" id="hEditorSub">Edición de bloques por día y rango horario.</div>
          </div>
          <button class="hEditorClose" id="hEditorClose">✕</button>
        </div>

        <div class="hEditorBody">
          <div class="hEditorGrid">
            <div>
              <label class="hLbl">LOCAL</label>
              <select id="heLocal" class="hInp"></select>
            </div>
            <div>
              <label class="hLbl">UNIVERSIDAD</label>
              <select id="heUni" class="hInp"></select>
            </div>
            <div>
              <label class="hLbl">SALÓN</label>
              <input id="heSalon" class="hInp" placeholder="Ej: AGRARIA LM 1"/>
            </div>
            <div>
              <label class="hLbl">ID</label>
              <input id="heId" class="hInp" placeholder="ID interno" />
            </div>
          </div>

          <div class="hEditorBlocks">
            <div class="hEditorBlocksHead">
              <div class="hEditorBlocksTitle">BLOQUES</div>
              <button class="hBtn hBtnGhost" id="heAddBlock">+ BLOQUE</button>
            </div>

            <div class="hEditorBlocksWrap">
              <table class="hEditorTable">
                <thead>
                  <tr>
                    <th>DÍA</th>
                    <th>INICIO</th>
                    <th>FIN</th>
                    <th>CURSO</th>
                    <th>DOCENTE</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="heTbody"></tbody>
              </table>
            </div>

            <div class="hEditorHint">
              Nota: los horarios se alinean al tablero (TIME MARKS). Ej.: 13:00–15:00 es válido.
            </div>
          </div>
        </div>

        <div class="hEditorFoot">
          <button class="hBtn hBtnGhost" id="heCancel">CANCELAR</button>
          <button class="hBtn hBtnDanger" id="heDelete">ELIMINAR</button>
          <button class="hBtn hBtnPrimary" id="heSave">GUARDAR</button>
        </div>
      </div>
    `;
    document.body.appendChild(el);

    // listeners base (una sola vez)
    document.getElementById("hEditorClose").addEventListener("click", closeHorariosEditor);
    document.getElementById("heCancel").addEventListener("click", closeHorariosEditor);

    document.getElementById("heAddBlock").addEventListener("click", ()=>{
      appendHorarioBlockRow({ day:"LUNES", start:"08:00", end:"09:50", course:"", teacher:"" });
    });

    document.getElementById("heSave").addEventListener("click", saveHorariosEditor);
    document.getElementById("heDelete").addEventListener("click", deleteHorarioEditor);
  }

  function openHorariosEditor(scheduleId, isNew=false){
    if (CURRENT_ROLE !== "admin") return;
    ensureHorariosEditorModal();
    HORARIOS_EDIT_CURRENT_ID = scheduleId || null;
    HORARIOS_EDIT_IS_NEW = !!isNew;

    // cargar selects
    fillSelectPlain("heLocal", sortByLocalOrder(LOCAL_ORDER.slice()));
    fillSelectPlain("heUni", ["AGRARIA","U.LIMA","PUCP","ESCOLARES"]);

    const overlay = document.getElementById("hEditorOverlay");
    const title = document.getElementById("hEditorTitle");
    const sub   = document.getElementById("hEditorSub");
    const delBtn= document.getElementById("heDelete");

    const s = isNew ? null : (SCHEDULES.find(x=>x.id===scheduleId) || null);

    title.textContent = isNew ? "NUEVO HORARIO" : "EDITAR HORARIO";
    sub.textContent = isNew ? "Crea un nuevo salón con sus bloques." : "Edita bloques por día y rango horario.";
    delBtn.style.display = isNew ? "none" : "";

    // defaults
    const heLocal = document.getElementById("heLocal");
    const heUni   = document.getElementById("heUni");
    const heSalon = document.getElementById("heSalon");
    const heId    = document.getElementById("heId");

    if (s){
      heLocal.value = s.local;
      heUni.value   = s.uni;
      heSalon.value = s.salon;
      heId.value    = s.id;
      heId.disabled = true; // id estable para no romper columnas
    }else{
      heLocal.value = "LA MOLINA";
      heUni.value   = "AGRARIA";
      heSalon.value = "";
      heId.value    = "SCH_" + String(Date.now());
      heId.disabled = false;
    }

    // blocks
    const tb = document.getElementById("heTbody");
    tb.innerHTML = "";
    const blocks = (s && Array.isArray(s.blocks)) ? s.blocks : [];
    for (const b of blocks) appendHorarioBlockRow(b);

    overlay.style.display = "flex";
  }

  function closeHorariosEditor(){
    const overlay = document.getElementById("hEditorOverlay");
    if (overlay) overlay.style.display = "none";
    HORARIOS_EDIT_CURRENT_ID = null;
    HORARIOS_EDIT_IS_NEW = false;
  }

  function escapeAttr(s){
    return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function timeOptionsHtml(selected){
    const sel = String(selected||"");
    return TIME_MARKS.map(t=>`<option value="${t}" ${t===sel ? "selected" : ""}>${t}</option>`).join("");
  }

  function dayOptionsHtml(selected){
    const sel = normalizeDayKey(selected||"LUNES");
    return DAYS.map(d=>`<option value="${d}" ${d===sel ? "selected" : ""}>${d}</option>`).join("");
  }

  function appendHorarioBlockRow(b){
    const tb = document.getElementById("heTbody");
    if (!tb) return;

    const day = normalizeDayKey(b.day || "LUNES");
    const start = b.start || "08:00";
    const end = b.end || "09:50";
    const course = b.course || "";
    const teacher = b.teacher || "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><select class="heDay hInpSm">${dayOptionsHtml(day)}</select></td>
      <td><select class="heStart hInpSm">${timeOptionsHtml(start)}</select></td>
      <td><select class="heEnd hInpSm">${timeOptionsHtml(end)}</select></td>
      <td><input class="heCourse hInpSm" value="${escapeAttr(course)}" placeholder="Ej: RV / ÁLG 1"/></td>
      <td><input class="heTeacher hInpSm" value="${escapeAttr(teacher)}" placeholder="Ej: TABER"/></td>
      <td><button class="hBtn hBtnTiny hBtnDanger heDel">✕</button></td>
    `;
    tb.appendChild(tr);

    tr.querySelector(".heDel").addEventListener("click", ()=>tr.remove());
  }

  function collectEditorBlocks(){
    const tb = document.getElementById("heTbody");
    const rows = Array.from(tb.querySelectorAll("tr"));
    const blocks = [];
    for (const r of rows){
      const day = normalizeDayKey(r.querySelector(".heDay").value);
      const start = r.querySelector(".heStart").value;
      const end = r.querySelector(".heEnd").value;
      const course = r.querySelector(".heCourse").value.trim();
      const teacher = r.querySelector(".heTeacher").value.trim();

      const is = idxMark(start);
      const ie = idxMark(end);
      if (is < 0 || ie < 0 || is >= ie) continue;

      blocks.push({ day, start, end, course, teacher });
    }
    return blocks;
  }

  function saveHorariosEditor(){
    if (CURRENT_ROLE !== "admin") return;

    const local = document.getElementById("heLocal").value;
    const uni   = document.getElementById("heUni").value;
    const salon = document.getElementById("heSalon").value.trim();
    const id    = document.getElementById("heId").value.trim();

    if (!local || !uni || !salon || !id){
      alert("Completa LOCAL / UNIVERSIDAD / SALÓN / ID.");
      return;
    }

    const blocks = collectEditorBlocks();
    const obj = { id, local, uni, salon, blocks };

    if (HORARIOS_EDIT_IS_NEW){
      if (SCHEDULES.some(x=>x.id===id)){
        alert("Ese ID ya existe. Cambia el ID.");
        return;
      }
      SCHEDULES.push(obj);
    }else{
      const i = SCHEDULES.findIndex(x=>x.id===HORARIOS_EDIT_CURRENT_ID);
      if (i < 0){
        alert("No se encontró el horario para editar.");
        return;
      }
      // mantener ID estable
      obj.id = SCHEDULES[i].id;
      SCHEDULES[i] = obj;
    }

    SCHEDULES = sortSchedules(SCHEDULES);
    saveSchedules();
    closeHorariosEditor();

    try{ rebuildHorariosSalonOptions(); }catch(e){}
    try{ renderHorarios(); }catch(e){}
  }

  function deleteHorarioEditor(){
    if (CURRENT_ROLE !== "admin") return;
    if (!HORARIOS_EDIT_CURRENT_ID) return;
    if (!confirm("¿Eliminar este horario?")) return;

    SCHEDULES = SCHEDULES.filter(x=>x.id!==HORARIOS_EDIT_CURRENT_ID);
    SCHEDULES = sortSchedules(SCHEDULES);
    saveSchedules();

    closeHorariosEditor();
    try{ rebuildHorariosSalonOptions(); }catch(e){}
    try{ renderHorarios(); }catch(e){}
  }

  // ===================== DESCARGAR PNG =====================
  function safeFileName(s){
    return String(s||"horario")
      .trim()
      .toLowerCase()
      .replace(/[^\w]+/g,"_")
      .replace(/^_+|_+$/g,"");
  }

  async function downloadSchedulePNG(scheduleId){
    const card = document.querySelector(`.schCard[data-id="${scheduleId}"]`);
    if (!card) return;


    // asegurar visibilidad dentro de contenedores con scroll (matriz)
    try{ card.scrollIntoView({ block:"center", inline:"center" }); }catch(e){}

    const prevBody = document.body.classList.contains("exportMode");
    document.body.classList.add("exportMode");

    // Neutralizar zoom/transform (matriz) para exportar nítido
    const prevZoom = card.style.zoom;
    const prevTransform = card.style.transform;
    card.style.zoom = "1";
    card.style.transform = "none";

    // ocultar botón para que no salga en la imagen
    const btn = card.querySelector(".schDl");
    const prevBtnDisplay = btn ? btn.style.display : "";
    if (btn) btn.style.display = "none";

    const wrap = card.querySelector(".schTableWrap");
    if (wrap) wrap.scrollLeft = 0;

    await new Promise(r=>requestAnimationFrame(()=>r()));

    const canvas = await html2canvas(card, {
      backgroundColor: "#ffffff",
      scale: 2,
      useCORS: true
    });

    // restaurar zoom/transform
    card.style.zoom = prevZoom;
    card.style.transform = prevTransform;

    if (btn) btn.style.display = prevBtnDisplay;
    if (!prevBody) document.body.classList.remove("exportMode");

    const nameLocal = safeFileName(card.getAttribute("data-local"));
    const nameSalon = safeFileName(card.getAttribute("data-salon"));
    const nameUni   = safeFileName(card.getAttribute("data-uni"));

    const a = document.createElement("a");
    a.download = `horario_${nameUni}_${nameLocal}_${nameSalon}.png`;
    a.href = canvas.toDataURL("image/png");
    a.click();
  }

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest(".schDl");
    if (!btn) return;
    const sid = btn.getAttribute("data-sid");
    if (!sid) return;
    downloadSchedulePNG(sid);
  });

  document.addEventListener("dblclick", (e)=>{
    const cell = e.target.closest(".hCellEditable");
    if (!cell) return;
    if (CURRENT_ROLE !== "admin" || !HORARIOS_EDIT_MODE) return;

    const card = cell.closest(".schCard");
    if (!card) return;

    openHorariosCellEditModal({
      scheduleId: cell.dataset.scheduleId || card.getAttribute("data-id"),
      day: cell.dataset.day,
      start: cell.dataset.start,
      end: cell.dataset.end,
      course: cell.dataset.course || "",
      blockIndex: Number(cell.dataset.blockIndex || "-1"),
      cardKey: cell.dataset.cardKey || card.getAttribute("data-cardkey") || "",
      isPlaceholder: cell.dataset.placeholder === "1",
      phLocal: cell.dataset.phLocal || "",
      phColKey: cell.dataset.phColKey || ""
    });
  });

  document.addEventListener("keydown", (e)=>{
    const ov = document.getElementById("hCellEditOverlay");
    if (ov && ov.style.display !== "none"){
      if (e.key === "Escape"){
        e.preventDefault();
        closeHorariosCellEditModal();
        return;
      }
      if (e.key === "Enter"){
        const tag = String((document.activeElement && document.activeElement.tagName) || "").toUpperCase();
        if (tag === "TEXTAREA") return;
        e.preventDefault();
        saveHorariosCellEditModal();
        return;
      }
    }
    if (e.key === "Escape" && HORARIOS_MATRIX_FULLSCREEN){
      e.preventDefault();
      setHorariosMatrixFullscreen(false);
    }
  });

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest(".schEdit");
    if (!btn) return;
    if (CURRENT_ROLE !== "admin") return;
    const sid = btn.getAttribute("data-sid");
    if (!sid) return;
    openHorariosEditor(sid, false);
  });

  // ===================== RENDER =====================

  // ===================== INICIO (ALUMNOS) =====================

function ensureInicioAlumnoLayout(){
    const el = document.getElementById("view_inicio_alumno");
    if (!el || el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="alHero panel12">
        <div class="alHeroInner">
          <div class="alHeroLeft">
            <div class="alHeroKicker">PORTAL DEL ALUMNO</div>
            <div class="alHeroTitle">Bienvenido(a), <span id="alHeroName">Alumno</span></div>
            <div class="alHeroSub">Tu perfil, tu horario y tu sílabo en un solo lugar.</div>

            <div class="alHeroActions">
              <button class="alBtn alBtnGhost" id="alJumpPerfil">Ver mi perfil</button>
              <button class="alBtn alBtnPrimary" id="alJumpHorario">Ver mi horario</button>
              <button class="alBtn alBtnGhost" id="alJumpSilabo">Ver mi sílabo</button>
            </div>

            <div class="alHeroNote">
              <span class="dot" style="background:#b10f2e;"></span>
              <span>Los accesos se ajustan a tu matrícula. Si algo no aparece, comunícate con tu tutor para actualización.</span>
            </div>
          </div>

          <div class="alHeroRight">
            <div class="alStat">
              <div class="alStatLabel">Próxima clase</div>
              <div class="alStatValue" id="alNextClass">—</div>
              <div class="alStatMeta" id="alNextClassMeta">—</div>
            </div>

            <div class="alStat">
              <div class="alStatLabel">Estado</div>
              <div class="alStatValue" id="alEstadoChip">—</div>
              <div class="alStatMeta" id="alLocalChip">—</div>
            </div>
          </div>
        </div>
      </div>
    `;

    const bP = document.getElementById("alJumpPerfil");
    const bH = document.getElementById("alJumpHorario");
    const bS = document.getElementById("alJumpSilabo");

    if (bP) bP.addEventListener("click", ()=>setView("perfil_alumno"));
    if (bH) bH.addEventListener("click", ()=>setView("horarios"));
    if (bS) bS.addEventListener("click", ()=>setView("silabos"));

    el.dataset.ready = "1";
  }

function ensurePerfilAlumnoLayout(){
    const el = document.getElementById("view_perfil_alumno");
    if (!el || el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card panel12 alSection">
        <div class="alSectionHead">
          <div>
            <div class="alSectionTitle">MI PERFIL</div>
            <div class="alSectionSub">Información registrada en su matrícula.</div>
          </div>
          <div class="alSectionTools">
            <button class="alBtn alBtnGhost" id="alPerfilRefresh">Actualizar</button>
          </div>
        </div>
        <div id="alPerfilGridPro"></div>
      </div>
    `;

    const b = document.getElementById("alPerfilRefresh");
    if (b) b.addEventListener("click", ()=>{ try{ refreshAlumnoProfileFromCache(); }catch(e){} renderPerfilAlumno(); });

    el.dataset.ready = "1";
  }

  function renderPerfilAlumno(){
    ensurePerfilAlumnoLayout();

    const prof = getAlumnoProfile();
    const grid = document.getElementById("alPerfilGridPro");
    if (!grid) return;

    if (!prof){
      grid.innerHTML = `
        <div class="alEmpty">
          <div class="alEmptyTitle">Perfil no encontrado</div>
          <div class="alEmptyText">Cierre sesión y vuelva a ingresar.</div>
        </div>`;
      return;
    }

    const uni = uniKey(prof.uni || prof.uni_sheet || prof.ciclo || "") || (prof.uni || "-");
    const avatar = escapeHtml((prof.nombre||"A").trim().slice(0,1).toUpperCase());
    const first = (prof?.nombre ? String(prof.nombre).trim().split(" ")[0] : "Alumno");

    const hasApo = !!(norm(prof.nombre_apo)||norm(prof.cel_apo)||norm(prof.correo_apo)||norm(prof.dni_apo));

    const cardIdent = `
      <div class="alProCard">
        <div class="alProHead">
          <div class="alAvatarBig">${avatar}</div>
          <div class="alProHeadTxt">
            <div class="alNameBig">${escapeHtml(prof.nombre || "ALUMNO")}</div>
            <div class="alSmall">
              <span class="alTag">USUARIO: <b>${escapeHtml(prof.usuario || "-")}</b></span>
              <span class="alTag">DNI: <b>${escapeHtml(prof.dni || "-")}</b></span>
              <span class="alTag">ESTADO: <b>${escapeHtml(prof.estado || "-")}</b></span>
            </div>
          </div>
        </div>

        <div class="alKVGrid">
          <div class="alKV"><span>Universidad</span><b>${escapeHtml(uni || "-")}</b></div>
          <div class="alKV"><span>Modalidad</span><b>${escapeHtml(prof.modalidad || "-")}</b></div>
          <div class="alKV"><span>Local</span><b>${escapeHtml(prof.local || "-")}</b></div>
          <div class="alKV"><span>Salón</span><b>${escapeHtml(prof.salon || "-")}</b></div>
          <div class="alKV"><span>Ciclo</span><b>${escapeHtml(prof.ciclo || "-")}</b></div>
          <div class="alKV"><span>Carrera</span><b>${escapeHtml(prof.carrera || "-")}</b></div>
        </div>
      </div>
    `;

    const cardContacto = `
      <div class="alProCard">
        <div class="alProTitle">Contacto del alumno</div>
        <div class="alKVList">
          <div class="alKVLine"><span>Correo</span><b>${escapeHtml(prof.correo || "-")}</b></div>
          <div class="alKVLine"><span>Celular</span><b>${escapeHtml(prof.celular || "-")}</b></div>
        </div>
      </div>
    `;

    const cardApo = `
      <div class="alProCard">
        <div class="alProTitle">Apoderado</div>
        ${hasApo ? `
          <div class="alKVList">
            <div class="alKVLine"><span>Nombre</span><b>${escapeHtml(prof.nombre_apo || "-")}</b></div>
            <div class="alKVLine"><span>Celular</span><b>${escapeHtml(prof.cel_apo || "-")}</b></div>
            <div class="alKVLine"><span>DNI</span><b>${escapeHtml(prof.dni_apo || "-")}</b></div>
            <div class="alKVLine"><span>Correo</span><b>${escapeHtml(prof.correo_apo || "-")}</b></div>
          </div>
        ` : `
          <div class="alEmptyMini">Sin datos de apoderado registrados.</div>
        `}
      </div>
    `;

    grid.innerHTML = `
      <div class="alProGrid">
        <div class="alProCol">
          ${cardIdent}
        </div>
        <div class="alProCol">
          ${cardContacto}
          ${cardApo}
        </div>
      </div>
    `;
  }

  // Relee el perfil desde la "cache" de matrícula si existe el usuario (sin pedir credenciales)
  function refreshAlumnoProfileFromCache(){
    try{
      const user = loadAlumnoUser();
      if (!user) return;
      const u = norm(user);
      const hit = (state?.allRows || []).find(r=>norm(r.usuario)===u);
      if (hit) setAlumnoSession(hit);
    }catch(e){}
  }


function alumnoUniFromProfile(prof){
    if (!prof) return "";
    const u = uniKey(prof.uni || prof.uni_sheet || "");
    if (u) return u;
    return uniKey(uniGroupFromCiclo(prof.ciclo || ""));
  }

  function getAlumnoSchedule(prof){
    if (!prof) return null;
    const uni = alumnoUniFromProfile(prof);
    const local = norm(prof.local || "");
    const salon = norm(prof.salon || "");
    let base = SCHEDULES.slice();

    const sameUni = (a,b)=> uniKey(a)===uniKey(b);

    // Coincidencia estricta
    let hit = base.find(s => sameUni(s.uni, uni) && norm(s.local)===local && norm(s.salon)===salon);
    if (hit) return hit;

    // Fallback por uni + salón
    hit = base.find(s => sameUni(s.uni, uni) && norm(s.salon)===salon);
    if (hit) return hit;

    // Fallback por salón (último recurso)
    hit = base.find(s => norm(s.salon)===salon);
    return hit || null;
  }

  function dayNameFromDate(d){
    const map = ["DOMINGO","LUNES","MARTES","MIÉRCOLES","JUEVES","VIERNES","SÁBADO"];
    return map[d.getDay()];
  }

  function timeToMin(hhmm){
    const [h,m] = String(hhmm||"0:0").split(":").map(x=>parseInt(x,10));
    return (h*60) + (m||0);
  }

  function getAlumnoNextClass(prof){
    const sch = getAlumnoSchedule(prof);
    if (!sch) return null;

    const now = new Date();
    const today = dayNameFromDate(now);
    const nowMin = now.getHours()*60 + now.getMinutes();

    // bloques de hoy ordenados por inicio
    const todayBlocks = sch.blocks
      .filter(b => norm(b.day) === norm(today))
      .slice()
      .sort((a,b)=>timeToMin(a.start)-timeToMin(b.start));

    // próxima de hoy
    for (const b of todayBlocks){
      if (timeToMin(b.end) >= nowMin){
        return { day: today, start:b.start, end:b.end, course:b.course, teacher:b.teacher || "" };
      }
    }

    // siguiente día con clases
    const order = ["LUNES","MARTES","MIÉRCOLES","JUEVES","VIERNES","SÁBADO","DOMINGO"];
    const idxToday = order.indexOf(today);
    for (let k=1;k<=7;k++){
      const dn = order[(idxToday + k) % 7];
      const blocks = sch.blocks
        .filter(b => norm(b.day)===norm(dn))
        .slice()
        .sort((a,b)=>timeToMin(a.start)-timeToMin(b.start));
      if (blocks.length){
        const b = blocks[0];
        return { day: dn, start:b.start, end:b.end, course:b.course, teacher:b.teacher || "" };
      }
    }
    return null;
  }

  function highlightScheduleToday(table){
    if (!table) return;
    const now = new Date();
    const today = dayNameFromDate(now);

    const ths = Array.from(table.querySelectorAll("thead th"));
    if (!ths.length) return;

    const th = ths.find(x => norm(x.textContent) === norm(today));
    if (!th) return;
    th.classList.add("isToday");
  }


function renderInicioAlumno(){
    ensureInicioAlumnoLayout();

    const prof = getAlumnoProfile();
    const heroName = document.getElementById("alHeroName");
    const nextBox = document.getElementById("alNextClass");
    const nextMeta = document.getElementById("alNextClassMeta");
    const estadoChip = document.getElementById("alEstadoChip");
    const localChip = document.getElementById("alLocalChip");

    // Personalizar bloque de marca (sidebar) para alumno
    const brandTitle = document.getElementById("brandTitle");
    const brandSub = document.getElementById("brandSub");

    if (prof){
      const first = (prof?.nombre ? String(prof.nombre).trim().split(" ")[0] : "Alumno");
      if (heroName) heroName.textContent = first;

      const uni = uniKey(prof.uni || prof.uni_sheet || prof.ciclo || "") || (prof.uni || "-");
      if (brandTitle) brandTitle.innerHTML = "LA META<br/>PORTAL DEL ALUMNO";
      if (brandSub) brandSub.textContent = `${first} • ${uni}`.trim();
    } else {
      if (heroName) heroName.textContent = "Alumno";
      if (brandTitle) brandTitle.innerHTML = "LA META<br/>PORTAL DEL ALUMNO";
      if (brandSub) brandSub.textContent = "Acceso para estudiantes";
    }

    if (!prof){
      if (estadoChip) estadoChip.innerHTML = `<span class="alChip warn">SIN PERFIL</span>`;
      if (localChip) localChip.innerHTML = `<span class="alChip soft">—</span>`;
      if (nextBox) nextBox.textContent = "—";
      if (nextMeta) nextMeta.textContent = "Cierre sesión y vuelva a ingresar.";
      return;
    }

    // Chips superiores
    if (estadoChip) estadoChip.innerHTML = `<span class="alChip ${low(prof.estado)==="activo" ? "ok":"warn"}">${escapeHtml(prof.estado || "-")}</span>`;
    if (localChip) localChip.innerHTML = `<span class="alChip soft">${escapeHtml(prof.local || "-")} • ${escapeHtml(prof.salon || "-")}</span>`;

    // Próxima clase
    const nxt = getAlumnoNextClass(prof);
    if (nextBox) nextBox.textContent = nxt ? `${nxt.day} ${nxt.start}–${nxt.end}` : "—";
    if (nextMeta) nextMeta.textContent = nxt ? `${nxt.course}${nxt.teacher ? " • " + nxt.teacher : ""}` : "Sin clases próximas (revise su horario)";
  }


function render(opts = {}){
    if (state.view==="inicio_alumno") renderInicioAlumno();
    if (state.view==="perfil_alumno") renderPerfilAlumno();
    if (state.view==="overview") renderOverview();
    if (state.view==="local") renderLocal();
    if (state.view==="table") renderTable();
    if (state.view==="horarios") renderHorarios();
        if (state.view==="programa") renderPrograma();
if (state.view==="impresiones") renderImpresiones();
    if (state.view==="silabos") renderSilabos();
    if (state.view==="evaluaciones"){
      const soft = (opts && opts.fromAutoRefresh === true && CURRENT_ROLE==="alumno" && state.evalInProgress === true);
      renderEvaluaciones(false, soft);
    }
    if (state.view==="materiales") renderMateriales();
    if (state.view==="listas") renderListas();
    if (state.view==="reportes") renderReportes();
      if (state.view==="notas") renderNotasGenerales();
}

  // ===================== LOAD DATA MATRÍCULA =====================
    async function loadOneSalon(salon){
    const url = csvUrl(salon.gid) + "&v=" + Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} (${salon.local} / ${salon.ciclo} / ${salon.salon})`);

    const raw = await res.text();
    const lines = raw.split(/\r?\n/).filter(l=>l.trim().length>0);

    // Normalización fuerte de encabezados (tildes/espacios/signos)
    const headKey = (s)=> String(s||"")
      .toUpperCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[¿?]/g,"")
      .replace(/[\._-]/g," ")
      .replace(/\s+/g," ")
      .trim();

    const hasAny = (keys, list)=> (list||[]).some(k => keys.includes(headKey(k)));

    // 1) Detectar la FILA real de encabezados (evitar falsos positivos)
    const NAME_KEYS = [HEAD.NOMBRES_A, HEAD.NOMBRES_B, HEAD.NOMBRES_C, "NOMBRES", "APELLIDOS"];
    let bestIdx = -1;
    let bestScore = -1;
    let bestHeader = null;

    const scanMax = Math.min(lines.length, 260);
    for (let i=0;i<scanMax;i++){
      const cells = parseCSVLine(lines[i]).map(norm);
      const keysAll = cells.map(headKey);
      const keys = keysAll.filter(Boolean);

      // Debe tener alguna columna de nombre + ESTADO
      if (!hasAny(keys, NAME_KEYS)) continue;
      if (!keys.includes("ESTADO")) continue;

      let score = 0;
      if (hasAny(keys, [HEAD.NOMBRES_A, HEAD.NOMBRES_B, HEAD.NOMBRES_C, "NOMBRES"])) score += 5;
      if (keys.includes("APELLIDOS")) score += 2;
      if (keys.includes("MODALIDAD")) score += 3;
      if (keys.includes("DNI")) score += 2;
      if (keys.includes("CORREO")) score += 2;
      if (keys.includes("USUARIO")) score += 2;
      if (keys.includes("CONTRASEÑA") || keys.includes("CONTRASENA")) score += 2;
      if (keys.includes("UNIVERSIDAD")) score += 1;
      if (keys.includes("CELULAR")) score += 1;
      if (keys.includes("PADRE O APODERADO")) score += 1;

      // Mantener el mejor candidato
      if (score > bestScore){
        bestScore = score;
        bestIdx = i;
        bestHeader = cells;
      }
    }

    if (bestIdx === -1 || bestScore < 6){
      return { salon, rows: [], error: "No se encontró un encabezado válido (NOMBRES/ESTADO/MODALIDAD/DNI/CORREO...)."};
    }

    const headerIdx = bestIdx;
    const header = bestHeader;

    // 2) Mapear encabezados -> índices (permite duplicados)
    const keyToIdxs = new Map();
    for (let i=0;i<header.length;i++){
      const k = headKey(header[i]);
      if (!k) continue;
      if (!keyToIdxs.has(k)) keyToIdxs.set(k, []);
      keyToIdxs.get(k).push(i);
    }

    const idxs = (k)=> keyToIdxs.get(headKey(k)) || [];
    const pickFirst = (ks)=> {
      for (const k of (ks||[])){
        const a = idxs(k);
        if (a.length) return a[0];
      }
      return -1;
    };
    const pickLast = (ks)=> {
      for (const k of (ks||[])){
        const a = idxs(k);
        if (a.length) return a[a.length-1];
      }
      return -1;
    };

    // Duplicados típicos (ALUMNO primero, APODERADO al final)
    const correoIdxs = idxs("CORREO");
    const dniIdxs    = idxs("DNI");
    const celIdxs    = idxs("CELULAR");

    const iCorreoAl = (correoIdxs.length ? correoIdxs[0] : -1);
    const iDniAl    = (dniIdxs.length ? dniIdxs[0] : -1);
    const iCelAl    = (celIdxs.length ? celIdxs[0] : -1);

    const iCorreoApo = (correoIdxs.length>1) ? correoIdxs[correoIdxs.length-1] : pickFirst(["CORREO APODERADO","CORREO DEL APODERADO"]);
    const iDniApo2   = (dniIdxs.length>1) ? dniIdxs[dniIdxs.length-1] : pickFirst(["DNI APODERADO","DNI DEL APODERADO"]);
    const iCelApoDup = (celIdxs.length>1) ? celIdxs[celIdxs.length-1] : -1;

    // Campos alumno (nuevo formato)
    const iNombres   = pickFirst(["NOMBRES"]);
    const iApellidos = pickFirst(["APELLIDOS"]);
    const iNomComp   = pickFirst(["NOMBRES COMPLETOS","NOMBRE COMPLETO"]);
    const iEdad      = pickFirst(["EDAD"]);
    const iProvincia = pickFirst(["PROVINCIA"]);
    const iDistrito  = pickFirst(["DISTRITO"]);
    const iColegio   = pickFirst(["COLEGIO"]);
    const iDistCol   = pickFirst(["DISTRITO DE COLEGIO","DISTRITO COLEGIO","DISTRITO DEL COLEGIO"]);
    const iAcademia  = pickFirst(["ACADEMIA"]);
    const iPrep      = pickFirst(["PREPARACION","PREPARACIÓN"]);
    const iComo      = pickFirst(["¿CÓMO SE ENTERÓ DE LA META?","COMO SE ENTERO DE LA META","CÓMO SE ENTERÓ DE LA META"]);
    const iCarrera   = pickFirst(["CARRERA"]);
    const iUniAl     = pickFirst(["UNIVERSIDAD"]);

    // Accesos
    const iUsuario   = pickFirst(["USUARIO"]);
    let iPass        = pickFirst(["CONTRASEÑA","CONTRASENA"]);

    // Fechas / obs
    const iFIns      = pickFirst(["FECHA DE INSCRIPCIÓN","FECHA DE INSCRIPCION","FECHA INSCRIPCIÓN","FECHA INSCRIPCION"]);
    const iFIni      = pickFirst(["FECHA DE INICIO","FECHA INICIO"]);
    const iFRet      = pickFirst(["FECHA DE RETIRO","FECHA RETIRO"]);
    const iObs       = pickFirst(["OBSERVACIONES","OBSERVACION"]);

    // Modalidad / Estado
    const iMod = pickFirst(["MODALIDAD"]);
    const iEst = pickFirst(["ESTADO"]);

    // Apoderado
    let iNombreApo = pickFirst(["PADRE O APODERADO","PADRE/APODERADO","APODERADO","NOMBRE DEL APODERADO"]);
    if (iNombreApo < 0){
      // fallback legacy: si hay varios "NOMBRE COMPLETO", el último suele ser apoderado
      const nc = idxs("NOMBRE COMPLETO");
      if (nc.length > 1) iNombreApo = nc[nc.length-1];
    }

    // Cel apoderado: preferir duplicado de CELULAR; si no, buscar CEL / CEL APODERADO
    let iCelApo = iCelApoDup;
    if (iCelApo < 0){
      const cels = idxs("CEL");
      if (cels.length) iCelApo = cels[cels.length-1];
      else iCelApo = pickFirst(["CEL APODERADO","CELULAR APODERADO"]);
    }

    const get = (cells, idx)=> (idx>=0 ? norm(cells[idx]||"") : "");

    const onlyDigits = (s)=> String(s||"").replace(/\D/g,"");
    const looksDni = (s)=> onlyDigits(s).length === 8;
    const looksEmail = (s)=> String(s||"").includes("@");

    const looksPhone = (s)=> onlyDigits(s).length >= 8;

    const looksPersonName = (s)=>{
      const t = norm(s);
      if (!t) return false;
      const cleaned = t
        .replace(/[^A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s'’\-]/g," ")
        .replace(/\s+/g," ")
        .trim();
      if (!cleaned) return false;
      const words = cleaned.split(" ").filter(Boolean);
      if (words.length < 1 || words.length > 8) return false;
      // Heurística: nombres suelen empezar con mayúscula o estar en MAYÚSCULAS
      const first = cleaned[0];
      const isUpperStart = /^[A-ZÁÉÍÓÚÜÑ]$/.test(first) || cleaned === cleaned.toUpperCase();
      if (!isUpperStart) return false;
      return true;
    };

    const out = [];
    for (let i=headerIdx+1; i<lines.length; i++){
      const cells = parseCSVLine(lines[i]);
      if (!cells.some(v=>norm(v).length>0)) continue;

      // Nombre (preferencia: nombres_completos -> nombres+apellidos -> legacy)
      const nombres = get(cells, iNombres);
      const apellidos = get(cells, iApellidos);
      const nombres_completos = get(cells, iNomComp);
      let nombre = nombres_completos || [nombres, apellidos].filter(Boolean).join(" ").trim();

      if (!nombre){
        const iNombreLegacy = pickFirst([HEAD.NOMBRES_A, HEAD.NOMBRES_B, HEAD.NOMBRES_C, "NOMBRE"]);
        nombre = get(cells, iNombreLegacy);
      }
      if (!nombre) continue;

      const modalidad = normalizeModalidad(get(cells, iMod), salon.local);
      const estado = normalizeEstado(get(cells, iEst));

      // Filtro anti-basura: solo filas con estado reconocido o con identidad (DNI/correo/usuario)
      const correo_al  = get(cells, iCorreoAl);
      const dni_al     = get(cells, iDniAl);
      const usuario    = get(cells, iUsuario);

            const celular_al = get(cells, iCelAl);

      const okEstado = (estado === "ACTIVO" || estado === "RETIRO" || estado === "CAMBIO");

      // Identidad mínima para considerar "fila de alumno" (evita textos sueltos del Sheet)
      const hasStrongId = looksDni(dni_al) || looksEmail(correo_al) || looksEmail(usuario);
      const hasIdentity = hasStrongId || looksPhone(celular_al);

      // ✅ Regla dura: si no hay identidad, NO es alumno
      if (!hasIdentity) continue;

      // ✅ Regla adicional: si el "nombre" parece texto (frases largas) y no hay DNI/correo, descartarlo
      if (!looksPersonName(nombre) && !hasStrongId) continue;
const edad = get(cells, iEdad);
      const provincia = get(cells, iProvincia);
      const distrito = get(cells, iDistrito);
      const colegio = get(cells, iColegio);
      const distrito_colegio = get(cells, iDistCol);

      const academia = get(cells, iAcademia);
      const preparacion = get(cells, iPrep);
      const como_entero = get(cells, iComo);
      const carrera = get(cells, iCarrera);

      const uni_sheet = get(cells, iUniAl);

      const contrasena = get(cells, iPass);

      const fecha_inscripcion = get(cells, iFIns);
      const fecha_inicio = get(cells, iFIni);
      const fecha_retiro = get(cells, iFRet);
      const observaciones = get(cells, iObs);

      const nombre_apo = get(cells, iNombreApo);
      const cel_apo    = get(cells, iCelApo);
      const dni_apo    = get(cells, iDniApo2);
      const correo_apo = get(cells, iCorreoApo);

      out.push({
        // claves generales
        nombre,
        nombres,
        apellidos,
        nombres_completos: nombres_completos || nombre,

        modalidad,
        estado,

        local: salon.local,
        ciclo: salon.ciclo,
        salon: salon.salon,
        gid: salon.gid,

        // alumno
        correo_al,
        dni_al,
        celular_al,
        edad,
        provincia,
        distrito,
        colegio,
        distrito_colegio,
        academia,
        preparacion,
        como_entero,
        carrera,
        uni_sheet,

        // apoderado
        nombre_apo,
        cel_apo,
        dni_apo,
        correo_apo,

        // accesos
        usuario,
        contrasena,

        // fechas / obs
        fecha_inscripcion,
        fecha_inicio,
        fecha_retiro,
        observaciones
      });
    }

    return { salon, rows: out, error: null };
  }

// ===================== LOAD ALL (SIN DELAY / SIN FLASH) =====================
let LOADING = false;
let PENDING = false;

function ensureBoot(){
  if (state.booted) return;

  // eventos NAV (una sola vez)
  const bind = (id, fn)=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("click", fn);
  };

  bind("nav_inicio_alumno", ()=>setView("inicio_alumno"));
  bind("nav_perfil_alumno", ()=>setView("perfil_alumno"));
  bind("nav_overview", ()=>setView("overview"));
  bind("nav_local", ()=>setView("local"));
  bind("nav_table", ()=>setView("table"));
  bind("nav_horarios", ()=>setView("horarios"));
    bind("nav_programa", ()=>setView("programa"));
bind("nav_impresiones", ()=>setView("impresiones"));
  bind("nav_silabos", ()=>setView("silabos"));
  bind("nav_evaluaciones", ()=>setView("evaluaciones"));
  bind("nav_materiales", ()=>setView("materiales"));
  bind("nav_listas", ()=>setView("listas"));
  bind("nav_reportes", ()=>setView("reportes"));

    bind("nav_notas", ()=>setView("notas"));
// logout
  const outBtn = document.getElementById("btnLogout");
  if (outBtn) outBtn.addEventListener("click", ()=>{
    clearRole();
    location.reload();
  });

  // eventos filtros matrícula
  ["fLocal","fUni","fSalon","fModalidad","fEstado"].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", ()=>{
      rebuildSalonOptions();
      render({ fromAutoRefresh:true });
    });
  });

  const q = document.getElementById("q");
  if (q) q.addEventListener("input", render);

  const btn = document.getElementById("btnNowTop");
  if (btn) btn.addEventListener("click", loadAll);

  state.booted = true;
}

async function loadAll(){
  // candado anti-overlap
  if (LOADING){
    PENDING = true;
    return;
  }
  LOADING = true;

  try{
    // ✅ 1) Restaurar vista INMEDIATO (antes de descargar)
    const sv = loadSavedView();
    if (sv && ALLOWED_VIEWS.includes(sv) && state.view !== sv){
      setView(sv);
    }

    // ✅ 2) Descargar matrícula
    const results = await Promise.allSettled(SALONES.map(loadOneSalon));
    let rows = [];
    for (const r of results){
      if (r.status === "fulfilled") rows = rows.concat(r.value.rows);
    }

    state.rawRows = rows;

    // Actualizar perfil del alumno (si corresponde)
    updateAlumnoProfileFromRawRows();

    const matriculaRows = state.rawRows.filter(r => r.estado==="ACTIVO" || r.estado==="RETIRO");
    state.canonical = dedupeMatriculaByName(matriculaRows);
    state.cambiosRows = state.rawRows.filter(r => r.estado==="CAMBIO");

    // ✅ 3) Descargar impresiones
    await loadImpresiones();

    // ✅ 4) Boot una sola vez + filtros + render
    ensureBoot();

    // Importante: initFilters puede rearmar selects; se ejecuta aquí para mantener data al día
    initFilters();
    render({ fromAutoRefresh:true });

  } catch(e){
    console.error("loadAll:", e);
  } finally {
    LOADING = false;

    // si hubo refresh pendiente, ejecuta 1 más (sin overlap)
    if (PENDING){
      PENDING = false;
      loadAll();
    }
  }
}



function startApp(){
  try{
    document.documentElement.setAttribute("data-build", APP_BUILD);
    console.info("APP_BUILD", APP_BUILD);
  }catch(e){}
  ensureBoot();
  applyRoleUI();

  // si había una vista guardada, aplícala
  const sv = loadSavedView();
  if (sv && ALLOWED_VIEWS.includes(sv) && state.view !== sv){
    setView(sv);
  }

  loadAll();
  setInterval(loadAll, AUTO_REFRESH_MS);
}

// ✅ Arranque: lo antes posible (para reducir flash)
window.addEventListener("DOMContentLoaded", () => {
  // 1) Auth primero
  const hasSession = initAuth();

  // 2) Si no hay sesión, esperar a que el usuario inicie (overlay)
  //    (La app se inicia cuando el overlay se oculta tras login)
  if (!hasSession){
    // Al primer login exitoso se ejecutará esto automáticamente:
    const observer = new MutationObserver(() => {
      const o = document.getElementById("authOverlay");
      if (o && o.style.display === "none"){
        observer.disconnect();
        startApp();
      }
    });
    observer.observe(document.body, { attributes:true, childList:false, subtree:true });
    return;
  }

  // 3) Sesión existente: iniciar app
  startApp();
});</script>
</body>
</html>
