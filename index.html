<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LA META | PANEL DE CONTROL</title>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- PNG export (captura COMPLETA del elemento, no solo lo visible) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* ======================================================================
      ✅ EDITA COLORES AQUÍ (HORARIOS)
      - AGRARIA: NO TOCAR (me dijiste que está perfecto)
      - PUCP: azul
      - U.LIMA: naranja
    ====================================================================== */
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(15,23,42,0.10);
      --accent:#d10b0b;
      --accent2:#a40000;
      --soft:#fff5f5;
      --shadow: 0 14px 34px rgba(15,23,42,0.10);
      --radius:18px;

      /* Universidades (marcadores) */
      --pucp:#6ea8da;     /* Azul */
      --ulima:#ff9900;    /* Naranja */
      --agraria:#4caf50;  /* Verde */

      /* Modalidad */
      --pres:#2bb673;
      --virt:#f2c94c;

      /* Estados */
      --ok:#16a34a;
      --bad:#dc2626;
      --warn:#f59e0b;

      /* ===== AGRARIA (NO TOCAR) ===== */
      --schHead_AGR:#1f5a1a;
      --schCell_AGR:#cfe8c8;

      /* ===== PUCP (AZUL) ===== */
      --schHead_PUCP:#1f4e79;
      --schCell_PUCP:#d6e9f7;

      /* ===== U.LIMA (NARANJA) ===== */
      --schHead_UL:#b85f00;
      --schCell_UL:#ffe6c7;

      /* Líneas de tabla / col horas */
      --schGrid:rgba(15,23,42,0.28);
      --schTimeBg:#ffffff;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }
    .topbar{ height:10px; background:linear-gradient(90deg,var(--accent2),var(--accent)); }

    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height: calc(100vh - 10px);
    }

    .sidebar{
      border-right:1px solid var(--border);
      padding:18px 14px;
      position: sticky;
      top: 0;
      align-self: start;
      height: calc(100vh - 10px);
      overflow:auto;
      background:#fff;
    }

    .brand{
      display:flex; gap:12px; align-items:center;
      padding:12px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      background: #fff;
    }
    .brand img{
      width:64px; height:64px; object-fit:contain;
      border-radius:14px; border:1px solid var(--border);
      padding:8px; background:#fff;
    }
    .brand h1{
      margin:0;
      font-size:15px;
      font-weight:950;
      letter-spacing:.2px;
      line-height:1.15;
      text-transform: uppercase;
    }
    .brand .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    .nav{ margin-top:16px; display:flex; flex-direction:column; gap:10px; }
    .nav button{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:950;
      color: var(--text);
    }
    .nav button.active{
      border-color: rgba(209,11,11,0.40);
      box-shadow: 0 0 0 3px rgba(209,11,11,0.10);
      background: var(--soft);
      color: var(--accent2);
    }

    .main{ padding:22px 22px 32px; }

    .headerline{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
    }

    .title{ display:flex; flex-direction:column; gap:8px; }
    .title h2{
      margin:0;
      font-size:20px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    .title p{
      margin:0;
      color: var(--muted);
      font-size:13px;
      font-weight:750;
      line-height:1.4;
      max-width: 980px;
    }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }

    select, input, button{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 14px;
      padding:11px 12px;
      font-size:12px;
      outline:none;
      color: var(--text);
    }
    input{ min-width:320px; }
    input::placeholder{ color:#94a3b8; }
    select:focus, input:focus{
      border-color: rgba(209,11,11,0.40);
      box-shadow: 0 0 0 3px rgba(209,11,11,0.10);
    }
    button{
      cursor:pointer;
      font-weight:950;
      border-color: rgba(209,11,11,0.25);
      background: var(--soft);
      color: var(--accent2);
    }
    button:hover{
      border-color: rgba(209,11,11,0.45);
      background: rgba(209,11,11,0.10);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      min-width: 0;
    }

    .kpi{ grid-column: span 3; min-height: 118px; }
    .kpi .label{ color: var(--muted); font-size:12px; font-weight:950; text-transform: uppercase; }
    .kpi .value{ margin-top:8px; font-size:36px; font-weight:950; color: var(--accent2); }
    .kpi .hint{ margin-top:8px; color: var(--muted); font-size:12px; font-weight:900; text-transform: uppercase; }

    .panel12{ grid-column: span 12; }
    .panel8{ grid-column: span 8; }
    .panel4{ grid-column: span 4; }
    .panel6{ grid-column: span 6; }

    .cardtitle{
      color: var(--muted);
      font-size:12px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform: uppercase;
      margin-bottom:10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }

    .panelHint{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      color: var(--muted); font-weight:900; font-size:12px; text-transform: uppercase;
    }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot.pucp{ background: var(--pucp); }
    .dot.ulima{ background: var(--ulima); }
    .dot.agraria{ background: var(--agraria); }
    .dot.pres{ background: var(--pres); }
    .dot.virt{ background: var(--virt); }

    .chartBox{ height: 420px; }
    .chartBoxTall{ height: 520px; }
    canvas{ width:100% !important; height:100% !important; }

    .uniCards{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    .uniCard{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      display:flex; gap:10px; align-items:center;
      background:#fff;
    }
    .uniCard img{
      width:44px; height:44px; object-fit:contain;
      border-radius:12px; border:1px solid var(--border);
      padding:6px; background:#fff;
    }
    .uniCard .t{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .uniCard .name{
      font-weight:950; font-size:12px; text-transform:uppercase;
      color: var(--text);
    }
    .uniCard .nums{
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fafafa;
      font-weight:950;
      font-size:12px;
    }

    table{ width:100%; border-collapse: collapse; font-size:12px; }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:nowrap;
    }
    th{
      position:sticky;
      top:0;
      background:#fff;
      z-index:1;
      color: var(--muted);
      font-weight:950;
      text-transform: uppercase;
    }

    /* ===================== HORARIOS ===================== */
    .schGridWrap{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .schCard{
      border:1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      background:#fff;
      box-shadow: var(--shadow);
    }
    .schHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .schHead .hLeft{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .schHead .loc{
      font-size:18px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform:uppercase;
      margin:0;
      line-height:1.1;
    }
    .schHead .sal{
      font-size:13px;
      font-weight:900;
      color: var(--muted);
      text-transform:uppercase;
      margin:0;
      line-height:1.1;
    }
    .schUniPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:10px 14px;
      font-weight:950;
      text-transform:uppercase;
      border:1px solid rgba(15,23,42,0.12);
      background:#f8fafc;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .schUniPill .b{
      width:10px;height:10px;border-radius:999px;display:inline-block;
    }

    /* Botón descargar PNG */
    .schDl{
      border: 1px solid rgba(15,23,42,0.12);
      background: #fff;
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 950;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }
    .schDl:hover{
      border-color: rgba(15,23,42,0.28);
      background:#fafafa;
    }

    /* Contenedor tabla */
    .schTableWrap{
      padding:0 10px 12px;
      overflow-x: hidden; /* desktop */
    }

    /* Tabla */
    .schTable{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      border:2px solid rgba(15,23,42,0.18);
      border-radius: 14px;
      overflow:hidden;
      min-width: 0;
    }

    .schTable th, .schTable td{
      border:1px solid var(--schGrid);
      padding: 6px 6px;
      text-align:center;
      vertical-align:middle;
      white-space:normal;
      word-break: normal;
      overflow-wrap: normal;
    }

    /* Encabezado días (usa variables por UNI) */
    .schTable thead th{
      background: var(--schHead);
      color:#fff;
      font-weight:950;
      text-transform:uppercase;
      font-size:11px;
      position:static;
    }
    .schTable .timeHead{
      background: var(--schHead);
      color:#fff;
      font-weight:950;
      font-size:12px;
    }

    .schTable .timeCell{
      background: var(--schTimeBg);
      font-weight:950;
      font-size:12px;
      text-align:left;
      padding-left:10px;
      white-space:nowrap;
    }

    .schCell{
      background: var(--schCell);
      font-weight:950;
      padding: 6px 6px;
    }
    .schEmpty{ background:#fff; }

    .schTable col.timeCol{ width: 92px; }

    /* ============================================================
      ✅ (CORRECCIÓN IMPORTANTE) “4 líneas imaginarias” BIEN CENTRADAS
      - Antes estabas usando 4 filas 1fr y eso metía mucho aire.
      - Ahora se centra el BLOQUE de texto con separación corta (row-gap).
      - Resultado: “HIS” y “RIOJA” quedan uno debajo del otro, CERCA y bonito.
    ============================================================ */
    .cell4{
      width:100%;
      height:100%;
      display:grid;
      grid-template-rows: repeat(4, auto);
      place-content:center;   /* centra TODO el conjunto verticalmente */
      row-gap: 2px;           /* separación pequeña y uniforme */
      align-items:center;
      justify-items:center;
    }
    .cell4 .slot{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:0 2px;
      line-height:1.05;
    }
    .cell4 .cLine{
      font-size:18px;
      font-weight:950;
      letter-spacing:.2px;
      text-transform:uppercase;
      white-space:nowrap; /* evita que “ÁLG 1” se parta */
      line-height:1.05;
    }
    .cell4 .tLine{
      font-size:12px;
      font-weight:900;
      text-transform:uppercase;
      color:#111827;
      white-space:nowrap;
      line-height:1.05;
    }

    /* ===================== COLORES POR UNIVERSIDAD (HORARIOS) ===================== */
    .schCard[data-uni="AGRARIA"]{
      --schHead: var(--schHead_AGR);
      --schCell: var(--schCell_AGR);
    }
    .schCard[data-uni="PUCP"]{
      --schHead: var(--schHead_PUCP);
      --schCell: var(--schCell_PUCP);
    }
    .schCard[data-uni="U.LIMA"]{
      --schHead: var(--schHead_UL);
      --schCell: var(--schCell_UL);
    }

    /* ===================== MODO EXPORT PNG (SIEMPRE “HORIZONTAL BONITO”) ===================== */
    body.exportMode .schCard{
      width: 1120px !important;        /* fuerza aspecto tipo laptop aunque estés en móvil */
      max-width: none !important;
    }
    body.exportMode .schTableWrap{
      overflow: visible !important;
      padding: 0 12px 12px !important;
    }
    body.exportMode .schTable{
      width: 100% !important;
      min-width: 0 !important;
    }
    body.exportMode .cell4 .cLine{ font-size:18px !important; }
    body.exportMode .cell4 .tLine{ font-size:12px !important; }
    body.exportMode .schTable thead th{ font-size:11px !important; }
    body.exportMode .schTable .timeCell{ font-size:12px !important; }

    /* ===================== RESPONSIVE ===================== */
    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .kpi{ grid-column: span 6; }
      .panel8, .panel6, .panel4{ grid-column: span 12; }
      .chartBox{ height: 360px; }
      .chartBoxTall{ height: 440px; }
      input{ min-width: 220px; }
      .controls{ justify-content:flex-start; }
      .uniCards{ grid-template-columns: 1fr; }
      .schGridWrap{ grid-template-columns: 1fr; }

      /* MÓVIL: más compacto + scroll horizontal */
      .schTableWrap{
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 0 8px 10px;
      }
      .schHead{ padding: 10px 10px 8px; }
      .schHead .loc{ font-size:16px; }
      .schHead .sal{ font-size:12px; }
      .schUniPill{ padding:8px 10px; font-size:12px; }
      .schDl{ padding:7px 9px; font-size:11px; }

      /* tamaño cómodo: NO enorme */
      .schTable{ min-width: 820px; }
      .schTable th, .schTable td{ padding: 4px 4px; }
      .schTable thead th{ font-size:10px; }
      .schTable .timeCell{ font-size:11px; padding-left:8px; }
      .schTable col.timeCol{ width: 84px; }

      .cell4{ row-gap: 2px; }
      .cell4 .cLine{ font-size:16px; }
      .cell4 .tLine{ font-size:11px; }
    }
  </style>
</head>

<body>
  <div class="topbar"></div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <img src="logo.png" alt="LA META" onerror="this.style.display='none'"/>
        <div>
          <h1>LA META<br/>PANEL DE CONTROL</h1>
          <div class="sub">Monitoreo de alumnos por local y salón</div>
        </div>
      </div>

      <div class="nav">
        <button id="nav_overview" class="active">RESUMEN GENERAL</button>
        <button id="nav_local">POR LOCAL</button>
        <button id="nav_table">TABLA</button>
        <button id="nav_horarios">HORARIOS</button>
      </div>
    </aside>

    <main class="main">
      <div class="headerline">
        <div class="title">
          <h2 id="viewTitle">RESUMEN GENERAL</h2>
          <p id="viewDesc">Panel estructurado para control de matrícula, modalidad y distribución por universidad.</p>
        </div>

        <div class="controls" id="controlsMatricula">
          <select id="fLocal"></select>
          <select id="fUni"></select>
          <select id="fSalon"></select>
          <select id="fModalidad"></select>
          <input id="q" type="text" placeholder="Buscar por nombre"/>
          <button id="btnNowTop">ACTUALIZAR</button>
        </div>
      </div>

      <div id="view_overview" class="grid"></div>
      <div id="view_local" class="grid" style="display:none;"></div>
      <div id="view_table" class="grid" style="display:none;"></div>
      <div id="view_horarios" class="grid" style="display:none;"></div>
    </main>
  </div>

<script>
  // ===================== MATRÍCULA (TU CÓDIGO) =====================
  const SPREADSHEET_ID = "1nHCBQLuJ8RZNtLisvAqD916pcxbUmtqPrMnO4V0ewvs";

  const SALONES = [
    { local:"LA MOLINA", ciclo:"AGRARIA",  salon:"AGRARIA LM 1", gid:115906280 },
    { local:"LA MOLINA", ciclo:"AGRARIA",  salon:"AGRARIA LM 2", gid:1576159193 },
    { local:"LA MOLINA", ciclo:"PUCP",     salon:"PUCP LM",     gid:1037962332 },
    { local:"LA MOLINA", ciclo:"U.LIMA",   salon:"U.LIMA LM",   gid:877886853 },
    { local:"LA MOLINA", ciclo:"ADELANTO", salon:"ADELANTO LM", gid:1271606284 },
    { local:"LA MOLINA", ciclo:"PARALELO", salon:"PARALELO LM", gid:1863430245 },

    { local:"SAN BORJA", ciclo:"AGRARIA", salon:"AGRARIA SB",  gid:538377241 },
    { local:"SAN BORJA", ciclo:"PUCP",    salon:"PUCP SB",     gid:998068235 },
    { local:"SAN BORJA", ciclo:"U.LIMA",  salon:"U.LIMA SB 1", gid:670800187 },
    { local:"SAN BORJA", ciclo:"U.LIMA",  salon:"U.LIMA SB 2", gid:1856014712 },

    { local:"SAN MIGUEL", ciclo:"AGRARIA",  salon:"AGRARIA SM",  gid:513074883 },
    { local:"SAN MIGUEL", ciclo:"PUCP",     salon:"PUCP SM",     gid:1531300183 },
    { local:"SAN MIGUEL", ciclo:"U.LIMA",   salon:"U.LIMA SM 1", gid:1080962628 },
    { local:"SAN MIGUEL", ciclo:"U.LIMA",   salon:"U.LIMA SM 2", gid:679583464 },
    { local:"SAN MIGUEL", ciclo:"ADELANTO", salon:"ADELANTO SM", gid:2120250792 },
    { local:"SAN MIGUEL", ciclo:"PARALELO", salon:"PARALELO SM", gid:721468852 },

    { local:"VIRTUAL", ciclo:"AGRARIA",     salon:"AGRARIA VIRTUAL", gid:709062846 },
    { local:"VIRTUAL", ciclo:"ESC. U.LIMA", salon:"U.LIMA ESCOLAR",  gid:315999969 },
    { local:"VIRTUAL", ciclo:"U.LIMA",      salon:"U.LIMA VIRTUAL",  gid:1667430860 },
  ];

  const AUTO_REFRESH_MS = 30000;

  const UNI_COLORS = {
    "PUCP": getCss("--pucp"),
    "U.LIMA": getCss("--ulima"),
    "AGRARIA": getCss("--agraria"),
  };

  function getCss(varName){
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }

  const MOD_COLORS = {
    "PRESENCIAL": getCss("--pres"),
    "VIRTUAL": getCss("--virt"),
  };

  const EST_COLORS = {
    "ACTIVO": getCss("--ok"),
    "RETIRO": getCss("--bad"),
    "CAMBIO": getCss("--warn"),
  };

  function uniGroupFromCiclo(ciclo){
    const c = String(ciclo||"").trim().toUpperCase();
    if (c === "AGRARIA") return "AGRARIA";
    if (c === "PUCP") return "PUCP";
    return "U.LIMA";
  }

  const HEAD = {
    NOMBRES_A: "NOMBRES COMPLETOS",
    NOMBRES_B: "NOMBRE COMPLETO",
    NOMBRES_C: "NOMBRES",
    MODALIDAD: "MODALIDAD",
    ESTADO: "ESTADO",
  };

  function csvUrl(gid){
    return `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${gid}`;
  }

  function parseCSVLine(line){
    const out = [];
    let cur = "", inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"'){
        if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === "," && !inQ){
        out.push(cur); cur = "";
      } else cur += ch;
    }
    out.push(cur);
    return out.map(x => String(x ?? "").trim());
  }

  function norm(s){ return String(s ?? "").replace(/\s+/g," ").trim(); }
  function low(s){ return norm(s).toLowerCase(); }
  function uniq(arr){ return [...new Set(arr)]; }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fillSelectKeep(selId, values, labelAll){
    const sel = document.getElementById(selId);
    const prev = sel.value || "__ALL__";
    sel.innerHTML = "";

    const all = document.createElement("option");
    all.value = "__ALL__";
    all.textContent = labelAll;
    sel.appendChild(all);

    for (const v of values){
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    }

    const exists = Array.from(sel.options).some(o => o.value === prev);
    sel.value = exists ? prev : "__ALL__";
  }

  function normalizeEstado(x){
    const s = low(x);
    if (s.includes("reti") || s.includes("retir")) return "RETIRO";
    if (s.includes("cambi")) return "CAMBIO";
    if (s.includes("activ")) return "ACTIVO";
    return "CAMBIO";
  }

  function normalizeModalidad(x, localFallback){
    const s = low(x);
    if (s.includes("virtual") || s.includes("online") || s.includes("remot")) return "VIRTUAL";
    if (s.includes("pres") || s.includes("aula")) return "PRESENCIAL";
    return (localFallback === "VIRTUAL") ? "VIRTUAL" : "PRESENCIAL";
  }

  function dedupeMatriculaByName(rows){
    const best = new Map();
    const score = (estado) => estado==="ACTIVO" ? 2 : 1;
    for (const r of rows){
      const key = low(r.nombre);
      if (!key) continue;
      const cur = best.get(key);
      if (!cur || score(r.estado) > score(cur.estado)) best.set(key, r);
    }
    return [...best.values()];
  }

  // ============================ PLUGIN DONUT OUTSIDE ============================
  const donutOutsideLabels = {
    id: "donutOutsideLabels",
    afterDatasetsDraw(chart, args, pluginOptions){
      const opt = pluginOptions || {};
      if (chart.config.type !== "doughnut") return;

      const ctx = chart.ctx;
      const dsIndex = opt.datasetIndex ?? 0;
      const dataset = chart.data.datasets[dsIndex];
      if (!dataset) return;

      const meta = chart.getDatasetMeta(dsIndex);
      if (!meta || !meta.data || !meta.data.length) return;

      const values = dataset.data.map(v => +v || 0);
      const total = values.reduce((a,b)=>a+b,0) || 1;

      const minPct = opt.minPercent ?? 6;
      const lineColor = opt.lineColor ?? "rgba(15,23,42,0.55)";
      const fontSize = opt.fontSize ?? 14;
      const fontWeight = opt.fontWeight ?? 950;
      const textColor = opt.textColor ?? "#111827";
      const strokeColor = opt.textStrokeColor ?? "#ffffff";
      const strokeW = opt.textStrokeWidth ?? 4;
      const extra = opt.outsideOffset ?? 30;
      const horiz = opt.horizOffset ?? 22;

      const area = chart.chartArea;
      const minX = area.left + 6;
      const maxX = area.right - 6;
      const minY = area.top + 6;
      const maxY = area.bottom - 6;

      const left = [];
      const right = [];

      meta.data.forEach((arc, i) => {
        const v = values[i];
        if (!v) return;

        const pct = (v/total)*100;
        if (pct >= minPct) return;

        const {x, y, startAngle, endAngle, outerRadius} = arc.getProps(
          ["x","y","startAngle","endAngle","outerRadius"], true
        );

        const angle = (startAngle + endAngle) / 2;
        const cos = Math.cos(angle);
        const sin = Math.sin(angle);

        const x1 = x + cos * (outerRadius + 2);
        const y1 = y + sin * (outerRadius + 2);

        let x2 = x + cos * (outerRadius + extra);
        let y2 = y + sin * (outerRadius + extra);

        x2 = Math.max(minX, Math.min(maxX, x2));
        y2 = Math.max(minY, Math.min(maxY, y2));

        const side = (cos >= 0) ? "right" : "left";
        const label = `${v} (${Math.round(pct)}%)`;

        (side==="right" ? right : left).push({
          x1, y1, x2, y2, side, label,
          targetY: y2
        });
      });

      function spread(items){
        items.sort((a,b)=>a.targetY - b.targetY);
        const gap = opt.minGap ?? 18;
        for (let k=1;k<items.length;k++){
          if (items[k].targetY - items[k-1].targetY < gap){
            items[k].targetY = items[k-1].targetY + gap;
          }
        }
        for (const it of items){
          it.targetY = Math.max(minY, Math.min(maxY, it.targetY));
        }
      }
      spread(left); spread(right);

      ctx.save();
      ctx.font = `${fontWeight} ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,Arial`;
      ctx.fillStyle = textColor;
      ctx.strokeStyle = lineColor;
      ctx.lineWidth = 1.2;

      function drawItem(it){
        const align = (it.side==="right") ? "left" : "right";
        let x3 = it.x2 + (it.side==="right" ? horiz : -horiz);
        let y3 = it.targetY;

        x3 = Math.max(minX, Math.min(maxX, x3));
        y3 = Math.max(minY, Math.min(maxY, y3));

        ctx.beginPath();
        ctx.moveTo(it.x1, it.y1);
        ctx.lineTo(it.x2, y3);
        ctx.lineTo(x3, y3);
        ctx.stroke();

        ctx.textAlign = align;
        ctx.textBaseline = "middle";

        ctx.save();
        ctx.lineWidth = strokeW;
        ctx.strokeStyle = strokeColor;
        ctx.strokeText(it.label, x3, y3);
        ctx.restore();

        ctx.fillStyle = textColor;
        ctx.fillText(it.label, x3, y3);
      }

      left.forEach(drawItem);
      right.forEach(drawItem);
      ctx.restore();
    }
  };

  const state = {
    view: "overview",
    rawRows: [],
    canonical: [],
    cambiosRows: [],
    filtered: [],

    ch_over_estado: null,
    ch_over_modalidad: null,
    ch_over_uni_stack: null,

    ch_loc_activos_salon: null,
    ch_loc_retiros_salon: null,
  };

  Chart.register(ChartDataLabels, donutOutsideLabels);

  const GRID = "rgba(15,23,42,0.10)";
  const TICK = "#64748b";

  function mkDoughnutWithLabels(canvasId, labels, values, colors, outsideOpts){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;

    return new Chart(canvas, {
      type: "doughnut",
      data: {
        labels,
        datasets:[{
          data: values,
          backgroundColor: colors,
          borderColor:"rgba(15,23,42,0.06)",
          borderWidth:1,
          hoverOffset: 6
        }]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        cutout: "62%",
        layout:{ padding:{ top: 20, right: 56, bottom: 20, left: 56 } },
        plugins:{
          legend:{ position:"bottom", labels:{ color:TICK, font:{ weight:"900" } } },
          tooltip:{ enabled:true },
          datalabels:{
            color:"#111827",
            textStrokeColor:"#ffffff",
            textStrokeWidth:4,
            font:{ weight:"950", size: 14 },
            formatter:(v, ctx)=>{
              const data = ctx.chart.data.datasets[0].data || [];
              const total = data.reduce((a,b)=>a+(+b||0),0) || 1;
              const p = (v/total)*100;
              if (!v) return "";
              if (p < ((outsideOpts?.minPercent) ?? 6)) return "";
              return `${v} (${Math.round(p)}%)`;
            }
          },
          donutOutsideLabels: outsideOpts || { minPercent: 6 }
        }
      }
    });
  }

  function mkBarReadable(canvasId, titleLabel){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;

    return new Chart(canvas, {
      type:"bar",
      data:{
        labels: [],
        datasets:[{
          label: titleLabel,
          data: [],
          backgroundColor: [],
          borderColor: [],
          borderWidth: 1.5,
          borderRadius: 12,
          maxBarThickness: 70
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        layout:{ padding:{ top: 26, right: 10, left: 10, bottom: 10 } },
        plugins:{
          legend:{ display:false },
          tooltip:{ enabled:true },
          datalabels:{
            color:"#111827",
            textStrokeColor:"#ffffff",
            textStrokeWidth:4,
            font:{ weight:"950", size: 15 },
            anchor:"end",
            align:(ctx)=>{
              const v = ctx.dataset.data[ctx.dataIndex] || 0;
              return v <= 2 ? "end" : "center";
            },
            offset:(ctx)=>{
              const v = ctx.dataset.data[ctx.dataIndex] || 0;
              return v <= 2 ? 2 : 0;
            },
            clamp:true,
            clip:false,
            formatter:(v)=> (v>0) ? v : ""
          }
        },
        scales:{
          x:{
            ticks:{
              color:TICK,
              font:{ weight:"900" },
              autoSkip: false,
              maxRotation: 30,
              minRotation: 0,
              callback: function(val){
                const s = String(this.getLabelForValue(val) || "");
                return s.length > 18 ? (s.slice(0,18) + "…") : s;
              }
            },
            grid:{ color:GRID }
          },
          y:{
            beginAtZero:true,
            ticks:{ color:TICK, font:{ weight:"900" } },
            grid:{ color:GRID }
          }
        }
      }
    });
  }

  function mkStackedUni(canvasId){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;

    return new Chart(canvas, {
      type:"bar",
      data:{
        labels: ["AGRARIA","PUCP","U.LIMA"],
        datasets:[
          {
            label:"ACTIVOS",
            data:[0,0,0],
            backgroundColor:"rgba(76,175,80,0.18)",
            borderColor:"rgba(76,175,80,0.25)",
            borderWidth:1.2,
            borderRadius:10,
            stack:"s1"
          },
          {
            label:"RETIROS",
            data:[0,0,0],
            backgroundColor:"rgba(220,38,38,0.25)",
            borderColor:"rgba(220,38,38,0.35)",
            borderWidth:1.2,
            borderRadius:10,
            stack:"s1"
          },
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        layout:{ padding:{ top: 30, right: 10, left: 10, bottom: 10 } },
        plugins:{
          legend:{ position:"bottom", labels:{ color:TICK, font:{ weight:"900" } } },
          tooltip:{ enabled:true },
          datalabels:{
            color:"#111827",
            textStrokeColor:"#ffffff",
            textStrokeWidth:4,
            font:{ weight:"950", size: 13 },
            anchor:(ctx)=> ctx.datasetIndex === 0 ? "center" : "end",
            align:(ctx)=>  ctx.datasetIndex === 0 ? "center" : "end",
            offset:(ctx)=> ctx.datasetIndex === 0 ? 0 : 4,
            clamp:true,
            clip:false,
            formatter:(v)=> (!v || v<=0) ? "" : v
          }
        },
        scales:{
          x:{ stacked:true, ticks:{ color:TICK, font:{ weight:"900" } }, grid:{ color:GRID } },
          y:{ stacked:true, beginAtZero:true, ticks:{ color:TICK, font:{ weight:"900" } }, grid:{ color:GRID } }
        }
      }
    });
  }

  function setChartData(chart, labels, values, colors){
    if (!chart) return;
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    if (colors){
      chart.data.datasets[0].backgroundColor = colors;
      chart.data.datasets[0].borderColor = colors;
    }
    chart.update("none");
  }

  // ============================ NAV ============================
  function setView(v){
    state.view = v;
    document.getElementById("nav_overview").classList.toggle("active", v==="overview");
    document.getElementById("nav_local").classList.toggle("active", v==="local");
    document.getElementById("nav_table").classList.toggle("active", v==="table");
    document.getElementById("nav_horarios").classList.toggle("active", v==="horarios");

    document.getElementById("view_overview").style.display = (v==="overview") ? "" : "none";
    document.getElementById("view_local").style.display = (v==="local") ? "" : "none";
    document.getElementById("view_table").style.display = (v==="table") ? "" : "none";
    document.getElementById("view_horarios").style.display = (v==="horarios") ? "" : "none";

    document.getElementById("controlsMatricula").style.display = (v==="horarios") ? "none" : "";

    const titles = {
      overview: ["RESUMEN GENERAL", "Panel estructurado para control de matrícula, modalidad y distribución por universidad."],
      local: ["POR LOCAL", "Monitoreo por salón (tutor) del local seleccionado."],
      table: ["TABLA", "Búsqueda y filtros para consulta interna."],
      horarios: ["HORARIOS", "Plantillas de horarios por local y universidad (descarga PNG completa)."]
    };
    document.getElementById("viewTitle").textContent = titles[v][0];
    document.getElementById("viewDesc").textContent = titles[v][1];

    const uniSel = document.getElementById("fUni");
    const salSel = document.getElementById("fSalon");
    if (v === "local"){
      uniSel.value = "__ALL__";
      salSel.value = "__ALL__";
      uniSel.disabled = true;
      salSel.disabled = true;
    } else if (v !== "horarios") {
      uniSel.disabled = false;
      salSel.disabled = false;
    }

    if (v !== "horarios"){
      rebuildSalonOptions();
    }
    render();
  }

  // ============================ FILTERS (MATRÍCULA) ============================
  function initFilters(){
    const locals = uniq(SALONES.map(s=>s.local)).sort();
    fillSelectKeep("fLocal", locals, "LOCAL: TODOS");
    fillSelectKeep("fUni", ["AGRARIA","PUCP","U.LIMA"], "UNIVERSIDAD: TODAS");
    rebuildSalonOptions();
    fillSelectKeep("fModalidad", ["PRESENCIAL","VIRTUAL"], "MODALIDAD: TODAS");
  }

  function rebuildSalonOptions(){
    const fLocal = document.getElementById("fLocal").value;
    const fUni = document.getElementById("fUni").value;

    let base = state.canonical;
    if (fLocal !== "__ALL__") base = base.filter(r=>r.local===fLocal);
    if (fUni !== "__ALL__") base = base.filter(r=>uniGroupFromCiclo(r.ciclo)===fUni);

    const salones = uniq(base.map(r=>r.salon)).sort();
    fillSelectKeep("fSalon", salones, "SALÓN: TODOS");
  }

  function applyFilters(){
    const fLocal = document.getElementById("fLocal").value;
    const fUni   = document.getElementById("fUni").value;
    const fSalon = document.getElementById("fSalon").value;
    const fMod   = document.getElementById("fModalidad").value;
    const q      = low(document.getElementById("q").value);

    let base = state.canonical;

    base = base.filter(r=>{
      if (fLocal!=="__ALL__" && r.local!==fLocal) return false;
      if (fUni!=="__ALL__" && uniGroupFromCiclo(r.ciclo)!==fUni) return false;
      if (fSalon!=="__ALL__" && r.salon!==fSalon) return false;
      if (fMod!=="__ALL__" && r.modalidad!==fMod) return false;

      if (q){
        const blob = low([r.nombre, r.local, r.ciclo, r.salon, r.modalidad, r.estado].join(" | "));
        if (!blob.includes(q)) return false;
      }
      return true;
    });

    state.filtered = base;
  }

  // ============================ LAYOUTS (MATRÍCULA) ============================
  function ensureOverviewLayout(){
    const el = document.getElementById("view_overview");
    if (el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card kpi">
        <div class="label">TOTAL DE ALUMNOS</div>
        <div class="value" id="k_total">0</div>
        <div class="hint">ACTIVOS + RETIROS</div>
      </div>

      <div class="card kpi">
        <div class="label">ACTIVOS</div>
        <div class="value" id="k_act">0</div>
      </div>

      <div class="card kpi">
        <div class="label">RETIROS</div>
        <div class="value" id="k_ret">0</div>
      </div>

      <div class="card kpi">
        <div class="label">CAMBIOS (TRASLADOS)</div>
        <div class="value" id="k_cam">0</div>
        <div class="hint">NO SUMA AL TOTAL</div>
      </div>

      <div class="card panel8">
        <div class="cardtitle">
          ESTADO Y MODALIDAD
          <div class="panelHint">
            <span class="pill"><span class="dot agraria"></span>AGRARIA</span>
            <span class="pill"><span class="dot pucp"></span>PUCP</span>
            <span class="pill"><span class="dot ulima"></span>U.LIMA</span>
          </div>
        </div>
        <div class="grid" style="margin-top:0;">
          <div class="card panel6" style="box-shadow:none; border:1px solid var(--border);">
            <div class="cardtitle">ESTADO</div>
            <div class="chartBox"><canvas id="over_estado"></canvas></div>
          </div>
          <div class="card panel6" style="box-shadow:none; border:1px solid var(--border);">
            <div class="cardtitle">MODALIDAD</div>
            <div class="chartBox"><canvas id="over_modalidad"></canvas></div>
          </div>
        </div>
      </div>

      <div class="card panel4">
        <div class="cardtitle">RESUMEN POR UNIVERSIDAD</div>
        <div class="chartBoxTall"><canvas id="over_uni_stack"></canvas></div>

        <div class="uniCards">
          <div class="uniCard">
            <img src="logo_agraria.png" alt="AGRARIA" onerror="this.style.display='none'">
            <div class="t">
              <div class="name">AGRARIA</div>
              <div class="nums">
                <span class="pill" style="border-color:rgba(76,175,80,0.35); background:rgba(76,175,80,0.10);">Activos: <b id="uA_act">0</b></span>
                <span class="pill">Retiros: <b id="uA_ret">0</b></span>
              </div>
            </div>
          </div>

          <div class="uniCard">
            <img src="logo_pucp.png" alt="PUCP" onerror="this.style.display='none'">
            <div class="t">
              <div class="name">PUCP</div>
              <div class="nums">
                <span class="pill" style="border-color:rgba(110,168,218,0.50); background:rgba(110,168,218,0.12);">Activos: <b id="uP_act">0</b></span>
                <span class="pill">Retiros: <b id="uP_ret">0</b></span>
              </div>
            </div>
          </div>

          <div class="uniCard">
            <img src="logo_ulima.png" alt="U.LIMA" onerror="this.style.display='none'">
            <div class="t">
              <div class="name">U.LIMA</div>
              <div class="nums">
                <span class="pill" style="border-color:rgba(255,153,0,0.55); background:rgba(255,153,0,0.12);">Activos: <b id="uL_act">0</b></span>
                <span class="pill">Retiros: <b id="uL_ret">0</b></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    state.ch_over_estado = mkDoughnutWithLabels(
      "over_estado",
      ["ACTIVO","RETIRO","CAMBIO"],
      [0,0,0],
      [EST_COLORS.ACTIVO, EST_COLORS.RETIRO, EST_COLORS.CAMBIO],
      { minPercent: 6, outsideOffset: 34, horizOffset: 26, minGap: 20, fontSize: 14 }
    );

    state.ch_over_modalidad = mkDoughnutWithLabels(
      "over_modalidad",
      ["PRESENCIAL","VIRTUAL"],
      [0,0],
      [MOD_COLORS.PRESENCIAL, MOD_COLORS.VIRTUAL],
      { minPercent: 10, outsideOffset: 28, horizOffset: 22, minGap: 18, fontSize: 14 }
    );

    state.ch_over_uni_stack = mkStackedUni("over_uni_stack");
    el.dataset.ready = "1";
  }

  function ensureLocalLayout(){
    const el = document.getElementById("view_local");
    if (el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card kpi">
        <div class="label">TOTAL (LOCAL)</div>
        <div class="value" id="lk_total">0</div>
        <div class="hint">ACTIVOS + RETIROS</div>
      </div>

      <div class="card kpi">
        <div class="label">ACTIVOS (LOCAL)</div>
        <div class="value" id="lk_act">0</div>
      </div>

      <div class="card kpi">
        <div class="label">RETIROS (LOCAL)</div>
        <div class="value" id="lk_ret">0</div>
      </div>

      <div class="card kpi">
        <div class="label">CAMBIOS (LOCAL)</div>
        <div class="value" id="lk_cam">0</div>
        <div class="hint">NO SUMA AL TOTAL</div>
      </div>

      <div class="card panel12">
        <div class="cardtitle">
          ACTIVOS POR SALÓN (LOCAL)
          <div class="panelHint">
            <span class="dot agraria"></span>AGRARIA
            <span class="dot pucp"></span>PUCP
            <span class="dot ulima"></span>U.LIMA
          </div>
        </div>
        <div class="chartBoxTall"><canvas id="loc_activos_salon"></canvas></div>
      </div>

      <div class="card panel12">
        <div class="cardtitle">RETIROS POR SALÓN (LOCAL)</div>
        <div class="chartBoxTall"><canvas id="loc_retiros_salon"></canvas></div>
      </div>

      <div class="card panel12">
        <div class="cardtitle">DETALLE (SALONES)</div>
        <div style="overflow:auto; max-height: 55vh;">
          <table>
            <thead>
              <tr>
                <th>LOCAL</th>
                <th>UNIVERSIDAD</th>
                <th>SALÓN</th>
                <th>ACTIVOS</th>
                <th>RETIROS</th>
                <th>TOTAL</th>
                <th>CAMBIOS</th>
              </tr>
            </thead>
            <tbody id="loc_table_salon"></tbody>
          </table>
        </div>
      </div>
    `;

    state.ch_loc_activos_salon = mkBarReadable("loc_activos_salon", "ACTIVOS");
    state.ch_loc_retiros_salon = mkBarReadable("loc_retiros_salon", "RETIROS");

    el.dataset.ready = "1";
  }

  function ensureTableLayout(){
    const el = document.getElementById("view_table");
    if (el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card panel12">
        <div class="cardtitle">TABLA</div>
        <div style="overflow:auto; max-height: 75vh;">
          <table>
            <thead>
              <tr>
                <th>NOMBRE</th>
                <th>LOCAL</th>
                <th>UNIVERSIDAD</th>
                <th>SALÓN</th>
                <th>MODALIDAD</th>
                <th>ESTADO</th>
              </tr>
            </thead>
            <tbody id="tb_body"></tbody>
          </table>
        </div>
      </div>
    `;
    el.dataset.ready = "1";
  }

  function renderOverview(){
    ensureOverviewLayout();
    applyFilters();

    const rows = state.filtered;

    const act = rows.filter(r=>r.estado==="ACTIVO").length;
    const ret = rows.filter(r=>r.estado==="RETIRO").length;
    const total = act + ret;

    const fLocal = document.getElementById("fLocal").value;
    const fUni   = document.getElementById("fUni").value;
    const fSalon = document.getElementById("fSalon").value;
    const fMod   = document.getElementById("fModalidad").value;
    const q      = low(document.getElementById("q").value);

    let cambiosBase = state.cambiosRows;
    if (fLocal!=="__ALL__") cambiosBase = cambiosBase.filter(r=>r.local===fLocal);
    if (fUni!=="__ALL__") cambiosBase = cambiosBase.filter(r=>uniGroupFromCiclo(r.ciclo)===fUni);
    if (fSalon!=="__ALL__") cambiosBase = cambiosBase.filter(r=>r.salon===fSalon);
    if (fMod!=="__ALL__") cambiosBase = cambiosBase.filter(r=>r.modalidad===fMod);
    if (q){
      cambiosBase = cambiosBase.filter(r=>{
        const blob = low([r.nombre, r.local, r.ciclo, r.salon, r.modalidad, r.estado].join(" | "));
        return blob.includes(q);
      });
    }
    const cambiosUnique = uniq(cambiosBase.map(r=>low(r.nombre))).filter(Boolean).length;

    const pres = rows.filter(r=>r.modalidad==="PRESENCIAL").length;
    const virt = rows.filter(r=>r.modalidad==="VIRTUAL").length;

    document.getElementById("k_total").textContent = total.toLocaleString("es-PE");
    document.getElementById("k_act").textContent = act.toLocaleString("es-PE");
    document.getElementById("k_ret").textContent = ret.toLocaleString("es-PE");
    document.getElementById("k_cam").textContent = cambiosUnique.toLocaleString("es-PE");

    state.ch_over_estado.data.datasets[0].data = [act, ret, cambiosUnique];
    state.ch_over_estado.update("none");

    state.ch_over_modalidad.data.datasets[0].data = [pres, virt];
    state.ch_over_modalidad.update("none");

    const aAct = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="AGRARIA" && r.estado==="ACTIVO").length;
    const aRet = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="AGRARIA" && r.estado==="RETIRO").length;

    const pAct = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="PUCP" && r.estado==="ACTIVO").length;
    const pRet = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="PUCP" && r.estado==="RETIRO").length;

    const lAct = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="U.LIMA" && r.estado==="ACTIVO").length;
    const lRet = rows.filter(r=>uniGroupFromCiclo(r.ciclo)==="U.LIMA" && r.estado==="RETIRO").length;

    document.getElementById("uA_act").textContent = aAct;
    document.getElementById("uA_ret").textContent = aRet;
    document.getElementById("uP_act").textContent = pAct;
    document.getElementById("uP_ret").textContent = pRet;
    document.getElementById("uL_act").textContent = lAct;
    document.getElementById("uL_ret").textContent = lRet;

    state.ch_over_uni_stack.data.datasets[0].data = [aAct, pAct, lAct];
    state.ch_over_uni_stack.data.datasets[1].data = [aRet, pRet, lRet];
    state.ch_over_uni_stack.update("none");
  }

  function renderLocal(){
    ensureLocalLayout();

    const fLocal = document.getElementById("fLocal").value;
    const fMod   = document.getElementById("fModalidad").value;
    const q      = low(document.getElementById("q").value);

    let salonesLocal = SALONES
      .filter(s => (fLocal==="__ALL__" ? true : s.local === fLocal))
      .map(s => s.salon);
    salonesLocal = uniq(salonesLocal);

    let baseMat = state.canonical;
    if (fLocal!=="__ALL__") baseMat = baseMat.filter(r=>r.local===fLocal);
    if (fMod!=="__ALL__") baseMat = baseMat.filter(r=>r.modalidad===fMod);
    if (q){
      baseMat = baseMat.filter(r=>{
        const blob = low([r.nombre, r.local, r.ciclo, r.salon, r.modalidad, r.estado].join(" | "));
        return blob.includes(q);
      });
    }

    const act = baseMat.filter(r=>r.estado==="ACTIVO").length;
    const ret = baseMat.filter(r=>r.estado==="RETIRO").length;
    const total = act + ret;

    let baseCam = state.cambiosRows;
    if (fLocal!=="__ALL__") baseCam = baseCam.filter(r=>r.local===fLocal);
    if (fMod!=="__ALL__") baseCam = baseCam.filter(r=>r.modalidad===fMod);
    if (q){
      baseCam = baseCam.filter(r=>{
        const blob = low([r.nombre, r.local, r.ciclo, r.salon, r.modalidad, r.estado].join(" | "));
        return blob.includes(q);
      });
    }
    const cambiosUnique = uniq(baseCam.map(r=>low(r.nombre))).filter(Boolean).length;

    document.getElementById("lk_total").textContent = total.toLocaleString("es-PE");
    document.getElementById("lk_act").textContent = act.toLocaleString("es-PE");
    document.getElementById("lk_ret").textContent = ret.toLocaleString("es-PE");
    document.getElementById("lk_cam").textContent = cambiosUnique.toLocaleString("es-PE");

    const activosPorSalon = salonesLocal.map(s => baseMat.filter(r=>r.salon===s && r.estado==="ACTIVO").length);
    const activosColors = salonesLocal.map(s=>{
      const conf = SALONES.find(x => x.salon===s && (fLocal==="__ALL__" ? true : x.local===fLocal));
      const uni = conf ? uniGroupFromCiclo(conf.ciclo) : "U.LIMA";
      return UNI_COLORS[uni] || UNI_COLORS["AGRARIA"];
    });

    const retirosPorSalon = salonesLocal.map(s => baseMat.filter(r=>r.salon===s && r.estado==="RETIRO").length);
    const retirosColors = salonesLocal.map(_ => "#dc2626");

    setChartData(state.ch_loc_activos_salon, salonesLocal, activosPorSalon, activosColors);
    setChartData(state.ch_loc_retiros_salon, salonesLocal, retirosPorSalon, retirosColors);

    const tbody = document.getElementById("loc_table_salon");
    tbody.innerHTML = salonesLocal.map(s=>{
      const rs = baseMat.filter(r=>r.salon===s);
      const a = rs.filter(r=>r.estado==="ACTIVO").length;
      const r = rs.filter(r=>r.estado==="RETIRO").length;
      const t = a + r;

      const conf = SALONES.find(x => x.salon === s && (fLocal==="__ALL__" ? true : x.local===fLocal));
      const uni = conf ? uniGroupFromCiclo(conf.ciclo) : (rs[0] ? uniGroupFromCiclo(rs[0].ciclo) : "");

      const c = uniq(baseCam.filter(x=>x.salon===s).map(x=>low(x.nombre))).filter(Boolean).length;
      const loc = (fLocal==="__ALL__" ? (conf?.local || rs[0]?.local || "") : fLocal);

      return `
        <tr>
          <td>${escapeHtml(loc)}</td>
          <td>${escapeHtml(uni)}</td>
          <td>${escapeHtml(s)}</td>
          <td>${a}</td>
          <td>${r}</td>
          <td>${t}</td>
          <td>${c}</td>
        </tr>
      `;
    }).join("");
  }

  function renderTable(){
    ensureTableLayout();
    applyFilters();

    const rows = state.filtered;
    const tbody = document.getElementById("tb_body");
    tbody.innerHTML = rows.slice(0,800).map(r=>`
      <tr>
        <td>${escapeHtml(r.nombre)}</td>
        <td>${escapeHtml(r.local)}</td>
        <td>${escapeHtml(uniGroupFromCiclo(r.ciclo))}</td>
        <td>${escapeHtml(r.salon)}</td>
        <td>${escapeHtml(r.modalidad)}</td>
        <td>${escapeHtml(r.estado)}</td>
      </tr>
    `).join("");
  }

  // ===================== HORARIOS =====================
  /*
    ✅ CÓMO EDITAR CURSOS / PROFES / HORAS (PARA TODOS LOS HORARIOS)
    Cada bloque:
      { day:"LUNES", start:"08:00", end:"09:50", course:"ÁLG 1", teacher:"PEREZ" }

    ✅ SI CAMBIA LA HORA DE UN CURSO:
      - Cambia start y end.
      - Deben ser horas existentes en TIME_MARKS (lista de marcas abajo).

    ✅ 4 LÍNEAS IMAGINARIAS
      - Slot 4 SIEMPRE es profesor.
      - Para el curso:
          * 1 línea  -> slot 2
          * 2 líneas -> slot 2 y 3
          * 3 líneas -> slot 1,2,3
      - Si quieres FORZAR líneas manualmente:
          course: "REF. / MATES"   -> 2 líneas exactas
          course: "PAL1 / PAL2 / PAL3" -> 3 líneas exactas

    ✅ NO SEPARAR "ÁLG 1", "RV 2", "FÍS 1", etc.
      - Se mantienen juntos en UNA línea.
  */

  const DAYS = ["LUNES","MARTES","MIÉRCOLES","JUEVES","VIERNES","SÁBADO"];

  // ✅ MISMAS HORAS PARA TODOS (NO CAMBIAR AQUÍ, SOLO USARLAS)
  const TIME_ROWS = [
    { start:"08:00", end:"08:30", label:"8:00 - 8:30" },
    { start:"08:30", end:"09:00", label:"8:30 - 9:00" },
    { start:"09:00", end:"09:30", label:"9:00 - 9:30" },

    { start:"09:30", end:"09:50", label:"9:30 - 9:50" },
    { start:"09:50", end:"10:00", label:"" },

    { start:"10:00", end:"10:30", label:"10:00 - 10:30" },
    { start:"10:30", end:"11:00", label:"10:30 - 11:00" },
    { start:"11:00", end:"11:30", label:"11:00 - 11:30" },

    { start:"11:30", end:"11:50", label:"11:30 - 11:50" },
    { start:"11:50", end:"12:00", label:"" },

    { start:"12:00", end:"12:30", label:"12:00 - 12:30" },
    { start:"12:30", end:"13:00", label:"12:30 - 13:00" },
    { start:"13:00", end:"13:30", label:"13:00 - 13:30" },

    { start:"13:30", end:"13:50", label:"13:30 - 13:50" },
    { start:"13:50", end:"15:00", label:"13:50 - 15:00" },

    { start:"15:00", end:"15:30", label:"15:00 - 15:30" },
    { start:"15:30", end:"16:00", label:"15:30 - 16:00" },
    { start:"16:00", end:"16:30", label:"16:00 - 16:30" },
    { start:"16:30", end:"17:00", label:"16:30 - 17:00" },

    { start:"17:00", end:"17:30", label:"17:00 - 17:30" },
    { start:"17:30", end:"18:00", label:"17:30 - 18:00" },
  ];

  const TIME_MARKS = (()=>{
    const marks = TIME_ROWS.map(r=>r.start);
    marks.push(TIME_ROWS[TIME_ROWS.length-1].end);
    return marks;
  })();
  function idxMark(t){ return TIME_MARKS.indexOf(t); }

  function normalizeDayKey(d){
    const x = String(d||"").trim().toUpperCase();
    if (x==="MIERCOLES") return "MIÉRCOLES";
    if (x==="SABADO") return "SÁBADO";
    return x;
  }

  // “ÁLG 1” / “RV 2” / “FÍS 1” => 1 sola línea
  function isCodePlusNumber(tokens){
    if (tokens.length !== 2) return false;
    const left = tokens[0];
    const right = tokens[1];
    const num = /^[0-9]+$/.test(right);
    if (!num) return false;
    const okLeft = /^[A-ZÁÉÍÓÚÑ\.]{2,}$/.test(left);
    return okLeft;
  }

  // Convierte course en 1–3 líneas (slots 1–3). Docente siempre slot 4.
  function courseToLines(courseRaw){
    let s = norm(courseRaw || "");
    if (!s) return [];

    // Forzado manual por el usuario
    if (s.includes("\n")){
      return s.split("\n").map(norm).filter(Boolean).slice(0,3);
    }
    if (s.includes(" / ")){
      return s.split(" / ").map(norm).filter(Boolean).slice(0,3);
    }

    const tokens = s.split(" ").map(norm).filter(Boolean);

    // “ÁLG 1” => una línea
    if (isCodePlusNumber(tokens)) return [`${tokens[0]} ${tokens[1]}`];

    // 1 token => una línea
    if (tokens.length === 1) return [tokens[0]];

    // 2 tokens (no num) => dos líneas (REF. / MATES)
    if (tokens.length === 2) return [tokens[0], tokens[1]];

    // 3 o más => tres líneas (máximo)
    return [tokens[0], tokens[1], tokens.slice(2).join(" ")].slice(0,3);
  }

  function renderCell4(courseRaw, teacherRaw){
    const lines = courseToLines(courseRaw);
    const teacher = norm(teacherRaw || "");

    let slot1 = "", slot2 = "", slot3 = "";
    if (lines.length === 3){
      slot1 = lines[0]; slot2 = lines[1]; slot3 = lines[2];
    } else if (lines.length === 2){
      slot2 = lines[0]; slot3 = lines[1];
    } else if (lines.length === 1){
      slot2 = lines[0];
    }

    return `
      <div class="cell4">
        <div class="slot"><div class="cLine">${escapeHtml(slot1)}</div></div>
        <div class="slot"><div class="cLine">${escapeHtml(slot2)}</div></div>
        <div class="slot"><div class="cLine">${escapeHtml(slot3)}</div></div>
        <div class="slot"><div class="tLine">${teacher ? escapeHtml(teacher) : "&nbsp;"}</div></div>
      </div>
    `;
  }

  function buildScheduleMatrix(schedule){
    const rows = TIME_ROWS.map(()=> {
      const o = {};
      DAYS.forEach(d=>o[d] = { kind:"empty" });
      return o;
    });

    for (const b of (schedule.blocks||[])){
      const day = normalizeDayKey(b.day);
      if (!DAYS.includes(day)) continue;

      const s = idxMark(b.start);
      const e = idxMark(b.end);
      if (s < 0 || e < 0 || e <= s) continue;

      const rowStart = TIME_ROWS.findIndex(r=>r.start === b.start);
      if (rowStart < 0) continue;

      let span = 0;
      for (let i=rowStart; i<TIME_ROWS.length; i++){
        const row = TIME_ROWS[i];
        span++;
        if (row.end === b.end) break;
        const nextMark = idxMark(row.end);
        if (nextMark >= e) break;
      }

      rows[rowStart][day] = {
        kind:"start",
        rowspan: span,
        block: {
          course: b.course || "",
          teacher: b.teacher || ""
        }
      };

      for (let k=1; k<span; k++){
        const rr = rowStart + k;
        if (rr >= TIME_ROWS.length) break;
        rows[rr][day] = { kind:"skip" };
      }
    }

    return rows;
  }

  function uniDotColor(uni){
    if (uni==="AGRARIA") return getCss("--agraria");
    if (uni==="PUCP") return getCss("--pucp");
    return getCss("--ulima");
  }

  function scheduleToHtmlCard(s){
    const dot = uniDotColor(s.uni);
    const matrix = buildScheduleMatrix(s);

    const colgroup = `
      <colgroup>
        <col class="timeCol">
        ${DAYS.map(()=>`<col>`).join("")}
      </colgroup>
    `;

    const thead = `
      <thead>
        <tr>
          <th class="timeHead">AG</th>
          ${DAYS.map(d=>`<th>${escapeHtml(d)}</th>`).join("")}
        </tr>
      </thead>
    `;

    const tbody = matrix.map((rowObj, i)=>{
      const timeLabel = TIME_ROWS[i].label;
      const timeCell = `<td class="timeCell">${escapeHtml(timeLabel)}</td>`;

      const tds = DAYS.map(d=>{
        const cell = rowObj[d];
        if (cell.kind === "skip") return "";
        if (cell.kind === "start"){
          return `
            <td class="schCell" rowspan="${cell.rowspan}">
              ${renderCell4(cell.block.course, cell.block.teacher)}
            </td>
          `;
        }
        return `<td class="schEmpty"></td>`;
      }).join("");

      return `<tr>${timeCell}${tds}</tr>`;
    }).join("");

    return `
      <div class="schCard" data-id="${escapeHtml(s.id)}" data-local="${escapeHtml(s.local)}" data-uni="${escapeHtml(s.uni)}" data-salon="${escapeHtml(s.salon)}">
        <div class="schHead">
          <div class="hLeft">
            <p class="loc">${escapeHtml(s.local)}</p>
            <p class="sal">${escapeHtml(s.salon)}</p>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <div class="schUniPill">
              <span class="b" style="background:${dot};"></span>
              ${escapeHtml(s.uni)}
            </div>
            <button class="schDl" data-sid="${escapeHtml(s.id)}">DESCARGAR PNG</button>
          </div>
        </div>

        <div class="schTableWrap">
          <table class="schTable">
            ${colgroup}
            ${thead}
            <tbody>${tbody}</tbody>
          </table>
        </div>
      </div>
    `;
  }

  // ===================== ORDEN DE HORARIOS (LO QUE PEDISTE) =====================
  const LOCAL_ORDER = ["LA MOLINA","SAN MIGUEL","SAN BORJA","VIRTUAL"];
  const UNI_ORDER = ["AGRARIA","PUCP","U.LIMA"];

  function sortSchedules(list){
    const idxLoc = (x)=> {
      const i = LOCAL_ORDER.indexOf(x.local);
      return i<0 ? 999 : i;
    };
    const idxUni = (x)=> {
      const i = UNI_ORDER.indexOf(x.uni);
      return i<0 ? 999 : i;
    };
    return list.slice().sort((a,b)=>{
      const dl = idxLoc(a) - idxLoc(b);
      if (dl !== 0) return dl;
      const du = idxUni(a) - idxUni(b);
      if (du !== 0) return du;
      return String(a.salon||"").localeCompare(String(b.salon||""), "es");
    });
  }

  /* ======================================================================
    ✅ AQUÍ COMPLETAS LOS HORARIOS (SCHEDULES)
    - Ya están TODOS llenos con ejemplos.
    - Tú solo reemplazas course y teacher, y si cambian horas, cambia start/end.
    - Usa SOLO las horas de TIME_MARKS.
  ====================================================================== */
  const SCHEDULES = sortSchedules([
    // ========================= AGRARIA (VERDE - NO TOCAR COLORES) =========================
    {
      id:"AGR_LM_1",
      local:"LA MOLINA",
      uni:"AGRARIA",
      salon:"AGRARIA LM 1",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"HIS", teacher:"RIOJA" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"ECO", teacher:"SOTO" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"RV 1", teacher:"TABER" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"GEO", teacher:"TORRES" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"FÍS 1", teacher:"RUBEN" },
        { day:"SÁBADO", start:"08:00", end:"11:00", course:"SIM", teacher:"" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"QUÍ 1", teacher:"COSTA" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"ARI", teacher:"DIAZ" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"REF. MATES", teacher:"ANGEL" }, /* auto: REF. / MATES */
        { day:"JUEVES", start:"10:00", end:"11:50", course:"TRI", teacher:"TORRES" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"RM 1", teacher:"OBANDO" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"GGF", teacher:"RIOJA" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"ÁLG 1", teacher:"UCANCIAL" }, /* 1 sola línea */
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"TXT", teacher:"ZAVALA" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"BIO 1", teacher:"LUYO" },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"FÍS 2", teacher:"RUBEN" },

        { day:"LUNES", start:"15:00", end:"17:00", course:"QUÍ 2", teacher:"COSTA" },
        { day:"MARTES", start:"15:00", end:"17:00", course:"ÁLG 2", teacher:"UCANCIAL" },
        { day:"MIÉRCOLES", start:"15:00", end:"17:00", course:"RV 2", teacher:"TABER" },
        { day:"JUEVES", start:"15:00", end:"17:00", course:"BIO 2", teacher:"LUYO" },
        { day:"VIERNES", start:"15:00", end:"17:00", course:"RM 2", teacher:"OBANDO" },
      ]
    },

    {
      id:"AGR_LM_2",
      local:"LA MOLINA",
      uni:"AGRARIA",
      salon:"AGRARIA LM 2",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"CURSO 1", teacher:"PROF A" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"CURSO 2", teacher:"PROF B" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"CURSO 3", teacher:"PROF C" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"CURSO 4", teacher:"PROF D" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"CURSO 5", teacher:"PROF E" },

        { day:"LUNES", start:"10:00", end:"11:50", course:"MAT 1", teacher:"PROF F" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"REF. / MATES", teacher:"PROF G" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"FÍS 1", teacher:"PROF H" },

        { day:"MARTES", start:"12:00", end:"13:50", course:"BIO 1", teacher:"PROF I" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"QUI 1", teacher:"PROF J" },

        { day:"LUNES", start:"15:00", end:"17:00", course:"RV 2", teacher:"PROF K" },
        { day:"MIÉRCOLES", start:"15:00", end:"17:00", course:"RM 2", teacher:"PROF L" },
      ]
    },

    {
      id:"AGR_SM",
      local:"SAN MIGUEL",
      uni:"AGRARIA",
      salon:"AGRARIA SM",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"HIS", teacher:"PROF 1" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"ECO", teacher:"PROF 2" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"GEO", teacher:"PROF 3" },

        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"ÁLG 1", teacher:"PROF 4" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"FÍS 1", teacher:"PROF 5" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"BIO 1", teacher:"PROF 6" },
        { day:"MARTES", start:"12:00", end:"13:50", course:"TXT", teacher:"PROF 7" },

        { day:"JUEVES", start:"15:00", end:"17:00", course:"RV 2", teacher:"PROF 8" },
        { day:"VIERNES", start:"15:00", end:"17:00", course:"RM 2", teacher:"PROF 9" },
      ]
    },

    {
      id:"AGR_SB",
      local:"SAN BORJA",
      uni:"AGRARIA",
      salon:"AGRARIA SB",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"CURSO A", teacher:"PROF A" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"CURSO B", teacher:"PROF B" },
        { day:"VIERNES", start:"08:00", end:"09:50", course:"CURSO C", teacher:"PROF C" },

        { day:"MARTES", start:"10:00", end:"11:50", course:"ÁLG 1", teacher:"PROF D" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"REF. MATES", teacher:"PROF E" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"BIO 1", teacher:"PROF F" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"FÍS 2", teacher:"PROF G" },

        { day:"MARTES", start:"15:00", end:"17:00", course:"RV 2", teacher:"PROF H" },
      ]
    },

    {
      id:"AGR_VIRT",
      local:"VIRTUAL",
      uni:"AGRARIA",
      salon:"AGRARIA VIRTUAL",
      blocks:[
        { day:"LUNES", start:"10:00", end:"11:50", course:"VIRT 1", teacher:"PROF V1" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"VIRT 2", teacher:"PROF V2" },
        { day:"VIERNES", start:"15:00", end:"17:00", course:"VIRT 3", teacher:"PROF V3" },
      ]
    },

    // ========================= PUCP (AZUL) =========================
    {
      id:"PUCP_LM",
      local:"LA MOLINA",
      uni:"PUCP",
      salon:"PUCP LM",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"MAT 1", teacher:"PROF P1" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"LENG", teacher:"PROF P2" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"HIS", teacher:"PROF P3" },

        { day:"JUEVES", start:"10:00", end:"11:50", course:"REF. / MATES", teacher:"PROF P4" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"FÍS 1", teacher:"PROF P5" },

        { day:"LUNES", start:"12:00", end:"13:50", course:"BIO 1", teacher:"PROF P6" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"QUI 1", teacher:"PROF P7" },

        { day:"MARTES", start:"15:00", end:"17:00", course:"MAT 2", teacher:"PROF P8" },
        { day:"JUEVES", start:"15:00", end:"17:00", course:"FÍS 2", teacher:"PROF P9" },
      ]
    },

    {
      id:"PUCP_SM",
      local:"SAN MIGUEL",
      uni:"PUCP",
      salon:"PUCP SM",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"MAT 1", teacher:"PROF A" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"HIS", teacher:"PROF B" },

        { day:"MARTES", start:"10:00", end:"11:50", course:"REF. MATES", teacher:"PROF C" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"FÍS 1", teacher:"PROF D" },

        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"BIO 1", teacher:"PROF E" },
        { day:"JUEVES", start:"15:00", end:"17:00", course:"MAT 2", teacher:"PROF F" },
      ]
    },

    {
      id:"PUCP_SB",
      local:"SAN BORJA",
      uni:"PUCP",
      salon:"PUCP SB",
      blocks:[
        { day:"MARTES", start:"08:00", end:"09:50", course:"MAT 1", teacher:"PROF 1" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"REF. / MATES", teacher:"PROF 2" },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"FÍS 2", teacher:"PROF 3" },
        { day:"SÁBADO", start:"08:00", end:"11:00", course:"TALLER", teacher:"PROF 4" },
      ]
    },

    // ========================= U.LIMA (NARANJA) =========================
    {
      id:"UL_LM",
      local:"LA MOLINA",
      uni:"U.LIMA",
      salon:"U.LIMA LM",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"MAT 1", teacher:"PROF U1" },
        { day:"MARTES", start:"08:00", end:"09:50", course:"COMU", teacher:"PROF U2" },
        { day:"MIÉRCOLES", start:"08:00", end:"09:50", course:"HIS", teacher:"PROF U3" },
        { day:"JUEVES", start:"10:00", end:"11:50", course:"REF. MATES", teacher:"PROF U4" },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"FÍS 1", teacher:"PROF U5" },
      ]
    },

    {
      id:"UL_SM_1",
      local:"SAN MIGUEL",
      uni:"U.LIMA",
      salon:"U.LIMA SM 1",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"MAT 1", teacher:"PROF 1" },
        { day:"MARTES", start:"10:00", end:"11:50", course:"REF. / MATES", teacher:"PROF 2" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"BIO 1", teacher:"PROF 3" },
        { day:"JUEVES", start:"15:00", end:"17:00", course:"FÍS 2", teacher:"PROF 4" },
      ]
    },

    {
      id:"UL_SM_2",
      local:"SAN MIGUEL",
      uni:"U.LIMA",
      salon:"U.LIMA SM 2",
      blocks:[
        { day:"LUNES", start:"10:00", end:"11:50", course:"MAT 1", teacher:"PROF A" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"FÍS 1", teacher:"PROF B" },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"QUI 1", teacher:"PROF C" },
        { day:"SÁBADO", start:"08:00", end:"11:00", course:"SIM", teacher:"PROF D" },
      ]
    },

    {
      id:"UL_SB_1",
      local:"SAN BORJA",
      uni:"U.LIMA",
      salon:"U.LIMA SB 1",
      blocks:[
        { day:"MARTES", start:"08:00", end:"09:50", course:"MAT 1", teacher:"PROF 1" },
        { day:"JUEVES", start:"08:00", end:"09:50", course:"HIS", teacher:"PROF 2" },
        { day:"VIERNES", start:"10:00", end:"11:50", course:"REF. MATES", teacher:"PROF 3" },
      ]
    },

    {
      id:"UL_SB_2",
      local:"SAN BORJA",
      uni:"U.LIMA",
      salon:"U.LIMA SB 2",
      blocks:[
        { day:"LUNES", start:"12:00", end:"13:50", course:"BIO 1", teacher:"PROF A" },
        { day:"MIÉRCOLES", start:"12:00", end:"13:50", course:"FÍS 2", teacher:"PROF B" },
        { day:"VIERNES", start:"15:00", end:"17:00", course:"MAT 2", teacher:"PROF C" },
      ]
    },

    {
      id:"UL_ESC",
      local:"VIRTUAL",
      uni:"U.LIMA",
      salon:"U.LIMA ESCOLAR",
      blocks:[
        { day:"LUNES", start:"08:00", end:"09:50", course:"ESC 1", teacher:"PROF E1" },
        { day:"MIÉRCOLES", start:"10:00", end:"11:50", course:"ESC 2", teacher:"PROF E2" },
        { day:"VIERNES", start:"12:00", end:"13:50", course:"ESC 3", teacher:"PROF E3" },
      ]
    },

    {
      id:"UL_VIRT",
      local:"VIRTUAL",
      uni:"U.LIMA",
      salon:"U.LIMA VIRTUAL",
      blocks:[
        { day:"MARTES", start:"10:00", end:"11:50", course:"VIRT 1", teacher:"PROF V1" },
        { day:"JUEVES", start:"12:00", end:"13:50", course:"VIRT 2", teacher:"PROF V2" },
        { day:"SÁBADO", start:"08:00", end:"11:00", course:"VIRT 3", teacher:"PROF V3" },
      ]
    },
  ]);

  function ensureHorariosLayout(){
    const el = document.getElementById("view_horarios");
    if (el.dataset.ready === "1") return;

    el.innerHTML = `
      <div class="card panel12">
        <div class="cardtitle">FILTROS (HORARIOS)</div>
        <div class="controls" style="justify-content:flex-start;">
          <select id="hLocal"></select>
          <select id="hUni"></select>
          <select id="hSalon"></select>
          <button id="hReset">VER TODO</button>
        </div>
        <div class="panelHint" style="margin-top:10px;">
          <span class="pill"><span class="dot agraria"></span>AGRARIA</span>
          <span class="pill"><span class="dot pucp"></span>PUCP</span>
          <span class="pill"><span class="dot ulima"></span>U.LIMA</span>
          <span class="pill">Descarga PNG siempre sale en “horizontal bonito”.</span>
        </div>
      </div>

      <div class="panel12">
        <div class="schGridWrap" id="schGrid"></div>
      </div>
    `;

    const locals = uniq(SCHEDULES.map(s=>s.local));
    fillSelectKeep("hLocal", sortByLocalOrder(locals), "LOCAL: TODOS");
    fillSelectKeep("hUni", ["AGRARIA","PUCP","U.LIMA"], "UNIVERSIDAD: TODAS");

    // ✅ Por defecto: mostrar TODO
    document.getElementById("hLocal").value = "__ALL__";
    document.getElementById("hUni").value = "__ALL__";
    rebuildHorariosSalonOptions();
    document.getElementById("hSalon").value = "__ALL__";

    document.getElementById("hLocal").addEventListener("change", ()=>{
      rebuildHorariosSalonOptions();
      renderHorarios();
    });
    document.getElementById("hUni").addEventListener("change", ()=>{
      rebuildHorariosSalonOptions();
      renderHorarios();
    });
    document.getElementById("hSalon").addEventListener("change", renderHorarios);
    document.getElementById("hReset").addEventListener("click", ()=>{
      document.getElementById("hLocal").value="__ALL__";
      document.getElementById("hUni").value="__ALL__";
      rebuildHorariosSalonOptions();
      document.getElementById("hSalon").value="__ALL__";
      renderHorarios();
    });

    el.dataset.ready = "1";
  }

  function sortByLocalOrder(values){
    return values.slice().sort((a,b)=>{
      const ia = LOCAL_ORDER.indexOf(a); const ib = LOCAL_ORDER.indexOf(b);
      return (ia<0?999:ia) - (ib<0?999:ib);
    });
  }

  function rebuildHorariosSalonOptions(){
    const fLocal = document.getElementById("hLocal").value;
    const fUni = document.getElementById("hUni").value;

    let base = SCHEDULES.slice();
    if (fLocal !== "__ALL__") base = base.filter(s=>s.local===fLocal);
    if (fUni !== "__ALL__") base = base.filter(s=>s.uni===fUni);

    const salones = uniq(base.map(s=>s.salon)).sort((a,b)=>a.localeCompare(b,"es"));
    fillSelectKeep("hSalon", salones, "SALÓN: TODOS");
  }

  function renderHorarios(){
    ensureHorariosLayout();

    const fLocal = document.getElementById("hLocal").value;
    const fUni   = document.getElementById("hUni").value;
    const fSalon = document.getElementById("hSalon").value;

    let base = SCHEDULES.slice();
    if (fLocal !== "__ALL__") base = base.filter(s=>s.local===fLocal);
    if (fUni !== "__ALL__") base = base.filter(s=>s.uni===fUni);
    if (fSalon !== "__ALL__") base = base.filter(s=>s.salon===fSalon);

    // ✅ Orden: LA MOLINA -> SAN MIGUEL -> SAN BORJA -> VIRTUAL
    base = sortSchedules(base);

    const grid = document.getElementById("schGrid");
    grid.innerHTML = base.map(scheduleToHtmlCard).join("");
  }

  // ===================== DESCARGAR PNG “HORIZONTAL BONITO” =====================
  function safeFileName(s){
    return String(s||"horario")
      .trim()
      .toLowerCase()
      .replace(/[^\w]+/g,"_")
      .replace(/^_+|_+$/g,"");
  }

  async function downloadSchedulePNG(scheduleId){
    const card = document.querySelector(`.schCard[data-id="${scheduleId}"]`);
    if (!card) return;

    const prevBody = document.body.classList.contains("exportMode");
    document.body.classList.add("exportMode");

    // ocultar botón para que no salga en la imagen
    const btn = card.querySelector(".schDl");
    const prevBtnDisplay = btn ? btn.style.display : "";
    if (btn) btn.style.display = "none";

    const wrap = card.querySelector(".schTableWrap");
    if (wrap) wrap.scrollLeft = 0;

    await new Promise(r=>requestAnimationFrame(()=>r()));

    const canvas = await html2canvas(card, {
      backgroundColor: "#ffffff",
      scale: 2,
      useCORS: true
    });

    if (btn) btn.style.display = prevBtnDisplay;
    if (!prevBody) document.body.classList.remove("exportMode");

    const nameLocal = safeFileName(card.getAttribute("data-local"));
    const nameSalon = safeFileName(card.getAttribute("data-salon"));
    const nameUni   = safeFileName(card.getAttribute("data-uni"));

    const a = document.createElement("a");
    a.download = `horario_${nameUni}_${nameLocal}_${nameSalon}.png`;
    a.href = canvas.toDataURL("image/png");
    a.click();
  }

  document.addEventListener("click", (e)=>{
    const btn = e.target.closest(".schDl");
    if (!btn) return;
    const sid = btn.getAttribute("data-sid");
    if (!sid) return;
    downloadSchedulePNG(sid);
  });

  // ===================== RENDER =====================
  function render(){
    if (state.view==="overview") renderOverview();
    if (state.view==="local") renderLocal();
    if (state.view==="table") renderTable();
    if (state.view==="horarios") renderHorarios();
  }

  // ===================== LOAD DATA MATRÍCULA =====================
  async function loadOneSalon(salon){
    const url = csvUrl(salon.gid) + "&v=" + Date.now();
    const res = await fetch(url, { cache:"no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} (${salon.local} / ${salon.ciclo} / ${salon.salon})`);

    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);

    let headerIdx = -1;
    let header = null;

    for (let i=0;i<Math.min(lines.length, 200);i++){
      const cells = parseCSVLine(lines[i]).map(norm);
      const hasName = cells.includes(HEAD.NOMBRES_A) || cells.includes(HEAD.NOMBRES_B) || cells.includes(HEAD.NOMBRES_C);
      const hasEst = cells.includes(HEAD.ESTADO);
      if (hasName && hasEst){ headerIdx = i; header = cells; break; }
    }

    if (headerIdx === -1){
      return { salon, rows: [], error: "No se encontró encabezado con NOMBRES y ESTADO." };
    }

    const idx = (name) => header.findIndex(h => norm(h) === name);
    const iNombreA = idx(HEAD.NOMBRES_A);
    const iNombreB = idx(HEAD.NOMBRES_B);
    const iNombreC = idx(HEAD.NOMBRES_C);
    const iNombre = (iNombreA>=0) ? iNombreA : (iNombreB>=0 ? iNombreB : iNombreC);

    const iMod = idx(HEAD.MODALIDAD);
    const iEst = idx(HEAD.ESTADO);

    const out = [];
    for (let i=headerIdx+1; i<lines.length; i++){
      const cells = parseCSVLine(lines[i]);
      if (!cells.some(v=>norm(v).length>0)) continue;

      const nombre = norm(cells[iNombre]);
      if (!nombre) continue;

      const modalidadCell = (iMod>=0) ? cells[iMod] : "";
      const modalidad = normalizeModalidad(modalidadCell, salon.local);

      const estado = normalizeEstado(cells[iEst]);

      out.push({
        nombre,
        modalidad,
        estado,
        local: salon.local,
        ciclo: salon.ciclo,
        salon: salon.salon,
        gid: salon.gid
      });
    }

    return { salon, rows: out, error: null };
  }

  async function loadAll(){
    try{
      const results = await Promise.allSettled(SALONES.map(loadOneSalon));
      let rows = [];
      for (const r of results){
        if (r.status==="fulfilled") rows = rows.concat(r.value.rows);
      }

      state.rawRows = rows;

      const matriculaRows = state.rawRows.filter(r => r.estado==="ACTIVO" || r.estado==="RETIRO");
      state.canonical = dedupeMatriculaByName(matriculaRows);

      state.cambiosRows = state.rawRows.filter(r => r.estado==="CAMBIO");

      initFilters();
      render();
    } catch(e){
      console.error(e);
    }
  }

  // ===================== EVENTS =====================
  document.getElementById("nav_overview").addEventListener("click", ()=>setView("overview"));
  document.getElementById("nav_local").addEventListener("click", ()=>setView("local"));
  document.getElementById("nav_table").addEventListener("click", ()=>setView("table"));
  document.getElementById("nav_horarios").addEventListener("click", ()=>setView("horarios"));

  ["fLocal","fUni","fSalon","fModalidad"].forEach(id=>{
    document.getElementById(id).addEventListener("change", ()=>{
      rebuildSalonOptions();
      render();
    });
  });

  document.getElementById("q").addEventListener("input", render);
  document.getElementById("btnNowTop").addEventListener("click", loadAll);

  initFilters();
  loadAll();
  setInterval(loadAll, AUTO_REFRESH_MS);
</script>
</body>
</html>
