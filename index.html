<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LA META | PANEL</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:#f3f4f6;}
  .overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:9999;}
  .card{width:min(760px,92vw); background:#fff; border-radius:18px; padding:28px; box-shadow:0 18px 60px rgba(0,0,0,.2);}
  .h1{font-size:28px; font-weight:800; margin:0 0 6px;}
  .sub{color:#64748b; font-weight:600; margin:0 0 10px;}
  .build{color:#94a3b8; font-size:13px; margin:0 0 16px;}
  .roles{display:grid; grid-template-columns:1fr 1fr; gap:14px; margin:14px 0 10px;}
  .role{border:1px solid #e5e7eb; border-radius:14px; padding:14px; text-align:center; cursor:pointer; user-select:none;
        font-weight:800; color:#b91c1c; background:#fff;}
  .role.big{grid-column:1 / -1;}
  .role.active{border:2px solid #dc2626; background:#fff1f2; color:#991b1b;}
  .row{display:flex; gap:12px; align-items:center; margin-top:10px;}
  input{flex:1; height:52px; border-radius:14px; border:2px solid #f2c9cf; padding:0 14px; font-size:18px; outline:none;}
  .btn{height:52px; padding:0 18px; border:0; border-radius:14px; background:#b91c1c; color:#fff; font-weight:900; cursor:pointer;}
  .btn:disabled{opacity:.55; cursor:not-allowed;}
  .msg{margin-top:10px; font-weight:800; color:#b91c1c; min-height:22px;}
  .ok{color:#166534;}
</style>
</head>
<body>

<div class="overlay" id="loginOverlay">
  <div class="card">
    <div class="h1">ACCESO AL PANEL</div>
    <div class="sub">Seleccione su tipo de acceso e ingrese la clave.</div>
    <div class="build">Build: <b>v9</b></div>

    <div class="roles">
      <div class="role" id="roleAdmin">ADMIN</div>
      <div class="role" id="roleTutor">TUTOR</div>
      <div class="role big" id="roleAlumno">ALUMNO</div>
    </div>

    <div style="color:#64748b; font-weight:700; margin-top:6px;">Rol seleccionado: <b id="roleLabel">-</b></div>

    <div class="row">
      <input id="pass" type="password" placeholder="Clave" autocomplete="current-password"/>
      <button class="btn" id="btnEnter">ENTRAR</button>
    </div>

    <div class="msg" id="msg"></div>
  </div>
</div>

<script>
/** ========= CONFIG ========= **/
const STUDENT_API_URL = "https://script.google.com/macros/s/AKfycbzWE1G1EwtGfF4xk6ON2ArMe_Kwfwnj6M2YUXWxkFJGU4iwscmmPelMErwHMtNR4cvg/exec";
const BUILD = "v9";

/** ========= UI ========= **/
const elAdmin = document.getElementById('roleAdmin');
const elTutor = document.getElementById('roleTutor');
const elAlumno = document.getElementById('roleAlumno');
const roleLabel = document.getElementById('roleLabel');
const passEl = document.getElementById('pass');
const msgEl = document.getElementById('msg');
const btn = document.getElementById('btnEnter');

let selectedRole = null;

function setMsg(text, ok=false){
  msgEl.textContent = text || '';
  msgEl.className = 'msg' + (ok ? ' ok' : '');
}

function setRole(role){
  selectedRole = role;
  [elAdmin, elTutor, elAlumno].forEach(x=>x.classList.remove('active'));
  if(role==='ADMIN') elAdmin.classList.add('active');
  if(role==='TUTOR') elTutor.classList.add('active');
  if(role==='ALUMNO') elAlumno.classList.add('active');
  roleLabel.textContent = role || '-';
  setMsg('');
}

elAdmin.addEventListener('click', ()=>setRole('ADMIN'));
elTutor.addEventListener('click', ()=>setRole('TUTOR'));
elAlumno.addEventListener('click', ()=>setRole('ALUMNO'));

/** ========= JSONP ========= **/
function jsonp(url, timeoutMs=12000){
  return new Promise((resolve, reject)=>{
    const cbName = 'cb_' + Date.now() + '_' + Math.floor(Math.random()*1e6);
    const script = document.createElement('script');
    let done = false;

    const cleanup = ()=>{
      if(script.parentNode) script.parentNode.removeChild(script);
      try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
    };

    const timer = setTimeout(()=>{
      if(done) return;
      done = true;
      cleanup();
      reject(new Error('Tiempo de espera agotado'));
    }, timeoutMs);

    window[cbName] = (data)=>{
      if(done) return;
      done = true;
      clearTimeout(timer);
      cleanup();
      resolve(data);
    };

    script.onerror = ()=>{
      if(done) return;
      done = true;
      clearTimeout(timer);
      cleanup();
      reject(new Error('No se pudo conectar con el servidor'));
    };

    const joiner = url.includes('?') ? '&' : '?';
    script.src = url + joiner + 'callback=' + encodeURIComponent(cbName);
    document.body.appendChild(script);
  });
}

/** ========= LOGIN ========= **/
async function enter(){
  const pw = passEl.value || '';
  if(!selectedRole) return setMsg('Seleccione un rol.');
  if(!pw.trim()) return setMsg('Ingrese la clave.');

  btn.disabled = true;
  setMsg('Validando...');

  try{
    if(selectedRole === 'ALUMNO'){
      const url = STUDENT_API_URL + '?action=authStudent&password=' + encodeURIComponent(pw);
      const res = await jsonp(url, 15000);
      if(!res || !res.ok){
        return setMsg((res && res.error) ? res.error : 'Contraseña inválida.');
      }
      // Éxito: aquí luego conectamos con tu vista de Alumno completa.
      setMsg('Acceso ALUMNO OK: ' + (res.alumno?.nombre || ''), true);
      // TODO: ocultar overlay y mostrar portal alumno (lo conectamos en el siguiente paso).
      return;
    }

    // ADMIN/TUTOR: aquí se conecta a tu lógica existente (no tocamos nada todavía).
    setMsg('Rol ' + selectedRole + ' OK (conecta tu lógica actual).', true);
  }catch(err){
    setMsg(String(err && err.message ? err.message : err));
  }finally{
    btn.disabled = false;
  }
}

btn.addEventListener('click', enter);
passEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') enter(); });
</script>
</body>
</html>
