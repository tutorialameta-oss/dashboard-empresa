<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LA META | PANEL</title>
  <style>
    :root{
      --bg:#e9eaee;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --red:#b30000;
      --red2:#d10b0b;
      --line:#e5e7eb;
      --shadow:0 20px 60px rgba(0,0,0,.18);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .topbar{height:10px;background:var(--red)}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 60px}
    h1{margin:18px 0 8px;font-size:32px;letter-spacing:.4px}
    .sub{color:var(--muted);font-weight:600;margin-bottom:18px}
    .center{min-height:70vh;display:flex;align-items:center;justify-content:center}
    .card{
      width:min(980px,100%);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:26px 26px 22px;
    }
    .card h2{margin:0 0 6px;font-size:26px}
    .card p{margin:0 0 18px;color:var(--muted);font-weight:600}
    .roleRow{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:10px 0 14px}
    .roleRow.bottom{grid-template-columns:1fr; margin-top:0}
    /* Radio roles (no se “desmarca”) */
    .roleRadio{display:none}
    .roleBtn{
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 14px;
      text-align:center;
      font-weight:800;
      color:var(--red2);
      background:#fff;
      cursor:pointer;
      user-select:none;
      transition:.12s ease;
    }
    .roleBtn:hover{transform:translateY(-1px)}
    .roleRadio:checked + .roleBtn{
      outline:3px solid rgba(209,11,11,.20);
      border-color:rgba(209,11,11,.35);
      background:#fff5f5;
    }
    .loginRow{display:flex;gap:12px;align-items:center}
    .input{
      flex:1;
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px 14px;
      font-size:16px;
      outline:none;
    }
    .input:focus{border-color:rgba(209,11,11,.5); box-shadow:0 0 0 4px rgba(209,11,11,.12)}
    .btn{
      border:none;
      border-radius:14px;
      padding:14px 18px;
      background:var(--red2);
      color:#fff;
      font-weight:900;
      cursor:pointer;
      min-width:120px;
    }
    .btn:active{transform:translateY(1px)}
    .err{margin-top:10px;color:var(--red2);font-weight:800}
    /* Portal alumno */
    .grid{display:grid;grid-template-columns:340px 1fr;gap:16px;align-items:start}
    .box{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
    }
    .box h3{margin:0 0 10px}
    .k{color:var(--muted);font-weight:800;font-size:13px;margin-top:6px}
    .v{font-weight:900}
    .pill{display:inline-block;background:#fff5f5;border:1px solid rgba(209,11,11,.25);color:var(--red2);padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px}
    .logout{float:right;background:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:12px;font-weight:900;cursor:pointer}
    .week{border:1px solid var(--line);border-radius:16px;overflow:hidden;margin-bottom:12px;background:#fff}
    .weekHead{padding:12px 14px;background:#fff5f5;font-weight:900;display:flex;justify-content:space-between;cursor:pointer}
    .weekBody{padding:12px 14px;display:none}
    .week.open .weekBody{display:block}
    .item{border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0;background:#fff}
    .itemTitle{font-weight:900}
    .itemMeta{color:var(--muted);font-weight:800;font-size:13px;margin-top:2px}
    .rowBtns{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .btn2{border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;border:1px solid var(--line);background:#fff}
    .btnRed{background:var(--red2);color:#fff;border:none}
    .qgrid{display:grid;grid-template-columns:repeat(5,minmax(56px,1fr));gap:10px;margin-top:10px}
    .opt{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 0;
      text-align:center;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .opt input{display:none}
    .opt.sel{outline:3px solid rgba(209,11,11,.18); border-color:rgba(209,11,11,.35); background:#fff5f5}
    .sendRow{margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .small{color:var(--muted);font-weight:700;font-size:12px}
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="topbar"></div>
  <div class="wrap">
    <h1>LA META | PANEL DE CONTROL</h1>
    <div class="sub">Acceso a material y evaluación (pruebas actuales: Álgebra).</div>

    <div id="screenLogin" class="center">
      <div class="card">
        <h2>ACCESO AL PANEL</h2>
        <p>Seleccione su tipo de acceso e ingrese la clave.</p>

        <!-- Roles: radio + label (no se “borra” la selección) -->
        <div class="roleRow">
          <div>
            <input class="roleRadio" type="radio" name="role" id="roleAlumno" value="alumno" checked>
            <label class="roleBtn" for="roleAlumno">ALUMNO</label>
          </div>
          <div>
            <input class="roleRadio" type="radio" name="role" id="roleTutor" value="tutor">
            <label class="roleBtn" for="roleTutor">TUTOR</label>
          </div>
        </div>
        <div class="roleRow bottom">
          <div>
            <input class="roleRadio" type="radio" name="role" id="roleAdmin" value="admin">
            <label class="roleBtn" for="roleAdmin">ADMIN</label>
          </div>
        </div>

        <div class="loginRow">
          <input id="inpClave" class="input" placeholder="Clave" type="password" autocomplete="current-password"/>
          <button id="btnEntrar" class="btn" type="button">ENTRAR</button>
        </div>
        <div id="loginErr" class="err" style="display:none"></div>
      </div>
    </div>

    <div id="screenAlumno" style="display:none">
      <div class="box" style="margin-bottom:14px">
        <button id="btnSalir" class="logout" type="button">SALIR</button>
        <div class="pill">PORTAL ALUMNO</div>
        <h2 style="margin:8px 0 6px">Bienvenido, <span id="alNombre"></span></h2>
        <div class="small">Puede enviar aunque deje preguntas en blanco. ENVIAR registra en la hoja R.</div>
      </div>

      <div class="grid">
        <div>
          <div class="box">
            <h3>Datos del alumno</h3>
            <div class="k">Nombre</div><div class="v" id="alNombre2">—</div>
            <div class="k">Curso</div><div class="v">ÁLGEBRA</div>
          </div>

          <div class="box" style="margin-top:12px">
            <h3>Materiales (PDF)</h3>
            <ul id="listaPDF" style="margin:0;padding-left:18px;font-weight:800"></ul>
            <div class="small" style="margin-top:8px">Se genera desde tu Google Sheets (Álgebra).</div>
          </div>
        </div>

        <div>
          <div class="box">
            <h3>Evaluaciones (por semana)</h3>
            <div class="small">Abra el PDF y responda. Las preguntas son opcionales.</div>
            <div id="weeks"></div>
            <div id="sendMsg" class="small" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/** ================= CONFIG ================= **/
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxHaXXfPIsGODuJo5J1TZvESJuYBslDloH4p8AphemCIPScRROxPjlMdJNluMqxgnMh/exec";

// Cronograma Álgebra (tu Sheet 1nHCB... gid 502858541) -> CSV público (si no está público, no se podrá leer desde GitHub)
const ALG_SHEET_ID = "1nHCBQLuJ8RZNtLisvAqD916pcxbUmtqPrMnO4V0ewvs";
const ALG_GID = "502858541";
const ALG_CSV_URL = `https://docs.google.com/spreadsheets/d/${ALG_SHEET_ID}/gviz/tq?tqx=out:csv&gid=${ALG_GID}`;

// Tutor/Admin (por ahora sin cambios)
const TUTOR_PASS = ""; // si quieres, pon una clave
const ADMIN_PASS = ""; // si quieres, pon una clave

/** ================= STATE ================= **/
let alumno = null; // {nombre, clave}
let blocks = [];  // items del cronograma

/** ================= UTIL ================= **/
function qs(sel){ return document.querySelector(sel); }
function show(id){ qs(id).style.display=""; }
function hide(id){ qs(id).style.display="none"; }
function setErr(msg){
  const el = qs("#loginErr");
  if(!msg){ el.style.display="none"; el.textContent=""; return; }
  el.style.display="block"; el.textContent = msg;
}
function getRole(){
  const r = document.querySelector('input[name="role"]:checked');
  return r ? r.value : "alumno";
}

/** JSONP call (evita CORS) */
function apiJSONP(params, timeoutMs=20000){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    let done = false;
    const script = document.createElement("script");

    window[cb] = (data) => {
      done = true;
      cleanup();
      resolve(data);
    };

    const cleanup = () => {
      try{ delete window[cb]; }catch(e){ window[cb] = undefined; }
      if(script && script.parentNode) script.parentNode.removeChild(script);
    };

    const qs2 = new URLSearchParams({...params, callback: cb}).toString();
    script.src = WEBAPP_URL + "?" + qs2;
    script.onerror = () => { if(done) return; done=true; cleanup(); reject(new Error("No se pudo conectar (script error)")); };
    document.body.appendChild(script);

    setTimeout(() => { if(done) return; done=true; cleanup(); reject(new Error("No se pudo conectar (timeout)")); }, timeoutMs);
  });
}

/** CSV parser simple */
function parseCSV(text){
  const rows = [];
  let cur = "", inQ = false, row = [];
  for(let i=0;i<text.length;i++){
    const ch = text[i], nx = text[i+1];
    if(ch === '"' && nx === '"'){ cur += '"'; i++; continue; }
    if(ch === '"'){ inQ = !inQ; continue; }
    if(ch === ',' && !inQ){ row.push(cur); cur=""; continue; }
    if((ch === '\n' || ch === '\r') && !inQ){
      if(cur.length || row.length){ row.push(cur); rows.push(row); }
      cur=""; row=[];
      continue;
    }
    cur += ch;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function norm(s){ return String(s||"").trim(); }
function isValidUrl(u){ return /^https?:\/\//i.test(u||""); }

/** ================= LOGIN FLOW ================= **/
qs("#btnEntrar").addEventListener("click", async () => {
  setErr("");
  const role = getRole();
  const clave = norm(qs("#inpClave").value);
  if(!clave) return setErr("Ingrese una clave.");

  try{
    if(role === "alumno"){
      const res = await apiJSONP({action:"login", clave});
      if(!res || !res.ok) return setErr((res && res.error) ? res.error : "Clave incorrecta.");
      alumno = res.alumno;
      sessionStorage.setItem("lameta_alumno", JSON.stringify(alumno));
      await enterAlumno();
      return;
    }

    // Tutor/Admin (por ahora sin cambios)
    if(role === "tutor"){
      if(TUTOR_PASS && clave !== TUTOR_PASS) return setErr("Clave de tutor incorrecta.");
      alert("Tutor: sin cambios en esta entrega.");
      return;
    }
    if(role === "admin"){
      if(ADMIN_PASS && clave !== ADMIN_PASS) return setErr("Clave de admin incorrecta.");
      alert("Admin: sin cambios en esta entrega.");
      return;
    }
  }catch(err){
    setErr(err && err.message ? err.message : String(err));
  }
});

qs("#btnSalir").addEventListener("click", () => {
  sessionStorage.removeItem("lameta_alumno");
  alumno = null;
  qs("#inpClave").value = "";
  hide("#screenAlumno");
  show("#screenLogin");
  window.scrollTo(0,0);
});

async function enterAlumno(){
  // pinta cabecera
  qs("#alNombre").textContent = alumno.nombre;
  qs("#alNombre2").textContent = alumno.nombre;

  hide("#screenLogin");
  show("#screenAlumno");

  // cargar cronograma
  await loadAlgebra();
  renderAlumno();
}

/** ================= DATA + UI ================= **/
async function loadAlgebra(){
  // intenta leer CSV del cronograma
  try{
    const r = await fetch(ALG_CSV_URL, {cache:"no-store"});
    const t = await r.text();
    const rows = parseCSV(t);
    // Esperado: FECHA | BLOQUES | ALGEBRA(TEMA) | HIPERVINCULOS
    // En tu ejemplo: B=FECHA, C=BLOQUES, D=TEMA, E=HIPERVINCULOS (pero el CSV vendrá por columnas reales).
    // Buscamos encabezados flexibles:
    const header = rows[0].map(h => norm(h).toUpperCase());
    const idxFecha = header.findIndex(h => h.includes("FECHA"));
    const idxBloque = header.findIndex(h => h.includes("BLOQUE"));
    const idxTema  = header.findIndex(h => h.includes("ALGEBRA") || h.includes("TEMA"));
    const idxLink  = header.findIndex(h => h.includes("HIPERV") || h.includes("LINK"));

    blocks = [];
    for(let i=1;i<rows.length;i++){
      const rr = rows[i];
      const fecha = norm(rr[idxFecha]);
      const bloque = norm(rr[idxBloque] || "").toUpperCase();
      const tema = norm(rr[idxTema]);
      const link = norm(rr[idxLink]);
      if(!fecha && !bloque && !tema && !link) continue;
      blocks.push({fecha, bloque, tema, link});
    }
  }catch(e){
    // si no se puede leer (sheet no público), deja vacío
    blocks = [];
  }
}

function renderAlumno(){
  // Materiales (lista de PDFs con link)
  const ul = qs("#listaPDF");
  ul.innerHTML = "";
  const withLink = blocks.filter(b => isValidUrl(b.link));
  if(withLink.length === 0){
    const li = document.createElement("li");
    li.innerHTML = `<span style="color:#6b7280;font-weight:800">No se pudo cargar el cronograma (verifique que el Sheet esté público o publicado).</span>`;
    ul.appendChild(li);
  }else{
    for(const b of withLink){
      const li = document.createElement("li");
      const title = `Bloque ${b.bloque || "?"} · ${b.tema || "(sin tema)"} (${b.fecha || ""})`;
      li.innerHTML = `<a href="${b.link}" target="_blank" rel="noopener">${title}</a>`;
      ul.appendChild(li);
    }
  }

  // Evaluaciones por semana (agrupa por fecha)
  const byDate = {};
  for(const b of blocks){
    const key = b.fecha || "Sin fecha";
    byDate[key] = byDate[key] || [];
    byDate[key].push(b);
  }
  const dates = Object.keys(byDate);
  const cont = qs("#weeks");
  cont.innerHTML = "";

  if(dates.length === 0){
    cont.innerHTML = `<div class="small" style="margin-top:10px;color:#6b7280;font-weight:800">No hay datos para mostrar.</div>`;
    return;
  }

  for(const d of dates){
    const wrap = document.createElement("div");
    wrap.className = "week";
    const head = document.createElement("div");
    head.className = "weekHead";
    head.innerHTML = `<span>${d}</span><span>▼</span>`;
    head.addEventListener("click", () => wrap.classList.toggle("open"));

    const body = document.createElement("div");
    body.className = "weekBody";

    for(const b of byDate[d]){
      body.appendChild(renderBlockItem(b));
    }

    wrap.appendChild(head);
    wrap.appendChild(body);
    cont.appendChild(wrap);
  }

  // abre la primera semana
  cont.querySelector(".week")?.classList.add("open");
}

function renderBlockItem(b){
  const item = document.createElement("div");
  item.className = "item";

  const title = document.createElement("div");
  title.className = "itemTitle";
  title.textContent = `Bloque ${b.bloque || "?"} · ${b.tema || "(sin tema)"}`;

  const meta = document.createElement("div");
  meta.className = "itemMeta";
  meta.textContent = `Fecha: ${b.fecha || "—"} · ${isValidUrl(b.link) ? "Con PDF" : "Sin link"}`;

  const btns = document.createElement("div");
  btns.className = "rowBtns";

  const btnPdf = document.createElement("button");
  btnPdf.className = "btn2";
  btnPdf.type = "button";
  btnPdf.textContent = "Abrir PDF";
  btnPdf.disabled = !isValidUrl(b.link);
  btnPdf.addEventListener("click", () => window.open(b.link, "_blank", "noopener"));

  const btnResp = document.createElement("button");
  btnResp.className = "btn2 btnRed";
  btnResp.type = "button";
  btnResp.textContent = "Responder";

  btns.appendChild(btnPdf);
  btns.appendChild(btnResp);

  // Form preguntas (5, opcionales)
  const form = document.createElement("div");
  form.style.display = "none";
  form.style.marginTop = "10px";

  const answers = {q1:"", q2:"", q3:"", q4:"", q5:""};

  for(let qi=1; qi<=5; qi++){
    const qwrap = document.createElement("div");
    qwrap.style.marginTop = "10px";
    qwrap.innerHTML = `<div style="font-weight:900">Pregunta ${qi} <span class="small">(opcional)</span></div>`;
    const grid = document.createElement("div");
    grid.className = "qgrid";

    ["A","B","C","D","E"].forEach(opt => {
      const lab = document.createElement("label");
      lab.className = "opt";
      const inp = document.createElement("input");
      inp.type = "radio";
      inp.name = `q${qi}_${b.fecha}_${b.bloque}_${b.tema}`;
      inp.value = opt;

      inp.addEventListener("change", () => {
        answers["q"+qi] = opt;
        // marca visual
        [...grid.querySelectorAll(".opt")].forEach(x => x.classList.remove("sel"));
        lab.classList.add("sel");
      });

      lab.appendChild(inp);
      lab.appendChild(document.createTextNode(opt));
      grid.appendChild(lab);
    });

    qwrap.appendChild(grid);
    form.appendChild(qwrap);
  }

  const sendRow = document.createElement("div");
  sendRow.className = "sendRow";

  const btnSend = document.createElement("button");
  btnSend.className = "btn2 btnRed";
  btnSend.type = "button";
  btnSend.textContent = "ENVIAR";

  const msg = document.createElement("div");
  msg.className = "small";
  msg.style.fontWeight = "900";

  btnSend.addEventListener("click", async () => {
    msg.textContent = "Enviando...";
    try{
      const payload = {
        action:"save",
        clave: alumno.clave,
        curso:"ALG",
        fecha: b.fecha || "",
        bloque: b.bloque || "",
        tema: b.tema || "",
        q1: answers.q1 || "",
        q2: answers.q2 || "",
        q3: answers.q3 || "",
        q4: answers.q4 || "",
        q5: answers.q5 || ""
      };
      const res = await apiJSONP(payload, 30000);
      if(res && res.ok){
        msg.textContent = "Enviado ✅";
      }else{
        msg.textContent = (res && res.error) ? ("Error: " + res.error) : "Error al enviar";
      }
    }catch(e){
      msg.textContent = e && e.message ? ("Error: " + e.message) : "Error al enviar";
    }
  });

  sendRow.appendChild(btnSend);
  sendRow.appendChild(msg);
  form.appendChild(sendRow);

  btnResp.addEventListener("click", () => {
    form.style.display = (form.style.display === "none") ? "" : "none";
  });

  item.appendChild(title);
  item.appendChild(meta);
  item.appendChild(btns);
  item.appendChild(form);
  return item;
}

/** ================= AUTO RESTORE SESSION ================= **/
(function init(){
  const saved = sessionStorage.getItem("lameta_alumno");
  if(saved){
    try{
      alumno = JSON.parse(saved);
      if(alumno && alumno.clave) enterAlumno();
    }catch(e){ /* ignore */ }
  }
})();
</script>
</body>
</html>
