<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LA META | PANEL DE CONTROL</title>
<style>
  :root{
    --red:#b10000;
    --red2:#d40000;
    --bg:#f4f5f7;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --border:#e5e7eb;
    --shadow:0 10px 30px rgba(0,0,0,.08);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text)}
  .topbar{height:10px;background:var(--red2)}
  .wrap{max-width:1280px;margin:22px auto;padding:0 18px}
  h1{margin:0 0 6px;font-size:28px;letter-spacing:.2px}
  .sub{margin:0 0 16px;color:var(--muted);font-weight:600}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
  .pad{padding:18px}
  .login{max-width:760px;margin:40px auto}
  .login h2{margin:0 0 6px}
  .seg{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:14px 0}
  .seg button{border:1px solid var(--border); background:#fff; padding:12px 14px; border-radius:14px; font-weight:800; color:var(--red); cursor:pointer}
  .seg button.active{border-color:var(--red2); box-shadow:0 0 0 3px rgba(212,0,0,.12)}
  .row{display:flex;gap:10px;align-items:center}
  .row input{flex:1; padding:14px 14px;border:1px solid var(--border);border-radius:14px;font-size:16px}
  .btn{background:var(--red2);color:#fff;border:none;border-radius:14px;padding:13px 16px;font-weight:900;cursor:pointer}
  .btn.sec{background:#fff;color:var(--red2);border:1px solid var(--border)}
  .err{margin-top:10px;color:var(--red2);font-weight:800}
  /* Student layout */
  .headerCard{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .welcome h2{margin:0;font-size:22px}
  .welcome .meta{margin-top:4px;color:var(--muted);font-weight:700}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:16px}
  .side .block{margin-bottom:14px}
  .kv{display:grid;grid-template-columns:110px 1fr;gap:8px 10px;align-items:start}
  .kv div:nth-child(odd){color:var(--muted);font-weight:800}
  .kv div:nth-child(even){font-weight:900}
  .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .tab{padding:10px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;font-weight:900;color:var(--muted);cursor:pointer}
  .tab.active{border-color:var(--red2);color:var(--red2);box-shadow:0 0 0 3px rgba(212,0,0,.10)}
  .sectionTitle{margin:0 0 10px;font-size:16px;letter-spacing:.2px}
  .materials a{display:block;padding:10px 10px;border-radius:12px;border:1px solid var(--border);text-decoration:none;color:#0f172a;font-weight:800;margin:8px 0;background:#fff}
  .materials a:hover{border-color:var(--red2)}
  /* accordion */
  details{border:1px solid var(--border);border-radius:16px;background:#fff;margin:10px 0;overflow:hidden}
  summary{list-style:none;cursor:pointer;padding:14px 14px;background:#fff;font-weight:900;display:flex;align-items:center;justify-content:space-between}
  summary::-webkit-details-marker{display:none}
  .sumMeta{color:var(--muted);font-weight:800;font-size:13px}
  .inside{padding:14px;border-top:1px solid var(--border)}
  .task{border:1px solid var(--border);border-radius:16px;padding:14px;background:#fff;margin:10px 0}
  .taskTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .task h3{margin:0;font-size:16px}
  .task .small{color:var(--muted);font-weight:800;margin-top:4px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .pill{padding:10px 12px;border-radius:999px;border:1px solid var(--border);background:#fff;font-weight:900;cursor:pointer}
  .pill.red{background:var(--red2);color:#fff;border:none}
  /* Questions */
  .q{margin-top:12px}
  .q .qlabel{font-weight:900;margin-bottom:8px}
  .opts{display:grid;grid-template-columns:repeat(5, minmax(0,1fr));gap:10px}
  .opt{border:1px solid var(--border);border-radius:14px;padding:10px;background:#fff;display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;font-weight:900}
  .opt input{accent-color:var(--red2)}
  .opt.sel{border-color:var(--red2);box-shadow:0 0 0 3px rgba(212,0,0,.10)}
  .hint{color:var(--muted);font-weight:800;margin-top:8px}
  .ok{color:#0f7a2a;font-weight:900;margin-top:10px}
  /* Responsive */
  @media (max-width: 980px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="topbar"></div>
<div class="wrap">
  <h1>LA META | PANEL DE CONTROL</h1>
  <p class="sub">Acceso a material y evaluación (Álgebra).</p>

  <!-- LOGIN -->
  <div id="loginView" class="card login">
    <div class="pad">
      <h2>ACCESO AL PANEL</h2>
      <div class="sub" style="margin:0 0 10px">Seleccione su tipo de acceso e ingrese la clave.</div>

      <div class="seg">
        <button id="btnAdmin" type="button">ADMIN</button>
        <button id="btnTutor" type="button">TUTOR</button>
      </div>
      <div class="seg" style="grid-template-columns:1fr">
        <button id="btnAlumno" class="active" type="button">ALUMNO</button>
      </div>

      <div class="row">
        <input id="clave" type="password" placeholder="Clave del alumno" autocomplete="current-password" />
        <button id="btnEntrar" class="btn" type="button">ENTRAR</button>
      </div>
      <div id="loginErr" class="err" style="display:none"></div>
    </div>
  </div>

  <!-- STUDENT -->
  <div id="studentView" style="display:none">
    <div class="card">
      <div class="pad headerCard">
        <div class="welcome">
          <div style="font-weight:900;color:var(--muted);letter-spacing:.2px">PORTAL ALUMNO</div>
          <h2 id="stuName">Bienvenido</h2>
          <div class="meta" id="stuMeta">Curso: ÁLGEBRA</div>
        </div>
        <button id="btnSalir" class="btn sec" type="button">SALIR</button>
      </div>
    </div>

    <div class="grid">
      <div class="side">
        <div class="card block">
          <div class="pad">
            <div class="sectionTitle">Datos del alumno</div>
            <div class="kv">
              <div>Nombre</div><div id="kvNombre">-</div>
              <div>Posición</div><div id="kvPos">-</div>
              <div>Curso</div><div>ÁLGEBRA</div>
            </div>
            <div class="tabs">
              <button class="tab active" data-tab="materials" type="button">Materiales</button>
              <button class="tab" data-tab="help" type="button">Ayuda</button>
            </div>
            <div id="tab_materials" class="materials" style="margin-top:12px"></div>
            <div id="tab_help" style="display:none;margin-top:12px;color:var(--muted);font-weight:800">
              • Puede <b>enviar</b> aunque deje preguntas en blanco.<br>
              • El registro se guarda en la hoja <b>R</b> en su <b>posición</b>.<br>
              • “Abrir PDF” se abre en otra pestaña.
            </div>
          </div>
        </div>
      </div>

      <div class="main">
        <div class="card">
          <div class="pad">
            <div class="sectionTitle">Evaluaciones (por semana)</div>
            <div class="sub" style="margin:0">Despliegue una fecha, abra el PDF y responda. ENVIAR registra en la hoja R en su posición.</div>
          </div>
        </div>

        <div id="evalContainer" style="margin-top:12px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxHaXXfPIsGODuJo5J1TZvESJuYBslDloH4p8AphemCIPScRROxPjlMdJNluMqxgnMh/exec";   // Apps Script /exec (JSONP)
const SCHEDULE_SHEET_ID = "1nHCBQLuJ8RZNtLisvAqD916pcxbUmtqPrMnO4V0ewvs";
const SCHEDULE_GID = "502858541"; // cronograma (FECHA, BLOQUE, TEMA, LINK)
const COURSE_CODE = "ALG";

/* ========= Helpers ========= */
const $ = (id)=>document.getElementById(id);

function setErr(msg){
  const el = $("loginErr");
  if(!msg){ el.style.display="none"; el.textContent=""; return; }
  el.style.display="block";
  el.textContent = msg;
}

function saveScroll(){
  try{ sessionStorage.setItem("lameta_scrollY", String(window.scrollY||0)); }catch(e){}
}
function restoreScroll(){
  try{
    const y = parseInt(sessionStorage.getItem("lameta_scrollY")||"0",10);
    if(!isNaN(y)) window.scrollTo(0,y);
  }catch(e){}
}

function jsonp(params, timeoutMs=20000){
  return new Promise((resolve,reject)=>{
    const cb = "cb_"+Date.now()+"_"+Math.random().toString(16).slice(2);
    const qs = new URLSearchParams({...params, callback: cb}).toString();
    const src = WEBAPP_URL + "?" + qs;
    const s = document.createElement("script");
    let done=false;
    const t = setTimeout(()=>{
      if(done) return;
      done=true;
      cleanup();
      reject(new Error("timeout"));
    }, timeoutMs);
    function cleanup(){
      clearTimeout(t);
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      if(s && s.parentNode) s.parentNode.removeChild(s);
    }
    window[cb] = (data)=>{
      if(done) return;
      done=true;
      cleanup();
      resolve(data);
    };
    s.onerror = ()=>{
      if(done) return;
      done=true;
      cleanup();
      reject(new Error("network"));
    };
    document.head.appendChild(s);
    s.src = src;
  });
}

function formatDate(d){
  try{
    if(d instanceof Date) return d.toLocaleDateString("es-PE");
    return String(d||"");
  }catch(e){ return String(d||""); }
}

function parseDMY(str){
  if(!str) return null;
  const s = String(str).trim();
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+"T00:00:00");
  const m1 = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m1) return new Date(parseInt(m1[3],10), parseInt(m1[2],10)-1, parseInt(m1[1],10));
  const months = {ene:0,feb:1,mar:2,abr:3,may:4,jun:5,jul:6,ago:7,sep:8,oct:9,nov:10,dic:11};
  const m2 = s.toLowerCase().match(/^(\d{1,2})\s*[-\/]\s*([a-zñ]{3})$/);
  if(m2 && months[m2[2]]!==undefined){
    return new Date(2026, months[m2[2]], parseInt(m2[1],10));
  }
  return null;
}

/* ========= State ========= */
let session = null; // { nombre, clave, pos }
let schedule = [];  // rows

/* ========= UI ========= */
function showLogin(){
  $("loginView").style.display="block";
  $("studentView").style.display="none";
}
function showStudent(){
  $("loginView").style.display="none";
  $("studentView").style.display="block";
  restoreScroll();
}

function setTabs(){
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tab = btn.getAttribute("data-tab");
      if(tab==="materials"||tab==="help"){
        document.querySelectorAll('.side .tab').forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        $("tab_materials").style.display = tab==="materials" ? "block":"none";
        $("tab_help").style.display = tab==="help" ? "block":"none";
      }
    });
  });
}

function renderMaterials(items){
  const box = $("tab_materials");
  box.innerHTML = "";
  if(!items.length){
    box.innerHTML = "<div style='color:var(--muted);font-weight:800'>Aún no hay materiales con link.</div>";
    return;
  }
  for(const it of items){
    const a = document.createElement("a");
    a.href = it.link;
    a.target = "_blank";
    a.rel = "noopener";
    a.textContent = `Bloque ${it.bloque} • ${it.tema || "(sin tema)"} (${it.fechaTxt})`;
    a.addEventListener("click", saveScroll);
    box.appendChild(a);
  }
}

function makeQuestionBlock(name, labelTxt){
  const wrap = document.createElement("div");
  wrap.className = "q";
  const label = document.createElement("div");
  label.className = "qlabel";
  label.textContent = labelTxt + " (opcional)";
  const opts = document.createElement("div");
  opts.className = "opts";
  const letters = ["A","B","C","D","E"];
  letters.forEach(L=>{
    const lab = document.createElement("label");
    lab.className = "opt";
    const inp = document.createElement("input");
    inp.type = "radio";
    inp.name = name;
    inp.value = L;
    inp.addEventListener("change", ()=>{
      opts.querySelectorAll(".opt").forEach(o=>o.classList.remove("sel"));
      lab.classList.add("sel");
    });
    const span = document.createElement("span");
    span.textContent = L;
    lab.appendChild(inp);
    lab.appendChild(span);
    opts.appendChild(lab);
  });
  wrap.appendChild(label);
  wrap.appendChild(opts);
  return wrap;
}

function getAnswer(name){
  const el = document.querySelector(`input[name="${name}"]:checked`);
  return el ? el.value : "";
}

function renderEvaluations(rows){
  const byDate = new Map();
  for(const r of rows){
    const k = r.fechaKey;
    if(!byDate.has(k)) byDate.set(k, []);
    byDate.get(k).push(r);
  }

  const container = $("evalContainer");
  container.innerHTML = "";

  const keys = Array.from(byDate.keys()).sort((a,b)=>new Date(a)-new Date(b));
  for(const k of keys){
    const list = byDate.get(k);
    const d = new Date(k);
    const fechaTxt = formatDate(d);

    const det = document.createElement("details");
    det.open = (k===keys[0]);

    const sum = document.createElement("summary");
    const left = document.createElement("div");
    left.innerHTML = `<div style="font-size:16px;font-weight:900">${fechaTxt}</div><div class="sumMeta">${list.length} bloque(s)</div>`;
    const right = document.createElement("div");
    right.className = "sumMeta";
    right.textContent = "Abrir / Enviar";
    sum.appendChild(left);
    sum.appendChild(right);
    det.appendChild(sum);

    const inside = document.createElement("div");
    inside.className = "inside";

    for(const it of list){
      const task = document.createElement("div");
      task.className = "task";

      const top = document.createElement("div");
      top.className = "taskTop";
      const title = document.createElement("div");
      title.innerHTML = `<h3>Bloque ${it.bloque} • ${it.tema || "(sin tema)"}</h3><div class="small">Fecha: ${fechaTxt}</div>`;
      const actions = document.createElement("div");
      actions.className = "actions";

      const openBtn = document.createElement("button");
      openBtn.className = "pill";
      openBtn.type = "button";
      openBtn.textContent = it.link ? "Abrir PDF" : "Sin link";
      openBtn.disabled = !it.link;
      openBtn.addEventListener("click", ()=>{
        if(!it.link) return;
        saveScroll();
        window.open(it.link, "_blank", "noopener");
      });

      const sendBtn = document.createElement("button");
      sendBtn.className = "pill red";
      sendBtn.type = "button";
      sendBtn.textContent = "ENVIAR";
      sendBtn.addEventListener("click", async ()=>{
        sendBtn.disabled=true;
        sendBtn.textContent="Enviando...";
        try{
          const payload = {
            action:"save",
            clave: session.clave,
            curso: COURSE_CODE,
            fecha: it.fechaISO,
            bloque: it.bloque,
            tema: it.tema || "",
            q1: getAnswer(it.uid+"_q1"),
            q2: getAnswer(it.uid+"_q2"),
            q3: getAnswer(it.uid+"_q3"),
            q4: getAnswer(it.uid+"_q4"),
            q5: getAnswer(it.uid+"_q5"),
          };
          const res = await jsonp(payload, 25000);
          if(res && res.ok){
            hint.textContent = `Enviado. Guardado en hoja R (posición ${res.posicion || session.pos || "-" }).`;
            hint.className = "ok";
          }else{
            hint.textContent = "No se pudo guardar: " + (res && res.error ? res.error : "Error");
          }
        }catch(err){
          hint.textContent = "No se pudo guardar: " + (err && err.message ? err.message : err);
        }finally{
          sendBtn.disabled=false;
          sendBtn.textContent="ENVIAR";
        }
      });

      actions.appendChild(openBtn);
      actions.appendChild(sendBtn);

      top.appendChild(title);
      top.appendChild(actions);

      const qwrap = document.createElement("div");
      qwrap.appendChild(makeQuestionBlock(it.uid+"_q1","Pregunta 1"));
      qwrap.appendChild(makeQuestionBlock(it.uid+"_q2","Pregunta 2"));
      qwrap.appendChild(makeQuestionBlock(it.uid+"_q3","Pregunta 3"));
      qwrap.appendChild(makeQuestionBlock(it.uid+"_q4","Pregunta 4"));
      qwrap.appendChild(makeQuestionBlock(it.uid+"_q5","Pregunta 5"));

      const hint = document.createElement("div");
      hint.className = "hint";
      hint.textContent = "Puede enviar aunque deje preguntas en blanco.";

      task.appendChild(top);
      task.appendChild(qwrap);
      task.appendChild(hint);

      inside.appendChild(task);
    }

    det.appendChild(inside);
    container.appendChild(det);
  }
}

async function loadSchedule(){
  const url = `https://docs.google.com/spreadsheets/d/${SCHEDULE_SHEET_ID}/gviz/tq?tqx=out:csv&gid=${SCHEDULE_GID}`;
  const r = await fetch(url, {cache:"no-store"});
  const txt = await r.text();

  const rows = [];
  let i=0, cur="", inq=false, row=[];
  function pushCell(){ row.push(cur); cur=""; }
  function pushRow(){ rows.push(row); row=[]; }
  while(i<txt.length){
    const ch = txt[i];
    if(inq){
      if(ch==='\"' && txt[i+1]==='\"'){ cur+='\"'; i+=2; continue; }
      if(ch==='\"'){ inq=false; i++; continue; }
      cur+=ch; i++; continue;
    }else{
      if(ch==='\"'){ inq=true; i++; continue; }
      if(ch===','){ pushCell(); i++; continue; }
      if(ch==='\n'){ pushCell(); pushRow(); i++; continue; }
      if(ch==='\r'){ i++; continue; }
      cur+=ch; i++; continue;
    }
  }
  if(cur.length||row.length){ pushCell(); pushRow(); }

  const head = rows[0].map(x=>String(x||"").trim().toUpperCase());
  const idxFecha = head.findIndex(h=>h.includes("FECHA"));
  const idxBloque = head.findIndex(h=>h.includes("BLOQUE"));
  const idxTema = head.findIndex(h=>h.includes("TEMA")||h.includes("ALGEBRA")||h.includes("ÁLGEBRA"));
  const idxLink = head.findIndex(h=>h.includes("HIPER")||h.includes("LINK"));

  const out = [];
  for(let r=1;r<rows.length;r++){
    const rr = rows[r];
    const fechaRaw = rr[idxFecha] || "";
    const bloque = String(rr[idxBloque]||"").trim() || "";
    if(!bloque) continue;
    const tema = String(rr[idxTema]||"").trim();
    const link = String(rr[idxLink]||"").trim();

    const d = parseDMY(fechaRaw) || new Date(fechaRaw);
    const fechaISO = isNaN(d.getTime()) ? "" : d.toISOString().slice(0,10);
    const fechaKey = isNaN(d.getTime()) ? "2099-12-31" : d.toISOString().slice(0,10);

    out.push({
      fechaKey,
      fechaISO,
      fechaTxt: isNaN(d.getTime()) ? String(fechaRaw) : formatDate(d),
      bloque,
      tema,
      link: (link && link.startsWith("http")) ? link : "",
      uid: `${fechaKey}_${bloque}`.replace(/[^a-zA-Z0-9_]/g,"_")
    });
  }

  const order = {A:1,B:2,C:3,D:4,E:5};
  out.sort((a,b)=>{
    if(a.fechaKey!==b.fechaKey) return a.fechaKey.localeCompare(b.fechaKey);
    return (order[a.bloque]||99) - (order[b.bloque]||99);
  });

  schedule = out;
  renderMaterials(out.filter(x=>x.link));
  renderEvaluations(out);
}

/* ========= Events ========= */
$("btnAdmin").addEventListener("click", ()=>window.location.href="../");
$("btnTutor").addEventListener("click", ()=>alert("Tutor: sin cambios en esta entrega."));
$("btnSalir").addEventListener("click", ()=>{
  session=null;
  localStorage.removeItem("lameta_session");
  showLogin();
});

$("btnEntrar").addEventListener("click", async ()=>{
  setErr("");
  const clave = $("clave").value.trim();
  if(!clave) return setErr("Ingrese una clave.");
  $("btnEntrar").disabled=true;
  $("btnEntrar").textContent="Validando...";
  try{
    const res = await jsonp({action:"login", clave}, 25000);
    if(res && res.ok && res.alumno){
      session = {
        nombre: res.alumno.nombre || "",
        clave: res.alumno.clave || clave,
        pos: res.alumno.posicion || ""
      };
      localStorage.setItem("lameta_session", JSON.stringify(session));
      $("stuName").textContent = "Bienvenido, " + session.nombre;
      $("kvNombre").textContent = session.nombre;
      $("kvPos").textContent = session.pos || "-";
      $("stuMeta").textContent = `Curso: ÁLGEBRA • Posición: ${session.pos||"-"} • Puede enviar aunque deje preguntas en blanco.`;
      showStudent();
      await loadSchedule();
    }else{
      setErr(res && res.error ? res.error : "Clave inválida.");
    }
  }catch(err){
    setErr("No se pudo conectar (" + (err && err.message ? err.message : err) + ").");
  }finally{
    $("btnEntrar").disabled=false;
    $("btnEntrar").textContent="ENTRAR";
  }
});

window.addEventListener("beforeunload", saveScroll);

(function init(){
  setTabs();
  showLogin();
})();
</script>
</body>
</html>
